var Xd=Object.defineProperty,Zd=Object.defineProperties;var Kd=Object.getOwnPropertyDescriptors;var Ma=Object.getOwnPropertySymbols;var Qd=Object.prototype.hasOwnProperty,Jd=Object.prototype.propertyIsEnumerable;var Ra=(n,t,e)=>t in n?Xd(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,E=(n,t)=>{for(var e in t||(t={}))Qd.call(t,e)&&Ra(n,e,t[e]);if(Ma)for(var e of Ma(t))Jd.call(t,e)&&Ra(n,e,t[e]);return n},k=(n,t)=>Zd(n,Kd(t));function Z(n,t){if(!n)throw new Error(t||"loader assertion failed.")}const Qr={self:typeof self!="undefined"&&self,window:typeof window!="undefined"&&window,global:typeof global!="undefined"&&global,document:typeof document!="undefined"&&document},Jr=Qr.global||Qr.self||Qr.window||{},tg=typeof process!="object"||String(process)!=="[object process]"||process.browser,Oa=typeof process!="undefined"&&process.version&&/v([0-9]*)/.exec(process.version);Oa&&parseFloat(Oa[1]);const eg="3.0.12";function Jt(n,t){if(!n)throw new Error(t||"loaders.gl assertion failed.")}const ts={self:typeof self!="undefined"&&self,window:typeof window!="undefined"&&window,global:typeof global!="undefined"&&global,document:typeof document!="undefined"&&document},ng=ts.global||ts.self||ts.window||{},es=typeof process!="object"||String(process)!=="[object process]"||process.browser,ns=typeof importScripts=="function",ig=typeof window!="undefined"&&typeof window.orientation!="undefined",Ca=typeof process!="undefined"&&process.version&&/v([0-9]*)/.exec(process.version);Ca&&parseFloat(Ca[1]);function A(n,t,e){return t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}class rg{constructor(t,e){A(this,"name",void 0),A(this,"workerThread",void 0),A(this,"isRunning",void 0),A(this,"result",void 0),A(this,"_resolve",void 0),A(this,"_reject",void 0),this.name=t,this.workerThread=e,this.isRunning=!0,this._resolve=()=>{},this._reject=()=>{},this.result=new Promise((i,r)=>{this._resolve=i,this._reject=r})}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){Jt(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){Jt(this.isRunning),this.isRunning=!1,this._reject(t)}}const is=new Map;function sg(n){Jt(n.source&&!n.url||!n.source&&n.url);let t=is.get(n.source||n.url);return t||(n.url&&(t=og(n.url),is.set(n.url,t)),n.source&&(t=Na(n.source),is.set(n.source,t))),Jt(t),t}function og(n){if(!n.startsWith("http"))return n;const t=ag(n);return Na(t)}function Na(n){const t=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(t)}function ag(n){return`try {
  importScripts('${n}');
} catch (error) {
  console.error(error);
  throw error;
}`}function Da(n,t=!0,e){const i=e||new Set;if(n){if(Fa(n))i.add(n);else if(Fa(n.buffer))i.add(n.buffer);else if(!ArrayBuffer.isView(n)){if(t&&typeof n=="object")for(const r in n)Da(n[r],t,i)}}return e===void 0?Array.from(i):[]}function Fa(n){return n?n instanceof ArrayBuffer||typeof MessagePort!="undefined"&&n instanceof MessagePort||typeof ImageBitmap!="undefined"&&n instanceof ImageBitmap||typeof OffscreenCanvas!="undefined"&&n instanceof OffscreenCanvas:!1}const rs=()=>{};class Ua{static isSupported(){return typeof Worker!="undefined"}constructor(t){A(this,"name",void 0),A(this,"source",void 0),A(this,"url",void 0),A(this,"terminated",!1),A(this,"worker",void 0),A(this,"onMessage",void 0),A(this,"onError",void 0),A(this,"_loadableURL","");const{name:e,source:i,url:r}=t;Jt(i||r),this.name=e,this.source=i,this.url=r,this.onMessage=rs,this.onError=s=>console.log(s),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=rs,this.onError=rs,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(t,e){e=e||Da(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+=`worker ${this.name}. `,t.message&&(e+=`${t.message} in `),t.lineno&&(e+=`:${t.lineno}:${t.colno}`),new Error(e)}_createBrowserWorker(){this._loadableURL=sg({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},t.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},t.onmessageerror=e=>console.error(e),t}}class cg{constructor(t){A(this,"name","unnamed"),A(this,"source",void 0),A(this,"url",void 0),A(this,"maxConcurrency",1),A(this,"maxMobileConcurrency",1),A(this,"onDebug",()=>{}),A(this,"reuseWorkers",!0),A(this,"props",{}),A(this,"jobQueue",[]),A(this,"idleQueue",[]),A(this,"count",0),A(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach(t=>t.destroy()),this.isDestroyed=!0}setProps(t){this.props=E(E({},this.props),t),t.name!==void 0&&(this.name=t.name),t.maxConcurrency!==void 0&&(this.maxConcurrency=t.maxConcurrency),t.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=t.maxMobileConcurrency),t.reuseWorkers!==void 0&&(this.reuseWorkers=t.reuseWorkers),t.onDebug!==void 0&&(this.onDebug=t.onDebug)}async startJob(t,e=(r,s,o)=>r.done(o),i=(r,s)=>r.error(s)){const r=new Promise(s=>(this.jobQueue.push({name:t,onMessage:e,onError:i,onStart:s}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const i=new rg(e.name,t);t.onMessage=r=>e.onMessage(i,r.type,r.payload),t.onError=r=>e.onError(i,r),e.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Ua({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return ig?this.maxMobileConcurrency:this.maxConcurrency}}const lg={maxConcurrency:3,maxMobileConcurrency:1,onDebug:()=>{},reuseWorkers:!0};class le{static isSupported(){return Ua.isSupported()}static getWorkerFarm(t={}){return le._workerFarm=le._workerFarm||new le({}),le._workerFarm.setProps(t),le._workerFarm}constructor(t){A(this,"props",void 0),A(this,"workerPools",new Map),this.props=E({},lg),this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy()}setProps(t){this.props=E(E({},this.props),t);for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:i,url:r}=t;let s=this.workerPools.get(e);return s||(s=new cg({name:e,source:i,url:r}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}A(le,"_workerFarm",void 0);const ug="latest";function hg(n,t={}){const e=t[n.id]||{},i=`${n.id}-worker.js`;let r=e.workerUrl;if(t._workerType==="test"&&(r=`modules/${n.module}/dist/${i}`),!r){let s=n.version;s==="latest"&&(s=ug);const o=s?`@${s}`:"";r=`https://unpkg.com/@loaders.gl/${n.module}${o}/dist/${i}`}return Jt(r),r}function fg(n,t=eg){Jt(n,"no worker provided");const e=n.version;return!(!t||!e)}const dg="3.0.12",ss={};async function os(n,t=null,e={}){return t&&(n=gg(n,t,e)),ss[n]=ss[n]||pg(n),await ss[n]}function gg(n,t,e){if(n.startsWith("http"))return n;const i=e.modules||{};return i[n]?i[n]:es?e.CDN?(Jt(e.CDN.startsWith("http")),`${e.CDN}/${t}@${dg}/dist/libs/${n}`):ns?`../src/libs/${n}`:`modules/${t}/src/libs/${n}`:`modules/${t}/dist/libs/${n}`}async function pg(n){if(n.endsWith("wasm"))return await(await fetch(n)).arrayBuffer();if(!es)return;if(ns)return importScripts(n);const e=await(await fetch(n)).text();return mg(e,n)}function mg(n,t){if(!es)return;if(ns)return eval.call(ng,n),null;const e=document.createElement("script");e.id=t;try{e.appendChild(document.createTextNode(n))}catch(i){e.text=n}return document.body.appendChild(e),null}function _g(n,t){return le.isSupported()?n.worker&&(t==null?void 0:t.worker):!1}async function bg(n,t,e,i,r){const s=n.id,o=hg(n,e),c=le.getWorkerFarm(e).getWorkerPool({name:s,url:o});e=JSON.parse(JSON.stringify(e));const l=await c.startJob("process-on-worker",yg.bind(null,r));return l.postMessage("process",{input:t,options:e}),await(await l.result).result}async function yg(n,t,e,i){switch(e){case"done":t.done(i);break;case"error":t.error(i.error);break;case"process":const{id:r,input:s,options:o}=i;try{const a=await n(s,o);t.postMessage("done",{id:r,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";t.postMessage("error",{id:r,error:c})}break;default:console.warn(`parse-with-worker unknown message ${e}`)}}function Tg(n,t=5){return typeof n=="string"?n.slice(0,t):ArrayBuffer.isView(n)?Ba(n.buffer,n.byteOffset,t):n instanceof ArrayBuffer?Ba(n,0,t):""}function Ba(n,t,e){if(n.byteLength<=t+e)return"";const i=new DataView(n);let r="";for(let s=0;s<e;s++)r+=String.fromCharCode(i.getUint8(t+s));return r}function Eg(n){try{return JSON.parse(n)}catch(t){throw new Error(`Failed to parse JSON from data starting with "${Tg(n)}"`)}}function vg(n){return n&&typeof n=="object"&&n.isBuffer}function Ag(n){return n}function ka(n){if(vg(n)&&(n=Ag(n)),n instanceof ArrayBuffer)return n;if(ArrayBuffer.isView(n))return n.byteOffset===0&&n.byteLength===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);if(typeof n=="string"){const t=n;return new TextEncoder().encode(t).buffer}if(n&&typeof n=="object"&&n._toArrayBuffer)return n._toArrayBuffer();throw new Error("toArrayBuffer")}function wg(n,t,e){if(e=e||n.byteLength,n.byteLength<e||t.byteLength<e)return!1;const i=new Uint8Array(n),r=new Uint8Array(t);for(let s=0;s<i.length;++s)if(i[s]!==r[s])return!1;return!0}function Sg(...n){const t=n.map(s=>s instanceof ArrayBuffer?new Uint8Array(s):s),e=t.reduce((s,o)=>s+o.byteLength,0),i=new Uint8Array(e);let r=0;for(const s of t)i.set(s,r),r+=s.byteLength;return i.buffer}function as(n,t,e){const i=e!==void 0?new Uint8Array(n).subarray(t,t+e):new Uint8Array(n).subarray(t);return new Uint8Array(i).buffer}function xn(n,t){return Z(n>=0),Z(t>0),n+(t-1)&~(t-1)}function Ig(n,t,e){let i;if(n instanceof ArrayBuffer)i=new Uint8Array(n);else{const r=n.byteOffset,s=n.byteLength;i=new Uint8Array(n.buffer||n.arrayBuffer,r,s)}return t.set(i,e),e+xn(i.byteLength,4)}async function Pg(n){const t=[];for await(const e of n)t.push(e);return Sg(...t)}function Va(){let n;if(typeof window!="undefined"&&window.performance)n=window.performance.now();else if(typeof process!="undefined"&&process.hrtime){const t=process.hrtime();n=t[0]*1e3+t[1]/1e6}else n=Date.now();return n}class za{constructor(t,e){this.name=t,this.type=e,this.sampleSize=1,this.reset()}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Va(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Va()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Ln{constructor({id:t,stats:e}){this.id=t,this.stats={},this._initializeStats(e),Object.seal(this)}get(t,e="count"){return this._getOrCreate({name:t,type:e})}get size(){return Object.keys(this.stats).length}reset(){for(const t in this.stats)this.stats[t].reset();return this}forEach(t){for(const e in this.stats)t(this.stats[e])}getTable(){const t={};return this.forEach(e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}}),t}_initializeStats(t=[]){t.forEach(e=>this._getOrCreate(e))}_getOrCreate(t){if(!t||!t.name)return null;const{name:e,type:i}=t;return this.stats[e]||(t instanceof za?this.stats[e]=t:this.stats[e]=new za(e,i)),this.stats[e]}}const xg="Queued Requests",Lg="Active Requests",Mg="Cancelled Requests",Rg="Queued Requests Ever",Og="Active Requests Ever",Cg={id:"request-scheduler",throttleRequests:!0,maxRequests:6};class Ng{constructor(t={}){A(this,"props",void 0),A(this,"stats",void 0),A(this,"activeRequestCount",0),A(this,"requestQueue",[]),A(this,"requestMap",new Map),A(this,"deferredUpdate",null),this.props=E(E({},Cg),t),this.stats=new Ln({id:this.props.id}),this.stats.get(xg),this.stats.get(Lg),this.stats.get(Mg),this.stats.get(Rg),this.stats.get(Og)}scheduleRequest(t,e=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(t))return this.requestMap.get(t);const i={handle:t,priority:0,getPriority:e},r=new Promise(s=>(i.resolve=s,i));return this.requestQueue.push(i),this.requestMap.set(t,r),this._issueNewRequests(),r}_issueRequest(t){const{handle:e,resolve:i}=t;let r=!1;const s=()=>{r||(r=!0,this.requestMap.delete(e),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:s}):Promise.resolve({done:s})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout(()=>this._issueNewRequestsAsync(),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;const t=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(t!==0){this._updateAllRequests();for(let e=0;e<t;++e){const i=this.requestQueue.shift();i&&this._issueRequest(i)}}}_updateAllRequests(){const t=this.requestQueue;for(let e=0;e<t.length;++e){const i=t[e];this._updateRequest(i)||(t.splice(e,1),this.requestMap.delete(i.handle),e--)}t.sort((e,i)=>e.priority-i.priority)}_updateRequest(t){return t.priority=t.getPriority(t.handle),t.priority<0?(t.resolve(null),!1):!0}}let Dg="";const ja={};function Fg(n){for(const t in ja)if(n.startsWith(t)){const e=ja[t];n=n.replace(t,e)}return!n.startsWith("http://")&&!n.startsWith("https://")&&(n=`${Dg}${n}`),n}function Ga(n){const t=n&&n.lastIndexOf("/");return t>=0?n.substr(0,t):""}const Ug=n=>typeof n=="boolean",Mn=n=>typeof n=="function",Rn=n=>n!==null&&typeof n=="object",$a=n=>Rn(n)&&n.constructor==={}.constructor,Bg=n=>n&&typeof n[Symbol.iterator]=="function",kg=n=>n&&typeof n[Symbol.asyncIterator]=="function",On=n=>typeof Response!="undefined"&&n instanceof Response||n&&n.arrayBuffer&&n.text&&n.json,ze=n=>typeof Blob!="undefined"&&n instanceof Blob,Vg=n=>typeof ReadableStream!="undefined"&&n instanceof ReadableStream||Rn(n)&&Mn(n.tee)&&Mn(n.cancel)&&Mn(n.getReader),zg=n=>n&&typeof n=="object"&&n.isBuffer,jg=n=>Rn(n)&&Mn(n.read)&&Mn(n.pipe)&&Ug(n.readable),Ha=n=>Vg(n)||jg(n),Gg=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,$g=/^([-\w.]+\/[-\w.+]+)/;function Hg(n){const t=$g.exec(n);return t?t[1]:n}function Wa(n){const t=Gg.exec(n);return t?t[1]:""}const Wg=/\?.*/;function Ci(n){if(On(n)){const t=cs(n.url||""),e=n.headers.get("content-type")||"";return{url:t,type:Hg(e)||Wa(t)}}return ze(n)?{url:cs(n.name||""),type:n.type||""}:typeof n=="string"?{url:cs(n),type:Wa(n)}:{url:"",type:""}}function qg(n){return On(n)?n.headers["content-length"]||-1:ze(n)?n.size:typeof n=="string"?n.length:n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.byteLength:-1}function cs(n){return n.replace(Wg,"")}async function qa(n){if(On(n))return n;const t={},e=qg(n);e>=0&&(t["content-length"]=String(e));const{url:i,type:r}=Ci(n);r&&(t["content-type"]=r);const s=await Zg(n);s&&(t["x-first-bytes"]=s),typeof n=="string"&&(n=new TextEncoder().encode(n));const o=new Response(n,{headers:t});return Object.defineProperty(o,"url",{value:i}),o}async function Yg(n){if(!n.ok){const t=await Xg(n);throw new Error(t)}}async function Xg(n){let t=`Failed to fetch resource ${n.url} (${n.status}): `;try{const e=n.headers.get("Content-Type");let i=n.statusText;e.includes("application/json")&&(i+=` ${await n.text()}`),t+=i,t=t.length>60?`${t.slice(60)}...`:t}catch(e){}return t}async function Zg(n){const t=5;if(typeof n=="string")return`data:,${n.slice(0,t)}`;if(n instanceof Blob){const e=n.slice(0,5);return await new Promise(i=>{const r=new FileReader;r.onload=s=>{var o;return i(s==null||(o=s.target)===null||o===void 0?void 0:o.result)},r.readAsDataURL(e)})}if(n instanceof ArrayBuffer){const e=n.slice(0,t);return`data:base64,${Kg(e)}`}return null}function Kg(n){let t="";const e=new Uint8Array(n);for(let i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return btoa(t)}async function Ya(n,t){if(typeof n=="string"){n=Fg(n);let e=t;return t!=null&&t.fetch&&typeof(t==null?void 0:t.fetch)!="function"&&(e=t.fetch),await fetch(n,e)}return await qa(n)}function Xa(n){if(typeof window!="undefined"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process!="undefined"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,e=n||t;return!!(e&&e.indexOf("Electron")>=0)}function Za(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Xa()}const Ni={self:typeof self!="undefined"&&self,window:typeof window!="undefined"&&window,global:typeof global!="undefined"&&global,document:typeof document!="undefined"&&document,process:typeof process=="object"&&process},Cn=Ni.window||Ni.self||Ni.global,Ka=Ni.process||{},Qa=typeof __VERSION__!="undefined"?__VERSION__:"untranspiled source",Di=Za();function Qg(n){try{const t=window[n],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),t}catch(t){return null}}class Jg{constructor(t,e,i="sessionStorage"){this.storage=Qg(i),this.id=t,this.config={},Object.assign(this.config,e),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){return this.config={},this.updateConfiguration(t)}updateConfiguration(t){if(Object.assign(this.config,t),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}return this}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function tp(n){let t;return n<10?t="".concat(n.toFixed(2),"ms"):n<100?t="".concat(n.toFixed(1),"ms"):n<1e3?t="".concat(n.toFixed(0),"ms"):t="".concat((n/1e3).toFixed(2),"s"),t}function ep(n,t=8){const e=Math.max(t-n.length,0);return"".concat(" ".repeat(e)).concat(n)}function ls(n,t,e,i=600){const r=n.src.replace(/\(/g,"%28").replace(/\)/g,"%29");n.width>i&&(e=Math.min(e,i/n.width));const s=n.width*e,o=n.height*e,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(s/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(r,");"),"background-size:".concat(s,"px ").concat(o,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}const Ja={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function tc(n){return typeof n=="string"?Ja[n.toUpperCase()]||Ja.WHITE:n}function np(n,t,e){return!Di&&typeof n=="string"&&(t&&(t=tc(t),n="[".concat(t,"m").concat(n,"[39m")),e&&(t=tc(e),n="[".concat(e+10,"m").concat(n,"[49m"))),n}function ip(n,t=["constructor"]){const e=Object.getPrototypeOf(n),i=Object.getOwnPropertyNames(e);for(const r of i)typeof n[r]=="function"&&(t.find(s=>r===s)||(n[r]=n[r].bind(n)))}function Fi(n,t){if(!n)throw new Error(t||"Assertion failed")}function je(){let n;if(Di&&Cn.performance)n=Cn.performance.now();else if(Ka.hrtime){const t=Ka.hrtime();n=t[0]*1e3+t[1]/1e6}else n=Date.now();return n}const Ge={debug:Di&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},rp={enabled:!0,level:0};function Bt(){}const ec={},nc={once:!0};function sp(n){for(const t in n)for(const e in n[t])return e||"untitled";return"empty"}class Ui{constructor({id:t}={id:""}){this.id=t,this.VERSION=Qa,this._startTs=je(),this._deltaTs=je(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new Jg("__probe-".concat(this.id,"__"),rp),this.userData={},this.timeStamp("".concat(this.id," started")),ip(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((je()-this._startTs).toPrecision(10))}getDelta(){return Number((je()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(t=!0){return this._storage.updateConfiguration({enabled:t}),this}setLevel(t){return this._storage.updateConfiguration({level:t}),this}assert(t,e){Fi(t,e)}warn(t){return this._getLogFunction(0,t,Ge.warn,arguments,nc)}error(t){return this._getLogFunction(0,t,Ge.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,Ge.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,Ge.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){return this._getLogFunction(t,e,Ge.debug||Ge.info,arguments,nc)}table(t,e,i){return e?this._getLogFunction(t,e,console.table||Bt,i&&[i],{tag:sp(e)}):Bt}image({logLevel:t,priority:e,image:i,message:r="",scale:s=1}){return this._shouldLog(t||e)?Di?cp({image:i,message:r,scale:s}):ap({image:i,message:r,scale:s}):Bt}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(t){return this._storage.config[t]}set(t,e){this._storage.updateConfiguration({[t]:e})}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||Bt)}group(t,e,i={collapsed:!1}){i=rc({logLevel:t,message:e,opts:i});const{collapsed:r}=i;return i.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(t,e,i={}){return this.group(t,e,Object.assign({},i,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||Bt)}withGroup(t,e,i){this.group(t,e)();try{i()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=ic(t)}_getLogFunction(t,e,i,r=[],s){if(this._shouldLog(t)){s=rc({logLevel:t,message:e,args:r,opts:s}),i=i||s.method,Fi(i),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=je();const o=s.tag||s.message;if(s.once)if(!ec[o])ec[o]=je();else return Bt;return e=op(this.id,s.message,s),i.bind(console,e,...s.args)}return Bt}}Ui.VERSION=Qa;function ic(n){if(!n)return 0;let t;switch(typeof n){case"number":t=n;break;case"object":t=n.logLevel||n.priority||0;break;default:return 0}return Fi(Number.isFinite(t)&&t>=0),t}function rc(n){const{logLevel:t,message:e}=n;n.logLevel=ic(t);const i=n.args?Array.from(n.args):[];for(;i.length&&i.shift()!==e;);switch(n.args=i,typeof t){case"string":case"function":e!==void 0&&i.unshift(e),n.message=t;break;case"object":Object.assign(n,t);break}typeof n.message=="function"&&(n.message=n.message());const r=typeof n.message;return Fi(r==="string"||r==="object"),Object.assign(n,n.opts)}function op(n,t,e){if(typeof t=="string"){const i=e.time?ep(tp(e.total)):"";t=e.time?"".concat(n,": ").concat(i,"  ").concat(t):"".concat(n,": ").concat(t),t=np(t,e.color,e.background)}return t}function ap({image:n,message:t="",scale:e=1}){let i=null;try{i=module.require("asciify-image")}catch(r){}return i?()=>i(n,{fit:"box",width:"".concat(Math.round(80*e),"%")}).then(r=>console.log(r)):Bt}function cp({image:n,message:t="",scale:e=1}){if(typeof n=="string"){const r=new Image;return r.onload=()=>{const s=ls(r,t,e);console.log(...s)},r.src=n,Bt}const i=n.nodeName||"";if(i.toLowerCase()==="img")return console.log(...ls(n,t,e)),Bt;if(i.toLowerCase()==="canvas"){const r=new Image;return r.onload=()=>console.log(...ls(r,t,e)),r.src=n.toDataURL(),Bt}return Bt}function lp(n){if(!n&&!Za())return"Node";if(Xa(n))return"Electron";const e=n||(typeof navigator!="undefined"?navigator:{}).userAgent||"";if(e.indexOf("Edge")>-1)return"Edge";const i=e.indexOf("MSIE ")!==-1,r=e.indexOf("Trident/")!==-1;return i||r?"IE":Cn.chrome?"Chrome":Cn.safari?"Safari":Cn.mozInnerScreenX?"Firefox":"Unknown"}const sc=new Ui({id:"loaders.gl"});class up{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class hp{constructor(){A(this,"console",void 0),this.console=console}log(...t){return this.console.log.bind(this.console,...t)}info(...t){return this.console.info.bind(this.console,...t)}warn(...t){return this.console.warn.bind(this.console,...t)}error(...t){return this.console.error.bind(this.console,...t)}}const oc={fetch:null,mimeType:void 0,nothrow:!1,log:new hp,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},fp={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function ac(){Jr.loaders=Jr.loaders||{};const{loaders:n}=Jr;return n._state=n._state||{},n._state}const cc=()=>{const n=ac();return n.globalOptions=n.globalOptions||E({},oc),n.globalOptions};function dp(n,t,e,i){return e=e||[],e=Array.isArray(e)?e:[e],gp(n,e),mp(t,n,i)}function lc(n,t){const e=cc(),i=n||e;return typeof i.fetch=="function"?i.fetch:Rn(i.fetch)?r=>Ya(r,i):t!=null&&t.fetch?t==null?void 0:t.fetch:Ya}function gp(n,t){uc(n,null,oc,fp,t);for(const e of t){const i=n&&n[e.id]||{},r=e.options&&e.options[e.id]||{},s=e.deprecatedOptions&&e.deprecatedOptions[e.id]||{};uc(i,e.id,r,s,t)}}function uc(n,t,e,i,r){const s=t||"Top level",o=t?`${t}.`:"";for(const a in n){const c=!t&&Rn(n[a]),l=a==="baseUri"&&!t,u=a==="workerUrl"&&t;if(!(a in e)&&!l&&!u){if(a in i)sc.warn(`${s} loader option '${o}${a}' no longer supported, use '${i[a]}'`)();else if(!c){const h=pp(a,r);sc.warn(`${s} loader option '${o}${a}' not recognized. ${h}`)()}}}}function pp(n,t){const e=n.toLowerCase();let i="";for(const r of t)for(const s in r.options){if(n===s)return`Did you mean '${r.id}.${s}'?`;const o=s.toLowerCase();(e.startsWith(o)||o.startsWith(e))&&(i=i||`Did you mean '${r.id}.${s}'?`)}return i}function mp(n,t,e){const i=n.options||{},r=E({},i);return _p(r,e),r.log===null&&(r.log=new up),hc(r,cc()),hc(r,t),r}function hc(n,t){for(const e in t)if(e in t){const i=t[e];$a(i)&&$a(n[e])?n[e]=E(E({},n[e]),t[e]):n[e]=t[e]}}function _p(n,t){t&&!("baseUri"in n)&&(n.baseUri=t)}function us(n){var t;return n?(Array.isArray(n)&&(n=n[0]),Array.isArray((t=n)===null||t===void 0?void 0:t.extensions)):!1}function hs(n){var t,e;Z(n,"null loader"),Z(us(n),"invalid loader");let i;return Array.isArray(n)&&(i=n[1],n=n[0],n=k(E({},n),{options:E(E({},n.options),i)})),((t=n)!==null&&t!==void 0&&t.parseTextSync||(e=n)!==null&&e!==void 0&&e.parseText)&&(n.text=!0),n.text||(n.binary=!0),n}const fc=()=>{const n=ac();return n.loaderRegistry=n.loaderRegistry||[],n.loaderRegistry};function bp(n){const t=fc();n=Array.isArray(n)?n:[n];for(const e of n){const i=hs(e);t.find(r=>i===r)||t.unshift(i)}}function yp(){return fc()}const Tp=/\.([^.]+)$/;async function Ep(n,t=[],e,i){if(!gc(n))return null;let r=dc(n,t,k(E({},e),{nothrow:!0}),i);if(r)return r;if(ze(n)&&(n=await n.slice(0,10).arrayBuffer(),r=dc(n,t,e,i)),!r&&!(e!=null&&e.nothrow))throw new Error(pc(n));return r}function dc(n,t=[],e,i){if(!gc(n))return null;if(t&&!Array.isArray(t))return hs(t);let r=[];t&&(r=r.concat(t)),e!=null&&e.ignoreRegisteredLoaders||r.push(...yp()),Ap(r);const s=vp(n,r,e,i);if(!s&&!(e!=null&&e.nothrow))throw new Error(pc(n));return s}function vp(n,t,e,i){const{url:r,type:s}=Ci(n),o=r||(i==null?void 0:i.url);let a=null;return e!=null&&e.mimeType&&(a=fs(t,e==null?void 0:e.mimeType)),a=a||wp(t,o),a=a||fs(t,s),a=a||Ip(t,n),a=a||fs(t,e==null?void 0:e.fallbackMimeType),a}function gc(n){return!(n instanceof Response&&n.status===204)}function pc(n){const{url:t,type:e}=Ci(n);let i="No valid loader found";return n&&(i+=` data: "${Lp(n)}", contentType: "${e}"`),t&&(i+=` url: ${t}`),i}function Ap(n){for(const t of n)hs(t)}function wp(n,t){const e=t&&Tp.exec(t),i=e&&e[1];return i?Sp(n,i):null}function Sp(n,t){t=t.toLowerCase();for(const e of n)for(const i of e.extensions)if(i.toLowerCase()===t)return e;return null}function fs(n,t){for(const e of n)if(e.mimeTypes&&e.mimeTypes.includes(t)||t===`application/x.${e.id}`)return e;return null}function Ip(n,t){if(!t)return null;for(const e of n)if(typeof t=="string"){if(Pp(t,e))return e}else if(ArrayBuffer.isView(t)){if(mc(t.buffer,t.byteOffset,e))return e}else if(t instanceof ArrayBuffer&&mc(t,0,e))return e;return null}function Pp(n,t){return t.testText?t.testText(n):(Array.isArray(t.tests)?t.tests:[t.tests]).some(i=>n.startsWith(i))}function mc(n,t,e){return(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>xp(n,t,e,r))}function xp(n,t,e,i){if(i instanceof ArrayBuffer)return wg(i,n,i.byteLength);switch(typeof i){case"function":return i(n,e);case"string":const r=ds(n,t,i.length);return i===r;default:return!1}}function Lp(n,t=5){return typeof n=="string"?n.slice(0,t):ArrayBuffer.isView(n)?ds(n.buffer,n.byteOffset,t):n instanceof ArrayBuffer?ds(n,0,t):""}function ds(n,t,e){if(n.byteLength<t+e)return"";const i=new DataView(n);let r="";for(let s=0;s<e;s++)r+=String.fromCharCode(i.getUint8(t+s));return r}const Mp=256*1024;function*Rp(n,t){const e=(t==null?void 0:t.chunkSize)||Mp;let i=0;const r=new TextEncoder;for(;i<n.length;){const s=Math.min(n.length-i,e),o=n.slice(i,i+s);i+=s,yield r.encode(o)}}const Op=256*1024;function*Cp(n,t={}){const{chunkSize:e=Op}=t;let i=0;for(;i<n.byteLength;){const r=Math.min(n.byteLength-i,e),s=new ArrayBuffer(r),o=new Uint8Array(n,i,r);new Uint8Array(s).set(o),i+=r,yield s}}const Np=1024*1024;async function*Dp(n,t){const e=(t==null?void 0:t.chunkSize)||Np;let i=0;for(;i<n.size;){const r=i+e,s=await n.slice(i,r).arrayBuffer();i=r,yield s}}function _c(n,t){return tg?Fp(n,t):Up(n)}async function*Fp(n,t){const e=n.getReader();let i;try{for(;;){const r=i||e.read();t!=null&&t._streamReadAhead&&(i=e.read());const{done:s,value:o}=await r;if(s)return;yield ka(o)}}catch(r){e.releaseLock()}}async function*Up(n,t){for await(const e of n)yield ka(e)}function Bp(n,t){if(typeof n=="string")return Rp(n,t);if(n instanceof ArrayBuffer)return Cp(n,t);if(ze(n))return Dp(n,t);if(Ha(n))return _c(n,t);if(On(n))return _c(n.body,t);throw new Error("makeIterator")}const bc="Cannot convert supplied data type";function kp(n,t,e){if(t.text&&typeof n=="string")return n;if(zg(n)&&(n=n.buffer),n instanceof ArrayBuffer){const i=n;return t.text&&!t.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(n)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(n);let i=n.buffer;const r=n.byteLength||n.length;return(n.byteOffset!==0||r!==i.byteLength)&&(i=i.slice(n.byteOffset,n.byteOffset+r)),i}throw new Error(bc)}async function Vp(n,t,e){const i=n instanceof ArrayBuffer||ArrayBuffer.isView(n);if(typeof n=="string"||i)return kp(n,t);if(ze(n)&&(n=await qa(n)),On(n)){const r=n;return await Yg(r),t.binary?await r.arrayBuffer():await r.text()}if(Ha(n)&&(n=Bp(n,e)),Bg(n)||kg(n))return Pg(n);throw new Error(bc)}function zp(n,t,e=null){if(e)return e;const i=E({fetch:lc(t,n)},n);return Array.isArray(i.loaders)||(i.loaders=null),i}function jp(n,t){if(!t&&n&&!Array.isArray(n))return n;let e;if(n&&(e=Array.isArray(n)?n:[n]),t&&t.loaders){const i=Array.isArray(t.loaders)?t.loaders:[t.loaders];e=e?[...e,...i]:i}return e&&e.length?e:null}async function gs(n,t,e,i){Jt(!i||typeof i=="object"),t&&!Array.isArray(t)&&!us(t)&&(i=void 0,e=t,t=void 0),n=await n,e=e||{};const{url:r}=Ci(n),o=jp(t,i),a=await Ep(n,o,e);return a?(e=dp(e,a,o,r),i=zp({url:r,parse:gs,loaders:o},e,i),await Gp(a,n,e,i)):null}async function Gp(n,t,e,i){if(fg(n),t=await Vp(t,n,e),n.parseTextSync&&typeof t=="string")return e.dataType="text",n.parseTextSync(t,e,i,n);if(_g(n,e))return await bg(n,t,e,i,gs);if(n.parseText&&typeof t=="string")return await n.parseText(t,e,i,n);if(n.parse)return await n.parse(t,e,i,n);throw Jt(!n.parseSync),new Error(`${n.id} loader - no parser found and worker is disabled`)}async function $e(n,t,e,i){!Array.isArray(t)&&!us(t)&&(e=t,t=void 0);const r=lc(e);let s=n;return typeof n=="string"&&(s=await r(n)),ze(n)&&(s=await r(n)),await gs(s,t,e)}const $p="3.0.12";function yc(n,t){if(!n)throw new Error(t)}const ps={self:typeof self!="undefined"&&self,window:typeof window!="undefined"&&window,global:typeof global!="undefined"&&global,document:typeof document!="undefined"&&document},Tc=ps.global||ps.self||ps.window,Hp=typeof process!="object"||String(process)!=="[object process]"||process.browser,Ec=typeof process!="undefined"&&process.version&&/v([0-9]*)/.exec(process.version);Ec&&parseFloat(Ec[1]);const{_parseImageNode:Wp}=Tc,ms=typeof Image!="undefined",_s=typeof ImageBitmap!="undefined",qp=Boolean(Wp),bs=Hp?!0:qp;function Yp(n){switch(n){case"auto":return _s||ms||bs;case"imagebitmap":return _s;case"image":return ms;case"data":return bs;default:throw new Error(`@loaders.gl/images: image ${n} not supported in this environment`)}}function Xp(){if(_s)return"imagebitmap";if(ms)return"image";if(bs)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Zp(n){const t=Qp(n);if(!t)throw new Error("Not an image");return t}function Kp(n){switch(Zp(n)){case"data":return n;case"image":case"imagebitmap":const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("getImageData");return t.width=n.width,t.height=n.height,e.drawImage(n,0,0),e.getImageData(0,0,n.width,n.height);default:throw new Error("getImageData")}}function Qp(n){return typeof ImageBitmap!="undefined"&&n instanceof ImageBitmap?"imagebitmap":typeof Image!="undefined"&&n instanceof Image?"image":n&&typeof n=="object"&&n.data&&n.width&&n.height?"data":null}const Jp=/^data:image\/svg\+xml/,tm=/\.svg((\?|#).*)?$/;function ys(n){return n&&(Jp.test(n)||tm.test(n))}function em(n,t){if(ys(t)){let i=new TextDecoder().decode(n);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(s){throw new Error(s.message)}return`data:image/svg+xml;base64,${btoa(i)}`}return vc(n,t)}function vc(n,t){if(ys(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(n)])}async function Ac(n,t,e){const i=em(n,e),r=self.URL||self.webkitURL,s=typeof i!="string"&&r.createObjectURL(i);try{return await nm(s||i,t)}finally{s&&r.revokeObjectURL(s)}}async function nm(n,t){const e=new Image;return e.src=n,t.image&&t.image.decode&&e.decode?(await e.decode(),e):await new Promise((i,r)=>{try{e.onload=()=>i(e),e.onerror=s=>r(new Error(`Could not load image ${n}: ${s}`))}catch(s){r(s)}})}const im={};let wc=!0;async function rm(n,t,e){let i;ys(e)?i=await Ac(n,t,e):i=vc(n,e);const r=t&&t.imagebitmap;return await sm(i,r)}async function sm(n,t=null){if((om(t)||!wc)&&(t=null),t)try{return await createImageBitmap(n,t)}catch(e){console.warn(e),wc=!1}return await createImageBitmap(n)}function om(n){for(const t in n||im)return!1;return!0}const te=!1,Nn=!0;function Ts(n){const t=Dn(n);return am(t)||um(t)||cm(t)||lm(t)}function am(n){const t=Dn(n);return t.byteLength>=24&&t.getUint32(0,te)===2303741511?{mimeType:"image/png",width:t.getUint32(16,te),height:t.getUint32(20,te)}:null}function cm(n){const t=Dn(n);return t.byteLength>=10&&t.getUint32(0,te)===1195984440?{mimeType:"image/gif",width:t.getUint16(6,Nn),height:t.getUint16(8,Nn)}:null}function lm(n){const t=Dn(n);return t.byteLength>=14&&t.getUint16(0,te)===16973&&t.getUint32(2,Nn)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,Nn),height:t.getUint32(22,Nn)}:null}function um(n){const t=Dn(n);if(!(t.byteLength>=3&&t.getUint16(0,te)===65496&&t.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:r}=hm();let s=2;for(;s+9<t.byteLength;){const o=t.getUint16(s,te);if(r.has(o))return{mimeType:"image/jpeg",height:t.getUint16(s+5,te),width:t.getUint16(s+7,te)};if(!i.has(o))return null;s+=2,s+=t.getUint16(s,te)}return null}function hm(){const n=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)n.add(e);const t=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:n,sofMarkers:t}}function Dn(n){if(n instanceof DataView)return n;if(ArrayBuffer.isView(n))return new DataView(n.buffer);if(n instanceof ArrayBuffer)return new DataView(n);throw new Error("toDataView")}function fm(n,t){const{mimeType:e}=Ts(n)||{},{_parseImageNode:i}=Tc;return yc(i),i(n,e,t)}async function dm(n,t,e){t=t||{};const r=(t.image||{}).type||"auto",{url:s}=e||{},o=gm(r);let a;switch(o){case"imagebitmap":a=await rm(n,t,s);break;case"image":a=await Ac(n,t,s);break;case"data":a=await fm(n,t);break;default:yc(!1)}return r==="data"&&(a=Kp(a)),a}function gm(n){switch(n){case"auto":case"data":return Xp();default:return Yp(n),n}}const pm=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],mm=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],Sc={id:"image",module:"images",name:"Images",version:$p,mimeTypes:mm,extensions:pm,parse:dm,tests:[n=>Boolean(Ts(new DataView(n)))],options:{image:{type:"auto",decode:!0}}};var Ic=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},Pc={},He={exports:{}};(function(n){function t(e){return e&&e.__esModule?e:{default:e}}n.exports=t,n.exports.default=n.exports,n.exports.__esModule=!0})(He);var Fn={exports:{}};(function(n){function t(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?(n.exports=t=function(r){return typeof r},n.exports.default=n.exports,n.exports.__esModule=!0):(n.exports=t=function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},n.exports.default=n.exports,n.exports.__esModule=!0),t(e)}n.exports=t,n.exports.default=n.exports,n.exports.__esModule=!0})(Fn);var yt={},_m=He.exports;Object.defineProperty(yt,"__esModule",{value:!0});yt.console=yt.process=yt.document=yt.global=yt.window=yt.self=void 0;var bm=_m(Fn.exports),jt={self:typeof self!="undefined"&&self,window:typeof window!="undefined"&&window,global:typeof Ic!="undefined"&&Ic,document:typeof document!="undefined"&&document,process:(typeof process=="undefined"?"undefined":(0,bm.default)(process))==="object"&&process},ym=jt.self||jt.window||jt.global;yt.self=ym;var Tm=jt.window||jt.self||jt.global;yt.window=Tm;var Em=jt.global||jt.self||jt.window;yt.global=Em;var vm=jt.document||{};yt.document=vm;var Am=jt.process||{};yt.process=Am;var wm=console;yt.console=wm;var Un={},Bn={},Sm=He.exports;Object.defineProperty(Bn,"__esModule",{value:!0});Bn.default=Im;var Es=Sm(Fn.exports);function Im(n){if(typeof window!="undefined"&&(0,Es.default)(window.process)==="object"&&window.process.type==="renderer"||typeof process!="undefined"&&(0,Es.default)(process.versions)==="object"&&Boolean(process.versions.electron))return!0;var t=(typeof navigator=="undefined"?"undefined":(0,Es.default)(navigator))==="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,e=n||t;return!!(e&&e.indexOf("Electron")>=0)}var xc=He.exports;Object.defineProperty(Un,"__esModule",{value:!0});Un.default=Lc;Un.isBrowserMainThread=Lm;var Pm=xc(Fn.exports),xm=xc(Bn);function Lc(){var n=(typeof process=="undefined"?"undefined":(0,Pm.default)(process))==="object"&&String(process)==="[object process]"&&!process.browser;return!n||(0,xm.default)()}function Lm(){return Lc()&&typeof document!="undefined"}var Bi={},Mc=He.exports;Object.defineProperty(Bi,"__esModule",{value:!0});Bi.isMobile=Om;Bi.default=Cm;var ki=yt,Mm=Mc(Un),Rm=Mc(Bn);function Om(){return typeof ki.window.orientation!="undefined"}function Cm(n){if(!n&&!(0,Mm.default)())return"Node";if((0,Rm.default)(n))return"Electron";var t=typeof navigator!="undefined"?navigator:{},e=n||t.userAgent||"";if(e.indexOf("Edge")>-1)return"Edge";var i=e.indexOf("MSIE ")!==-1,r=e.indexOf("Trident/")!==-1;return i||r?"IE":ki.window.chrome?"Chrome":ki.window.safari?"Safari":ki.window.mozInnerScreenX?"Firefox":"Unknown"}(function(n){var t=He.exports,e=Fn.exports;Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"self",{enumerable:!0,get:function(){return i.self}}),Object.defineProperty(n,"window",{enumerable:!0,get:function(){return i.window}}),Object.defineProperty(n,"global",{enumerable:!0,get:function(){return i.global}}),Object.defineProperty(n,"document",{enumerable:!0,get:function(){return i.document}}),Object.defineProperty(n,"process",{enumerable:!0,get:function(){return i.process}}),Object.defineProperty(n,"console",{enumerable:!0,get:function(){return i.console}}),Object.defineProperty(n,"isBrowser",{enumerable:!0,get:function(){return r.default}}),Object.defineProperty(n,"isBrowserMainThread",{enumerable:!0,get:function(){return r.isBrowserMainThread}}),Object.defineProperty(n,"getBrowser",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(n,"isMobile",{enumerable:!0,get:function(){return s.isMobile}}),Object.defineProperty(n,"isElectron",{enumerable:!0,get:function(){return o.default}});var i=yt,r=c(Un),s=c(Bi),o=t(Bn);function a(l){if(typeof WeakMap!="function")return null;var u=new WeakMap,h=new WeakMap;return(a=function(g){return g?h:u})(l)}function c(l,u){if(!u&&l&&l.__esModule)return l;if(l===null||e(l)!=="object"&&typeof l!="function")return{default:l};var h=a(u);if(h&&h.has(l))return h.get(l);var f={},g=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in l)if(m!=="default"&&Object.prototype.hasOwnProperty.call(l,m)){var _=g?Object.getOwnPropertyDescriptor(l,m):null;_&&(_.get||_.set)?Object.defineProperty(f,m,_):f[m]=l[m]}return f.default=l,h&&h.set(l,f),f}})(Pc);var J=Pc,W=new Ui({id:"deck"});let vs={};function Nm(n){vs=n}function gt(n){W.level>0&&vs[n]&&vs[n].call(...arguments)}function Dm(n){const t=n[0],e=n[n.length-1];return t==="{"&&e==="}"||t==="["&&e==="]"}var Fm={name:"JSON",extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Dm,parseTextSync:JSON.parse};const kn="8.5.10",Vi=J.global.deck&&J.global.deck.VERSION;if(Vi&&Vi!==kn)throw new Error("deck.gl - multiple versions detected: ".concat(Vi," vs ").concat(kn));Vi||(W.log(1,"deck.gl ".concat(kn))(),J.global.deck=Object.assign(J.global.deck||{},{VERSION:kn,version:kn,log:W,_registerLoggers:Nm}),bp([Fm,[Sc,{imagebitmap:{premultiplyAlpha:"none"}}]]));var Um=J.global.deck;const F=new Ui({id:"luma.gl"});function Tt(n,t){if(!n)throw new Error(t||"luma.gl: assertion failed.")}const Bm="Invalid WebGLRenderingContext",km="Requires WebGL2";function zi(n){return typeof WebGLRenderingContext!="undefined"&&n instanceof WebGLRenderingContext||typeof WebGL2RenderingContext!="undefined"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&Number.isFinite(n._version))}function j(n){return typeof WebGL2RenderingContext!="undefined"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function Vm(n){return j(n)?n:null}function ji(n){return Tt(zi(n),Bm),n}function Et(n){return Tt(j(n),km),n}const Vn={};function zm(n){J.global.console&&J.global.console.error&&J.global.console.error(n)}function jm(n){J.global.console&&J.global.console.log&&J.global.console.log(n)}function Gm(n,t){Vn[n]=!0,t!==void 0&&zm(t)}function $m(n){const t=n.getError;n.getError=function(){let i;do i=t.apply(n),i!==0&&(Vn[i]=!0);while(i!==0);for(i in Vn)if(Vn[i])return delete Vn[i],parseInt(i,10);return 0}}const zn=function n(t){const e=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){const r=new n.VertexAttrib(e);this.attribs[i]=r}this.maxAttrib=0};zn.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};zn.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const Re=function(t){const e=this;this.gl=t,$m(t);const i=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(s){return s===e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject===e.defaultVertexArrayObject?null:e.currentVertexArrayObject:i.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(s){const o=e.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,s);const a=o.attribs[s];return a.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(s){const o=e.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,s);const a=o.attribs[s];return a.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(s,o){switch(s){case 34962:e.currentArrayBuffer=o;break;case 34963:e.currentVertexArrayObject.elementArrayBuffer=o;break}return i.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(s,o){const c=e.currentVertexArrayObject.attribs[s];switch(o){case 34975:return c.buffer;case 34338:return c.enabled;case 34339:return c.size;case 34340:return c.stride;case 34341:return c.type;case 34922:return c.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(s,o,a,c,l,u){const h=e.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,s);const f=h.attribs[s];return f.buffer=e.currentArrayBuffer,f.size=o,f.type=a,f.normalized=c,f.stride=l,f.offset=u,f.recache(),i.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas&&t.canvas.addEventListener("webglcontextrestored",()=>{jm("OESVertexArrayObject emulation library context restored"),e.reset_()},!0),this.reset_()};Re.prototype.VERTEX_ARRAY_BINDING_OES=34229;Re.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;const e=this.gl;this.maxVertexAttribs=e.getParameter(34921),this.defaultVertexArrayObject=new zn(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};Re.prototype.createVertexArrayOES=function(){const t=new zn(this);return this.vertexArrayObjects.push(t),t};Re.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject===t&&this.bindVertexArrayOES(null)};Re.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof zn&&t.hasBeenBound&&t.ext===this)};Re.prototype.bindVertexArrayOES=function(t){const e=this.gl;if(t&&!t.isAlive){Gm(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}const i=this.original,r=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const s=this.currentVertexArrayObject;if(r===s)return;(!r||s.elementArrayBuffer!==r.elementArrayBuffer)&&i.bindBuffer.call(e,34963,s.elementArrayBuffer);let o=this.currentArrayBuffer;const a=Math.max(r?r.maxAttrib:0,s.maxAttrib);for(let c=0;c<=a;c++){const l=s.attribs[c],u=r?r.attribs[c]:null;if((!r||l.enabled!==u.enabled)&&(l.enabled?i.enableVertexAttribArray.call(e,c):i.disableVertexAttribArray.call(e,c)),l.enabled){let h=!1;(!r||l.buffer!==u.buffer)&&(o!==l.buffer&&(i.bindBuffer.call(e,34962,l.buffer),o=l.buffer),h=!0),(h||l.cached!==u.cached)&&i.vertexAttribPointer.call(e,c,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!==o&&i.bindBuffer.call(e,34962,this.currentArrayBuffer)};function Hm(n){if(typeof n.createVertexArray=="function")return;const t=n.getSupportedExtensions;n.getSupportedExtensions=function(){const r=t.call(this)||[];return r.indexOf("OES_vertex_array_object")<0&&r.push("OES_vertex_array_object"),r};const e=n.getExtension;n.getExtension=function(r){const s=e.call(this,r);return s||(r!=="OES_vertex_array_object"?null:(n.__OESVertexArrayObject||(this.__OESVertexArrayObject=new Re(this)),this.__OESVertexArrayObject))}}const Rc="OES_element_index",Oc="WEBGL_draw_buffers",Wm="EXT_disjoint_timer_query",qm="EXT_disjoint_timer_query_webgl2",Ym="EXT_texture_filter_anisotropic",Cc="WEBGL_debug_renderer_info",Xm=35723,Zm=4352,Km=36795,Qm=34047,Jm=37445,t_=37446,K=n=>j(n)?void 0:0,e_={[3074]:n=>j(n)?void 0:36064,[Xm]:n=>j(n)?void 0:Zm,[35977]:K,[32937]:K,[Km]:(n,t)=>{const e=j(n)?n.getExtension(qm):n.getExtension(Wm);return e&&e.GPU_DISJOINT_EXT?t(e.GPU_DISJOINT_EXT):0},[Jm]:(n,t)=>{const e=n.getExtension(Cc);return t(e&&e.UNMASKED_VENDOR_WEBGL||7936)},[t_]:(n,t)=>{const e=n.getExtension(Cc);return t(e&&e.UNMASKED_RENDERER_WEBGL||7937)},[Qm]:(n,t)=>{const e=n.luma.extensions[Ym];return e?t(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:K,[35071]:K,[37447]:K,[36063]:(n,t)=>{if(!j(n)){const e=n.getExtension(Oc);return e?t(e.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:K,[35374]:K,[35377]:K,[34852]:n=>{if(!j(n)){const t=n.getExtension(Oc);return t?t.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:n=>n.getExtension(Rc)?2147483647:65535,[33001]:n=>n.getExtension(Rc)?16777216:65535,[33e3]:n=>16777216,[37157]:K,[35373]:K,[35657]:K,[36183]:K,[37137]:K,[34045]:K,[35978]:K,[35979]:K,[35968]:K,[35376]:K,[35375]:K,[35659]:K,[37154]:K,[35371]:K,[35658]:K,[35076]:K,[35077]:K,[35380]:K};function n_(n,t,e){const i=e_[e],r=typeof i=="function"?i(n,t,e):i;return r!==void 0?r:t(e)}const i_="OES_vertex_array_object",Nc="ANGLE_instanced_arrays",r_="WEBGL_draw_buffers",s_="EXT_disjoint_timer_query",o_="EXT_texture_filter_anisotropic",a_="VertexArray requires WebGL2 or OES_vertex_array_object extension";function c_(n,t){return{webgl2:j(n),ext:n.getExtension(t)}}const Dc={[i_]:{meta:{suffix:"OES"},createVertexArray:()=>{Tt(!1,a_)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[Nc]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(n,t){Tt(t===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[r_]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Tt(!1)}},[s_]:{meta:{suffix:"EXT"},createQuery:()=>{Tt(!1)},deleteQuery:()=>{Tt(!1)},beginQuery:()=>{Tt(!1)},endQuery:()=>{},getQuery(n,t){return this.getQueryObject(n,t)},getQueryParameter(n,t){return this.getQueryObject(n,t)},getQueryObject:()=>{}}},As={readBuffer:(n,t,e)=>{j(n)&&t(e)},getVertexAttrib:(n,t,e,i)=>{const{webgl2:r,ext:s}=c_(n,Nc);let o;switch(i){case 35069:o=r?void 0:!1;break;case 35070:o=!r&&!s?0:void 0;break}return o!==void 0?o:t(e,i)},getProgramParameter:(n,t,e,i)=>{if(!j(n))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0}return t(e,i)},getInternalformatParameter:(n,t,e,i,r)=>{if(!j(n))switch(r){case 32937:return new Int32Array([0])}return n.getInternalformatParameter(e,i,r)},getTexParameter(n,t,e,i){switch(i){case 34046:const{extensions:r}=n.luma,s=r[o_];i=s&&s.TEXTURE_MAX_ANISOTROPY_EXT||34046;break}return t(e,i)},getParameter:n_,hint(n,t,e,i){return t(e,i)}};function l_(n){n.luma=n.luma||{};const{luma:t}=n;return t.polyfilled||(Hm(n),h_(n),d_(n,Dc),f_(n,{target:t,target2:n}),t.polyfilled=!0),n}const u_=typeof global!="undefined"?global:window;u_.polyfillContext=l_;function h_(n){n.luma.extensions={};const t=n.getSupportedExtensions()||[];for(const e of t)n.luma[e]=n.getExtension(e)}function f_(n,{target:t,target2:e}){Object.keys(As).forEach(i=>{if(typeof As[i]=="function"){const r=n[i]?n[i].bind(n):()=>{},s=As[i].bind(null,n,r);t[i]=s,e[i]=s}})}function d_(n,t){for(const e of Object.getOwnPropertyNames(t))e!=="overrides"&&g_(n,{extension:e,target:n.luma,target2:n})}function g_(n,{extension:t,target:e,target2:i}){const r=Dc[t];Tt(r);const{meta:s={}}=r,{suffix:o=""}=s,a=n.getExtension(t);for(const c of Object.keys(r)){const l=`${c}${o}`;let u=null;c==="meta"||typeof n[c]=="function"||(a&&typeof a[l]=="function"?u=(...h)=>a[l](...h):typeof r[c]=="function"&&(u=r[c].bind(e))),u&&(e[c]=u,i[c]=u)}}const ws={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},Te=(n,t,e)=>t?n.enable(e):n.disable(e),Fc=(n,t,e)=>n.hint(e,t),St=(n,t,e)=>n.pixelStorei(e,t),p_=(n,t)=>{const e=j(n)?36009:36160;return n.bindFramebuffer(e,t)},m_=(n,t)=>n.bindFramebuffer(36008,t);function jn(n){return Array.isArray(n)||ArrayBuffer.isView(n)}const __={[3042]:Te,[32773]:(n,t)=>n.blendColor(...t),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(n,t)=>n.clearColor(...t),[3107]:(n,t)=>n.colorMask(...t),[2884]:Te,[2885]:(n,t)=>n.cullFace(t),[2929]:Te,[2931]:(n,t)=>n.clearDepth(t),[2932]:(n,t)=>n.depthFunc(t),[2928]:(n,t)=>n.depthRange(...t),[2930]:(n,t)=>n.depthMask(t),[3024]:Te,[35723]:Fc,[36006]:p_,[2886]:(n,t)=>n.frontFace(t),[33170]:Fc,[2849]:(n,t)=>n.lineWidth(t),[32823]:Te,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:Te,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:Te,[3088]:(n,t)=>n.scissor(...t),[2960]:Te,[2961]:(n,t)=>n.clearStencil(t),[2968]:(n,t)=>n.stencilMaskSeparate(1028,t),[36005]:(n,t)=>n.stencilMaskSeparate(1029,t),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(n,t)=>n.viewport(...t),[3333]:St,[3317]:St,[37440]:St,[37441]:St,[37443]:St,[3330]:St,[3332]:St,[3331]:St,[36010]:m_,[3314]:St,[32878]:St,[3316]:St,[3315]:St,[32877]:St,framebuffer:(n,t)=>{const e=t&&"handle"in t?t.handle:t;return n.bindFramebuffer(36160,e)},blend:(n,t)=>t?n.enable(3042):n.disable(3042),blendColor:(n,t)=>n.blendColor(...t),blendEquation:(n,t)=>{t=jn(t)?t:[t,t],n.blendEquationSeparate(...t)},blendFunc:(n,t)=>{t=jn(t)&&t.length===2?[...t,...t]:t,n.blendFuncSeparate(...t)},clearColor:(n,t)=>n.clearColor(...t),clearDepth:(n,t)=>n.clearDepth(t),clearStencil:(n,t)=>n.clearStencil(t),colorMask:(n,t)=>n.colorMask(...t),cull:(n,t)=>t?n.enable(2884):n.disable(2884),cullFace:(n,t)=>n.cullFace(t),depthTest:(n,t)=>t?n.enable(2929):n.disable(2929),depthFunc:(n,t)=>n.depthFunc(t),depthMask:(n,t)=>n.depthMask(t),depthRange:(n,t)=>n.depthRange(...t),dither:(n,t)=>t?n.enable(3024):n.disable(3024),derivativeHint:(n,t)=>{n.hint(35723,t)},frontFace:(n,t)=>n.frontFace(t),mipmapHint:(n,t)=>n.hint(33170,t),lineWidth:(n,t)=>n.lineWidth(t),polygonOffsetFill:(n,t)=>t?n.enable(32823):n.disable(32823),polygonOffset:(n,t)=>n.polygonOffset(...t),sampleCoverage:(n,t)=>n.sampleCoverage(...t),scissorTest:(n,t)=>t?n.enable(3089):n.disable(3089),scissor:(n,t)=>n.scissor(...t),stencilTest:(n,t)=>t?n.enable(2960):n.disable(2960),stencilMask:(n,t)=>{t=jn(t)?t:[t,t];const[e,i]=t;n.stencilMaskSeparate(1028,e),n.stencilMaskSeparate(1029,i)},stencilFunc:(n,t)=>{t=jn(t)&&t.length===3?[...t,...t]:t;const[e,i,r,s,o,a]=t;n.stencilFuncSeparate(1028,e,i,r),n.stencilFuncSeparate(1029,s,o,a)},stencilOp:(n,t)=>{t=jn(t)&&t.length===3?[...t,...t]:t;const[e,i,r,s,o,a]=t;n.stencilOpSeparate(1028,e,i,r),n.stencilOpSeparate(1029,s,o,a)},viewport:(n,t)=>n.viewport(...t)};function it(n,t,e){return t[n]!==void 0?t[n]:e[n]}const b_={blendEquation:(n,t,e)=>n.blendEquationSeparate(it(32777,t,e),it(34877,t,e)),blendFunc:(n,t,e)=>n.blendFuncSeparate(it(32969,t,e),it(32968,t,e),it(32971,t,e),it(32970,t,e)),polygonOffset:(n,t,e)=>n.polygonOffset(it(32824,t,e),it(10752,t,e)),sampleCoverage:(n,t,e)=>n.sampleCoverage(it(32938,t,e),it(32939,t,e)),stencilFuncFront:(n,t,e)=>n.stencilFuncSeparate(1028,it(2962,t,e),it(2967,t,e),it(2963,t,e)),stencilFuncBack:(n,t,e)=>n.stencilFuncSeparate(1029,it(34816,t,e),it(36003,t,e),it(36004,t,e)),stencilOpFront:(n,t,e)=>n.stencilOpSeparate(1028,it(2964,t,e),it(2965,t,e),it(2966,t,e)),stencilOpBack:(n,t,e)=>n.stencilOpSeparate(1029,it(34817,t,e),it(34818,t,e),it(34819,t,e))},Uc={enable:(n,t)=>n({[t]:!0}),disable:(n,t)=>n({[t]:!1}),pixelStorei:(n,t,e)=>n({[t]:e}),hint:(n,t,e)=>n({[t]:e}),bindFramebuffer:(n,t,e)=>{switch(t){case 36160:return n({[36006]:e,[36010]:e});case 36009:return n({[36006]:e});case 36008:return n({[36010]:e});default:return null}},blendColor:(n,t,e,i,r)=>n({[32773]:new Float32Array([t,e,i,r])}),blendEquation:(n,t)=>n({[32777]:t,[34877]:t}),blendEquationSeparate:(n,t,e)=>n({[32777]:t,[34877]:e}),blendFunc:(n,t,e)=>n({[32969]:t,[32968]:e,[32971]:t,[32970]:e}),blendFuncSeparate:(n,t,e,i,r)=>n({[32969]:t,[32968]:e,[32971]:i,[32970]:r}),clearColor:(n,t,e,i,r)=>n({[3106]:new Float32Array([t,e,i,r])}),clearDepth:(n,t)=>n({[2931]:t}),clearStencil:(n,t)=>n({[2961]:t}),colorMask:(n,t,e,i,r)=>n({[3107]:[t,e,i,r]}),cullFace:(n,t)=>n({[2885]:t}),depthFunc:(n,t)=>n({[2932]:t}),depthRange:(n,t,e)=>n({[2928]:new Float32Array([t,e])}),depthMask:(n,t)=>n({[2930]:t}),frontFace:(n,t)=>n({[2886]:t}),lineWidth:(n,t)=>n({[2849]:t}),polygonOffset:(n,t,e)=>n({[32824]:t,[10752]:e}),sampleCoverage:(n,t,e)=>n({[32938]:t,[32939]:e}),scissor:(n,t,e,i,r)=>n({[3088]:new Int32Array([t,e,i,r])}),stencilMask:(n,t)=>n({[2968]:t,[36005]:t}),stencilMaskSeparate:(n,t,e)=>n({[t===1028?2968:36005]:e}),stencilFunc:(n,t,e,i)=>n({[2962]:t,[2967]:e,[2963]:i,[34816]:t,[36003]:e,[36004]:i}),stencilFuncSeparate:(n,t,e,i,r)=>n({[t===1028?2962:34816]:e,[t===1028?2967:36003]:i,[t===1028?2963:36004]:r}),stencilOp:(n,t,e,i)=>n({[2964]:t,[2965]:e,[2966]:i,[34817]:t,[34818]:e,[34819]:i}),stencilOpSeparate:(n,t,e,i,r)=>n({[t===1028?2964:34817]:e,[t===1028?2965:34818]:i,[t===1028?2966:34819]:r}),viewport:(n,t,e,i,r)=>n({[2978]:[t,e,i,r]})},ee=(n,t)=>n.isEnabled(t),Bc={[3042]:ee,[2884]:ee,[2929]:ee,[3024]:ee,[32823]:ee,[32926]:ee,[32928]:ee,[3089]:ee,[2960]:ee,[35977]:ee};function kc(n){for(const t in n)return!1;return!0}function y_(n,t){if(n===t)return!0;const e=Array.isArray(n)||ArrayBuffer.isView(n),i=Array.isArray(t)||ArrayBuffer.isView(t);if(e&&i&&n.length===t.length){for(let r=0;r<n.length;++r)if(n[r]!==t[r])return!1;return!0}return!1}function Vc(n,t){const e=n[t].bind(n);n[t]=function(...r){const s=r[0];return s in n.state.cache?n.state.enable?n.state.cache[s]:e(...r):e(...r)},Object.defineProperty(n[t],"name",{value:`${t}-from-cache`,configurable:!1})}function T_(n,t,e){const i=n[t].bind(n);n[t]=function(...s){const{valueChanged:o,oldValue:a}=e(n.state._updateCache,...s);return o&&i(...s),a},Object.defineProperty(n[t],"name",{value:`${t}-to-cache`,configurable:!1})}function E_(n){const t=n.useProgram.bind(n);n.useProgram=function(i){n.state.program!==i&&(t(i),n.state.program=i)}}class v_{constructor(t,{copyState:e=!1,log:i=()=>{}}={}){this.gl=t,this.program=null,this.stateStack=[],this.enable=!0,this.cache=e?w_(t):Object.assign({},ws),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(t={}){this.stateStack.push({})}pop(){Tt(this.stateStack.length>0);const t=this.stateStack[this.stateStack.length-1];ue(this.gl,t),this.stateStack.pop()}_updateCache(t){let e=!1,i;const r=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const s in t){Tt(s!==void 0);const o=t[s],a=this.cache[s];y_(o,a)||(e=!0,i=a,r&&!(s in r)&&(r[s]=a),this.cache[s]=o)}return{valueChanged:e,oldValue:i}}}function zc(n,t={}){const{enable:e=!0,copyState:i}=t;if(Tt(i!==void 0),!n.state){const r=typeof global!="undefined"?global:window,{polyfillContext:s}=r;s&&s(n),n.state=new v_(n,{copyState:i}),E_(n);for(const o in Uc){const a=Uc[o];T_(n,o,a)}Vc(n,"getParameter"),Vc(n,"isEnabled")}return n.state.enable=e,n}function A_(n){n.state||zc(n,{copyState:!1}),n.state.push()}function jc(n){Tt(n.state),n.state.pop()}function ue(n,t){if(Tt(zi(n),"setParameters requires a WebGL context"),kc(t))return;const e={};for(const r in t){const s=Number(r),o=__[r];o&&(typeof o=="string"?e[o]=!0:o(n,t[r],s))}const i=n.state&&n.state.cache;if(i)for(const r in e)b_[r](n,t,i)}function w_(n,t){if(t=t||ws,typeof t=="number"){const r=t,s=Bc[r];return s?s(n,r):n.getParameter(r)}const e=Array.isArray(t)?t:Object.keys(t),i={};for(const r of e){const s=Bc[r];i[r]=s?s(n,Number(r)):n.getParameter(Number(r))}return i}function S_(n){ue(n,ws)}function Gt(n,t,e){if(kc(t))return e(n);const{nocatch:i=!0}=t;A_(n),ue(n,t);let r;if(i)r=e(n),jc(n);else try{r=e(n)}finally{jc(n)}return r}function We(n){const{luma:t}=n;if(n.canvas&&t){const{clientWidth:e}=t.canvasSizeInfo;return e?n.drawingBufferWidth/e:1}return 1}function Ss(n,t,e=!0){const i=We(n),r=n.drawingBufferWidth,s=n.drawingBufferHeight;return P_(t,i,r,s,e)}function I_(n){const t=typeof window=="undefined"?1:window.devicePixelRatio||1;return Number.isFinite(n)?n<=0?1:n:n?t:1}function P_(n,t,e,i,r){const s=Gc(n[0],t,e);let o=$c(n[1],t,i,r),a=Gc(n[0]+1,t,e);const c=a===e-1?a:a-1;a=$c(n[1]+1,t,i,r);let l;return r?(a=a===0?a:a+1,l=o,o=a):l=a===i-1?a:a-1,{x:s,y:o,width:Math.max(c-s+1,1),height:Math.max(l-o+1,1)}}function Gc(n,t,e){return Math.min(Math.round(n*t),e-1)}function $c(n,t,e,i){return i?Math.max(0,e-1-Math.round(n*t)):Math.min(Math.round(n*t),e-1)}const Is=J.isBrowser(),x_=Is&&typeof document!="undefined",Hc={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function Wc(n={}){Tt(Is,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),n=Object.assign({},Hc,n);const{width:t,height:e}=n;function i(a){if(n.throwOnError)throw new Error(a);return console.error(a),null}n.onError=i;let r;const{canvas:s}=n,o=O_({canvas:s,width:t,height:e,onError:i});return r=R_(o,n),r?(r=Ps(r,n),C_(r),r):null}function Ps(n,t={}){if(!n||n._instrumented)return n;n._version=n._version||N_(n),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{},t=Object.assign({},Hc,t);const{manageState:e,debug:i}=t;return e&&zc(n,{copyState:!1,log:(...r)=>F.log(1,...r)()}),Is&&i&&(J.global.makeDebugContext?(n=J.global.makeDebugContext(n,t),F.level=Math.max(F.level,1)):F.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),n._instrumented=!0,n}function L_(n){const t=n.getParameter(7936),e=n.getParameter(7937),i=n.getExtension("WEBGL_debug_renderer_info"),r=i&&n.getParameter(i.UNMASKED_VENDOR_WEBGL||7936),s=i&&n.getParameter(i.UNMASKED_RENDERER_WEBGL||7937);return{vendor:r||t,renderer:s||e,vendorMasked:t,rendererMasked:e,version:n.getParameter(7938),shadingLanguageVersion:n.getParameter(35724)}}function M_(n,t={}){if(n.canvas){const i=I_(t.useDevicePixels);D_(n,i,t);return}const e=n.getExtension("STACKGL_resize_drawingbuffer");e&&"width"in t&&"height"in t&&e.resize(t.width,t.height)}function R_(n,t){const{onError:e}=t;let i=null;const r=c=>i=c.statusMessage||i;n.addEventListener("webglcontextcreationerror",r,!1);const{webgl1:s=!0,webgl2:o=!0}=t;let a=null;return o&&(a=a||n.getContext("webgl2",t),a=a||n.getContext("experimental-webgl2",t)),s&&(a=a||n.getContext("webgl",t),a=a||n.getContext("experimental-webgl",t)),n.removeEventListener("webglcontextcreationerror",r,!1),a?(t.onContextLost&&n.addEventListener("webglcontextlost",t.onContextLost,!1),t.onContextRestored&&n.addEventListener("webglcontextrestored",t.onContextRestored,!1),a):e(`Failed to create ${o&&!s?"WebGL2":"WebGL"} context: ${i||"Unknown error"}`)}function O_({canvas:n,width:t=800,height:e=600,onError:i}){let r;return typeof n=="string"?(x_&&document.readyState==="complete"||i(`createGLContext called on canvas '${n}' before page was loaded`),r=document.getElementById(n)):n?r=n:(r=document.createElement("canvas"),r.id="lumagl-canvas",r.style.width=Number.isFinite(t)?`${t}px`:"100%",r.style.height=Number.isFinite(e)?`${e}px`:"100%",document.body.insertBefore(r,document.body.firstChild)),r}function C_(n){const t=j(n)?"WebGL2":"WebGL1",e=L_(n),i=e?`(${e.vendor},${e.renderer})`:"",r=n.debug?" debug":"";F.info(1,`${t}${r} context ${i}`)()}function N_(n){return typeof WebGL2RenderingContext!="undefined"&&n instanceof WebGL2RenderingContext?2:1}function D_(n,t,e){let i="width"in e?e.width:n.canvas.clientWidth,r="height"in e?e.height:n.canvas.clientHeight;(!i||!r)&&(F.log(1,"Canvas clientWidth/clientHeight is 0")(),t=1,i=n.canvas.width||1,r=n.canvas.height||1),n.luma=n.luma||{},n.luma.canvasSizeInfo=n.luma.canvasSizeInfo||{};const s=n.luma.canvasSizeInfo;if(s.clientWidth!==i||s.clientHeight!==r||s.devicePixelRatio!==t){let o=t;const a=Math.floor(i*o),c=Math.floor(r*o);n.canvas.width=a,n.canvas.height=c,(n.drawingBufferWidth!==a||n.drawingBufferHeight!==c)&&(F.warn("Device pixel ratio clamped")(),o=Math.min(n.drawingBufferWidth/i,n.drawingBufferHeight/r),n.canvas.width=Math.floor(i*o),n.canvas.height=Math.floor(r*o)),Object.assign(n.luma.canvasSizeInfo,{clientWidth:i,clientHeight:r,devicePixelRatio:t})}}const Gn="8.5.10",F_="set luma.log.level=1 (or higher) to trace rendering";class U_{constructor(){this.stats=new Map}get(t){return this.stats.has(t)||this.stats.set(t,new Ln({id:t})),this.stats.get(t)}}const Oe=new U_;if(J.global.luma&&J.global.luma.VERSION!==Gn)throw new Error(`luma.gl - multiple VERSIONs detected: ${J.global.luma.VERSION} vs ${Gn}`);J.global.luma||(J.isBrowser()&&F.log(1,`luma.gl ${Gn} - ${F_}`)(),J.global.luma=J.global.luma||{VERSION:Gn,version:Gn,log:F,stats:Oe,globals:{modules:{},nodeIO:{}}});J.global.luma;function B_(n){return typeof window!="undefined"&&window.requestAnimationFrame?window.requestAnimationFrame(n):setTimeout(n,1e3/60)}function k_(n){return typeof window!="undefined"&&window.cancelAnimationFrame?window.cancelAnimationFrame(n):clearTimeout(n)}function O(n,t){if(!n)throw new Error(t||"luma.gl: assertion failed.")}function xs(n,t){if(typeof t!="string")return t;const e=Number(t);if(!isNaN(e))return e;t=t.replace(/^.*\./,"");const i=n[t];return O(i!==void 0,`Accessing undefined constant GL.${t}`),i}function Ee(n,t){t=Number(t);for(const e in n)if(n[e]===t)return`GL.${e}`;return String(t)}const Ls={};function he(n="id"){Ls[n]=Ls[n]||1;const t=Ls[n]++;return`${n}-${t}`}function qc(n){return O(typeof n=="number","Input must be a number"),n&&(n&n-1)==0}function qe(n){let t=!0;for(const e in n){t=!1;break}return t}function Yc(n,t,e,i){const r=`See luma.gl ${e} Upgrade Guide at https://luma.gl/docs/upgrade-guide`,s=Object.getPrototypeOf(n);i.forEach(o=>{s.methodName||(s[o]=()=>{throw F.removed(`Calling removed method ${t}.${o}: `,r)(),new Error(o)})})}const Ye="Resource subclass must define virtual methods";class fe{constructor(t,e={}){ji(t);const{id:i,userData:r={}}=e;this.gl=t,this.gl2=t,this.id=i||he(this.constructor.name),this.userData=r,this._bound=!1,this._handle=e.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return`${this.constructor.name}(${this.id})`}get handle(){return this._handle}delete({deleteChildren:t=!1}={}){const e=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,e&&t&&e.filter(Boolean).forEach(i=>i.delete()),this}bind(t=this.handle){if(typeof t!="function")return this._bindHandle(t),this;let e;return this._bound?e=t():(this._bindHandle(this.handle),this._bound=!0,e=t(),this._bound=!1,this._bindHandle(null)),e}unbind(){this.bind(null)}getParameter(t,e={}){t=xs(this.gl,t),O(t);const r=(this.constructor.PARAMETERS||{})[t];if(r){const s=j(this.gl);if(!((!("webgl2"in r)||s)&&(!("extension"in r)||this.gl.getExtension(r.extension)))){const a=r.webgl1,c="webgl2"in r?r.webgl2:r.webgl1;return s?c:a}}return this._getParameter(t,e)}getParameters(t={}){const{parameters:e,keys:i}=t,r=this.constructor.PARAMETERS||{},s=j(this.gl),o={},a=e||Object.keys(r);for(const c of a){const l=r[c];if(l&&(!("webgl2"in l)||s)&&(!("extension"in l)||this.gl.getExtension(l.extension))){const h=i?Ee(this.gl,c):c;o[h]=this.getParameter(c,t),i&&l.type==="GLenum"&&(o[h]=Ee(this.gl,o[h]))}}return o}setParameter(t,e){t=xs(this.gl,t),O(t);const r=(this.constructor.PARAMETERS||{})[t];if(r){const s=j(this.gl);if(!((!("webgl2"in r)||s)&&(!("extension"in r)||this.gl.getExtension(r.extension))))throw new Error("Parameter not available on this platform");r.type==="GLenum"&&(e=xs(e))}return this._setParameter(t,e),this}setParameters(t){for(const e in t)this.setParameter(e,t[e]);return this}stubRemovedMethods(t,e,i){return Yc(this,t,e,i)}initialize(t){}_createHandle(){throw new Error(Ye)}_deleteHandle(){throw new Error(Ye)}_bindHandle(t){throw new Error(Ye)}_getOptsFromHandle(){throw new Error(Ye)}_getParameter(t,e){throw new Error(Ye)}_setParameter(t,e){throw new Error(Ye)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const t=this.constructor.name,e=Oe.get("Resource Counts");e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}_removeStats(){const t=this.constructor.name;Oe.get("Resource Counts").get(`${t}s Active`).decrementCount()}_trackAllocatedMemory(t,e=this.constructor.name){const i=Oe.get("Memory Usage");i.get("GPU Memory").addCount(t),i.get(`${e} Memory`).addCount(t),this.byteLength=t}_trackDeallocatedMemory(t=this.constructor.name){const e=Oe.get("Memory Usage");e.get("GPU Memory").subtractCount(this.byteLength),e.get(`${t} Memory`).subtractCount(this.byteLength),this.byteLength=0}}const V_="Failed to deduce GL constant from typed array";function Ms(n){switch(ArrayBuffer.isView(n)?n.constructor:n){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(V_)}}function $n(n,{clamped:t=!0}={}){switch(n){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function z_({data:n,width:t,height:e,bytesPerPixel:i=4,temp:r}){const s=t*i;r=r||new Uint8Array(s);for(let o=0;o<e/2;++o){const a=o*s,c=(e-o-1)*s;r.set(n.subarray(a,a+s)),n.copyWithin(a,c,c+s),n.set(r,c)}}function j_({data:n,width:t,height:e}){const i=Math.round(t/2),r=Math.round(e/2),s=new Uint8Array(i*r*4);for(let o=0;o<r;o++)for(let a=0;a<i;a++)for(let c=0;c<4;c++)s[(o*i+a)*4+c]=n[(o*2*t+a*2)*4+c];return{data:s,width:i,height:r}}function Rs(n,t,e){const{removedProps:i={},deprecatedProps:r={},replacedProps:s={}}=e;for(const a in i)if(a in t){const l=i[a]?`${n}.${i[a]}`:"N/A";F.removed(`${n}.${a}`,l)()}for(const a in r)if(a in t){const c=r[a];F.deprecated(`${n}.${a}`,`${n}.${c}`)()}let o=null;for(const a in s)if(a in t){const c=s[a];F.deprecated(`${n}.${a}`,`${n}.${c}`)(),o=o||Object.assign({},t),o[c]=t[a],delete o[a]}return o||t}const G_={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},$_={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class At{static getBytesPerElement(t){return $n(t.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(t){return O(t.size),$n(t.type||5126).BYTES_PER_ELEMENT*t.size}static resolve(...t){return new At(...[G_,...t])}constructor(...t){t.forEach(e=>this._assign(e)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return At.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return At.getBytesPerVertex(this)}_assign(t={}){return t=Rs("Accessor",t,$_),t.type!==void 0&&(this.type=t.type,(t.type===5124||t.type===5125)&&(this.integer=!0)),t.size!==void 0&&(this.size=t.size),t.offset!==void 0&&(this.offset=t.offset),t.stride!==void 0&&(this.stride=t.stride),t.normalized!==void 0&&(this.normalized=t.normalized),t.integer!==void 0&&(this.integer=t.integer),t.divisor!==void 0&&(this.divisor=t.divisor),t.buffer!==void 0&&(this.buffer=t.buffer),t.index!==void 0&&(typeof t.index=="boolean"?this.index=t.index?1:0:this.index=t.index),t.instanced!==void 0&&(this.divisor=t.instanced?1:0),t.isInstanced!==void 0&&(this.divisor=t.isInstanced?1:0),this}}const Xc=10,Zc={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},H_={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:Zc},W_={removedProps:Zc};class X extends fe{constructor(t,e={}){super(t,e);this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=e.target||(this.gl.webgl2?36662:34962),this.initialize(e),Object.seal(this)}getElementCount(t=this.accessor){return Math.round(this.byteLength/At.getBytesPerElement(t))}getVertexCount(t=this.accessor){return Math.round(this.byteLength/At.getBytesPerVertex(t))}initialize(t={}){return ArrayBuffer.isView(t)&&(t={data:t}),Number.isFinite(t)&&(t={byteLength:t}),t=Rs("Buffer",t,H_),this.usage=t.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},t,t.accessor)),t.data?this._setData(t.data,t.offset,t.byteLength):this._setByteLength(t.byteLength||0),this}setProps(t){return t=Rs("Buffer",t,W_),"accessor"in t&&this.setAccessor(t.accessor),this}setAccessor(t){return t=Object.assign({},t),delete t.buffer,this.accessor=new At(t),this}reallocate(t){return t>this.byteLength?(this._setByteLength(t),!0):(this.bytesUsed=t,!1)}setData(t){return this.initialize(t)}subData(t){ArrayBuffer.isView(t)&&(t={data:t});const{data:e,offset:i=0,srcOffset:r=0}=t,s=t.byteLength||t.length;O(e);const o=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(o,this.handle),r!==0||s!==void 0?(Et(this.gl),this.gl.bufferSubData(this.target,i,e,r,s)):this.gl.bufferSubData(o,i,e),this.gl.bindBuffer(o,null),this.debugData=null,this._inferType(e),this}copyData({sourceBuffer:t,readOffset:e=0,writeOffset:i=0,size:r}){const{gl:s}=this;return Et(s),s.bindBuffer(36662,t.handle),s.bindBuffer(36663,this.handle),s.copyBufferSubData(36662,36663,e,i,r),s.bindBuffer(36662,null),s.bindBuffer(36663,null),this.debugData=null,this}getData({dstData:t=null,srcByteOffset:e=0,dstOffset:i=0,length:r=0}={}){Et(this.gl);const s=$n(this.accessor.type||5126,{clamped:!1}),o=this._getAvailableElementCount(e),a=i;let c,l;t?(l=t.length,c=l-a):(c=Math.min(o,r||o),l=a+c);const u=Math.min(o,c);return r=r||u,O(r<=u),t=t||new s(l),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,t,i,r),this.gl.bindBuffer(36662,null),t}bind({target:t=this.target,index:e=this.accessor&&this.accessor.index,offset:i=0,size:r}={}){return t===35345||t===35982?r!==void 0?this.gl.bindBufferRange(t,e,this.handle,i,r):(O(i===0),this.gl.bindBufferBase(t,e,this.handle)):this.gl.bindBuffer(t,this.handle),this}unbind({target:t=this.target,index:e=this.accessor&&this.accessor.index}={}){return t===35345||t===35982?this.gl.bindBufferBase(t,e,null):this.gl.bindBuffer(t,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(Xc,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(t,e=0,i=t.byteLength+e){O(ArrayBuffer.isView(t)),this._trackDeallocatedMemory();const r=this._getTarget();this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,i,this.usage),this.gl.bufferSubData(r,e,t),this.gl.bindBuffer(r,null),this.debugData=t.slice(0,Xc),this.bytesUsed=i,this._trackAllocatedMemory(i);const s=Ms(t);return O(s),this.setAccessor(new At(this.accessor,{type:s})),this}_setByteLength(t,e=this.usage){O(t>=0),this._trackDeallocatedMemory();let i=t;t===0&&(i=new Float32Array(0));const r=this._getTarget();return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,i,e),this.gl.bindBuffer(r,null),this.usage=e,this.debugData=null,this.bytesUsed=t,this._trackAllocatedMemory(t),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(t){const e=$n(this.accessor.type||5126,{clamped:!1}),i=t/e.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(t){this.accessor.type||this.setAccessor(new At(this.accessor,{type:Ms(t)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(t){this.gl.bindBuffer(this.target,this.handle);const e=this.gl.getBufferParameter(this.target,t);return this.gl.bindBuffer(this.target,null),e}get type(){return F.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return F.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(t){return F.deprecated("setByteLength","reallocate")(),this.reallocate(t)}updateAccessor(t){return F.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new At(this.accessor,t),this}}const Os={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},Kc={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},Qc={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function q_(n,t){const e=Os[t];if(!e)return!1;if(e.gl1===void 0&&e.gl2===void 0)return!0;const i=j(n)&&e.gl2||e.gl1;return typeof i=="string"?n.getExtension(i):i}function Y_(n,t){const e=Os[t];switch(e&&e.types[0]){case 5126:return n.getExtension("OES_texture_float_linear");case 5131:return n.getExtension("OES_texture_half_float_linear");default:return!0}}const X_=[9729,9728],Jc=J.global.WebGLBuffer||function(){};class Xe extends fe{static isSupported(t,e={}){const{format:i,linearFiltering:r}=e;let s=!0;return i&&(s=s&&q_(t,i),s=s&&(!r||Y_(t,i))),s}constructor(t,e){const{id:i=he("texture"),handle:r,target:s}=e;super(t,{id:i,handle:r});this.target=s,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return`Texture(${this.id},${this.width}x${this.height})`}initialize(t={}){let e=t.data;if(e instanceof Promise)return e.then(S=>this.initialize(Object.assign({},t,{pixels:S,data:S}))),this;const i=typeof HTMLVideoElement!="undefined"&&e instanceof HTMLVideoElement;if(i&&e.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,e.addEventListener("loadeddata",()=>this.initialize(t)),this;const{pixels:r=null,format:s=6408,border:o=0,recreate:a=!1,parameters:c={},pixelStore:l={},textureUnit:u=void 0}=t;e||(e=r);let{width:h,height:f,dataFormat:g,type:m,compressed:_=!1,mipmaps:T=!0}=t;const{depth:v=0}=t;return{width:h,height:f,compressed:_,dataFormat:g,type:m}=this._deduceParameters({format:s,type:m,dataFormat:g,compressed:_,data:e,width:h,height:f}),this.width=h,this.height=f,this.depth=v,this.format=s,this.type=m,this.dataFormat=g,this.border=o,this.textureUnit=u,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),T&&this._isNPOT()&&(F.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),T=!1,this._updateForNPOT(c)),this.mipmaps=T,this.setImageData({data:e,width:h,height:f,depth:v,format:s,type:m,dataFormat:g,border:o,mipmaps:T,parameters:l,compressed:_}),T&&this.generateMipmap(),this.setParameters(c),a&&(this.data=e),i&&(this._video={video:e,parameters:c,lastTime:e.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?e.currentTime:-1}),this}update(){if(this._video){const{video:t,parameters:e,lastTime:i}=this._video;if(i===t.currentTime||t.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:t,parameters:e}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=t.currentTime}}resize({height:t,width:e,mipmaps:i=!1}){return e!==this.width||t!==this.height?this.initialize({width:e,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(t={}){return this._isNPOT()?(F.warn(`texture: ${this} is Non-Power-Of-Two, disabling mipmaping`)(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Gt(this.gl,t,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(t){this._trackDeallocatedMemory("Texture");const{target:e=this.target,pixels:i=null,level:r=0,format:s=this.format,border:o=this.border,offset:a=0,parameters:c={}}=t;let{data:l=null,type:u=this.type,width:h=this.width,height:f=this.height,dataFormat:g=this.dataFormat,compressed:m=!1}=t;l||(l=i),{type:u,dataFormat:g,compressed:m,width:h,height:f}=this._deduceParameters({format:s,type:u,dataFormat:g,compressed:m,data:l,width:h,height:f});const{gl:_}=this;_.bindTexture(this.target,this.handle);let T=null;({data:l,dataType:T}=this._getDataType({data:l,compressed:m}));let v;if(Gt(this.gl,c,()=>{switch(T){case"null":_.texImage2D(e,r,s,h,f,o,g,u,l);break;case"typed-array":_.texImage2D(e,r,s,h,f,o,g,u,l,a);break;case"buffer":v=Et(_),v.bindBuffer(35052,l.handle||l),v.texImage2D(e,r,s,h,f,o,g,u,a),v.bindBuffer(35052,null);break;case"browser-object":j(_)?_.texImage2D(e,r,s,h,f,o,g,u,l):_.texImage2D(e,r,s,g,u,l);break;case"compressed":for(const[S,y]of l.entries())_.compressedTexImage2D(e,S,y.format,y.width,y.height,o,y.data);break;default:O(!1,"Unknown image data type")}}),l&&l.byteLength)this._trackAllocatedMemory(l.byteLength,"Texture");else{const S=Kc[this.dataFormat]||4,y=Qc[this.type]||1;this._trackAllocatedMemory(this.width*this.height*S*y,"Texture")}return this.loaded=!0,this}setSubImageData({target:t=this.target,pixels:e=null,data:i=null,x:r=0,y:s=0,width:o=this.width,height:a=this.height,level:c=0,format:l=this.format,type:u=this.type,dataFormat:h=this.dataFormat,compressed:f=!1,offset:g=0,border:m=this.border,parameters:_={}}){if({type:u,dataFormat:h,compressed:f,width:o,height:a}=this._deduceParameters({format:l,type:u,dataFormat:h,compressed:f,data:i,width:o,height:a}),O(this.depth===0,"texSubImage not supported for 3D textures"),i||(i=e),i&&i.data){const T=i;i=T.data,o=T.shape[0],a=T.shape[1]}i instanceof X&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),Gt(this.gl,_,()=>{if(f)this.gl.compressedTexSubImage2D(t,c,r,s,o,a,l,i);else if(i===null)this.gl.texSubImage2D(t,c,r,s,o,a,h,u,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(t,c,r,s,o,a,h,u,i,g);else if(i instanceof Jc){const T=Et(this.gl);T.bindBuffer(35052,i),T.texSubImage2D(t,c,r,s,o,a,h,u,g),T.bindBuffer(35052,null)}else j(this.gl)?Et(this.gl).texSubImage2D(t,c,r,s,o,a,h,u,i):this.gl.texSubImage2D(t,c,r,s,h,u,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(t={}){return F.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t=this.textureUnit){const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,this.handle),t}unbind(t=this.textureUnit){const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,null),t}_getDataType({data:t,compressed:e=!1}){return e?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof X?{data:t.handle,dataType:"buffer"}:t instanceof Jc?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(t){const{format:e,data:i}=t;let{width:r,height:s,dataFormat:o,type:a,compressed:c}=t;const l=Os[e];return o=o||l&&l.dataFormat,a=a||l&&l.types[0],c=c||l&&l.compressed,{width:r,height:s}=this._deduceImageSize(i,r,s),{dataFormat:o,type:a,compressed:c,width:r,height:s,format:e,data:i}}_deduceImageSize(t,e,i){let r;return typeof ImageData!="undefined"&&t instanceof ImageData?r={width:t.width,height:t.height}:typeof HTMLImageElement!="undefined"&&t instanceof HTMLImageElement?r={width:t.naturalWidth,height:t.naturalHeight}:typeof HTMLCanvasElement!="undefined"&&t instanceof HTMLCanvasElement?r={width:t.width,height:t.height}:typeof ImageBitmap!="undefined"&&t instanceof ImageBitmap?r={width:t.width,height:t.height}:typeof HTMLVideoElement!="undefined"&&t instanceof HTMLVideoElement?r={width:t.videoWidth,height:t.videoHeight}:t?r={width:e,height:i}:r={width:e>=0?e:1,height:i>=0?i:1},O(r,"Could not deduced texture size"),O(e===void 0||r.width===e,"Deduced texture width does not match supplied width"),O(i===void 0||r.height===i,"Deduced texture height does not match supplied height"),r}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(t){switch(t){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const e=this.gl.getTexParameter(this.target,t);return this.gl.bindTexture(this.target,null),e}}_setParameter(t,e){switch(this.gl.bindTexture(this.target,this.handle),e=this._getNPOTParam(t,e),t){case 33082:case 33083:this.gl.texParameterf(this.handle,t,e);break;case 4096:case 4097:O(!1);break;default:this.gl.texParameteri(this.target,t,e);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return j(this.gl)||!this.width||!this.height?!1:!qc(this.width)||!qc(this.height)}_updateForNPOT(t){t[this.gl.TEXTURE_MIN_FILTER]===void 0&&(t[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),t[this.gl.TEXTURE_WRAP_S]===void 0&&(t[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),t[this.gl.TEXTURE_WRAP_T]===void 0&&(t[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(t,e){if(this._isNPOT())switch(t){case 10241:X_.indexOf(e)===-1&&(e=9729);break;case 10242:case 10243:e!==33071&&(e=33071);break}return e}}let Z_="";function K_(n,t){return O(typeof n=="string"),n=Z_+n,new Promise((e,i)=>{try{const r=new Image;r.onload=()=>e(r),r.onerror=()=>i(new Error(`Could not load image ${n}.`)),r.crossOrigin=t&&t.crossOrigin||"anonymous",r.src=n}catch(r){i(r)}})}class It extends Xe{static isSupported(t,e){return Xe.isSupported(t,e)}constructor(t,e={}){ji(t),(e instanceof Promise||typeof e=="string")&&(e={data:e}),typeof e.data=="string"&&(e=Object.assign({},e,{data:K_(e.data)}));super(t,Object.assign({},e,{target:3553}));this.initialize(e),Object.seal(this)}}const Cs=[34069,34070,34071,34072,34073,34074];class tl extends Xe{constructor(t,e={}){ji(t);super(t,Object.assign({},e,{target:34067}));this.initialize(e),Object.seal(this)}initialize(t={}){const{mipmaps:e=!0,parameters:i={}}=t;return this.opts=t,this.setCubeMapImageData(t).then(()=>{this.loaded=!0,e&&this.generateMipmap(t),this.setParameters(i)}),this}subImage({face:t,data:e,x:i=0,y:r=0,mipmapLevel:s=0}){return this._subImage({target:t,data:e,x:i,y:r,mipmapLevel:s})}async setCubeMapImageData({width:t,height:e,pixels:i,data:r,border:s=0,format:o=6408,type:a=5121}){const{gl:c}=this,l=i||r,u=await Promise.all(Cs.map(h=>{const f=l[h];return Promise.all(Array.isArray(f)?f:[f])}));this.bind(),Cs.forEach((h,f)=>{u[f].length>1&&this.opts.mipmaps!==!1&&F.warn(`${this.id} has mipmap and multiple LODs.`)(),u[f].forEach((g,m)=>{t&&e?c.texImage2D(h,m,o,t,e,s,o,a,g):c.texImage2D(h,m,o,o,a,g)})}),this.unbind()}setImageDataForFace(t){const{face:e,width:i,height:r,pixels:s,data:o,border:a=0,format:c=6408,type:l=5121}=t,{gl:u}=this,h=s||o;return this.bind(),h instanceof Promise?h.then(f=>this.setImageDataForFace(Object.assign({},t,{face:e,data:f,pixels:f}))):this.width||this.height?u.texImage2D(e,0,c,i,r,a,c,l,h):u.texImage2D(e,0,c,c,l,h),this}}tl.FACES=Cs;class Q_ extends Xe{static isSupported(t){return j(t)}constructor(t,e={}){Et(t),e=Object.assign({depth:1},e,{target:32879,unpackFlipY:!1});super(t,e);this.initialize(e),Object.seal(this)}setImageData({level:t=0,dataFormat:e=6408,width:i,height:r,depth:s=1,border:o=0,format:a,type:c=5121,offset:l=0,data:u,parameters:h={}}){if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),Gt(this.gl,h,()=>{ArrayBuffer.isView(u)&&this.gl.texImage3D(this.target,t,e,i,r,s,o,a,c,u),u instanceof X&&(this.gl.bindBuffer(35052,u.handle),this.gl.texImage3D(this.target,t,e,i,r,s,o,a,c,l))}),u&&u.byteLength)this._trackAllocatedMemory(u.byteLength,"Texture");else{const f=Kc[this.dataFormat]||4,g=Qc[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*f*g,"Texture")}return this.loaded=!0,this}}const Ce="EXT_color_buffer_float";var el={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Ce,bpp:2},[33327]:{gl2:Ce,bpp:4},[34842]:{gl2:Ce,bpp:8},[33326]:{gl2:Ce,bpp:4},[33328]:{gl2:Ce,bpp:8},[34836]:{gl2:Ce,bpp:16},[35898]:{gl2:Ce,bpp:4}};function J_(n,t,e){const i=e[t];if(!i)return!1;const r=j(n)&&i.gl2||i.gl1;return typeof r=="string"?n.getExtension(r):r}class Ze extends fe{static isSupported(t,{format:e}={format:null}){return!e||J_(t,e,el)}static getSamplesForFormat(t,{format:e}){return t.getInternalformatParameter(36161,e,32937)}constructor(t,e={}){super(t,e);this.initialize(e),Object.seal(this)}initialize({format:t,width:e=1,height:i=1,samples:r=0}){return O(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),r!==0&&j(this.gl)?this.gl.renderbufferStorageMultisample(36161,r,t,e,i):this.gl.renderbufferStorage(36161,t,e,i),this.format=t,this.width=e,this.height=i,this.samples=r,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*el[this.format].bpp),this}resize({width:t,height:e}){return t!==this.width||e!==this.height?this.initialize({width:t,height:e,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(t){this.gl.bindRenderbuffer(36161,t)}_syncHandle(t){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(t){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,t)}}const t0=256,e0=1024,n0=16384,nl=6144,il=6145,rl=6146,sl=34041,ol="clear: bad arguments";function Ns(n,{framebuffer:t=null,color:e=null,depth:i=null,stencil:r=null}={}){const s={};t&&(s.framebuffer=t);let o=0;e&&(o|=n0,e!==!0&&(s.clearColor=e)),i&&(o|=t0,i!==!0&&(s.clearDepth=i)),r&&(o|=e0,i!==!0&&(s.clearStencil=i)),O(o!==0,ol),Gt(n,s,()=>{n.clear(o)})}function i0(n,{framebuffer:t=null,buffer:e=nl,drawBuffer:i=0,value:r=[0,0,0,0]}={}){Et(n),Gt(n,{framebuffer:t},()=>{switch(e){case nl:switch(r.constructor){case Int32Array:n.clearBufferiv(e,i,r);break;case Uint32Array:n.clearBufferuiv(e,i,r);break;case Float32Array:default:n.clearBufferfv(e,i,r)}break;case il:n.clearBufferfv(il,0,[r]);break;case rl:n.clearBufferiv(rl,0,[r]);break;case sl:const[s,o]=r;n.clearBufferfi(sl,0,s,o);break;default:O(!1,ol)}})}function r0(n){switch(n){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return O(!1),0}}function Gi(n,t={}){const{sourceX:e=0,sourceY:i=0,sourceFormat:r=6408}=t;let{sourceAttachment:s=36064,target:o=null,sourceWidth:a,sourceHeight:c,sourceType:l}=t;const{framebuffer:u,deleteFramebuffer:h}=s0(n);O(u);const{gl:f,handle:g,attachments:m}=u;a=a||u.width,c=c||u.height,s===36064&&g===null&&(s=1028),O(m[s]),l=l||m[s].type,o=o0(o,l,r,a,c),l=l||Ms(o);const _=f.bindFramebuffer(36160,g);return f.readPixels(e,i,a,c,r,l,o),f.bindFramebuffer(36160,_||null),h&&u.delete(),o}function al(n,{sourceAttachment:t=36064,targetMaxHeight:e=Number.MAX_SAFE_INTEGER}={}){let i=Gi(n,{sourceAttachment:t}),{width:r,height:s}=n;for(;s>e;)({data:i,width:r,height:s}=j_({data:i,width:r,height:s}));z_({data:i,width:r,height:s});const o=document.createElement("canvas");o.width=r,o.height=s;const a=o.getContext("2d"),c=a.createImageData(r,s);return c.data.set(i),a.putImageData(c,0,0),o.toDataURL()}function s0(n){return n instanceof ct?{framebuffer:n,deleteFramebuffer:!1}:{framebuffer:p0(n),deleteFramebuffer:!0}}function o0(n,t,e,i,r){if(n)return n;t=t||5121;const s=$n(t,{clamped:!1}),o=r0(e);return new s(i*r*o)}const Q={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function a0(n){const t=new It(n,{format:6408,type:5126,dataFormat:6408}),e=new ct(n,{id:"test-framebuffer",check:!1,attachments:{[36064]:t}}),i=e.getStatus();return t.delete(),e.delete(),i===36053}var cl={[Q.WEBGL2]:[!1,!0],[Q.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[Q.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[Q.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[Q.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[Q.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[Q.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[Q.FLOAT_BLEND]:["EXT_float_blend"],[Q.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[Q.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[Q.TEXTURE_FLOAT]:["OES_texture_float",!0],[Q.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[Q.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[Q.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[Q.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[Q.COLOR_ATTACHMENT_RGBA32F]:[a0,"EXT_color_buffer_float"],[Q.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[Q.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[Q.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[Q.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[Q.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[Q.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};const c0=2;function Ds(n,t){return ll(n,t)}function ll(n,t){return t=Array.isArray(t)?t:[t],t.every(e=>ul(n,e))}function l0(n){n.luma=n.luma||{},n.luma.caps=n.luma.caps||{};for(const t in cl)n.luma.caps[t]===void 0&&(n.luma.caps[t]=ul(n,t));return n.luma.caps}function ul(n,t){return n.luma=n.luma||{},n.luma.caps=n.luma.caps||{},n.luma.caps[t]===void 0&&(n.luma.caps[t]=u0(n,t)),n.luma.caps[t]||F.log(c0,`Feature: ${t} not supported`)(),n.luma.caps[t]}function u0(n,t){const e=cl[t];O(e,t);let i;const r=j(n)&&e[1]||e[0];if(typeof r=="function")i=r(n);else if(Array.isArray(r)){i=!0;for(const s of r)i=i&&Boolean(n.getExtension(s))}else typeof r=="string"?i=Boolean(n.getExtension(r)):typeof r=="boolean"?i=r:O(!1);return i}const hl="Multiple render targets not supported";class ct extends fe{static isSupported(t,e={}){const{colorBufferFloat:i,colorBufferHalfFloat:r}=e;let s=!0;return i&&(s=Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("WEBGL_color_buffer_float")||t.getExtension("OES_texture_float"))),r&&(s=s&&Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("EXT_color_buffer_half_float"))),s}static getDefaultFramebuffer(t){return t.luma=t.luma||{},t.luma.defaultFramebuffer=t.luma.defaultFramebuffer||new ct(t,{id:"default-framebuffer",handle:null,attachments:{}}),t.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const t=Et(this.gl);return t.getParameter(t.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const t=Et(this.gl);return t.getParameter(t.MAX_DRAW_BUFFERS)}constructor(t,e={}){super(t,e);this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(e),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize({width:t=1,height:e=1,attachments:i=null,color:r=!0,depth:s=!0,stencil:o=!1,check:a=!0,readBuffer:c=void 0,drawBuffers:l=void 0}){if(O(t>=0&&e>=0,"Width and height need to be integers"),this.width=t,this.height=e,i)for(const u in i){const h=i[u];(Array.isArray(h)?h[0]:h).resize({width:t,height:e})}else i=this._createDefaultAttachments(r,s,o,t,e);this.update({clearAttachments:!0,attachments:i,readBuffer:c,drawBuffers:l}),i&&a&&this.checkStatus()}delete(){for(const t of this.ownResources)t.delete();return super.delete(),this}update({attachments:t={},readBuffer:e,drawBuffers:i,clearAttachments:r=!1,resizeAttachments:s=!0}){this.attach(t,{clearAttachments:r,resizeAttachments:s});const{gl:o}=this,a=o.bindFramebuffer(36160,this.handle);return e&&this._setReadBuffer(e),i&&this._setDrawBuffers(i),o.bindFramebuffer(36160,a||null),this}resize(t={}){let{width:e,height:i}=t;if(this.handle===null)return O(e===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;e===void 0&&(e=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),e!==this.width&&i!==this.height&&F.log(2,`Resizing framebuffer ${this.id} to ${e}x${i}`)();for(const r in this.attachments)this.attachments[r].resize({width:e,height:i});return this.width=e,this.height=i,this}attach(t,{clearAttachments:e=!1,resizeAttachments:i=!0}={}){const r={};e&&Object.keys(this.attachments).forEach(o=>{r[o]=null}),Object.assign(r,t);const s=this.gl.bindFramebuffer(36160,this.handle);for(const o in r){O(o!==void 0,"Misspelled framebuffer binding point?");const a=Number(o),c=r[a];let l=c;if(!l)this._unattach(a);else if(l instanceof Ze)this._attachRenderbuffer({attachment:a,renderbuffer:l});else if(Array.isArray(c)){const[u,h=0,f=0]=c;l=u,this._attachTexture({attachment:a,texture:u,layer:h,level:f})}else this._attachTexture({attachment:a,texture:l,layer:0,level:0});i&&l&&l.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,s||null),Object.assign(this.attachments,t),Object.keys(this.attachments).filter(o=>!this.attachments[o]).forEach(o=>{delete this.attachments[o]})}checkStatus(){const t=this.getStatus();if(t!==36053)throw new Error(f0(t));return this}getStatus(){const{gl:t}=this,e=t.bindFramebuffer(36160,this.handle),i=t.checkFramebufferStatus(36160);return t.bindFramebuffer(36160,e||null),i}clear(t={}){const{color:e,depth:i,stencil:r,drawBuffers:s=[]}=t,o=this.gl.bindFramebuffer(36160,this.handle);return(e||i||r)&&Ns(this.gl,{color:e,depth:i,stencil:r}),s.forEach((a,c)=>{i0(this.gl,{drawBuffer:c,value:a})}),this.gl.bindFramebuffer(36160,o||null),this}readPixels(t={}){return F.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(t={}){return F.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(t={}){return F.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(t={}){return F.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(t={}){return F.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(t={}){return F.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate({attachments:t=[],x:e=0,y:i=0,width:r,height:s}){const o=Et(this.gl),a=o.bindFramebuffer(36008,this.handle);return e===0&&i===0&&r===void 0&&s===void 0?o.invalidateFramebuffer(36008,t):o.invalidateFramebuffer(36008,t,e,i,r,s),o.bindFramebuffer(36008,a),this}getAttachmentParameter(t,e,i){let r=this._getAttachmentParameterFallback(e);return r===null&&(this.gl.bindFramebuffer(36160,this.handle),r=this.gl.getFramebufferAttachmentParameter(36160,t,e),this.gl.bindFramebuffer(36160,null)),i&&r>1e3&&(r=Ee(this.gl,r)),r}getAttachmentParameters(t=36064,e,i=this.constructor.ATTACHMENT_PARAMETERS||[]){const r={};for(const s of i){const o=e?Ee(this.gl,s):s;r[o]=this.getAttachmentParameter(t,s,e)}return r}getParameters(t=!0){const e=Object.keys(this.attachments),i={};for(const r of e){const s=Number(r),o=t?Ee(this.gl,s):s;i[o]=this.getAttachmentParameters(s,t)}return i}show(){return typeof window!="undefined"&&window.open(al(this),"luma-debug-texture"),this}log(t=0,e=""){if(t>F.level||typeof window=="undefined")return this;e=e||`Framebuffer ${this.id}`;const i=al(this,{targetMaxHeight:100});return F.image({logLevel:t,message:e,image:i},e)(),this}bind({target:t=36160}={}){return this.gl.bindFramebuffer(t,this.handle),this}unbind({target:t=36160}={}){return this.gl.bindFramebuffer(t,null),this}_createDefaultAttachments(t,e,i,r,s){let o=null;return t&&(o=o||{},o[36064]=new It(this.gl,{id:`${this.id}-color0`,pixels:null,format:6408,type:5121,width:r,height:s,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(o[36064])),e&&i?(o=o||{},o[33306]=new Ze(this.gl,{id:`${this.id}-depth-stencil`,format:35056,width:r,height:111}),this.ownResources.push(o[33306])):e?(o=o||{},o[36096]=new Ze(this.gl,{id:`${this.id}-depth`,format:33189,width:r,height:s}),this.ownResources.push(o[36096])):i&&O(!1),o}_unattach(t){const e=this.attachments[t];!e||(e instanceof Ze?this.gl.framebufferRenderbuffer(36160,t,36161,null):this.gl.framebufferTexture2D(36160,t,3553,null,0),delete this.attachments[t])}_attachRenderbuffer({attachment:t=36064,renderbuffer:e}){const{gl:i}=this;i.framebufferRenderbuffer(36160,t,36161,e.handle),this.attachments[t]=e}_attachTexture({attachment:t=36064,texture:e,layer:i,level:r}){const{gl:s}=this;switch(s.bindTexture(e.target,e.handle),e.target){case 35866:case 32879:Et(s).framebufferTextureLayer(36160,t,e.target,r,i);break;case 34067:const a=h0(i);s.framebufferTexture2D(36160,t,a,e.handle,r);break;case 3553:s.framebufferTexture2D(36160,t,3553,e.handle,r);break;default:O(!1,"Illegal texture type")}s.bindTexture(e.target,null),this.attachments[t]=e}_setReadBuffer(t){const e=Vm(this.gl);e?e.readBuffer(t):O(t===36064||t===1029,hl),this.readBuffer=t}_setDrawBuffers(t){const{gl:e}=this,i=Et(e);if(i)i.drawBuffers(t);else{const r=e.getExtension("WEBGL_draw_buffers");r?r.drawBuffersWEBGL(t):O(t.length===1&&(t[0]===36064||t[0]===1029),hl)}this.drawBuffers=t}_getAttachmentParameterFallback(t){const e=l0(this.gl);switch(t){case 36052:return e.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return e.WEBGL2?null:8;case 33297:return e.WEBGL2?null:5125;case 33296:return!e.WEBGL2&&!e.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(t){return this.gl.bindFramebuffer(36160,t)}}function h0(n){return n<34069?n+34069:n}function f0(n){return(ct.STATUS||{})[n]||`Framebuffer error ${n}`}const d0=[36049,36048,33296,33298,33299,33300,33301,33302,33303];ct.ATTACHMENT_PARAMETERS=d0;function g0(n,t){O(n instanceof It||n instanceof tl||n instanceof Q_);const e=n.constructor,{gl:i,width:r,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u}=n,h=Object.assign({width:r,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u},t);return new e(i,h)}function p0(n,t){const{gl:e,width:i,height:r,id:s}=n;return new ct(e,Object.assign({},t,{id:`framebuffer-for-${s}`,width:i,height:r,attachments:{[36064]:n}}))}function $i(n,t="unnamed"){const e=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=n.match(e);return i?i[1]:t}const m0=35632,_0=35633;function b0(n){switch(n){case m0:return"fragment";case _0:return"vertex";default:return"unknown type"}}function y0(n,t,e,i){const r=n.split(/\r?\n/),s={},o={},a=i||$i(t)||"(unnamed)",c=`${b0(e)} shader ${a}`;for(let u=0;u<r.length;u++){const h=r[u];if(h.length<=1)continue;const f=h.split(":"),g=f[0],m=parseInt(f[2],10);if(isNaN(m))throw new Error(`GLSL compilation error in ${c}: ${n}`);g!=="WARNING"?s[m]=h:o[m]=h}const l=T0(t);return{shaderName:c,errors:fl(s,l),warnings:fl(o,l)}}function fl(n,t){let e="";for(let i=0;i<t.length;i++){const r=t[i];if(!(!n[i+3]&&!n[i+2]&&!n[i+1])&&(e+=`${r}
`,n[i+1])){const s=n[i+1],o=s.split(":",3),a=o[0],c=parseInt(o[1],10)||0,l=s.substring(o.join(":").length+1).trim();e+=dl(`^^^ ${a}: ${l}

`,c)}}return e}function T0(n,t=1,e=": "){const i=n.split(/\r?\n/),r=String(i.length+t-1).length;return i.map((s,o)=>{const a=String(o+t),c=a.length;return dl(a,r-c)+e+s})}function dl(n,t){let e="";for(let i=0;i<t;++i)e+=" ";return`${e}${n}`}function gl(n){let t=100;const e=n.match(/[^\s]+/g);if(e.length>=2&&e[0]==="#version"){const i=parseInt(e[1],10);Number.isFinite(i)&&(t=i)}return t}const E0="Shader: GLSL source code must be a JavaScript string";class Hn extends fe{static getTypeName(t){switch(t){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return O(!1),"unknown"}}constructor(t,e){ji(t),O(typeof e.source=="string",E0);const i=$i(e.source,null)||e.id||he(`unnamed ${Hn.getTypeName(e.shaderType)}`);super(t,{id:i});this.shaderType=e.shaderType,this.source=e.source,this.initialize(e)}initialize({source:t}){const e=$i(t,null);e&&(this.id=he(e)),this._compile(t)}getParameter(t){return this.gl.getShaderParameter(this.handle,t)}toString(){return`${Hn.getTypeName(this.shaderType)}:${this.id}`}getName(){return $i(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const t=this.gl.getExtension("WEBGL_debug_shaders");return t?t.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(t=this.source){if(t.startsWith("#version ")||(t=`#version 100
${t}`),this.source=t,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){const i=this.gl.getShaderInfoLog(this.handle),{shaderName:r,errors:s,warnings:o}=y0(i,this.source,this.shaderType,this.id);throw F.error(`GLSL compilation errors in ${r}
${s}`)(),F.warn(`GLSL compilation warnings in ${r}
${o}`)(),new Error(`GLSL compilation errors in ${r}`)}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class Fs extends Hn{constructor(t,e){typeof e=="string"&&(e={source:e});super(t,Object.assign({},e,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class Us extends Hn{constructor(t,e){typeof e=="string"&&(e={source:e});super(t,Object.assign({},e,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const v0={[5126]:tt.bind(null,"uniform1fv",Pt,1,pt),[35664]:tt.bind(null,"uniform2fv",Pt,2,pt),[35665]:tt.bind(null,"uniform3fv",Pt,3,pt),[35666]:tt.bind(null,"uniform4fv",Pt,4,pt),[5124]:tt.bind(null,"uniform1iv",ve,1,pt),[35667]:tt.bind(null,"uniform2iv",ve,2,pt),[35668]:tt.bind(null,"uniform3iv",ve,3,pt),[35669]:tt.bind(null,"uniform4iv",ve,4,pt),[35670]:tt.bind(null,"uniform1iv",ve,1,pt),[35671]:tt.bind(null,"uniform2iv",ve,2,pt),[35672]:tt.bind(null,"uniform3iv",ve,3,pt),[35673]:tt.bind(null,"uniform4iv",ve,4,pt),[35674]:tt.bind(null,"uniformMatrix2fv",Pt,4,de),[35675]:tt.bind(null,"uniformMatrix3fv",Pt,9,de),[35676]:tt.bind(null,"uniformMatrix4fv",Pt,16,de),[35678]:ft,[35680]:ft,[5125]:tt.bind(null,"uniform1uiv",Hi,1,pt),[36294]:tt.bind(null,"uniform2uiv",Hi,2,pt),[36295]:tt.bind(null,"uniform3uiv",Hi,3,pt),[36296]:tt.bind(null,"uniform4uiv",Hi,4,pt),[35685]:tt.bind(null,"uniformMatrix2x3fv",Pt,6,de),[35686]:tt.bind(null,"uniformMatrix2x4fv",Pt,8,de),[35687]:tt.bind(null,"uniformMatrix3x2fv",Pt,6,de),[35688]:tt.bind(null,"uniformMatrix3x4fv",Pt,12,de),[35689]:tt.bind(null,"uniformMatrix4x2fv",Pt,8,de),[35690]:tt.bind(null,"uniformMatrix4x3fv",Pt,12,de),[35678]:ft,[35680]:ft,[35679]:ft,[35682]:ft,[36289]:ft,[36292]:ft,[36293]:ft,[36298]:ft,[36299]:ft,[36300]:ft,[36303]:ft,[36306]:ft,[36307]:ft,[36308]:ft,[36311]:ft},A0={},w0={},S0={},pl=[0];function Bs(n,t,e,i){t===1&&typeof n=="boolean"&&(n=n?1:0),Number.isFinite(n)&&(pl[0]=n,n=pl);const r=n.length;if(r%t&&F.warn(`Uniform size should be multiples of ${t}`,n)(),n instanceof e)return n;let s=i[r];s||(s=new e(r),i[r]=s);for(let o=0;o<r;o++)s[o]=n[o];return s}function Pt(n,t){return Bs(n,t,Float32Array,A0)}function ve(n,t){return Bs(n,t,Int32Array,w0)}function Hi(n,t){return Bs(n,t,Uint32Array,S0)}function ml(n,t,e){const i=v0[e.type];if(!i)throw new Error(`Unknown GLSL uniform type ${e.type}`);return i().bind(null,n,t)}function I0(n){if(n[n.length-1]!=="]")return{name:n,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/,e=n.match(t);if(!e||e.length<2)throw new Error(`Failed to parse GLSL uniform name ${n}`);return{name:e[1],length:e[2]||1,isArray:Boolean(e[2])}}function P0(n,t,e){for(const i in n){const r=n[i];if((!e||Boolean(e[i]))&&!x0(r))throw t=t?`${t} `:"",console.error(`${t} Bad uniform ${i}`,r),new Error(`${t} Bad uniform ${i}`)}return!0}function x0(n){return Array.isArray(n)||ArrayBuffer.isView(n)?M0(n):isFinite(n)||n===!0||n===!1||n instanceof Xe||n instanceof Ze?!0:n instanceof ct?Boolean(n.texture):!1}function L0(n,t,e){if(Array.isArray(e)||ArrayBuffer.isView(e))if(n[t]){const i=n[t];for(let r=0,s=e.length;r<s;++r)i[r]=e[r]}else n[t]=e.slice();else n[t]=e}function M0(n){if(n.length===0)return!1;const t=Math.min(n.length,16);for(let e=0;e<t;++e)if(!Number.isFinite(n[e]))return!1;return!0}function ft(){let n=null;return(t,e,i)=>{const r=n!==i;return r&&(t.uniform1i(e,i),n=i),r}}function tt(n,t,e,i){let r=null,s=null;return(o,a,c)=>{const l=t(c,e),u=l.length;let h=!1;if(r===null)r=new Float32Array(u),s=u,h=!0;else{O(s===u,"Uniform length cannot change.");for(let f=0;f<u;++f)if(l[f]!==r[f]){h=!0;break}}return h&&(i(o,n,a,l),r.set(l)),h}}function pt(n,t,e,i){n[t](e,i)}function de(n,t,e,i){n[t](e,!1,i)}const R0=5120,O0=5121,C0=5122,N0=5123,_l=0,Wi=1,D0=2,F0=3,qi=4,U0=5,B0=6,lt=5126,k0=35664,V0=35665,z0=35666,Wn=5124,j0=35667,G0=35668,$0=35669,qn=5125,H0=36294,W0=36295,q0=36296,Y0=35670,X0=35671,Z0=35672,K0=35673,Q0=35674,J0=35675,tb=35676,eb=35685,nb=35686,ib=35687,rb=35688,sb=35689,ob=35690,ks={[lt]:[lt,1,"float"],[k0]:[lt,2,"vec2"],[V0]:[lt,3,"vec3"],[z0]:[lt,4,"vec4"],[Wn]:[Wn,1,"int"],[j0]:[Wn,2,"ivec2"],[G0]:[Wn,3,"ivec3"],[$0]:[Wn,4,"ivec4"],[qn]:[qn,1,"uint"],[H0]:[qn,2,"uvec2"],[W0]:[qn,3,"uvec3"],[q0]:[qn,4,"uvec4"],[Y0]:[lt,1,"bool"],[X0]:[lt,2,"bvec2"],[Z0]:[lt,3,"bvec3"],[K0]:[lt,4,"bvec4"],[Q0]:[lt,8,"mat2"],[eb]:[lt,8,"mat2x3"],[nb]:[lt,8,"mat2x4"],[J0]:[lt,12,"mat3"],[ib]:[lt,12,"mat3x2"],[rb]:[lt,12,"mat3x4"],[tb]:[lt,16,"mat4"],[sb]:[lt,16,"mat4x2"],[ob]:[lt,16,"mat4x3"]};function ab(n){switch(n){case _l:return _l;case Wi:return Wi;case F0:return Wi;case D0:return Wi;case qi:return qi;case U0:return qi;case B0:return qi;default:return O(!1),0}}function bl(n){const t=ks[n];if(!t)return null;const[e,i]=t;return{type:e,components:i}}function yl(n,t){switch(n){case R0:case O0:case C0:case N0:n=lt;break}for(const e in ks){const[i,r,s]=ks[e];if(i===n&&r===t)return{glType:e,name:s}}return null}class cb{constructor(t){this.id=t.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(t),this._readVaryingsFromProgram(t)}getAttributeInfo(t){const e=Number(t);return Number.isFinite(e)?this.attributeInfosByLocation[e]:this.attributeInfosByName[t]||null}getAttributeLocation(t){const e=this.getAttributeInfo(t);return e?e.location:-1}getAttributeAccessor(t){const e=this.getAttributeInfo(t);return e?e.accessor:null}getVaryingInfo(t){const e=Number(t);return Number.isFinite(e)?this.varyingInfos[e]:this.varyingInfosByName[t]||null}getVaryingIndex(t){const e=this.getVaryingInfo();return e?e.location:-1}getVaryingAccessor(t){const e=this.getVaryingInfo();return e?e.accessor:null}_readAttributesFromProgram(t){const{gl:e}=t,i=e.getProgramParameter(t.handle,35721);for(let r=0;r<i;r++){const{name:s,type:o,size:a}=e.getActiveAttrib(t.handle,r),c=e.getAttribLocation(t.handle,s);c>=0&&this._addAttribute(c,s,o,a)}this.attributeInfos.sort((r,s)=>r.location-s.location)}_readVaryingsFromProgram(t){const{gl:e}=t;if(!j(e))return;const i=e.getProgramParameter(t.handle,35971);for(let r=0;r<i;r++){const{name:s,type:o,size:a}=e.getTransformFeedbackVarying(t.handle,r);this._addVarying(r,s,o,a)}this.varyingInfos.sort((r,s)=>r.location-s.location)}_addAttribute(t,e,i,r){const{type:s,components:o}=bl(i),a={type:s,size:r*o};this._inferProperties(t,e,a);const c={location:t,name:e,accessor:new At(a)};this.attributeInfos.push(c),this.attributeInfosByLocation[t]=c,this.attributeInfosByName[c.name]=c}_inferProperties(t,e,i){/instance/i.test(e)&&(i.divisor=1)}_addVarying(t,e,i,r){const{type:s,components:o}=bl(i),a=new At({type:s,size:r*o}),c={location:t,name:e,accessor:a};this.varyingInfos.push(c),this.varyingInfosByName[c.name]=c}}const Tl=4,lb=35981,ub=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class El extends fe{constructor(t,e={}){super(t,e);this.stubRemovedMethods("Program","v6.0",ub),this._isCached=!1,this.initialize(e),Object.seal(this),this._setId(e.id)}initialize(t={}){const{hash:e,vs:i,fs:r,varyings:s,bufferMode:o=lb}=t;return this.hash=e||"",this.vs=typeof i=="string"?new Fs(this.gl,{id:`${t.id}-vs`,source:i}):i,this.fs=typeof r=="string"?new Us(this.gl,{id:`${t.id}-fs`,source:r}):r,O(this.vs instanceof Fs),O(this.fs instanceof Us),this.uniforms={},this._textureUniforms={},s&&s.length>0&&(Et(this.gl),this.varyings=s,this.gl2.transformFeedbackVaryings(this.handle,s,o)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new cb(this),this.setProps(t)}delete(t={}){return this._isCached?this:super.delete(t)}setProps(t){return"uniforms"in t&&this.setUniforms(t.uniforms),this}draw({logPriority:t,drawMode:e=4,vertexCount:i,offset:r=0,start:s,end:o,isIndexed:a=!1,indexType:c=5123,instanceCount:l=0,isInstanced:u=l>0,vertexArray:h=null,transformFeedback:f,framebuffer:g,parameters:m={},uniforms:_,samplers:T}){if((_||T)&&(F.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(_||{})),F.priority>=t){const v=g?g.id:"default",S=`mode=${Ee(this.gl,e)} verts=${i} instances=${l} indexType=${Ee(this.gl,c)} isInstanced=${u} isIndexed=${a} Framebuffer=${v}`;F.log(t,S)()}return O(h),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||i===0||u&&l===0?!1:(h.bindForDraw(i,l,()=>{if(g!==void 0&&(m=Object.assign({},m,{framebuffer:g})),f){const v=ab(e);f.begin(v)}this._bindTextures(),Gt(this.gl,m,()=>{a&&u?this.gl2.drawElementsInstanced(e,i,c,r,l):a&&j(this.gl)&&!isNaN(s)&&!isNaN(o)?this.gl2.drawRangeElements(e,s,o,i,c,r):a?this.gl.drawElements(e,i,c,r):u?this.gl2.drawArraysInstanced(e,r,i,l):this.gl.drawArrays(e,r,i)}),f&&f.end()}),!0)}setUniforms(t={}){F.priority>=2&&P0(t,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const e in t){const i=t[e],r=this._uniformSetters[e];if(r){let s=i,o=!1;if(s instanceof ct&&(s=s.texture),s instanceof Xe)if(o=this.uniforms[e]!==i,o){r.textureIndex===void 0&&(r.textureIndex=this._textureIndexCounter++);const a=s,{textureIndex:c}=r;a.bind(c),s=c,this._textureUniforms[e]=a}else s=r.textureIndex;else this._textureUniforms[e]&&delete this._textureUniforms[e];(r(s)||o)&&L0(this.uniforms,e,i)}}return this}_areTexturesRenderable(){let t=!0;for(const e in this._textureUniforms){const i=this._textureUniforms[e];i.update(),t=t&&i.loaded}return t}_bindTextures(){for(const t in this._textureUniforms){const e=this._uniformSetters[t].textureIndex;this._textureUniforms[t].bind(e)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(t){const e=this.gl.getAttachedShaders(t),i={};for(const r of e)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new Fs({handle:r});break;case 35632:i.fs=new Us({handle:r});break}return i}_getParameter(t){return this.gl.getProgramParameter(this.handle,t)}_setId(t){if(!t){const e=this._getName();this.id=he(e)}}_getName(){let t=this.vs.getName()||this.fs.getName();return t=t.replace(/shader/i,""),t=t?`${t}-program`:"program",t}_compileAndLink(){const{gl:t}=this;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),F.time(Tl,`linkProgram for ${this._getName()}`)(),t.linkProgram(this.handle),F.timeEnd(Tl,`linkProgram for ${this._getName()}`)(),t.debug||F.level>0){if(!t.getProgramParameter(this.handle,35714))throw new Error(`Error linking: ${t.getProgramInfoLog(this.handle)}`);if(t.validateProgram(this.handle),!t.getProgramParameter(this.handle,35715))throw new Error(`Error validating: ${t.getProgramInfoLog(this.handle)}`)}}_readUniformLocationsFromLinkedProgram(){const{gl:t}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let e=0;e<this._uniformCount;e++){const i=this.gl.getActiveUniform(this.handle,e),{name:r}=I0(i.name);let s=t.getUniformLocation(this.handle,r);if(this._uniformSetters[r]=ml(t,s,i),i.size>1)for(let o=0;o<i.size;o++)s=t.getUniformLocation(this.handle,`${r}[${o}]`),this._uniformSetters[`${r}[${o}]`]=ml(t,s,i)}this._textureIndexCounter=0}getActiveUniforms(t,e){return this.gl2.getActiveUniforms(this.handle,t,e)}getUniformBlockIndex(t){return this.gl2.getUniformBlockIndex(this.handle,t)}getActiveUniformBlockParameter(t,e){return this.gl2.getActiveUniformBlockParameter(this.handle,t,e)}uniformBlockBinding(t,e){this.gl2.uniformBlockBinding(this.handle,t,e)}}const hb=34918,fb=34919,db=35007,gb=36795,pb=35976,mb=35887,_b=36202;class Yi extends fe{static isSupported(t,e=[]){const i=j(t),r=ll(t,Q.TIMER_QUERY);let s=i||r;for(const o of e)switch(o){case"queries":s=s&&i;break;case"timers":s=s&&r;break;default:O(!1)}return s}constructor(t,e={}){super(t,e);this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(db)}beginOcclusionQuery({conservative:t=!1}={}){return this.begin(t?_b:mb)}beginTransformFeedbackQuery(){return this.begin(pb)}begin(t){return this._queryPending?this:(this.target=t,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.gl2.getQueryParameter(this.handle,fb);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.gl2.getParameter(gb)}getResult(){return this.gl2.getQueryParameter(this.handle,hb)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let e=0;return this._pollingPromise=new Promise((i,r)=>{const s=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):e++>t?(r("Timed out"),this._pollingPromise=null):requestAnimationFrame(s)};requestAnimationFrame(s)}),this._pollingPromise}_createHandle(){return Yi.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}}class vl extends fe{static isSupported(t){return j(t)}constructor(t,e={}){Et(t);super(t,e);this.initialize(e),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(t={}){return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,qe(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(t),this}setProps(t){"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"bindOnUse"in t&&(t=t.bindOnUse),"buffers"in t&&this.setBuffers(t.buffers)}setBuffers(t={}){return this.bind(()=>{for(const e in t)this.setBuffer(e,t[e])}),this}setBuffer(t,e){const i=this._getVaryingIndex(t),{buffer:r,byteSize:s,byteOffset:o}=this._getBufferParams(e);return i<0?(this.unused[t]=r,F.warn(()=>`${this.id} unused varying buffer ${t}`)(),this):(this.buffers[i]=e,this.bindOnUse||this._bindBuffer(i,r,o,s),this)}begin(t=0){return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(t),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(t){let e,i,r;return t instanceof X?r=t:(r=t.buffer,i=t.byteSize,e=t.byteOffset),(e!==void 0||i!==void 0)&&(e=e||0,i=i||r.byteLength-e),{buffer:r,byteOffset:e,byteSize:i}}_getVaryingInfo(t){return this.configuration&&this.configuration.getVaryingInfo(t)}_getVaryingIndex(t){if(this.configuration)return this.configuration.getVaryingInfo(t).location;const e=Number(t);return Number.isFinite(e)?e:-1}_bindBuffers(){if(this.bindOnUse)for(const t in this.buffers){const{buffer:e,byteSize:i,byteOffset:r}=this._getBufferParams(this.buffers[t]);this._bindBuffer(t,e,r,i)}}_unbindBuffers(){if(this.bindOnUse)for(const t in this.buffers)this._bindBuffer(t,null)}_bindBuffer(t,e,i=0,r){const s=e&&e.handle;return!s||r===void 0?this.gl.bindBufferBase(35982,t,s):this.gl.bindBufferRange(35982,t,s,i,r),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(t){this.gl.bindTransformFeedback(36386,this.handle)}}let Xi=null;function bb(n){return(!Xi||Xi.byteLength<n)&&(Xi=new ArrayBuffer(n)),Xi}function yb(n,t){const e=bb(n.BYTES_PER_ELEMENT*t);return new n(e,0,t)}function Tb({target:n,source:t,start:e=0,count:i=1}){const r=t.length,s=i*r;let o=0;for(let a=e;o<r;o++)n[a++]=t[o];for(;o<s;)o<s-o?(n.copyWithin(e+o,e,e+o),o*=2):(n.copyWithin(e+o,e,e+s-o),o=s);return n}const Eb="elements must be GL.ELEMENT_ARRAY_BUFFER";class xt extends fe{static isSupported(t,e={}){return e.constantAttributeZero?j(t)||lp()==="Chrome":!0}static getDefaultArray(t){return t.luma=t.luma||{},t.luma.defaultVertexArray||(t.luma.defaultVertexArray=new xt(t,{handle:null,isDefaultArray:!0})),t.luma.defaultVertexArray}static getMaxAttributes(t){return xt.MAX_ATTRIBUTES=xt.MAX_ATTRIBUTES||t.getParameter(34921),xt.MAX_ATTRIBUTES}static setConstant(t,e,i){switch(i.constructor){case Float32Array:xt._setConstantFloatArray(t,e,i);break;case Int32Array:xt._setConstantIntArray(t,e,i);break;case Uint32Array:xt._setConstantUintArray(t,e,i);break;default:O(!1)}}constructor(t,e={}){const i=e.id||e.program&&e.program.id;super(t,Object.assign({},e,{id:i}));this.buffer=null,this.bufferValue=null,this.isDefaultArray=e.isDefaultArray||!1,this.gl2=t,this.initialize(e),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return xt.getMaxAttributes(this.gl)}initialize(t={}){return this.setProps(t)}setProps(t){return this}setElementBuffer(t=null,e={}){return O(!t||t.target===34963,Eb),this.bind(()=>{this.gl.bindBuffer(34963,t?t.handle:null)}),this}setBuffer(t,e,i){if(e.target===34963)return this.setElementBuffer(e,i);const{size:r,type:s,stride:o,offset:a,normalized:c,integer:l,divisor:u}=i,{gl:h,gl2:f}=this;return t=Number(t),this.bind(()=>{h.bindBuffer(34962,e.handle),l?(O(j(h)),f.vertexAttribIPointer(t,r,s,o,a)):h.vertexAttribPointer(t,r,s,c,o,a),h.enableVertexAttribArray(t),f.vertexAttribDivisor(t,u||0)}),this}enable(t,e=!0){return!e&&t===0&&!xt.isSupported(this.gl,{constantAttributeZero:!0})||(t=Number(t),this.bind(()=>e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t))),this}getConstantBuffer(t,e){const i=this._normalizeConstantArrayValue(e),r=i.byteLength*t,s=i.length*t;let o=!this.buffer;if(this.buffer=this.buffer||new X(this.gl,r),o=o||this.buffer.reallocate(r),o=o||!this._compareConstantArrayValues(i,this.bufferValue),o){const a=yb(e.constructor,s);Tb({target:a,source:i,start:0,count:s}),this.buffer.subData(a),this.bufferValue=e}return this.buffer}_normalizeConstantArrayValue(t){return Array.isArray(t)?new Float32Array(t):t}_compareConstantArrayValues(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}static _setConstantFloatArray(t,e,i){switch(i.length){case 1:t.vertexAttrib1fv(e,i);break;case 2:t.vertexAttrib2fv(e,i);break;case 3:t.vertexAttrib3fv(e,i);break;case 4:t.vertexAttrib4fv(e,i);break;default:O(!1)}}static _setConstantIntArray(t,e,i){switch(O(j(t)),i.length){case 1:t.vertexAttribI1iv(e,i);break;case 2:t.vertexAttribI2iv(e,i);break;case 3:t.vertexAttribI3iv(e,i);break;case 4:t.vertexAttribI4iv(e,i);break;default:O(!1)}}static _setConstantUintArray(t,e,i){switch(O(j(t)),i.length){case 1:t.vertexAttribI1uiv(e,i);break;case 2:t.vertexAttribI2uiv(e,i);break;case 3:t.vertexAttribI3uiv(e,i);break;case 4:t.vertexAttribI4uiv(e,i);break;default:O(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(t){return this.gl2.deleteVertexArray(t),[this.elements]}_bindHandle(t){this.gl2.bindVertexArray(t)}_getParameter(t,{location:e}){return O(Number.isFinite(e)),this.bind(()=>{switch(t){case 34373:return this.gl.getVertexAttribOffset(e,t);default:return this.gl.getVertexAttrib(e,t)}})}}const vb="VertexArray: attributes must be Buffers or constants (i.e. typed array)",Ab=/^(.+)__LOCATION_([0-9]+)$/,wb=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class Sb{constructor(t,e={}){const i=e.id||e.program&&e.program.id;this.id=i,this.gl=t,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new xt(t),Yc(this,"VertexArray","v6.0",wb),this.initialize(e),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(t={}){return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(t)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:t}=this.vertexArrayObject;return this.values=new Array(t).fill(null),this.accessors=new Array(t).fill(null),this.unused={},this.drawParams=null,this}setProps(t){return"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"attributes"in t&&this.setAttributes(t.attributes),"elements"in t&&this.setElementBuffer(t.elements),"bindOnUse"in t&&(t=t.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(t){return Object.assign(this.attributes,t),this.vertexArrayObject.bind(()=>{for(const e in t){const i=t[e];this._setAttribute(e,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(t=null,e={}){return this.elements=t,this.elementsAccessor=e,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(t,e),this}setBuffer(t,e,i={}){if(e.target===34963)return this.setElementBuffer(e,i);const{location:r,accessor:s}=this._resolveLocationAndAccessor(t,e,e.accessor,i);return r>=0&&(this.values[r]=e,this.accessors[r]=s,this.clearDrawParams(),this.vertexArrayObject.setBuffer(r,e,s)),this}setConstant(t,e,i={}){const{location:r,accessor:s}=this._resolveLocationAndAccessor(t,e,Object.assign({size:e.length},i));return r>=0&&(e=this.vertexArrayObject._normalizeConstantArrayValue(e),this.values[r]=e,this.accessors[r]=s,this.clearDrawParams(),this.vertexArrayObject.enable(r,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new X(this.gl,{accessor:{size:4}});for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this.values[t]instanceof X&&(this.gl.disableVertexAttribArray(t),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(t,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++){const e=this.values[t];e instanceof X&&this.setBuffer(t,e)}}),this}bindForDraw(t,e,i){let r;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(t,e),r=i()}),r}_resolveLocationAndAccessor(t,e,i,r){const s={location:-1,accessor:null},{location:o,name:a}=this._getAttributeIndex(t);if(!Number.isFinite(o)||o<0)return this.unused[t]=e,F.once(3,()=>`unused value ${t} in ${this.id}`)(),s;const c=this._getAttributeInfo(a||o);if(!c)return s;const l=this.accessors[o]||{},u=At.resolve(c.accessor,l,i,r),{size:h,type:f}=u;return O(Number.isFinite(h)&&Number.isFinite(f)),{location:o,accessor:u}}_getAttributeInfo(t){return this.configuration&&this.configuration.getAttributeInfo(t)}_getAttributeIndex(t){const e=Number(t);if(Number.isFinite(e))return{location:e};const i=Ab.exec(t),r=i?i[1]:t,s=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(r)+s,name:r}:{location:-1}}_setAttribute(t,e){if(e instanceof X)this.setBuffer(t,e);else if(Array.isArray(e)&&e.length&&e[0]instanceof X){const i=e[0],r=e[1];this.setBuffer(t,i,r)}else if(ArrayBuffer.isView(e)||Array.isArray(e)){const i=e;this.setConstant(t,i)}else if(e.buffer instanceof X){const i=e;this.setBuffer(t,i.buffer,i)}else throw new Error(vb)}_setConstantAttributes(t,e){const i=Math.max(t|0,e|0);let r=this.values[0];ArrayBuffer.isView(r)&&this._setConstantAttributeZero(r,i);for(let s=1;s<this.vertexArrayObject.MAX_ATTRIBUTES;s++)r=this.values[s],ArrayBuffer.isView(r)&&this._setConstantAttribute(s,r)}_setConstantAttributeZero(t,e){if(xt.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,t);return}const i=this.vertexArrayObject.getConstantBuffer(e,t);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(t,e){xt.setConstant(this.gl,t,e)}_updateDrawParams(){const t={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this._updateDrawParamsForLocation(t,e);return this.elements&&(t.elementCount=this.elements.getElementCount(this.elements.accessor),t.isIndexed=!0,t.indexType=this.elementsAccessor.type||this.elements.accessor.type,t.indexOffset=this.elementsAccessor.offset||0),t.indexCount===1/0&&(t.indexCount=0),t.vertexCount===1/0&&(t.vertexCount=0),t.instanceCount===1/0&&(t.instanceCount=0),t}_updateDrawParamsForLocation(t,e){const i=this.values[e],r=this.accessors[e];if(!i)return;const{divisor:s}=r,o=s>0;if(t.isInstanced=t.isInstanced||o,i instanceof X){const a=i;if(o){const c=a.getVertexCount(r);t.instanceCount=Math.min(t.instanceCount,c)}else{const c=a.getVertexCount(r);t.vertexCount=Math.min(t.vertexCount,c)}}}setElements(t=null,e={}){return F.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(t,e)}}function Ib(n,t){const{maxElts:e=16,size:i=1}=t;let r="[";for(let o=0;o<n.length&&o<e;++o)o>0&&(r+=`,${o%i==0?" ":""}`),r+=Yn(n[o],t);const s=n.length>e?"...":"]";return`${r}${s}`}function Yn(n,t={}){const e=1e-16,{isInteger:i=!1}=t;if(Array.isArray(n)||ArrayBuffer.isView(n))return Ib(n,t);if(!Number.isFinite(n))return String(n);if(Math.abs(n)<e)return i?"0":"0.";if(i||Math.abs(n)>100&&Math.abs(n)<1e4)return n.toFixed(0);const r=n.toPrecision(2);return r.indexOf(".0")===r.length-2?r.slice(0,-1):r}function Al({header:n="Uniforms",program:t,uniforms:e,undefinedOnly:i=!1}){O(t);const r=".*_.*",s=".*Matrix",o=t._uniformSetters,a={},c=Object.keys(o).sort();let l=0;for(const f of c)!f.match(r)&&!f.match(s)&&Vs({table:a,header:n,uniforms:e,uniformName:f,undefinedOnly:i})&&l++;for(const f of c)f.match(s)&&Vs({table:a,header:n,uniforms:e,uniformName:f,undefinedOnly:i})&&l++;for(const f of c)a[f]||Vs({table:a,header:n,uniforms:e,uniformName:f,undefinedOnly:i})&&l++;let u=0;const h={};if(!i)for(const f in e){const g=e[f];a[f]||(u++,h[f]={Type:`NOT USED: ${g}`,[n]:Yn(g)})}return{table:a,count:l,unusedTable:h,unusedCount:u}}function Vs({table:n,header:t,uniforms:e,uniformName:i,undefinedOnly:r}){const s=e[i],o=Pb(s);return!r||!o?(n[i]={[t]:o?Yn(s):"N/A","Uniform Type":o?s:"NOT PROVIDED"},!0):!1}function Pb(n){return n!=null}function xb({vertexArray:n,header:t="Attributes"}){if(!n.configuration)return{};const e={};n.elements&&(e.ELEMENT_ARRAY_BUFFER=wl(n,n.elements,null,t));const i=n.values;for(const r in i){const s=n._getAttributeInfo(r);if(s){let o=`${r}: ${s.name}`;const a=n.accessors[s.location];a&&(o=`${r}: ${Lb(s.name,a)}`),e[o]=wl(n,i[r],a,t)}}return e}function wl(n,t,e,i){const{gl:r}=n;if(!t)return{[i]:"null","Format ":"N/A"};let s="NOT PROVIDED",o=1,a=0,c=0,l,u,h;if(e&&(s=e.type,o=e.size,s=String(s).replace("Array",""),l=s.indexOf("nt")!==-1),t instanceof X){const f=t,{data:g,changed:m}=f.getDebugData();u=m?"*":"",h=g,c=f.byteLength,a=c/g.BYTES_PER_ELEMENT/o;let _;return e?_=`${e.divisor>0?"I ":"P "} ${a} (x${o}=${c} bytes ${Ee(r,s)})`:(l=!0,_=`${c} bytes`),{[i]:`${u}${Yn(h,{size:o,isInteger:l})}`,"Format ":_}}return h=t,o=t.length,s=String(t.constructor.name).replace("Array",""),l=s.indexOf("nt")!==-1,{[i]:`${Yn(h,{size:o,isInteger:l})} (constant)`,"Format ":`${o}x${s} (constant)`}}function Lb(n,t){const{type:e,size:i}=t,r=yl(e,i);return r?`${n} (${r.name})`:n}function Mb(n){const t={},e=`Accessors for ${n.id}`;for(const i of n.attributeInfos)if(i){const r=Sl(i);t[`in ${r}`]={[e]:JSON.stringify(i.accessor)}}for(const i of n.varyingInfos)if(i){const r=Sl(i);t[`out ${r}`]={[e]:JSON.stringify(i.accessor)}}return t}function Sl(n){const{type:t,size:e}=n.accessor,i=yl(t,e);return i?`${i.name} ${n.name}`:n.name}const Il=J.isBrowser()&&typeof document!="undefined";let Rb=0;class Ob{constructor(t={}){const{onCreateContext:e=T=>Wc(T),onAddHTML:i=null,onInitialize:r=()=>{},onRender:s=()=>{},onFinalize:o=()=>{},onError:a,gl:c=null,glOptions:l={},debug:u=!1,createFramebuffer:h=!1,autoResizeViewport:f=!0,autoResizeDrawingBuffer:g=!0,stats:m=Oe.get(`animation-loop-${Rb++}`)}=t;let{useDevicePixels:_=!0}=t;"useDevicePixelRatio"in t&&(F.deprecated("useDevicePixelRatio","useDevicePixels")(),_=t.useDevicePixelRatio),this.props={onCreateContext:e,onAddHTML:i,onInitialize:r,onRender:s,onFinalize:o,onError:a,gl:c,glOptions:l,debug:u,createFramebuffer:h},this.gl=c,this.needsRedraw=null,this.timeline=null,this.stats=m,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:f,autoResizeDrawingBuffer:g,useDevicePixels:_}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(t){return O(typeof t=="string"),this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.autoResizeViewport=t.autoResizeViewport),"autoResizeDrawingBuffer"in t&&(this.autoResizeDrawingBuffer=t.autoResizeDrawingBuffer),"useDevicePixels"in t&&(this.useDevicePixels=t.useDevicePixels),this}start(t={}){if(this._running)return this;this._running=!0;const e=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(t),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Yi.isSupported(this.gl,["timers"])?new Yi(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(i=>{this._running&&(this._addCallbackData(i||{}),i!==!1&&this._startLoop())});return this.props.onError&&e.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(t=>{this._resolveNextFrame=t})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(...t){return this.props.onCreateContext(...t)}onInitialize(...t){return this.props.onInitialize(...t)}onRender(...t){return this.props.onRender(...t)}onFinalize(...t){return this.props.onFinalize(...t)}getHTMLControlValue(t,e=1){const i=document.getElementById(t);return i?Number(i.value):e}setViewParameters(){return F.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){const t=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(t))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(t)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=Il?new Promise((t,e)=>{if(Il&&document.readyState==="complete"){t(document);return}window.addEventListener("load",()=>{t(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(t){this.display&&(this.display.delete(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_cancelAnimationFrame(t){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(t):k_(t)}_requestAnimationFrame(t){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(t):B_(t)}_renderFrame(...t){if(this.display){this.display._renderFrame(...t);return}this.onRender(...t)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){const{width:t,height:e,aspect:i}=this._getSizeAndAspect();(t!==this.animationProps.width||e!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(t){typeof t=="object"&&t!==null&&(this.animationProps=Object.assign({},this.animationProps,t))}_createWebGLContext(t){if(this.offScreen=t.canvas&&typeof OffscreenCanvas!="undefined"&&t.canvas instanceof OffscreenCanvas,t=Object.assign({},t,this.props.glOptions),this.gl=this.props.gl?Ps(this.props.gl,t):this.onCreateContext(t),!zi(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");S_(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){const t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";const e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",t.appendChild(this.gl.canvas),t.appendChild(e);const i=this.props.onAddHTML(e);i&&(e.innerHTML=i)}}_getSizeAndAspect(){const t=this.gl.drawingBufferWidth,e=this.gl.drawingBufferHeight;let i=1;const{canvas:r}=this.gl;return r&&r.clientHeight?i=r.clientWidth/r.clientHeight:t>0&&e>0&&(i=t/e),{width:t,height:e,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&M_(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new ct(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){const{canvas:t}=this.gl;t&&(t.addEventListener("mousemove",this._onMousemove),t.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(t){this.animationProps._mousePosition=[t.offsetX,t.offsetY]}_onMouseleave(t){this.animationProps._mousePosition=null}}const Xn="vs",zs="fs";function Lt(n,t){if(!n)throw new Error(t||"shadertools: assertion failed.")}const js={number:{validate(n,t){return Number.isFinite(n)&&(!("max"in t)||n<=t.max)&&(!("min"in t)||n>=t.min)}},array:{validate(n,t){return Array.isArray(n)||ArrayBuffer.isView(n)}}};function Cb(n){const t={};for(const e in n){const i=n[e],r=Nb(i);t[e]=r}return t}function Nb(n){let t=Pl(n);return t==="object"?n?"type"in n?Object.assign({},n,js[n.type]):"value"in n?(t=Pl(n.value),Object.assign({type:t},n,js[t])):{type:"object",value:n}:{type:"object",value:null}:Object.assign({type:t,value:n},js[t])}function Pl(n){return Array.isArray(n)||ArrayBuffer.isView(n)?"array":typeof n}const Db="vs",Fb="fs";class xl{constructor({name:t,vs:e,fs:i,dependencies:r=[],uniforms:s,getUniforms:o,deprecations:a=[],defines:c={},inject:l={},vertexShader:u,fragmentShader:h}){Lt(typeof t=="string"),this.name=t,this.vs=e||u,this.fs=i||h,this.getModuleUniforms=o,this.dependencies=r,this.deprecations=this._parseDeprecationDefinitions(a),this.defines=c,this.injections=Ub(l),s&&(this.uniforms=Cb(s))}getModuleSource(t){let e;switch(t){case Db:e=this.vs||"";break;case Fb:e=this.fs||"";break;default:Lt(!1)}return`#define MODULE_${this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_")}
${e}// END MODULE_${this.name}

`}getUniforms(t,e){return this.getModuleUniforms?this.getModuleUniforms(t,e):this.uniforms?this._defaultGetUniforms(t):{}}getDefines(){return this.defines}checkDeprecations(t,e){this.deprecations.forEach(i=>{i.regex.test(t)&&(i.deprecated?e.deprecated(i.old,i.new)():e.removed(i.old,i.new)())})}_parseDeprecationDefinitions(t){return t.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),t}_defaultGetUniforms(t={}){const e={},i=this.uniforms;for(const r in i){const s=i[r];r in t&&!s.private?(s.validate&&Lt(s.validate(t[r],s),`${this.name}: invalid ${r}`),e[r]=t[r]):e[r]=s.value}return e}}function Ub(n){const t={vs:{},fs:{}};for(const e in n){let i=n[e];const r=e.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),t[r][e]=i}return t}function Bb(n){return kb(Ml(n))}function kb(n){const t={},e={};return Ll({modules:n,level:0,moduleMap:t,moduleDepth:e}),Object.keys(e).sort((i,r)=>e[r]-e[i]).map(i=>t[i])}function Ll({modules:n,level:t,moduleMap:e,moduleDepth:i}){if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const r of n)e[r.name]=r,(i[r.name]===void 0||i[r.name]<t)&&(i[r.name]=t);for(const r of n)r.dependencies&&Ll({modules:r.dependencies,level:t+1,moduleMap:e,moduleDepth:i})}function Ml(n,t){return n.map(e=>(e instanceof xl||(Lt(typeof e!="string",`Shader module use by name is deprecated. Import shader module '${e}' and use it directly.`),Lt(e.name,"shader module has no name"),e=new xl(e),e.dependencies=Ml(e.dependencies)),e))}function Vb(n={}){const t=typeof window!="undefined"?window.navigator||{}:{},e=n.userAgent||t.userAgent||"",i=e.indexOf("MSIE ")!==-1,r=e.indexOf("Trident/")!==-1;return i||r}const zb=7936,jb=7937,Gb=7938,$b=35724,Gs={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},Ne={};Object.keys(Gs).forEach(n=>{Ne[n]=n});function Hb(n){return typeof WebGL2RenderingContext!="undefined"&&n instanceof WebGL2RenderingContext?!0:Boolean(n&&n._version===2)}function Wb(n){const t=n.getExtension("WEBGL_debug_renderer_info"),e=n.getParameter(t&&t.UNMASKED_VENDOR_WEBGL||zb),i=n.getParameter(t&&t.UNMASKED_RENDERER_WEBGL||jb);return{gpuVendor:qb(e,i),vendor:e,renderer:i,version:n.getParameter(Gb),shadingLanguageVersion:n.getParameter($b)}}function qb(n,t){return n.match(/NVIDIA/i)||t.match(/NVIDIA/i)?"NVIDIA":n.match(/INTEL/i)||t.match(/INTEL/i)?"INTEL":n.match(/AMD/i)||t.match(/AMD/i)||n.match(/ATI/i)||t.match(/ATI/i)?"AMD":"UNKNOWN GPU"}const $s={};function Rl(n,t,e={}){const i=Gs[t];if(Lt(i,t),!Vb(e))return!0;if(t in $s)return $s[t];const r=i[0],s=e.behavior||"enable",o=`#extension GL_${r} : ${s}
void main(void) {}`,a=n.createShader(35633);n.shaderSource(a,o),n.compileShader(a);const c=n.getShaderParameter(a,35713);return n.deleteShader(a),$s[t]=c,c}function Yb(n,t){const e=Gs[t];Lt(e,t);const i=Hb(n)&&e[1]||e[0],r=typeof i=="string"?Boolean(n.getExtension(i)):i;return Lt(r===!1||r===!0),r}function Zi(n,t){return t=Array.isArray(t)?t:[t],t.every(e=>Yb(n,e))}function Xb(n){switch(Wb(n).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function Zb(n,t,e){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return Zi(n,Ne.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),Zi(n,Ne.GLSL_DERIVATIVES)&&Rl(n,Ne.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),Zi(n,Ne.GLSL_FRAG_DATA)&&Rl(n,Ne.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),Zi(n,Ne.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}const Kb=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,Qb=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,Jb={[Xn]:Kb,[zs]:Qb},Ki="__LUMA_INJECT_DECLARATIONS__",Ol=/void\s+main\s*\([^)]*\)\s*\{\n?/,Cl=/}\n?[^{}]*$/,Hs=[];function Nl(n,t,e,i=!1){const r=t===Xn;for(const s in e){const o=e[s];o.sort((c,l)=>c.order-l.order),Hs.length=o.length;for(let c=0,l=o.length;c<l;++c)Hs[c]=o[c].injection;const a=`${Hs.join(`
`)}
`;switch(s){case"vs:#decl":r&&(n=n.replace(Ki,a));break;case"vs:#main-start":r&&(n=n.replace(Ol,c=>c+a));break;case"vs:#main-end":r&&(n=n.replace(Cl,c=>a+c));break;case"fs:#decl":r||(n=n.replace(Ki,a));break;case"fs:#main-start":r||(n=n.replace(Ol,c=>c+a));break;case"fs:#main-end":r||(n=n.replace(Cl,c=>a+c));break;default:n=n.replace(s,c=>c+a)}}return n=n.replace(Ki,""),i&&(n=n.replace(/\}\s*$/,s=>s+Jb[t])),n}function Ws(n){const t={};return Lt(Array.isArray(n)&&n.length>1),n.forEach(e=>{for(const i in e)t[i]=t[i]?`${t[i]}
${e[i]}`:e[i]}),t}function Ke(n){return new RegExp(`\\b${n}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}const Dl=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],ty=[...Dl,[Ke("attribute"),"in $1"],[Ke("varying"),"out $1"]],ey=[...Dl,[Ke("varying"),"in $1"]],Fl=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],ny=[...Fl,[Ke("in"),"attribute $1"],[Ke("out"),"varying $1"]],iy=[...Fl,[Ke("in"),"varying $1"]],qs="gl_FragColor",Ys=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,ry=/void\s+main\s*\([^)]*\)\s*\{\n?/;function sy(n,t,e){switch(t){case 300:return e?Qi(n,ty):oy(n);case 100:return e?Qi(n,ny):ay(n);default:throw new Error(`unknown GLSL version ${t}`)}}function Qi(n,t){for(const[e,i]of t)n=n.replace(e,i);return n}function oy(n){n=Qi(n,ey);const t=n.match(Ys);if(t){const e=t[1];n=n.replace(new RegExp(`\\b${qs}\\b`,"g"),e)}else{const e="fragmentColor";n=n.replace(ry,i=>`out vec4 ${e};
${i}`).replace(new RegExp(`\\b${qs}\\b`,"g"),e)}return n}function ay(n){n=Qi(n,iy);const t=n.match(Ys);if(t){const e=t[1];n=n.replace(Ys,"").replace(new RegExp(`\\b${e}\\b`,"g"),qs)}return n}const cy=`

${Ki}

`,Ul={[Xn]:"vertex",[zs]:"fragment"},ly=`precision highp float;

`;function uy(n,t){const{vs:e,fs:i}=t,r=Bb(t.modules||[]);return{gl:n,vs:Bl(n,Object.assign({},t,{source:e,type:Xn,modules:r})),fs:Bl(n,Object.assign({},t,{source:i,type:zs,modules:r})),getUniforms:hy(r)}}function Bl(n,{id:t,source:e,type:i,modules:r,defines:s={},hookFunctions:o=[],inject:a={},transpileToGLSL100:c=!1,prologue:l=!0,log:u}){Lt(typeof e=="string","shader source must be a string");const h=i===Xn,f=e.split(`
`);let g=100,m="",_=e;f[0].indexOf("#version ")===0?(g=300,m=f[0],_=f.slice(1).join(`
`)):m=`#version ${g}`;const T={};r.forEach(x=>{Object.assign(T,x.getDefines())}),Object.assign(T,s);let v=l?`${m}
${dy({id:t,source:e,type:i})}
${fy({type:i})}
${Xb(n)}
${Zb(n)}
${gy(T)}
${h?"":ly}
`:`${m}
`;const S=my(o),y={},P={},L={};for(const x in a){const N=typeof a[x]=="string"?{injection:a[x],order:0}:a[x],U=x.match(/^(v|f)s:(#)?([\w-]+)$/);if(U){const C=U[2],B=U[3];C?B==="decl"?P[x]=[N]:L[x]=[N]:y[x]=[N]}else L[x]=[N]}for(const x of r){u&&x.checkDeprecations(_,u),v+=x.getModuleSource(i,g);const U=x.injections[i];for(const C in U){const B=C.match(/^(v|f)s:#([\w-]+)$/);if(B){const z=B[2]==="decl"?P:L;z[C]=z[C]||[],z[C].push(U[C])}else y[C]=y[C]||[],y[C].push(U[C])}}return v+=cy,v=Nl(v,i,P),v+=py(S[i],y),v+=_,v=Nl(v,i,L),v=sy(v,c?100:g,h),v}function hy(n){return function(e){const i={};for(const r of n){const s=r.getUniforms(e,i);Object.assign(i,s)}return i}}function fy({type:n}){return`
#define SHADER_TYPE_${Ul[n].toUpperCase()}
`}function dy({id:n,source:t,type:e}){return n&&typeof n=="string"&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${n}_${Ul[e]}

`:""}function gy(n={}){let t=0,e="";for(const i in n){t===0&&(e+=`
// APPLICATION DEFINES
`),t++;const r=n[i];(r||Number.isFinite(r))&&(e+=`#define ${i.toUpperCase()} ${n[i]}
`)}return t===0&&(e+=`
`),e}function py(n,t){let e="";for(const i in n){const r=n[i];if(e+=`void ${r.signature} {
`,r.header&&(e+=`  ${r.header}`),t[i]){const s=t[i];s.sort((o,a)=>o.order-a.order);for(const o of s)e+=`  ${o.injection}
`}r.footer&&(e+=`  ${r.footer}`),e+=`}
`}return e}function my(n){const t={vs:{},fs:{}};return n.forEach(e=>{let i;typeof e!="string"?(i=e,e=i.hook):i={},e=e.trim();const[r,s]=e.split(":"),o=e.replace(/\(.+/,"");t[r][o]=Object.assign(i,{signature:s})}),t}const _y="void main() {gl_FragColor = vec4(0);}",kl=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,by=`#version 300 es
${kl}`;function Vl(n,t){t=Array.isArray(t)?t:[t];const e=n.replace(/^\s+/,"").split(/\s+/),[i,r,s]=e;if(!t.includes(i)||!r||!s)return null;const o=s.split(";")[0];return{qualifier:i,type:r,name:o}}function zl(n={}){const{version:t=100,input:e,inputType:i,output:r}=n;if(!e)return t===300?by:t>300?`#version ${t}
${kl}`:_y;const s=Ey(e,i);return t>=300?`#version ${t} ${t===300?"es":""}
in ${i} ${e};
out vec4 ${r};
void main() {
  ${r} = ${s};
}`:`varying ${i} ${e};
void main() {
  gl_FragColor = ${s};
}`}function yy(n){switch(n){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Lt(!1),null}}function Ty(n){switch(n){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Lt(!1),null}}function Ey(n,t){switch(t){case"float":return`vec4(${n}, 0.0, 0.0, 1.0)`;case"vec2":return`vec4(${n}, 0.0, 1.0)`;case"vec3":return`vec4(${n}, 1.0)`;case"vec4":return n;default:return Lt(!1),null}}const vy=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,Ay={name:"fp32",vs:vy,fs:null};function rt(n,t){if(!n)throw new Error("math.gl assertion ".concat(t))}const wy=1/Math.PI*180,Sy=1/180*Math.PI,nt={};nt.EPSILON=1e-12;nt.debug=!1;nt.precision=4;nt.printTypes=!1;nt.printDegrees=!1;nt.printRowMajor=!0;function Iy(n){return Math.round(n/nt.EPSILON)*nt.EPSILON}function Py(n,{precision:t=nt.precision||4}={}){return n=Iy(n),"".concat(parseFloat(n.toPrecision(t)))}function ge(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}function xy(n){return n.clone?n.clone():new Array(n.length)}function Xs(n,t,e){if(ge(n)){e=e||xy(n);for(let i=0;i<e.length&&i<n.length;++i)e[i]=t(n[i],i,e);return e}return t(n)}function Zs(n){return My(n)}function Ly(n){return Zn(n)}function My(n,t){return Xs(n,e=>e*Sy,t)}function Zn(n,t){return Xs(n,e=>e*wy,t)}function Kn(n,t,e){return Xs(n,i=>Math.max(t,Math.min(e,i)))}function Ji(n,t,e){return ge(n)?n.map((i,r)=>Ji(i,t[r],e)):e*t+(1-e)*n}function $t(n,t,e){const i=nt.EPSILON;e&&(nt.EPSILON=e);try{if(n===t)return!0;if(ge(n)&&ge(t)){if(n.length!==t.length)return!1;for(let r=0;r<n.length;++r)if(!$t(n[r],t[r]))return!1;return!0}return n&&n.equals?n.equals(t):t&&t.equals?t.equals(n):Number.isFinite(n)&&Number.isFinite(t)?Math.abs(n-t)<=nt.EPSILON*Math.max(1,Math.abs(n),Math.abs(t)):!1}finally{nt.EPSILON=i}}function Ry(n){function t(){var e=Reflect.construct(n,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return t.prototype=Object.create(n.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n,t}class Ks extends Ry(Array){get ELEMENTS(){return rt(!1),0}clone(){return new this.constructor().copy(this)}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}fromArray(t,e=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=t[i+e];return this.check()}to(t){return t===this?this:ge(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toArray(t=[],e=0){for(let i=0;i<this.ELEMENTS;++i)t[e+i]=this[i];return t}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(nt)}formatString(t){let e="";for(let i=0;i<this.ELEMENTS;++i)e+=(i>0?", ":"")+Py(this[i],t);return"".concat(t.printTypes?this.constructor.name:"","[").concat(e,"]")}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!$t(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,i){i===void 0&&(i=e,e=t,t=this);for(let r=0;r<this.ELEMENTS;++r){const s=t[r];this[r]=s+i*(e[r]-s)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],t[i]),e[i]);return this.check()}add(...t){for(const e of t)for(let i=0;i<this.ELEMENTS;++i)this[i]+=e[i];return this.check()}subtract(...t){for(const e of t)for(let i=0;i<this.ELEMENTS;++i)this[i]-=e[i];return this.check()}scale(t){if(Array.isArray(t))return this.multiply(t);for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.scale(1/t)}clampScalar(t,e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],t),e);return this.check()}multiplyByScalar(t){return this.scale(t)}get elements(){return this}check(){if(nt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}}function Oy(n,t){if(n.length!==t)return!1;for(let e=0;e<n.length;++e)if(!Number.isFinite(n[e]))return!1;return!0}function st(n){if(!Number.isFinite(n))throw new Error("Invalid number ".concat(n));return n}function Qn(n,t,e=""){if(nt.debug&&!Oy(n,t))throw new Error("math.gl: ".concat(e," some fields set to invalid numbers'"));return n}const jl={};function Qe(n,t){jl[n]||(jl[n]=!0,console.warn("".concat(n," has been removed in version ").concat(t,", see upgrade guide for more information")))}class Gl extends Ks{get ELEMENTS(){return rt(!1),0}copy(t){return rt(!1),this}get x(){return this[0]}set x(t){this[0]=st(t)}get y(){return this[1]}set y(t){this[1]=st(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let i=0;i<this.ELEMENTS;++i){const r=this[i]-t[i];e+=r*r}return st(e)}dot(t){let e=0;for(let i=0;i<this.ELEMENTS;++i)e+=this[i]*t[i];return st(e)}normalize(){const t=this.magnitude();if(t!==0)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let i=0;i<this.ELEMENTS;++i)this[i]*=e[i];return this.check()}divide(...t){for(const e of t)for(let i=0;i<this.ELEMENTS;++i)this[i]/=e[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return rt(t>=0&&t<this.ELEMENTS,"index is out of range"),st(this[t])}setComponent(t,e){return rt(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}var Jn=1e-6,Ht=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function Cy(){var n=new Ht(2);return Ht!=Float32Array&&(n[0]=0,n[1]=0),n}function Ny(n,t,e){var i=t[0],r=t[1];return n[0]=e[0]*i+e[2]*r,n[1]=e[1]*i+e[3]*r,n}function Dy(n,t,e){var i=t[0],r=t[1];return n[0]=e[0]*i+e[2]*r+e[4],n[1]=e[1]*i+e[3]*r+e[5],n}function $l(n,t,e){var i=t[0],r=t[1];return n[0]=e[0]*i+e[3]*r+e[6],n[1]=e[1]*i+e[4]*r+e[7],n}function Hl(n,t,e){var i=t[0],r=t[1];return n[0]=e[0]*i+e[4]*r+e[12],n[1]=e[1]*i+e[5]*r+e[13],n}(function(){var n=Cy();return function(t,e,i,r,s,o){var a,c;for(e||(e=2),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();function Wl(n,t,e){const i=t[0],r=t[1],s=e[3]*i+e[7]*r||1;return n[0]=(e[0]*i+e[4]*r)/s,n[1]=(e[1]*i+e[5]*r)/s,n}function ql(n,t,e){const i=t[0],r=t[1],s=t[2],o=e[3]*i+e[7]*r+e[11]*s||1;return n[0]=(e[0]*i+e[4]*r+e[8]*s)/o,n[1]=(e[1]*i+e[5]*r+e[9]*s)/o,n[2]=(e[2]*i+e[6]*r+e[10]*s)/o,n}function Fy(n,t,e){const i=t[0],r=t[1];return n[0]=e[0]*i+e[2]*r,n[1]=e[1]*i+e[3]*r,n[2]=t[2],n}function Uy(n,t,e){const i=t[0],r=t[1],s=t[2];return n[0]=e[0]*i+e[3]*r+e[6]*s,n[1]=e[1]*i+e[4]*r+e[7]*s,n[2]=e[2]*i+e[5]*r+e[8]*s,n[3]=t[3],n}class Qs extends Gl{constructor(t=0,e=0){super(2);ge(t)&&arguments.length===1?this.copy(t):(nt.debug&&(st(t),st(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return nt.debug&&(st(t.x),st(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Hl(this,this,t),this.check()}transformAsVector(t){return Wl(this,this,t),this.check()}transformByMatrix3(t){return $l(this,this,t),this.check()}transformByMatrix2x3(t){return Dy(this,this,t),this.check()}transformByMatrix2(t){return Ny(this,this,t),this.check()}}function Yl(){var n=new Ht(3);return Ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function By(n){var t=n[0],e=n[1],i=n[2];return Math.hypot(t,e,i)}function Xl(n,t,e){var i=new Ht(3);return i[0]=n,i[1]=t,i[2]=e,i}function ky(n,t){var e=t[0],i=t[1],r=t[2],s=e*e+i*i+r*r;return s>0&&(s=1/Math.sqrt(s)),n[0]=t[0]*s,n[1]=t[1]*s,n[2]=t[2]*s,n}function Zl(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function tr(n,t,e){var i=t[0],r=t[1],s=t[2],o=e[0],a=e[1],c=e[2];return n[0]=r*c-s*a,n[1]=s*o-i*c,n[2]=i*a-r*o,n}function Kl(n,t,e){var i=t[0],r=t[1],s=t[2],o=e[3]*i+e[7]*r+e[11]*s+e[15];return o=o||1,n[0]=(e[0]*i+e[4]*r+e[8]*s+e[12])/o,n[1]=(e[1]*i+e[5]*r+e[9]*s+e[13])/o,n[2]=(e[2]*i+e[6]*r+e[10]*s+e[14])/o,n}function Ql(n,t,e){var i=t[0],r=t[1],s=t[2];return n[0]=i*e[0]+r*e[3]+s*e[6],n[1]=i*e[1]+r*e[4]+s*e[7],n[2]=i*e[2]+r*e[5]+s*e[8],n}function Vy(n,t,e){var i=e[0],r=e[1],s=e[2],o=e[3],a=t[0],c=t[1],l=t[2],u=r*l-s*c,h=s*a-i*l,f=i*c-r*a,g=r*f-s*h,m=s*u-i*f,_=i*h-r*u,T=o*2;return u*=T,h*=T,f*=T,g*=2,m*=2,_*=2,n[0]=a+u+g,n[1]=c+h+m,n[2]=l+f+_,n}function zy(n,t,e,i){var r=[],s=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],s[0]=r[0],s[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),s[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function jy(n,t,e,i){var r=[],s=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],s[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),s[1]=r[1],s[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function Gy(n,t,e,i){var r=[],s=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],s[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),s[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),s[2]=r[2],n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function $y(n,t){var e=n[0],i=n[1],r=n[2],s=t[0],o=t[1],a=t[2],c=Math.sqrt(e*e+i*i+r*r),l=Math.sqrt(s*s+o*o+a*a),u=c*l,h=u&&Zl(n,t)/u;return Math.acos(Math.min(Math.max(h,-1),1))}var Hy=By;(function(){var n=Yl();return function(t,e,i,r,s,o){var a,c;for(e||(e=3),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();const Js=[0,0,0],Jl={};class I extends Gl{static get ZERO(){return Jl.ZERO=Jl.ZERO||Object.freeze(new I(0,0,0,0))}constructor(t=0,e=0,i=0){super(-0,-0,-0);arguments.length===1&&ge(t)?this.copy(t):(nt.debug&&(st(t),st(e),st(i)),this[0]=t,this[1]=e,this[2]=i)}set(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return nt.debug&&(st(t.x),st(t.y),st(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=st(t)}angle(t){return $y(this,t)}cross(t){return tr(this,this,t),this.check()}rotateX({radians:t,origin:e=Js}){return zy(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Js}){return jy(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Js}){return Gy(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Kl(this,this,t),this.check()}transformAsVector(t){return ql(this,this,t),this.check()}transformByMatrix3(t){return Ql(this,this,t),this.check()}transformByMatrix2(t){return Fy(this,this,t),this.check()}transformByQuaternion(t){return Vy(this,this,t),this.check()}}class tu extends Ks{get ELEMENTS(){return rt(!1),0}get RANK(){return rt(!1),0}toString(){let t="[";if(nt.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let i=0;i<this.RANK;++i)t+=" ".concat(this[i*this.RANK+e])}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=" ".concat(this[e])}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,i){return this[e*this.RANK+t]=st(i),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const i=t*this.RANK;for(let r=0;r<this.RANK;++r)e[r]=this[i+r];return e}setColumn(t,e){const i=t*this.RANK;for(let r=0;r<this.RANK;++r)this[i+r]=e[r];return this}}function Wy(){var n=new Ht(9);return Ht!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function qy(n,t){if(n===t){var e=t[1],i=t[2],r=t[5];n[1]=t[3],n[2]=t[6],n[3]=e,n[5]=t[7],n[6]=i,n[7]=r}else n[0]=t[0],n[1]=t[3],n[2]=t[6],n[3]=t[1],n[4]=t[4],n[5]=t[7],n[6]=t[2],n[7]=t[5],n[8]=t[8];return n}function Yy(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=u*o-a*l,f=-u*s+a*c,g=l*s-o*c,m=e*h+i*f+r*g;return m?(m=1/m,n[0]=h*m,n[1]=(-u*i+r*l)*m,n[2]=(a*i-r*o)*m,n[3]=f*m,n[4]=(u*e-r*c)*m,n[5]=(-a*e+r*s)*m,n[6]=g*m,n[7]=(-l*e+i*c)*m,n[8]=(o*e-i*s)*m,n):null}function Xy(n){var t=n[0],e=n[1],i=n[2],r=n[3],s=n[4],o=n[5],a=n[6],c=n[7],l=n[8];return t*(l*s-o*c)+e*(-l*r+o*a)+i*(c*r-s*a)}function eu(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=e[0],g=e[1],m=e[2],_=e[3],T=e[4],v=e[5],S=e[6],y=e[7],P=e[8];return n[0]=f*i+g*o+m*l,n[1]=f*r+g*a+m*u,n[2]=f*s+g*c+m*h,n[3]=_*i+T*o+v*l,n[4]=_*r+T*a+v*u,n[5]=_*s+T*c+v*h,n[6]=S*i+y*o+P*l,n[7]=S*r+y*a+P*u,n[8]=S*s+y*c+P*h,n}function Zy(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=e[0],g=e[1];return n[0]=i,n[1]=r,n[2]=s,n[3]=o,n[4]=a,n[5]=c,n[6]=f*i+g*o+l,n[7]=f*r+g*a+u,n[8]=f*s+g*c+h,n}function Ky(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=Math.sin(e),g=Math.cos(e);return n[0]=g*i+f*o,n[1]=g*r+f*a,n[2]=g*s+f*c,n[3]=g*o-f*i,n[4]=g*a-f*r,n[5]=g*c-f*s,n[6]=l,n[7]=u,n[8]=h,n}function nu(n,t,e){var i=e[0],r=e[1];return n[0]=i*t[0],n[1]=i*t[1],n[2]=i*t[2],n[3]=r*t[3],n[4]=r*t[4],n[5]=r*t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n}function Qy(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=e+e,a=i+i,c=r+r,l=e*o,u=i*o,h=i*a,f=r*o,g=r*a,m=r*c,_=s*o,T=s*a,v=s*c;return n[0]=1-h-m,n[3]=u-v,n[6]=f+T,n[1]=u+v,n[4]=1-l-m,n[7]=g-_,n[2]=f-T,n[5]=g+_,n[8]=1-l-h,n}const iu=Object.freeze([1,0,0,0,1,0,0,0,1]),Jy=Object.freeze([0,0,0,0,0,0,0,0,0]),tT=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL1ROW0:3,COL1ROW1:4,COL1ROW2:5,COL2ROW0:6,COL2ROW1:7,COL2ROW2:8}),Je={};class dt extends tu{static get IDENTITY(){return Je.IDENTITY=Je.IDENTITY||Object.freeze(new dt(iu)),Je.IDENTITY}static get ZERO(){return Je.ZERO=Je.ZERO||Object.freeze(new dt(Jy)),Je.ZERO}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return tT}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this.check()}set(t,e,i,r,s,o,a,c,l){return this[0]=t,this[1]=e,this[2]=i,this[3]=r,this[4]=s,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this.check()}setRowMajor(t,e,i,r,s,o,a,c,l){return this[0]=t,this[1]=r,this[2]=a,this[3]=e,this[4]=s,this[5]=c,this[6]=i,this[7]=o,this[8]=l,this.check()}determinant(){return Xy(this)}identity(){return this.copy(iu)}fromQuaternion(t){return Qy(this,t),this.check()}transpose(){return qy(this,this),this.check()}invert(){return Yy(this,this),this.check()}multiplyLeft(t){return eu(this,t,this),this.check()}multiplyRight(t){return eu(this,this,t),this.check()}rotate(t){return Ky(this,this,t),this.check()}scale(t){return Array.isArray(t)?nu(this,this,t):nu(this,this,[t,t,t]),this.check()}translate(t){return Zy(this,this,t),this.check()}transform(t,e){switch(t.length){case 2:e=$l(e||[-0,-0],t,this);break;case 3:e=Ql(e||[-0,-0,-0],t,this);break;case 4:e=Uy(e||[-0,-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return Qn(e,t.length),e}transformVector(t,e){return Qe("Matrix3.transformVector"),this.transform(t,e)}transformVector2(t,e){return Qe("Matrix3.transformVector"),this.transform(t,e)}transformVector3(t,e){return Qe("Matrix3.transformVector"),this.transform(t,e)}}function eT(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function nT(n,t){if(n===t){var e=t[1],i=t[2],r=t[3],s=t[6],o=t[7],a=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=e,n[6]=t[9],n[7]=t[13],n[8]=i,n[9]=s,n[11]=t[14],n[12]=r,n[13]=o,n[14]=a}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n}function iT(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],f=t[10],g=t[11],m=t[12],_=t[13],T=t[14],v=t[15],S=e*a-i*o,y=e*c-r*o,P=e*l-s*o,L=i*c-r*a,x=i*l-s*a,N=r*l-s*c,U=u*_-h*m,C=u*T-f*m,B=u*v-g*m,V=h*T-f*_,z=h*v-g*_,Y=f*v-g*T,R=S*Y-y*z+P*V+L*B-x*C+N*U;return R?(R=1/R,n[0]=(a*Y-c*z+l*V)*R,n[1]=(r*z-i*Y-s*V)*R,n[2]=(_*N-T*x+v*L)*R,n[3]=(f*x-h*N-g*L)*R,n[4]=(c*B-o*Y-l*C)*R,n[5]=(e*Y-r*B+s*C)*R,n[6]=(T*P-m*N-v*y)*R,n[7]=(u*N-f*P+g*y)*R,n[8]=(o*z-a*B+l*U)*R,n[9]=(i*B-e*z-s*U)*R,n[10]=(m*x-_*P+v*S)*R,n[11]=(h*P-u*x-g*S)*R,n[12]=(a*C-o*V-c*U)*R,n[13]=(e*V-i*C+r*U)*R,n[14]=(_*y-m*L-T*S)*R,n[15]=(u*L-h*y+f*S)*R,n):null}function rT(n){var t=n[0],e=n[1],i=n[2],r=n[3],s=n[4],o=n[5],a=n[6],c=n[7],l=n[8],u=n[9],h=n[10],f=n[11],g=n[12],m=n[13],_=n[14],T=n[15],v=t*o-e*s,S=t*a-i*s,y=t*c-r*s,P=e*a-i*o,L=e*c-r*o,x=i*c-r*a,N=l*m-u*g,U=l*_-h*g,C=l*T-f*g,B=u*_-h*m,V=u*T-f*m,z=h*T-f*_;return v*z-S*V+y*B+P*C-L*U+x*N}function ru(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=t[9],g=t[10],m=t[11],_=t[12],T=t[13],v=t[14],S=t[15],y=e[0],P=e[1],L=e[2],x=e[3];return n[0]=y*i+P*a+L*h+x*_,n[1]=y*r+P*c+L*f+x*T,n[2]=y*s+P*l+L*g+x*v,n[3]=y*o+P*u+L*m+x*S,y=e[4],P=e[5],L=e[6],x=e[7],n[4]=y*i+P*a+L*h+x*_,n[5]=y*r+P*c+L*f+x*T,n[6]=y*s+P*l+L*g+x*v,n[7]=y*o+P*u+L*m+x*S,y=e[8],P=e[9],L=e[10],x=e[11],n[8]=y*i+P*a+L*h+x*_,n[9]=y*r+P*c+L*f+x*T,n[10]=y*s+P*l+L*g+x*v,n[11]=y*o+P*u+L*m+x*S,y=e[12],P=e[13],L=e[14],x=e[15],n[12]=y*i+P*a+L*h+x*_,n[13]=y*r+P*c+L*f+x*T,n[14]=y*s+P*l+L*g+x*v,n[15]=y*o+P*u+L*m+x*S,n}function sT(n,t,e){var i=e[0],r=e[1],s=e[2],o,a,c,l,u,h,f,g,m,_,T,v;return t===n?(n[12]=t[0]*i+t[4]*r+t[8]*s+t[12],n[13]=t[1]*i+t[5]*r+t[9]*s+t[13],n[14]=t[2]*i+t[6]*r+t[10]*s+t[14],n[15]=t[3]*i+t[7]*r+t[11]*s+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],u=t[4],h=t[5],f=t[6],g=t[7],m=t[8],_=t[9],T=t[10],v=t[11],n[0]=o,n[1]=a,n[2]=c,n[3]=l,n[4]=u,n[5]=h,n[6]=f,n[7]=g,n[8]=m,n[9]=_,n[10]=T,n[11]=v,n[12]=o*i+u*r+m*s+t[12],n[13]=a*i+h*r+_*s+t[13],n[14]=c*i+f*r+T*s+t[14],n[15]=l*i+g*r+v*s+t[15]),n}function su(n,t,e){var i=e[0],r=e[1],s=e[2];return n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n[3]=t[3]*i,n[4]=t[4]*r,n[5]=t[5]*r,n[6]=t[6]*r,n[7]=t[7]*r,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function oT(n,t,e,i){var r=i[0],s=i[1],o=i[2],a=Math.hypot(r,s,o),c,l,u,h,f,g,m,_,T,v,S,y,P,L,x,N,U,C,B,V,z,Y,R,Dt;return a<Jn?null:(a=1/a,r*=a,s*=a,o*=a,c=Math.sin(e),l=Math.cos(e),u=1-l,h=t[0],f=t[1],g=t[2],m=t[3],_=t[4],T=t[5],v=t[6],S=t[7],y=t[8],P=t[9],L=t[10],x=t[11],N=r*r*u+l,U=s*r*u+o*c,C=o*r*u-s*c,B=r*s*u-o*c,V=s*s*u+l,z=o*s*u+r*c,Y=r*o*u+s*c,R=s*o*u-r*c,Dt=o*o*u+l,n[0]=h*N+_*U+y*C,n[1]=f*N+T*U+P*C,n[2]=g*N+v*U+L*C,n[3]=m*N+S*U+x*C,n[4]=h*B+_*V+y*z,n[5]=f*B+T*V+P*z,n[6]=g*B+v*V+L*z,n[7]=m*B+S*V+x*z,n[8]=h*Y+_*R+y*Dt,n[9]=f*Y+T*R+P*Dt,n[10]=g*Y+v*R+L*Dt,n[11]=m*Y+S*R+x*Dt,t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n)}function aT(n,t,e){var i=Math.sin(e),r=Math.cos(e),s=t[4],o=t[5],a=t[6],c=t[7],l=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=s*r+l*i,n[5]=o*r+u*i,n[6]=a*r+h*i,n[7]=c*r+f*i,n[8]=l*r-s*i,n[9]=u*r-o*i,n[10]=h*r-a*i,n[11]=f*r-c*i,n}function cT(n,t,e){var i=Math.sin(e),r=Math.cos(e),s=t[0],o=t[1],a=t[2],c=t[3],l=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*r-l*i,n[1]=o*r-u*i,n[2]=a*r-h*i,n[3]=c*r-f*i,n[8]=s*i+l*r,n[9]=o*i+u*r,n[10]=a*i+h*r,n[11]=c*i+f*r,n}function lT(n,t,e){var i=Math.sin(e),r=Math.cos(e),s=t[0],o=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*r+l*i,n[1]=o*r+u*i,n[2]=a*r+h*i,n[3]=c*r+f*i,n[4]=l*r-s*i,n[5]=u*r-o*i,n[6]=h*r-a*i,n[7]=f*r-c*i,n}function uT(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=e+e,a=i+i,c=r+r,l=e*o,u=i*o,h=i*a,f=r*o,g=r*a,m=r*c,_=s*o,T=s*a,v=s*c;return n[0]=1-h-m,n[1]=u+v,n[2]=f-T,n[3]=0,n[4]=u-v,n[5]=1-l-m,n[6]=g+_,n[7]=0,n[8]=f+T,n[9]=g-_,n[10]=1-l-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function hT(n,t,e,i,r,s,o){var a=1/(e-t),c=1/(r-i),l=1/(s-o);return n[0]=s*2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s*2*c,n[6]=0,n[7]=0,n[8]=(e+t)*a,n[9]=(r+i)*c,n[10]=(o+s)*l,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*s*2*l,n[15]=0,n}function fT(n,t,e,i,r){var s=1/Math.tan(t/2),o;return n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,r!=null&&r!==1/0?(o=1/(i-r),n[10]=(r+i)*o,n[14]=2*r*i*o):(n[10]=-1,n[14]=-2*i),n}function dT(n,t,e,i,r,s,o){var a=1/(t-e),c=1/(i-r),l=1/(s-o);return n[0]=-2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*l,n[11]=0,n[12]=(t+e)*a,n[13]=(r+i)*c,n[14]=(o+s)*l,n[15]=1,n}function gT(n,t,e,i){var r,s,o,a,c,l,u,h,f,g,m=t[0],_=t[1],T=t[2],v=i[0],S=i[1],y=i[2],P=e[0],L=e[1],x=e[2];return Math.abs(m-P)<Jn&&Math.abs(_-L)<Jn&&Math.abs(T-x)<Jn?eT(n):(u=m-P,h=_-L,f=T-x,g=1/Math.hypot(u,h,f),u*=g,h*=g,f*=g,r=S*f-y*h,s=y*u-v*f,o=v*h-S*u,g=Math.hypot(r,s,o),g?(g=1/g,r*=g,s*=g,o*=g):(r=0,s=0,o=0),a=h*o-f*s,c=f*r-u*o,l=u*s-h*r,g=Math.hypot(a,c,l),g?(g=1/g,a*=g,c*=g,l*=g):(a=0,c=0,l=0),n[0]=r,n[1]=a,n[2]=u,n[3]=0,n[4]=s,n[5]=c,n[6]=h,n[7]=0,n[8]=o,n[9]=l,n[10]=f,n[11]=0,n[12]=-(r*m+s*_+o*T),n[13]=-(a*m+c*_+l*T),n[14]=-(u*m+h*_+f*T),n[15]=1,n)}function pT(){var n=new Ht(4);return Ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function mT(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n[3]=t[3]+e[3],n}function _T(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}function bT(n){var t=n[0],e=n[1],i=n[2],r=n[3];return Math.hypot(t,e,i,r)}function yT(n){var t=n[0],e=n[1],i=n[2],r=n[3];return t*t+e*e+i*i+r*r}function TT(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=e*e+i*i+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),n[0]=e*o,n[1]=i*o,n[2]=r*o,n[3]=s*o,n}function ET(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]*t[3]}function vT(n,t,e,i){var r=t[0],s=t[1],o=t[2],a=t[3];return n[0]=r+i*(e[0]-r),n[1]=s+i*(e[1]-s),n[2]=o+i*(e[2]-o),n[3]=a+i*(e[3]-a),n}function AT(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3];return n[0]=e[0]*i+e[4]*r+e[8]*s+e[12]*o,n[1]=e[1]*i+e[5]*r+e[9]*s+e[13]*o,n[2]=e[2]*i+e[6]*r+e[10]*s+e[14]*o,n[3]=e[3]*i+e[7]*r+e[11]*s+e[15]*o,n}function wT(n,t,e){var i=t[0],r=t[1],s=t[2],o=e[0],a=e[1],c=e[2],l=e[3],u=l*i+a*s-c*r,h=l*r+c*i-o*s,f=l*s+o*r-a*i,g=-o*i-a*r-c*s;return n[0]=u*l+g*-o+h*-c-f*-a,n[1]=h*l+g*-a+f*-o-u*-c,n[2]=f*l+g*-c+u*-a-h*-o,n[3]=t[3],n}(function(){var n=pT();return function(t,e,i,r,s,o){var a,c;for(e||(e=4),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();const ou=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),ST=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),IT=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),tn={};class $ extends tu{static get IDENTITY(){return tn.IDENTITY=tn.IDENTITY||Object.freeze(new $(ou)),tn.IDENTITY}static get ZERO(){return tn.ZERO=tn.ZERO||Object.freeze(new $(ST)),tn.ZERO}get INDICES(){return IT}get ELEMENTS(){return 16}get RANK(){return 4}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0);arguments.length===1&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,i,r,s,o,a,c,l,u,h,f,g,m,_,T){return this[0]=t,this[1]=e,this[2]=i,this[3]=r,this[4]=s,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=u,this[10]=h,this[11]=f,this[12]=g,this[13]=m,this[14]=_,this[15]=T,this.check()}setRowMajor(t,e,i,r,s,o,a,c,l,u,h,f,g,m,_,T){return this[0]=t,this[1]=s,this[2]=l,this[3]=g,this[4]=e,this[5]=o,this[6]=u,this[7]=m,this[8]=i,this[9]=a,this[10]=h,this[11]=_,this[12]=r,this[13]=c,this[14]=f,this[15]=T,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(ou)}fromQuaternion(t){return uT(this,t),this.check()}frustum({left:t,right:e,bottom:i,top:r,near:s,far:o}){return o===1/0?$._computeInfinitePerspectiveOffCenter(this,t,e,i,r,s):hT(this,t,e,i,r,s,o),this.check()}static _computeInfinitePerspectiveOffCenter(t,e,i,r,s,o){const a=2*o/(i-e),c=2*o/(s-r),l=(i+e)/(i-e),u=(s+r)/(s-r),h=-1,f=-1,g=-2*o;return t[0]=a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=l,t[9]=u,t[10]=h,t[11]=f,t[12]=0,t[13]=0,t[14]=g,t[15]=0,t}lookAt(t,e,i){return arguments.length===1&&({eye:t,center:e,up:i}=t),e=e||[0,0,0],i=i||[0,1,0],gT(this,t,e,i),this.check()}ortho({left:t,right:e,bottom:i,top:r,near:s=.1,far:o=500}){return dT(this,t,e,i,r,s,o),this.check()}orthographic({fovy:t=45*Math.PI/180,aspect:e=1,focalDistance:i=1,near:r=.1,far:s=500}){if(t>Math.PI*2)throw Error("radians");const o=t/2,a=i*Math.tan(o),c=a*e;return new $().ortho({left:-c,right:c,bottom:-a,top:a,near:r,far:s})}perspective({fovy:t=void 0,fov:e=45*Math.PI/180,aspect:i=1,near:r=.1,far:s=500}={}){if(t=t||e,t>Math.PI*2)throw Error("radians");return fT(this,t,i,r,s),this.check()}determinant(){return rT(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const i=this.getScale(e||[-0,-0,-0]),r=1/i[0],s=1/i[1],o=1/i[2];return t[0]=this[0]*r,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=0,t[4]=this[4]*r,t[5]=this[5]*s,t[6]=this[6]*o,t[7]=0,t[8]=this[8]*r,t[9]=this[9]*s,t[10]=this[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t=[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=null){const i=this.getScale(e||[-0,-0,-0]),r=1/i[0],s=1/i[1],o=1/i[2];return t[0]=this[0]*r,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=this[4]*r,t[4]=this[5]*s,t[5]=this[6]*o,t[6]=this[8]*r,t[7]=this[9]*s,t[8]=this[10]*o,t}transpose(){return nT(this,this),this.check()}invert(){return iT(this,this),this.check()}multiplyLeft(t){return ru(this,t,this),this.check()}multiplyRight(t){return ru(this,this,t),this.check()}rotateX(t){return aT(this,this,t),this.check()}rotateY(t){return cT(this,this,t),this.check()}rotateZ(t){return lT(this,this,t),this.check()}rotateXYZ([t,e,i]){return this.rotateX(t).rotateY(e).rotateZ(i)}rotateAxis(t,e){return oT(this,this,t,e),this.check()}scale(t){return Array.isArray(t)?su(this,this,t):su(this,this,[t,t,t]),this.check()}translate(t){return sT(this,this,t),this.check()}transform(t,e){return t.length===4?(e=AT(e||[-0,-0,-0,-0],t,this),Qn(e,4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:i}=t;switch(i){case 2:e=Hl(e||[-0,-0],t,this);break;case 3:e=Kl(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return Qn(e,t.length),e}transformAsVector(t,e){switch(t.length){case 2:e=Wl(e||[-0,-0],t,this);break;case 3:e=ql(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return Qn(e,t.length),e}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,i){return this.identity().translate([t,e,i])}transformPoint(t,e){return Qe("Matrix4.transformPoint","3.0"),this.transformAsPoint(t,e)}transformVector(t,e){return Qe("Matrix4.transformVector","3.0"),this.transformAsPoint(t,e)}transformDirection(t,e){return Qe("Matrix4.transformDirection","3.0"),this.transformAsVector(t,e)}}function au(){var n=new Ht(4);return Ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function PT(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function cu(n,t,e){e=e*.5;var i=Math.sin(e);return n[0]=i*t[0],n[1]=i*t[1],n[2]=i*t[2],n[3]=Math.cos(e),n}function lu(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=e[0],c=e[1],l=e[2],u=e[3];return n[0]=i*u+o*a+r*l-s*c,n[1]=r*u+o*c+s*a-i*l,n[2]=s*u+o*l+i*c-r*a,n[3]=o*u-i*a-r*c-s*l,n}function xT(n,t,e){e*=.5;var i=t[0],r=t[1],s=t[2],o=t[3],a=Math.sin(e),c=Math.cos(e);return n[0]=i*c+o*a,n[1]=r*c+s*a,n[2]=s*c-r*a,n[3]=o*c-i*a,n}function LT(n,t,e){e*=.5;var i=t[0],r=t[1],s=t[2],o=t[3],a=Math.sin(e),c=Math.cos(e);return n[0]=i*c-s*a,n[1]=r*c+o*a,n[2]=s*c+i*a,n[3]=o*c-r*a,n}function MT(n,t,e){e*=.5;var i=t[0],r=t[1],s=t[2],o=t[3],a=Math.sin(e),c=Math.cos(e);return n[0]=i*c+r*a,n[1]=r*c-i*a,n[2]=s*c+o*a,n[3]=o*c-s*a,n}function RT(n,t){var e=t[0],i=t[1],r=t[2];return n[0]=e,n[1]=i,n[2]=r,n[3]=Math.sqrt(Math.abs(1-e*e-i*i-r*r)),n}function er(n,t,e,i){var r=t[0],s=t[1],o=t[2],a=t[3],c=e[0],l=e[1],u=e[2],h=e[3],f,g,m,_,T;return g=r*c+s*l+o*u+a*h,g<0&&(g=-g,c=-c,l=-l,u=-u,h=-h),1-g>Jn?(f=Math.acos(g),m=Math.sin(f),_=Math.sin((1-i)*f)/m,T=Math.sin(i*f)/m):(_=1-i,T=i),n[0]=_*r+T*c,n[1]=_*s+T*l,n[2]=_*o+T*u,n[3]=_*a+T*h,n}function OT(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=e*e+i*i+r*r+s*s,a=o?1/o:0;return n[0]=-e*a,n[1]=-i*a,n[2]=-r*a,n[3]=s*a,n}function CT(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n[3]=t[3],n}function uu(n,t){var e=t[0]+t[4]+t[8],i;if(e>0)i=Math.sqrt(e+1),n[3]=.5*i,i=.5/i,n[0]=(t[5]-t[7])*i,n[1]=(t[6]-t[2])*i,n[2]=(t[1]-t[3])*i;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[r*3+r]&&(r=2);var s=(r+1)%3,o=(r+2)%3;i=Math.sqrt(t[r*3+r]-t[s*3+s]-t[o*3+o]+1),n[r]=.5*i,i=.5/i,n[3]=(t[s*3+o]-t[o*3+s])*i,n[s]=(t[s*3+r]+t[r*3+s])*i,n[o]=(t[o*3+r]+t[r*3+o])*i}return n}var NT=mT,DT=_T,FT=ET,UT=vT,BT=bT,kT=yT,hu=TT,VT=function(){var n=Yl(),t=Xl(1,0,0),e=Xl(0,1,0);return function(i,r,s){var o=Zl(r,s);return o<-.999999?(tr(n,t,r),Hy(n)<1e-6&&tr(n,e,r),ky(n,n),cu(i,n,Math.PI),i):o>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(tr(n,r,s),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=1+o,hu(i,i))}}();(function(){var n=au(),t=au();return function(e,i,r,s,o,a){return er(n,i,o,a),er(t,r,s,a),er(e,n,t,2*a*(1-a)),e}})();(function(){var n=Wy();return function(t,e,i,r){return n[0]=i[0],n[3]=i[1],n[6]=i[2],n[1]=r[0],n[4]=r[1],n[7]=r[2],n[2]=-e[0],n[5]=-e[1],n[8]=-e[2],hu(t,uu(t,n))}})();const zT=[0,0,0,1];class ti extends Ks{constructor(t=0,e=0,i=0,r=1){super(-0,-0,-0,-0);Array.isArray(t)&&arguments.length===1?this.copy(t):this.set(t,e,i,r)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this.check()}set(t,e,i,r){return this[0]=t,this[1]=e,this[2]=i,this[3]=r,this.check()}fromMatrix3(t){return uu(this,t),this.check()}identity(){return PT(this),this.check()}fromAxisRotation(t,e){return cu(this,t,e),this.check()}setAxisAngle(t,e){return this.fromAxisRotation(t,e)}get ELEMENTS(){return 4}get x(){return this[0]}set x(t){this[0]=st(t)}get y(){return this[1]}set y(t){this[1]=st(t)}get z(){return this[2]}set z(t){this[2]=st(t)}get w(){return this[3]}set w(t){this[3]=st(t)}len(){return BT(this)}lengthSquared(){return kT(this)}dot(t,e){if(e!==void 0)throw new Error("Quaternion.dot only takes one argument");return FT(this,t)}rotationTo(t,e){return VT(this,t,e),this.check()}add(t,e){if(e!==void 0)throw new Error("Quaternion.add only takes one argument");return NT(this,this,t),this.check()}calculateW(){return RT(this,this),this.check()}conjugate(){return CT(this,this),this.check()}invert(){return OT(this,this),this.check()}lerp(t,e,i){return UT(this,t,e,i),this.check()}multiplyRight(t,e){return rt(!e),lu(this,this,t),this.check()}multiplyLeft(t,e){return rt(!e),lu(this,t,this),this.check()}normalize(){const t=this.len(),e=t>0?1/t:0;return this[0]=this[0]*e,this[1]=this[1]*e,this[2]=this[2]*e,this[3]=this[3]*e,t===0&&(this[3]=1),this.check()}rotateX(t){return xT(this,this,t),this.check()}rotateY(t){return LT(this,this,t),this.check()}rotateZ(t){return MT(this,this,t),this.check()}scale(t){return DT(this,this,t),this.check()}slerp(t,e,i){switch(arguments.length){case 1:({start:t=zT,target:e,ratio:i}=arguments[0]);break;case 2:[e,i]=arguments,t=this;break}return er(this,t,e,i),this.check()}transformVector4(t,e=t){return wT(e,t,this),Qn(e,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(t,e){return this.setAxisAngle(t,e)}premultiply(t,e){return this.multiplyLeft(t,e)}multiply(t,e){return this.multiplyRight(t,e)}}var to={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,PI_OVER_TWO:Math.PI/2,PI_OVER_FOUR:Math.PI/4,PI_OVER_SIX:Math.PI/6,TWO_PI:Math.PI*2},fu=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))

struct AmbientLight {
 vec3 color;
};

struct PointLight {
 vec3 color;
 vec3 position;
 vec3 attenuation;
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;

uniform bool lighting_uEnabled;

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

#endif
`;const jT={lightSources:{}};function eo({color:n=[0,0,0],intensity:t=1}={}){return n.map(e=>e*t/255)}function GT({ambientLight:n,pointLights:t=[],directionalLights:e=[]}){const i={};return n?i["lighting_uAmbientLight.color"]=eo(n):i["lighting_uAmbientLight.color"]=[0,0,0],t.forEach((r,s)=>{i[`lighting_uPointLight[${s}].color`]=eo(r),i[`lighting_uPointLight[${s}].position`]=r.position,i[`lighting_uPointLight[${s}].attenuation`]=r.attenuation||[1,0,0]}),i.lighting_uPointLightCount=t.length,e.forEach((r,s)=>{i[`lighting_uDirectionalLight[${s}].color`]=eo(r),i[`lighting_uDirectionalLight[${s}].direction`]=r.direction}),i.lighting_uDirectionalLightCount=e.length,i}function du(n=jT){if("lightSources"in n){const{ambientLight:t,pointLights:e,directionalLights:i}=n.lightSources||{};return t||e&&e.length>0||i&&i.length>0?Object.assign({},GT({ambientLight:t,pointLights:e,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in n){const t={pointLights:[],directionalLights:[]};for(const e of n.lights||[])switch(e.type){case"ambient":t.ambientLight=e;break;case"directional":t.directionalLights.push(e);break;case"point":t.pointLights.push(e);break}return du({lightSources:t})}return{}}const no={name:"lights",vs:fu,fs:fu,getUniforms:du,defines:{MAX_LIGHTS:3}},$T=new Uint8Array([0,255,255,255]),HT={pickingSelectedColor:null,pickingHighlightColor:$T,pickingActive:!1,pickingAttribute:!1};function WT(n=HT){const t={};if(n.pickingSelectedColor!==void 0)if(!n.pickingSelectedColor)t.picking_uSelectedColorValid=0;else{const e=n.pickingSelectedColor.slice(0,3);t.picking_uSelectedColorValid=1,t.picking_uSelectedColor=e}if(n.pickingHighlightColor){const e=Array.from(n.pickingHighlightColor,i=>i/255);Number.isFinite(e[3])||(e[3]=1),t.picking_uHighlightColor=e}return n.pickingActive!==void 0&&(t.picking_uActive=Boolean(n.pickingActive),t.picking_uAttribute=Boolean(n.pickingAttribute)),t}const qT=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,YT=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,XT={name:"picking",vs:qT,fs:YT,getUniforms:WT};var gu=`
uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
    vec3 halfway_direction = normalize(light_direction + view_direction);
    float lambertian = dot(light_direction, normal_worldspace);
    float specular = 0.0;
    if (lambertian > 0.0) {
      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
      specular = pow(specular_angle, lighting_uShininess);
    }
    lambertian = max(lambertian, 0.0);
    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);
    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}

vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = vec3(0, 0, 0);
  vec3 surfaceColor = vec3(0, 0, 0);

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}
`;const ZT={};function KT(n){const{ambient:t=.35,diffuse:e=.6,shininess:i=32,specularColor:r=[30,30,30]}=n;return{lighting_uAmbient:t,lighting_uDiffuse:e,lighting_uShininess:i,lighting_uSpecularColor:r.map(s=>s/255)}}function pu(n=ZT){if(!("material"in n))return{};const{material:t}=n;return t?KT(t):{lighting_uEnabled:!1}}const QT={name:"gouraud-lighting",dependencies:[no],vs:gu,defines:{LIGHTING_VERTEX:1},getUniforms:pu},JT={name:"phong-lighting",dependencies:[no],fs:gu,defines:{LIGHTING_FRAGMENT:1},getUniforms:pu};var tE=`uniform mat4 u_MVPMatrix;
uniform mat4 u_ModelMatrix;
uniform mat4 u_NormalMatrix;

varying vec3 pbr_vPosition;
varying vec2 pbr_vUV;

#ifdef HAS_NORMALS
# ifdef HAS_TANGENTS
varying mat3 pbr_vTBN;
# else
varying vec3 pbr_vNormal;
# endif
#endif

void pbr_setPositionNormalTangentUV(vec4 position, vec4 normal, vec4 tangent, vec2 uv)
{
  vec4 pos = u_ModelMatrix * position;
  pbr_vPosition = vec3(pos.xyz) / pos.w;

#ifdef HAS_NORMALS
#ifdef HAS_TANGENTS
  vec3 normalW = normalize(vec3(u_NormalMatrix * vec4(normal.xyz, 0.0)));
  vec3 tangentW = normalize(vec3(u_ModelMatrix * vec4(tangent.xyz, 0.0)));
  vec3 bitangentW = cross(normalW, tangentW) * tangent.w;
  pbr_vTBN = mat3(tangentW, bitangentW, normalW);
#else
  pbr_vNormal = normalize(vec3(u_ModelMatrix * vec4(normal.xyz, 0.0)));
#endif
#endif

#ifdef HAS_UV
  pbr_vUV = uv;
#else
  pbr_vUV = vec2(0.,0.);
#endif
}
`,eE=`#if defined(USE_TEX_LOD) && !defined(FEATURE_GLSL_TEXTURE_LOD)
# error PBR fragment shader: Texture LOD is not available
#endif

#if !defined(HAS_TANGENTS) && !defined(FEATURE_GLSL_DERIVATIVES)
# error PBR fragment shader: Derivatives are not available
#endif


#if (__VERSION__ < 300)
  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL1COND; INCR)
#else
  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL2COND; INCR)
#endif

precision highp float;

uniform bool pbr_uUnlit;

#ifdef USE_IBL
uniform samplerCube u_DiffuseEnvSampler;
uniform samplerCube u_SpecularEnvSampler;
uniform sampler2D u_brdfLUT;
uniform vec2 u_ScaleIBLAmbient;
#endif

#ifdef HAS_BASECOLORMAP
uniform sampler2D u_BaseColorSampler;
#endif
#ifdef HAS_NORMALMAP
uniform sampler2D u_NormalSampler;
uniform float u_NormalScale;
#endif
#ifdef HAS_EMISSIVEMAP
uniform sampler2D u_EmissiveSampler;
uniform vec3 u_EmissiveFactor;
#endif
#ifdef HAS_METALROUGHNESSMAP
uniform sampler2D u_MetallicRoughnessSampler;
#endif
#ifdef HAS_OCCLUSIONMAP
uniform sampler2D u_OcclusionSampler;
uniform float u_OcclusionStrength;
#endif

#ifdef ALPHA_CUTOFF
uniform float u_AlphaCutoff;
#endif

uniform vec2 u_MetallicRoughnessValues;
uniform vec4 u_BaseColorFactor;

uniform vec3 u_Camera;
#ifdef PBR_DEBUG
uniform vec4 u_ScaleDiffBaseMR;
uniform vec4 u_ScaleFGDSpec;
#endif

varying vec3 pbr_vPosition;

varying vec2 pbr_vUV;

#ifdef HAS_NORMALS
#ifdef HAS_TANGENTS
varying mat3 pbr_vTBN;
#else
varying vec3 pbr_vNormal;
#endif
#endif


struct PBRInfo
{
  float NdotL;
  float NdotV;
  float NdotH;
  float LdotH;
  float VdotH;
  float perceptualRoughness;
  float metalness;
  vec3 reflectance0;
  vec3 reflectance90;
  float alphaRoughness;
  vec3 diffuseColor;
  vec3 specularColor;
  vec3 n;
  vec3 v;
};

const float M_PI = 3.141592653589793;
const float c_MinRoughness = 0.04;

vec4 SRGBtoLINEAR(vec4 srgbIn)
{
#ifdef MANUAL_SRGB
#ifdef SRGB_FAST_APPROXIMATION
  vec3 linOut = pow(srgbIn.xyz,vec3(2.2));
#else
  vec3 bLess = step(vec3(0.04045),srgbIn.xyz);
  vec3 linOut = mix( srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)), bLess );
#endif
  return vec4(linOut,srgbIn.w);;
#else
  return srgbIn;
#endif
}

vec3 getNormal()
{
#ifndef HAS_TANGENTS
  vec3 pos_dx = dFdx(pbr_vPosition);
  vec3 pos_dy = dFdy(pbr_vPosition);
  vec3 tex_dx = dFdx(vec3(pbr_vUV, 0.0));
  vec3 tex_dy = dFdy(vec3(pbr_vUV, 0.0));
  vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);

#ifdef HAS_NORMALS
  vec3 ng = normalize(pbr_vNormal);
#else
  vec3 ng = cross(pos_dx, pos_dy);
#endif

  t = normalize(t - ng * dot(ng, t));
  vec3 b = normalize(cross(ng, t));
  mat3 tbn = mat3(t, b, ng);
#else
  mat3 tbn = pbr_vTBN;
#endif

#ifdef HAS_NORMALMAP
  vec3 n = texture2D(u_NormalSampler, pbr_vUV).rgb;
  n = normalize(tbn * ((2.0 * n - 1.0) * vec3(u_NormalScale, u_NormalScale, 1.0)));
#else
  vec3 n = normalize(tbn[2].xyz);
#endif

  return n;
}


#ifdef USE_IBL
vec3 getIBLContribution(PBRInfo pbrInputs, vec3 n, vec3 reflection)
{
  float mipCount = 9.0;
  float lod = (pbrInputs.perceptualRoughness * mipCount);
  vec3 brdf = SRGBtoLINEAR(texture2D(u_brdfLUT,
    vec2(pbrInputs.NdotV, 1.0 - pbrInputs.perceptualRoughness))).rgb;
  vec3 diffuseLight = SRGBtoLINEAR(textureCube(u_DiffuseEnvSampler, n)).rgb;

#ifdef USE_TEX_LOD
  vec3 specularLight = SRGBtoLINEAR(textureCubeLod(u_SpecularEnvSampler, reflection, lod)).rgb;
#else
  vec3 specularLight = SRGBtoLINEAR(textureCube(u_SpecularEnvSampler, reflection)).rgb;
#endif

  vec3 diffuse = diffuseLight * pbrInputs.diffuseColor;
  vec3 specular = specularLight * (pbrInputs.specularColor * brdf.x + brdf.y);
  diffuse *= u_ScaleIBLAmbient.x;
  specular *= u_ScaleIBLAmbient.y;

  return diffuse + specular;
}
#endif


vec3 diffuse(PBRInfo pbrInputs)
{
  return pbrInputs.diffuseColor / M_PI;
}

vec3 specularReflection(PBRInfo pbrInputs)
{
  return pbrInputs.reflectance0 +
    (pbrInputs.reflectance90 - pbrInputs.reflectance0) *
    pow(clamp(1.0 - pbrInputs.VdotH, 0.0, 1.0), 5.0);
}



float geometricOcclusion(PBRInfo pbrInputs)
{
  float NdotL = pbrInputs.NdotL;
  float NdotV = pbrInputs.NdotV;
  float r = pbrInputs.alphaRoughness;

  float attenuationL = 2.0 * NdotL / (NdotL + sqrt(r * r + (1.0 - r * r) * (NdotL * NdotL)));
  float attenuationV = 2.0 * NdotV / (NdotV + sqrt(r * r + (1.0 - r * r) * (NdotV * NdotV)));
  return attenuationL * attenuationV;
}





float microfacetDistribution(PBRInfo pbrInputs)
{
  float roughnessSq = pbrInputs.alphaRoughness * pbrInputs.alphaRoughness;
  float f = (pbrInputs.NdotH * roughnessSq - pbrInputs.NdotH) * pbrInputs.NdotH + 1.0;
  return roughnessSq / (M_PI * f * f);
}

void PBRInfo_setAmbientLight(inout PBRInfo pbrInputs) {
  pbrInputs.NdotL = 1.0;
  pbrInputs.NdotH = 0.0;
  pbrInputs.LdotH = 0.0;
  pbrInputs.VdotH = 1.0;
}

void PBRInfo_setDirectionalLight(inout PBRInfo pbrInputs, vec3 lightDirection) {
  vec3 n = pbrInputs.n;
  vec3 v = pbrInputs.v;
  vec3 l = normalize(lightDirection);
  vec3 h = normalize(l+v);

  pbrInputs.NdotL = clamp(dot(n, l), 0.001, 1.0);
  pbrInputs.NdotH = clamp(dot(n, h), 0.0, 1.0);
  pbrInputs.LdotH = clamp(dot(l, h), 0.0, 1.0);
  pbrInputs.VdotH = clamp(dot(v, h), 0.0, 1.0);
}

void PBRInfo_setPointLight(inout PBRInfo pbrInputs, PointLight pointLight) {
  vec3 light_direction = normalize(pointLight.position - pbr_vPosition);
  PBRInfo_setDirectionalLight(pbrInputs, light_direction);
}

vec3 calculateFinalColor(PBRInfo pbrInputs, vec3 lightColor) {
  vec3 F = specularReflection(pbrInputs);
  float G = geometricOcclusion(pbrInputs);
  float D = microfacetDistribution(pbrInputs);
  vec3 diffuseContrib = (1.0 - F) * diffuse(pbrInputs);
  vec3 specContrib = F * G * D / (4.0 * pbrInputs.NdotL * pbrInputs.NdotV);
  return pbrInputs.NdotL * lightColor * (diffuseContrib + specContrib);
}

vec4 pbr_filterColor(vec4 colorUnused)
{
#ifdef HAS_BASECOLORMAP
  vec4 baseColor = SRGBtoLINEAR(texture2D(u_BaseColorSampler, pbr_vUV)) * u_BaseColorFactor;
#else
  vec4 baseColor = u_BaseColorFactor;
#endif

#ifdef ALPHA_CUTOFF
  if (baseColor.a < u_AlphaCutoff) {
    discard;
  }
#endif

  vec3 color = vec3(0, 0, 0);

  if(pbr_uUnlit){
    color.rgb = baseColor.rgb;
  }
  else{


    float perceptualRoughness = u_MetallicRoughnessValues.y;
    float metallic = u_MetallicRoughnessValues.x;
#ifdef HAS_METALROUGHNESSMAP

    vec4 mrSample = texture2D(u_MetallicRoughnessSampler, pbr_vUV);
    perceptualRoughness = mrSample.g * perceptualRoughness;
    metallic = mrSample.b * metallic;
#endif
    perceptualRoughness = clamp(perceptualRoughness, c_MinRoughness, 1.0);
    metallic = clamp(metallic, 0.0, 1.0);

    float alphaRoughness = perceptualRoughness * perceptualRoughness;

    vec3 f0 = vec3(0.04);
    vec3 diffuseColor = baseColor.rgb * (vec3(1.0) - f0);
    diffuseColor *= 1.0 - metallic;
    vec3 specularColor = mix(f0, baseColor.rgb, metallic);
    float reflectance = max(max(specularColor.r, specularColor.g), specularColor.b);



    float reflectance90 = clamp(reflectance * 25.0, 0.0, 1.0);
    vec3 specularEnvironmentR0 = specularColor.rgb;
    vec3 specularEnvironmentR90 = vec3(1.0, 1.0, 1.0) * reflectance90;

    vec3 n = getNormal();
    vec3 v = normalize(u_Camera - pbr_vPosition);

    float NdotV = clamp(abs(dot(n, v)), 0.001, 1.0);
    vec3 reflection = -normalize(reflect(v, n));

    PBRInfo pbrInputs = PBRInfo(
      0.0,
      NdotV,
      0.0,
      0.0,
      0.0,
      perceptualRoughness,
      metallic,
      specularEnvironmentR0,
      specularEnvironmentR90,
      alphaRoughness,
      diffuseColor,
      specularColor,
      n,
      v
    );

#ifdef USE_LIGHTS
    PBRInfo_setAmbientLight(pbrInputs);
    color += calculateFinalColor(pbrInputs, lighting_uAmbientLight.color);
    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uDirectionalLightCount, i++) {
      if (i < lighting_uDirectionalLightCount) {
        PBRInfo_setDirectionalLight(pbrInputs, lighting_uDirectionalLight[i].direction);
        color += calculateFinalColor(pbrInputs, lighting_uDirectionalLight[i].color);
      }
    }
    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uPointLightCount, i++) {
      if (i < lighting_uPointLightCount) {
        PBRInfo_setPointLight(pbrInputs, lighting_uPointLight[i]);
        float attenuation = getPointLightAttenuation(lighting_uPointLight[i], distance(lighting_uPointLight[i].position, pbr_vPosition));
        color += calculateFinalColor(pbrInputs, lighting_uPointLight[i].color / attenuation);
      }
    }
#endif
#ifdef USE_IBL
    color += getIBLContribution(pbrInputs, n, reflection);
#endif
#ifdef HAS_OCCLUSIONMAP
    float ao = texture2D(u_OcclusionSampler, pbr_vUV).r;
    color = mix(color, color * ao, u_OcclusionStrength);
#endif

#ifdef HAS_EMISSIVEMAP
    vec3 emissive = SRGBtoLINEAR(texture2D(u_EmissiveSampler, pbr_vUV)).rgb * u_EmissiveFactor;
    color += emissive;
#endif

#ifdef PBR_DEBUG





    color = mix(color, baseColor.rgb, u_ScaleDiffBaseMR.y);
    color = mix(color, vec3(metallic), u_ScaleDiffBaseMR.z);
    color = mix(color, vec3(perceptualRoughness), u_ScaleDiffBaseMR.w);
#endif

  }

  return vec4(pow(color,vec3(1.0/2.2)), baseColor.a);
}
`;const io={name:"pbr",vs:tE,fs:eE,defines:{LIGHTING_FRAGMENT:1},dependencies:[no]},nE=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,iE={name:"transform",vs:nE,fs:null};class ei{static getDefaultProgramManager(t){return t.luma=t.luma||{},t.luma.defaultProgramManager=t.luma.defaultProgramManager||new ei(t),t.luma.defaultProgramManager}constructor(t){this.gl=t,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(t){this._defaultModules.find(e=>e.name===t.name)||this._defaultModules.push(t),this.stateHash++}removeDefaultModule(t){const e=typeof t=="string"?t:t.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==e),this.stateHash++}addShaderHook(t,e){e&&(t=Object.assign(e,{hook:t})),this._hookFunctions.push(t),this.stateHash++}get(t={}){const{vs:e="",fs:i="",defines:r={},inject:s={},varyings:o=[],bufferMode:a=35981,transpileToGLSL100:c=!1}=t,l=this._getModuleList(t.modules),u=this._getHash(e),h=this._getHash(i),f=l.map(y=>this._getHash(y.name)).sort(),g=o.map(y=>this._getHash(y)),m=Object.keys(r).sort(),_=Object.keys(s).sort(),T=[],v=[];for(const y of m)T.push(this._getHash(y)),T.push(this._getHash(r[y]));for(const y of _)v.push(this._getHash(y)),v.push(this._getHash(s[y]));const S=`${u}/${h}D${T.join("/")}M${f.join("/")}I${v.join("/")}V${g.join("/")}H${this.stateHash}B${a}${c?"T":""}`;if(!this._programCache[S]){const y=uy(this.gl,{vs:e,fs:i,modules:l,inject:s,defines:r,hookFunctions:this._hookFunctions,transpileToGLSL100:c});this._programCache[S]=new El(this.gl,{hash:S,vs:y.vs,fs:y.fs,varyings:o,bufferMode:a}),this._getUniforms[S]=y.getUniforms||(P=>{}),this._useCounts[S]=0}return this._useCounts[S]++,this._programCache[S]}getUniforms(t){return this._getUniforms[t.hash]||null}release(t){const e=t.hash;this._useCounts[e]--,this._useCounts[e]===0&&(this._programCache[e].delete(),delete this._programCache[e],delete this._getUniforms[e],delete this._useCounts[e])}_getHash(t){return this._hashes[t]===void 0&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}_getModuleList(t=[]){const e=new Array(this._defaultModules.length+t.length),i={};let r=0;for(let s=0,o=this._defaultModules.length;s<o;++s){const a=this._defaultModules[s],c=a.name;e[r++]=a,i[c]=!0}for(let s=0,o=t.length;s<o;++s){const a=t[s],c=a.name;i[c]||(e[r++]=a,i[c]=!0)}return e.length=r,e}}const rE={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function sE(n,t,e){const i={};let r=t.indices;for(const s in t.attributes){const o=t.attributes[s],a=oE(s,e);if(s==="indices")r=o;else if(o.constant)i[a]=o.value;else{const c=o.value,l=E({},o);delete l.value,i[a]=[new X(n,c),l],aE(s,l)}}if(r){const s=r.value||r;O(s instanceof Uint16Array||s instanceof Uint32Array,'attribute array for "indices" must be of integer type');const o={size:1,isIndexed:r.isIndexed===void 0?!0:r.isIndexed};i.indices=[new X(n,{data:s,target:34963}),o]}return i}function oE(n,t){const{attributeMap:e=rE}=t||{};return e&&e[n]||n}function aE(n,t){let e;switch(n){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":e="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":e="vectors";break}switch(e){case"vectors":t.size=t.size||3;break;case"uvs":t.size=t.size||2;break}O(Number.isFinite(t.size),`attribute ${n} needs size`)}const en=2,cE=1e4,lE="Model needs drawMode and vertexCount",mu=()=>{},uE={};class nn{constructor(t,e={}){const{id:i=he("model")}=e;O(zi(t)),this.id=i,this.gl=t,this.id=e.id||he("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(e)}initialize(t){this.props={},this.programManager=t.programManager||ei.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:e=null,vs:i,fs:r,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=t;this.programProps={program:e,vs:i,fs:r,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(t.moduleSettings))),this.drawMode=t.drawMode!==void 0?t.drawMode:4,this.vertexCount=t.vertexCount||0,this.geometryBuffers={},this.isInstanced=t.isInstanced||t.instanced||t.instanceCount>0,this._setModelProps(t),this.geometry={},O(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),lE)}setProps(t){this._setModelProps(t)}delete(){for(const t in this._attributes)this._attributes[t]!==this.attributes[t]&&this._attributes[t].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(t){const{program:e,vs:i,fs:r,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=t;this.programProps={program:e,vs:i,fs:r,modules:s,defines:o,inject:a,varyings:c,bufferMode:l,transpileToGLSL100:u},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(t){return this.drawMode=t,this}setVertexCount(t){return O(Number.isFinite(t)),this.vertexCount=t,this}setInstanceCount(t){return O(Number.isFinite(t)),this.instanceCount=t,this}setGeometry(t){return this.drawMode=t.drawMode,this.vertexCount=t.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=sE(this.gl,t),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(t={}){if(qe(t))return this;const e={};for(const i in t){const r=t[i];e[i]=r.getValue?r.getValue():r}return this.vertexArray.setAttributes(e),this}setUniforms(t={}){return Object.assign(this.uniforms,t),this}getModuleUniforms(t){this._checkProgram();const e=this.programManager.getUniforms(this.program);return e?e(t):{}}updateModuleSettings(t){const e=this.getModuleUniforms(t||{});return this.setUniforms(e)}clear(t){return Ns(this.program.gl,t),this}draw(t={}){this._checkProgram();const{moduleSettings:e=null,framebuffer:i,uniforms:r={},attributes:s={},transformFeedback:o=this.transformFeedback,parameters:a={},vertexArray:c=this.vertexArray}=t;this.setAttributes(s),this.updateModuleSettings(e),this.setUniforms(r);let l;F.priority>=en&&(l=this._logDrawCallStart(en));const u=this.vertexArray.getDrawParams(),{isIndexed:h=u.isIndexed,indexType:f=u.indexType,indexOffset:g=u.indexOffset,vertexArrayInstanced:m=u.isInstanced}=this.props;m&&!this.isInstanced&&F.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:_,instanceCount:T}=this,{onBeforeRender:v=mu,onAfterRender:S=mu}=this.props;v(),this.program.setUniforms(this.uniforms);const y=this.program.draw(Object.assign(uE,t,{logPriority:l,uniforms:null,framebuffer:i,parameters:a,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:c,transformFeedback:o,isIndexed:h,indexType:f,isInstanced:_,instanceCount:T,offset:h?g:0}));return S(),F.priority>=en&&this._logDrawCallEnd(l,c,i),y}transform(t={}){const{discard:e=!0,feedbackBuffers:i,unbindModels:r=[]}=t;let{parameters:s}=t;i&&this._setFeedbackBuffers(i),e&&(s=Object.assign({},s,{[35977]:e})),r.forEach(o=>o.vertexArray.unbindBuffers());try{this.draw(Object.assign({},t,{parameters:s}))}finally{r.forEach(o=>o.vertexArray.bindBuffers())}return this}render(t={}){return F.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(t).draw()}_setModelProps(t){Object.assign(this.props,t),"uniforms"in t&&this.setUniforms(t.uniforms),"pickable"in t&&(this.pickable=t.pickable),"instanceCount"in t&&(this.instanceCount=t.instanceCount),"geometry"in t&&this.setGeometry(t.geometry),"attributes"in t&&this.setAttributes(t.attributes),"_feedbackBuffers"in t&&this._setFeedbackBuffers(t._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:e}=this.programProps;if(e)this._managedProgram=!1;else{const{vs:i,fs:r,modules:s,inject:o,defines:a,varyings:c,bufferMode:l,transpileToGLSL100:u}=this.programProps;e=this.programManager.get({vs:i,fs:r,modules:s,inject:o,defines:a,varyings:c,bufferMode:l,transpileToGLSL100:u}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}O(e instanceof El,"Model needs a program"),this._programDirty=!1,e!==this.program&&(this.program=e,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Sb(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const t in this.geometryBuffers){const e=this.geometryBuffers[t][0]||this.geometryBuffers[t];e instanceof X&&e.delete()}}_setAnimationProps(t){this.animated&&O(t,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(t={}){if(qe(t))return this;const{gl:e}=this.program;return this.transformFeedback=this.transformFeedback||new vl(e,{program:this.program}),this.transformFeedback.setBuffers(t),this}_logDrawCallStart(t){const e=t>3?0:cE;if(!(Date.now()-this.lastLogTime<e))return this.lastLogTime=Date.now(),F.group(en,`>>> DRAWING MODEL ${this.id}`,{collapsed:F.level<=2})(),t}_logDrawCallEnd(t,e,i,r){if(t===void 0)return;const s=xb({vertexArray:e,header:`${this.id} attributes`,attributes:this._attributes}),{table:o,unusedTable:a,unusedCount:c}=Al({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:l,count:u}=Al({header:`${this.id} uniforms`,program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});u>0&&F.log("MISSING UNIFORMS",Object.keys(l))(),c>0&&F.log("UNUSED UNIFORMS",Object.keys(a))();const h=Mb(this.vertexArray.configuration);F.table(t,s)(),F.table(t,o)(),F.table(t+1,h)(),r&&r.log({logLevel:en,message:`Rendered to ${r.id}`}),F.groupEnd(en,`>>> DRAWING MODEL ${this.id}`)()}}class hE{constructor(t,e={}){this.gl=t,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}setupResources(t){for(const e of this.bindings)this._setupTransformFeedback(e,t)}updateModelProps(t={}){const{varyings:e}=this;return e.length>0&&(t=Object.assign({},t,{varyings:e})),t}getDrawOptions(t={}){const e=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:r}=e;return{attributes:Object.assign({},i,t.attributes),transformFeedback:r}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(t={}){this._setupBuffers(t)}getBuffer(t){const{feedbackBuffers:e}=this.bindings[this.currentIndex],i=t?e[t]:null;return i?i instanceof X?i:i.buffer:null}getData(t={}){const{varyingName:e}=t,i=this.getBuffer(e);return i?i.getData():null}delete(){for(const t in this.resources)this.resources[t].delete()}_initialize(t={}){this._setupBuffers(t),this.varyings=t.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&O(j(this.gl))}_getFeedbackBuffers(t){const{sourceBuffers:e={}}=t,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const r in this.feedbackMap){const s=this.feedbackMap[r];r in e&&(i[s]=r)}Object.assign(i,t.feedbackBuffers);for(const r in i){const s=i[r];if(typeof s=="string"){const o=e[s],{byteLength:a,usage:c,accessor:l}=o;i[r]=this._createNewBuffer(r,{byteLength:a,usage:c,accessor:l})}}return i}_setupBuffers(t={}){const{sourceBuffers:e=null}=t;Object.assign(this.feedbackMap,t.feedbackMap);const i=this._getFeedbackBuffers(t);this._updateBindings({sourceBuffers:e,feedbackBuffers:i})}_setupTransformFeedback(t,{model:e}){const{program:i}=e;t.transformFeedback=new vl(this.gl,{program:i,buffers:t.feedbackBuffers})}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this.feedbackMap){const{sourceBuffers:e,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),r=this._getNextIndex();this.bindings[r]=this._updateBinding(this.bindings[r],{sourceBuffers:e,feedbackBuffers:i})}}_updateBinding(t,e){return t?(Object.assign(t.sourceBuffers,e.sourceBuffers),Object.assign(t.feedbackBuffers,e.feedbackBuffers),t.transformFeedback&&t.transformFeedback.setBuffers(t.feedbackBuffers),t):{sourceBuffers:Object.assign({},e.sourceBuffers),feedbackBuffers:Object.assign({},e.feedbackBuffers)}}_swapBuffers(t){if(!this.feedbackMap)return null;const e=Object.assign({},t.sourceBuffers),i=Object.assign({},t.feedbackBuffers);for(const r in this.feedbackMap){const s=this.feedbackMap[r];e[r]=t.feedbackBuffers[s],i[s]=t.sourceBuffers[r],O(i[s]instanceof X)}return{sourceBuffers:e,feedbackBuffers:i}}_createNewBuffer(t,e){const i=new X(this.gl,e);return this.resources[t]&&this.resources[t].delete(),this.resources[t]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}}const fE="transform_uSampler_",nr="transform_uSize_",_u="transform_position";function dE({vs:n,sourceTextureMap:t,targetTextureVarying:e,targetTexture:i}){let s=Object.keys(t).length,o=null;const a={};let c=n,l={};if(s>0||e){const u=c.split(`
`),h=u.slice();if(u.forEach((f,g,m)=>{if(s>0){const _=bE(f,t);if(_){const{updatedLine:T,inject:v}=_;h[g]=T,l=Ws([l,v]),Object.assign(a,_.samplerTextureMap),s--}}e&&!o&&(o=_E(f,e))}),e){O(i);const f=`${nr}${e}`,g=`uniform vec2 ${f};
`,m=`     vec2 ${_u} = transform_getPos(${f});
     gl_Position = vec4(${_u}, 0, 1.);
`;l=Ws([l,{"vs:#decl":g,"vs:#main-start":m}])}c=h.join(`
`)}return{vs:c,targetTextureType:o,inject:l,samplerTextureMap:a}}function gE({sourceTextureMap:n,targetTextureVarying:t,targetTexture:e}){const i={};let r,s;t&&({width:r,height:s}=e,i[`${nr}${t}`]=[r,s]);for(const o in n)({width:r,height:s}=n[o]),i[`${nr}${o}`]=[r,s];return i}function pE(n){return Vl(n,["attribute","in"])}function mE(n){const t=`${fE}${n}`,e=`${nr}${n}`,i=`  uniform sampler2D ${t};
  uniform vec2 ${e};`;return{samplerName:t,sizeName:e,uniformDeclerations:i}}function _E(n,t){const e=Vl(n,["varying","out"]);return e&&e.name===t?e.type:null}function bE(n,t){const e={},i=pE(n);if(!i)return null;const{type:r,name:s}=i;if(s&&t[s]){const o=`// ${n} => Replaced by Transform with a sampler`,{samplerName:a,sizeName:c,uniformDeclerations:l}=mE(s),u=yy(r),h=`  ${r} ${s} = transform_getInput(${a}, ${c}).${u};
`;return e[a]=s,{updatedLine:o,inject:{"vs:#decl":l,"vs:#main-start":h},samplerTextureMap:e}}return null}const yE={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},TE="transform_output";class EE{constructor(t,e={}){this.gl=t,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}updateModelProps(t={}){const e=this._processVertexShader(t);return Object.assign({},t,e)}getDrawOptions(t={}){const{sourceBuffers:e,sourceTextures:i,framebuffer:r,targetTexture:s}=this.bindings[this.currentIndex],o=Object.assign({},e,t.attributes),a=Object.assign({},t.uniforms),c=Object.assign({},t.parameters);let l=t.discard;if(this.hasSourceTextures||this.hasTargetTexture){o.transform_elementID=this.elementIDBuffer;for(const h in this.samplerTextureMap){const f=this.samplerTextureMap[h];a[h]=i[f]}this._setSourceTextureParameters();const u=gE({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:s});Object.assign(a,u)}return this.hasTargetTexture&&(l=!1,c.viewport=[0,0,r.width,r.height]),{attributes:o,framebuffer:r,uniforms:a,discard:l,parameters:c}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(t={}){this._setupTextures(t)}getTargetTexture(){const{targetTexture:t}=this.bindings[this.currentIndex];return t}getData({packed:t=!1}={}){const{framebuffer:e}=this.bindings[this.currentIndex],i=Gi(e);if(!t)return i;const r=i.constructor,s=Ty(this.targetTextureType),o=new r(i.length*s/4);let a=0;for(let c=0;c<i.length;c+=4)for(let l=0;l<s;l++)o[a++]=i[c+l];return o}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(t={}){const{_targetTextureVarying:e,_swapTexture:i}=t;this._swapTexture=i,this.targetTextureVarying=e,this.hasTargetTexture=e,this._setupTextures(t)}_createTargetTexture(t){const{sourceTextures:e,textureOrReference:i}=t;if(i instanceof It)return i;const r=e[i];return r?(this._targetRefTexName=i,this._createNewTexture(r)):null}_setupTextures(t={}){const{sourceBuffers:e,_sourceTextures:i={},_targetTexture:r}=t,s=this._createTargetTexture({sourceTextures:i,textureOrReference:r});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:e,sourceTextures:i,targetTexture:s}),"elementCount"in t&&this._updateElementIDBuffer(t.elementCount)}_updateElementIDBuffer(t){if(typeof t!="number"||this.elementCount>=t)return;const e=new Float32Array(t);e.forEach((i,r,s)=>{s[r]=r}),this.elementIDBuffer?this.elementIDBuffer.setData({data:e}):this.elementIDBuffer=new X(this.gl,{data:e,accessor:{size:1}}),this.elementCount=t}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this._swapTexture){const{sourceTextures:e,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),r=this._getNextIndex();this.bindings[r]=this._updateBinding(this.bindings[r],{sourceTextures:e,targetTexture:i})}}_updateBinding(t,e){const{sourceBuffers:i,sourceTextures:r,targetTexture:s}=e;if(t||(t={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(t.sourceTextures,r),Object.assign(t.sourceBuffers,i),s){t.targetTexture=s;const{width:o,height:a}=s,{framebuffer:c}=t;c?(c.update({attachments:{[36064]:s},resizeAttachments:!1}),c.resize({width:o,height:a})):t.framebuffer=new ct(this.gl,{id:"transform-framebuffer",width:o,height:a,attachments:{[36064]:s}})}return t}_setSourceTextureParameters(){const t=this.currentIndex,{sourceTextures:e}=this.bindings[t];for(const i in e)e[i].setParameters(yE)}_swapTextures(t){if(!this._swapTexture)return null;const e=Object.assign({},t.sourceTextures);e[this._swapTexture]=t.targetTexture;const i=t.sourceTextures[this._swapTexture];return{sourceTextures:e,targetTexture:i}}_createNewTexture(t){const e=g0(t,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=e,e}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(t={}){const{sourceTextures:e,targetTexture:i}=this.bindings[this.currentIndex],{vs:r,uniforms:s,targetTextureType:o,inject:a,samplerTextureMap:c}=dE({vs:t.vs,sourceTextureMap:e,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),l=Ws([t.inject||{},a]);this.targetTextureType=o,this.samplerTextureMap=c;const u=t._fs||zl({version:gl(r),input:this.targetTextureVarying,inputType:o,output:TE}),h=this.hasSourceTextures||this.targetTextureVarying?[iE].concat(t.modules||[]):t.modules;return{vs:r,fs:u,modules:h,uniforms:s,inject:l}}}class ro{static isSupported(t){return j(t)}constructor(t,e={}){this.gl=t,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(e),Object.seal(this)}delete(){const{model:t,bufferTransform:e,textureTransform:i}=this;t&&t.delete(),e&&e.delete(),i&&i.delete()}run(t={}){const{clearRenderTarget:e=!0}=t,i=this._updateDrawOptions(t);e&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let t=!1;const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e)t=t||i.swap();O(t,"Nothing to swap")}getBuffer(t=null){return this.bufferTransform&&this.bufferTransform.getBuffer(t)}getData(t={}){const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e){const r=i.getData(t);if(r)return r}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(t={}){"elementCount"in t&&this.model.setVertexCount(t.elementCount);const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e)i.update(t)}_initialize(t={}){const{gl:e}=this;this._buildResourceTransforms(e,t),t=this._updateModelProps(t),this.model=new nn(e,Object.assign({},t,{fs:t.fs||zl({version:gl(t.vs)}),id:t.id||"transform-model",drawMode:t.drawMode||0,vertexCount:t.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(t){let e=Object.assign({},t);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const r of i)e=r.updateModelProps(e);return e}_buildResourceTransforms(t,e){vE(e)&&(this.bufferTransform=new hE(t,e)),AE(e)&&(this.textureTransform=new EE(t,e)),O(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(t){let e=Object.assign({},t);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const r of i)e=Object.assign(e,r.getDrawOptions(e));return e}}function vE(n){return!!(!qe(n.feedbackBuffers)||!qe(n.feedbackMap)||n.varyings&&n.varyings.length>0)}function AE(n){return!!(!qe(n._sourceTextures)||n._targetTexture||n._targetTextureVarying)}const bu={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class ni{static get DRAW_MODE(){return bu}constructor(t={}){const{id:e=he("geometry"),drawMode:i=bu.TRIANGLES,attributes:r={},indices:s=null,vertexCount:o=null}=t;this.id=e,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(r,s),this.vertexCount=o||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?E({indices:this.indices},this.attributes):this.attributes}_print(t){return`Geometry ${this.id} attribute ${t}`}_setAttributes(t,e){e&&(this.indices=ArrayBuffer.isView(e)?{value:e,size:1}:e);for(const i in t){let r=t[i];r=ArrayBuffer.isView(r)?{value:r}:r,O(ArrayBuffer.isView(r.value),`${this._print(i)}: must be typed array or object with value as typed array`),(i==="POSITION"||i==="positions")&&!r.size&&(r.size=3),i==="indices"?(O(!this.indices),this.indices=r):this.attributes[i]=r}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(t,e){if(e)return e.value.length;let i=1/0;for(const r in t){const s=t[r],{value:o,size:a,constant:c}=s;!c&&o&&a>=1&&(i=Math.min(i,o.length/a))}return O(Number.isFinite(i)),i}}let wE=1,SE=1;class yu{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(t){const{delay:e=0,duration:i=Number.POSITIVE_INFINITY,rate:r=1,repeat:s=1}=t,o=wE++,a={time:0,delay:e,duration:i,rate:r,repeat:s};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(t){this.channels.delete(t);for(const[e,i]of this.animations)i.channel===t&&this.detachAnimation(e)}isFinished(t){const e=this.channels.get(t);return e===void 0?!1:this.time>=e.delay+e.duration*e.repeat}getTime(t){if(t===void 0)return this.time;const e=this.channels.get(t);return e===void 0?-1:e.time}setTime(t){this.time=Math.max(0,t);const e=this.channels.values();for(const r of e)this._setChannelTime(r,this.time);const i=this.animations.values();for(const r of i){const{animation:s,channel:o}=r;s.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){const i=SE++;return this.animations.set(i,{animation:t,channel:e}),t.setTime(this.getTime(e)),i}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){const i=e-t.delay,r=t.duration*t.repeat;i>=r?t.time=t.duration*t.rate:(t.time=Math.max(0,i)%t.duration,t.time*=t.rate)}}const IE=`
struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry;
`,PE=`
#define SMOOTH_EDGE_RADIUS 0.5

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`;var xE={name:"geometry",vs:IE,fs:PE};const H={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(H,"IDENTITY",{get:()=>W.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")()||0});const ne={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Tu={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},LE=Object.keys(H).map(n=>"const int COORDINATE_SYSTEM_".concat(n," = ").concat(H[n],";")).join(""),ME=Object.keys(ne).map(n=>"const int PROJECTION_MODE_".concat(n," = ").concat(ne[n],";")).join("");var RE="".concat(LE,`
`).concat(ME,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z;
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy;
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter;
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}
vec3 project_normal(vec3 vector) {
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  return normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size(position_world.z),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world.xyz -= project_uCoordinateOrigin;
  }
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}
`),rn=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function Eu(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],f=t[10],g=t[11],m=t[12],_=t[13],T=t[14],v=t[15],S=e*a-i*o,y=e*c-r*o,P=e*l-s*o,L=i*c-r*a,x=i*l-s*a,N=r*l-s*c,U=u*_-h*m,C=u*T-f*m,B=u*v-g*m,V=h*T-f*_,z=h*v-g*_,Y=f*v-g*T,R=S*Y-y*z+P*V+L*B-x*C+N*U;return R?(R=1/R,n[0]=(a*Y-c*z+l*V)*R,n[1]=(r*z-i*Y-s*V)*R,n[2]=(_*N-T*x+v*L)*R,n[3]=(f*x-h*N-g*L)*R,n[4]=(c*B-o*Y-l*C)*R,n[5]=(e*Y-r*B+s*C)*R,n[6]=(T*P-m*N-v*y)*R,n[7]=(u*N-f*P+g*y)*R,n[8]=(o*z-a*B+l*U)*R,n[9]=(i*B-e*z-s*U)*R,n[10]=(m*x-_*P+v*S)*R,n[11]=(h*P-u*x-g*S)*R,n[12]=(a*C-o*V-c*U)*R,n[13]=(e*V-i*C+r*U)*R,n[14]=(_*y-m*L-T*S)*R,n[15]=(u*L-h*y+f*S)*R,n):null}function ii(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=t[9],g=t[10],m=t[11],_=t[12],T=t[13],v=t[14],S=t[15],y=e[0],P=e[1],L=e[2],x=e[3];return n[0]=y*i+P*a+L*h+x*_,n[1]=y*r+P*c+L*f+x*T,n[2]=y*s+P*l+L*g+x*v,n[3]=y*o+P*u+L*m+x*S,y=e[4],P=e[5],L=e[6],x=e[7],n[4]=y*i+P*a+L*h+x*_,n[5]=y*r+P*c+L*f+x*T,n[6]=y*s+P*l+L*g+x*v,n[7]=y*o+P*u+L*m+x*S,y=e[8],P=e[9],L=e[10],x=e[11],n[8]=y*i+P*a+L*h+x*_,n[9]=y*r+P*c+L*f+x*T,n[10]=y*s+P*l+L*g+x*v,n[11]=y*o+P*u+L*m+x*S,y=e[12],P=e[13],L=e[14],x=e[15],n[12]=y*i+P*a+L*h+x*_,n[13]=y*r+P*c+L*f+x*T,n[14]=y*s+P*l+L*g+x*v,n[15]=y*o+P*u+L*m+x*S,n}function OE(n,t,e){var i=e[0],r=e[1],s=e[2],o,a,c,l,u,h,f,g,m,_,T,v;return t===n?(n[12]=t[0]*i+t[4]*r+t[8]*s+t[12],n[13]=t[1]*i+t[5]*r+t[9]*s+t[13],n[14]=t[2]*i+t[6]*r+t[10]*s+t[14],n[15]=t[3]*i+t[7]*r+t[11]*s+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],u=t[4],h=t[5],f=t[6],g=t[7],m=t[8],_=t[9],T=t[10],v=t[11],n[0]=o,n[1]=a,n[2]=c,n[3]=l,n[4]=u,n[5]=h,n[6]=f,n[7]=g,n[8]=m,n[9]=_,n[10]=T,n[11]=v,n[12]=o*i+u*r+m*s+t[12],n[13]=a*i+h*r+_*s+t[13],n[14]=c*i+f*r+T*s+t[14],n[15]=l*i+g*r+v*s+t[15]),n}function CE(n,t,e){var i=e[0],r=e[1],s=e[2];return n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n[3]=t[3]*i,n[4]=t[4]*r,n[5]=t[5]*r,n[6]=t[6]*r,n[7]=t[7]*r,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function NE(){var n=new rn(4);return rn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function vu(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3];return n[0]=e[0]*i+e[4]*r+e[8]*s+e[12]*o,n[1]=e[1]*i+e[5]*r+e[9]*s+e[13]*o,n[2]=e[2]*i+e[6]*r+e[10]*s+e[14]*o,n[3]=e[3]*i+e[7]*r+e[11]*s+e[15]*o,n}(function(){var n=NE();return function(t,e,i,r,s,o){var a,c;for(e||(e=4),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();function DE(n,t){if(n===t)return!0;if(Array.isArray(n)){const e=n.length;if(!t||t.length!==e)return!1;for(let i=0;i<e;i++)if(n[i]!==t[i])return!1;return!0}return!1}function ir(n){let t={},e;return i=>{for(const r in i)if(!DE(i[r],t[r])){e=n(i),t=i;break}return e}}const Au=[0,0,0,0],FE=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],UE=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],BE=[0,0,0],kE=[0,0,0],VE=ir(GE);function wu(n,t,e=kE){let i=e,r,s=!0;switch(t===H.LNGLAT_OFFSETS||t===H.METER_OFFSETS?r=e:r=n.isGeospatial?[Math.fround(n.longitude),Math.fround(n.latitude),0]:null,n.projectionMode){case ne.WEB_MERCATOR:(t===H.LNGLAT||t===H.CARTESIAN)&&(s=!1);break;case ne.WEB_MERCATOR_AUTO_OFFSET:t===H.LNGLAT?i=r:t===H.CARTESIAN&&(i=[Math.fround(n.center[0]),Math.fround(n.center[1]),0],r=n.unprojectPosition(i),i[0]-=e[0],i[1]-=e[1],i[2]-=e[2]);break;case ne.IDENTITY:i=n.position.map(Math.fround);break;case ne.GLOBE:s=!1,r=null;break;default:s=!1}return i[2]=i[2]||0,{geospatialOrigin:r,shaderCoordinateOrigin:i,offsetMode:s}}function zE(n,t,e){const{viewMatrixUncentered:i,projectionMatrix:r}=n;let{viewMatrix:s,viewProjectionMatrix:o}=n,a=Au,c=Au,l=n.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:f}=wu(n,t,e);return f&&(c=n.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=vu([],c,o),s=i||s,o=ii([],r,s),o=ii([],o,FE)),{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}function jE({viewport:n,devicePixelRatio:t=1,modelMatrix:e=null,coordinateSystem:i=H.DEFAULT,coordinateOrigin:r,autoWrapLongitude:s=!1}={}){i===H.DEFAULT&&(i=n.isGeospatial?H.LNGLAT:H.CARTESIAN);const o=VE({viewport:n,devicePixelRatio:t,coordinateSystem:i,coordinateOrigin:r});return o.project_uWrapLongitude=s,o.project_uModelMatrix=e||UE,o}function GE({viewport:n,devicePixelRatio:t,coordinateSystem:e,coordinateOrigin:i}){const{projectionCenter:r,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=zE(n,e,i),u=n.getDistanceScales(),h=[n.width*t,n.height*t],f=n.projectionMatrix.transform([0,0,-n.focalDistance,1])[3]||1,g={project_uCoordinateSystem:e,project_uProjectionMode:n.projectionMode,project_uCoordinateOrigin:c,project_uCommonOrigin:o.slice(0,3),project_uCenter:r,project_uViewportSize:h,project_uDevicePixelRatio:t,project_uFocalDistance:f,project_uCommonUnitsPerMeter:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:BE,project_uScale:n.scale,project_uViewProjectionMatrix:s,project_uCameraPosition:a};if(l){const m=n.getDistanceScales(l);switch(e){case H.METER_OFFSETS:g.project_uCommonUnitsPerWorldUnit=m.unitsPerMeter,g.project_uCommonUnitsPerWorldUnit2=m.unitsPerMeter2;break;case H.LNGLAT:case H.LNGLAT_OFFSETS:g.project_uCommonUnitsPerWorldUnit=m.unitsPerDegree,g.project_uCommonUnitsPerWorldUnit2=m.unitsPerDegree2;break;case H.CARTESIAN:g.project_uCommonUnitsPerWorldUnit=[1,1,m.unitsPerMeter[2]],g.project_uCommonUnitsPerWorldUnit2=[0,0,m.unitsPerMeter2[2]];break}}return g}const $E={};function HE(n=$E){return n.viewport?jE(n):{}}var so={name:"project",dependencies:[Ay],vs:RE,getUniforms:HE};const WE=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    mat3 rotation = project_get_orientation_matrix(projectedPosition);
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`;var oo={name:"project32",dependencies:[so],vs:WE},mt=1e-6,sn=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function qE(){var n=new sn(4);return sn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function YE(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}function XE(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3];return n[0]=e[0]*i+e[4]*r+e[8]*s+e[12]*o,n[1]=e[1]*i+e[5]*r+e[9]*s+e[13]*o,n[2]=e[2]*i+e[6]*r+e[10]*s+e[14]*o,n[3]=e[3]*i+e[7]*r+e[11]*s+e[15]*o,n}(function(){var n=qE();return function(t,e,i,r,s,o){var a,c;for(e||(e=4),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();function rr(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function on(n,t){const e=XE([],t,n);return YE(e,e,1/e[3]),e}function Su(n,t){const e=n%t;return e<0?t+e:e}function ZE(n){return Math.log(n)*Math.LOG2E}const ao=Math.log2||ZE;function KE(n,t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],f=t[10],g=t[11],m=t[12],_=t[13],T=t[14],v=t[15],S=e*a-i*o,y=e*c-r*o,P=e*l-s*o,L=i*c-r*a,x=i*l-s*a,N=r*l-s*c,U=u*_-h*m,C=u*T-f*m,B=u*v-g*m,V=h*T-f*_,z=h*v-g*_,Y=f*v-g*T,R=S*Y-y*z+P*V+L*B-x*C+N*U;return R?(R=1/R,n[0]=(a*Y-c*z+l*V)*R,n[1]=(r*z-i*Y-s*V)*R,n[2]=(_*N-T*x+v*L)*R,n[3]=(f*x-h*N-g*L)*R,n[4]=(c*B-o*Y-l*C)*R,n[5]=(e*Y-r*B+s*C)*R,n[6]=(T*P-m*N-v*y)*R,n[7]=(u*N-f*P+g*y)*R,n[8]=(o*z-a*B+l*U)*R,n[9]=(i*B-e*z-s*U)*R,n[10]=(m*x-_*P+v*S)*R,n[11]=(h*P-u*x-g*S)*R,n[12]=(a*C-o*V-c*U)*R,n[13]=(e*V-i*C+r*U)*R,n[14]=(_*y-m*L-T*S)*R,n[15]=(u*L-h*y+f*S)*R,n):null}function co(n,t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=t[9],g=t[10],m=t[11],_=t[12],T=t[13],v=t[14],S=t[15],y=e[0],P=e[1],L=e[2],x=e[3];return n[0]=y*i+P*a+L*h+x*_,n[1]=y*r+P*c+L*f+x*T,n[2]=y*s+P*l+L*g+x*v,n[3]=y*o+P*u+L*m+x*S,y=e[4],P=e[5],L=e[6],x=e[7],n[4]=y*i+P*a+L*h+x*_,n[5]=y*r+P*c+L*f+x*T,n[6]=y*s+P*l+L*g+x*v,n[7]=y*o+P*u+L*m+x*S,y=e[8],P=e[9],L=e[10],x=e[11],n[8]=y*i+P*a+L*h+x*_,n[9]=y*r+P*c+L*f+x*T,n[10]=y*s+P*l+L*g+x*v,n[11]=y*o+P*u+L*m+x*S,y=e[12],P=e[13],L=e[14],x=e[15],n[12]=y*i+P*a+L*h+x*_,n[13]=y*r+P*c+L*f+x*T,n[14]=y*s+P*l+L*g+x*v,n[15]=y*o+P*u+L*m+x*S,n}function lo(n,t,e){var i=e[0],r=e[1],s=e[2],o,a,c,l,u,h,f,g,m,_,T,v;return t===n?(n[12]=t[0]*i+t[4]*r+t[8]*s+t[12],n[13]=t[1]*i+t[5]*r+t[9]*s+t[13],n[14]=t[2]*i+t[6]*r+t[10]*s+t[14],n[15]=t[3]*i+t[7]*r+t[11]*s+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],u=t[4],h=t[5],f=t[6],g=t[7],m=t[8],_=t[9],T=t[10],v=t[11],n[0]=o,n[1]=a,n[2]=c,n[3]=l,n[4]=u,n[5]=h,n[6]=f,n[7]=g,n[8]=m,n[9]=_,n[10]=T,n[11]=v,n[12]=o*i+u*r+m*s+t[12],n[13]=a*i+h*r+_*s+t[13],n[14]=c*i+f*r+T*s+t[14],n[15]=l*i+g*r+v*s+t[15]),n}function Iu(n,t,e){var i=e[0],r=e[1],s=e[2];return n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n[3]=t[3]*i,n[4]=t[4]*r,n[5]=t[5]*r,n[6]=t[6]*r,n[7]=t[7]*r,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function QE(n,t,e){var i=Math.sin(e),r=Math.cos(e),s=t[4],o=t[5],a=t[6],c=t[7],l=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=s*r+l*i,n[5]=o*r+u*i,n[6]=a*r+h*i,n[7]=c*r+f*i,n[8]=l*r-s*i,n[9]=u*r-o*i,n[10]=h*r-a*i,n[11]=f*r-c*i,n}function JE(n,t,e){var i=Math.sin(e),r=Math.cos(e),s=t[0],o=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*r+l*i,n[1]=o*r+u*i,n[2]=a*r+h*i,n[3]=c*r+f*i,n[4]=l*r-s*i,n[5]=u*r-o*i,n[6]=h*r-a*i,n[7]=f*r-c*i,n}function tv(n,t,e,i,r){var s=1/Math.tan(t/2),o;return n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,r!=null&&r!==1/0?(o=1/(i-r),n[10]=(r+i)*o,n[14]=2*r*i*o):(n[10]=-1,n[14]=-2*i),n}function Pu(n,t){var e=n[0],i=n[1],r=n[2],s=n[3],o=n[4],a=n[5],c=n[6],l=n[7],u=n[8],h=n[9],f=n[10],g=n[11],m=n[12],_=n[13],T=n[14],v=n[15],S=t[0],y=t[1],P=t[2],L=t[3],x=t[4],N=t[5],U=t[6],C=t[7],B=t[8],V=t[9],z=t[10],Y=t[11],R=t[12],Dt=t[13],ke=t[14],Pe=t[15];return Math.abs(e-S)<=mt*Math.max(1,Math.abs(e),Math.abs(S))&&Math.abs(i-y)<=mt*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(r-P)<=mt*Math.max(1,Math.abs(r),Math.abs(P))&&Math.abs(s-L)<=mt*Math.max(1,Math.abs(s),Math.abs(L))&&Math.abs(o-x)<=mt*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(a-N)<=mt*Math.max(1,Math.abs(a),Math.abs(N))&&Math.abs(c-U)<=mt*Math.max(1,Math.abs(c),Math.abs(U))&&Math.abs(l-C)<=mt*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(u-B)<=mt*Math.max(1,Math.abs(u),Math.abs(B))&&Math.abs(h-V)<=mt*Math.max(1,Math.abs(h),Math.abs(V))&&Math.abs(f-z)<=mt*Math.max(1,Math.abs(f),Math.abs(z))&&Math.abs(g-Y)<=mt*Math.max(1,Math.abs(g),Math.abs(Y))&&Math.abs(m-R)<=mt*Math.max(1,Math.abs(m),Math.abs(R))&&Math.abs(_-Dt)<=mt*Math.max(1,Math.abs(_),Math.abs(Dt))&&Math.abs(T-ke)<=mt*Math.max(1,Math.abs(T),Math.abs(ke))&&Math.abs(v-Pe)<=mt*Math.max(1,Math.abs(v),Math.abs(Pe))}function ev(){var n=new sn(2);return sn!=Float32Array&&(n[0]=0,n[1]=0),n}function xu(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function nv(n,t){return n[0]=-t[0],n[1]=-t[1],n}function Lu(n,t,e,i){var r=t[0],s=t[1];return n[0]=r+i*(e[0]-r),n[1]=s+i*(e[1]-s),n}(function(){var n=ev();return function(t,e,i,r,s,o){var a,c;for(e||(e=2),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();function iv(){var n=new sn(3);return sn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function rv(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function sv(n,t,e){return n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}function ov(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}var av=sv;(function(){var n=iv();return function(t,e,i,r,s,o){var a,c;for(e||(e=3),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();function pe(n,t){if(!n)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const Wt=Math.PI,Mu=Wt/4,qt=Wt/180,uo=180/Wt,ri=512,ho=4003e4,Ru=1.5;function cv(n){return Math.pow(2,n)}function lv(n){return ao(n)}function an([n,t]){pe(Number.isFinite(n)),pe(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const e=n*qt,i=t*qt,r=ri*(e+Wt)/(2*Wt),s=ri*(Wt+Math.log(Math.tan(Mu+i*.5)))/(2*Wt);return[r,s]}function Ae([n,t]){const e=n/ri*(2*Wt)-Wt,i=2*(Math.atan(Math.exp(t/ri*(2*Wt)-Wt))-Mu);return[e*uo,i*uo]}function uv({latitude:n}){pe(Number.isFinite(n));const t=Math.cos(n*qt);return lv(ho*t)-9}function sr({latitude:n,longitude:t,highPrecision:e=!1}){pe(Number.isFinite(n)&&Number.isFinite(t));const i={},r=ri,s=Math.cos(n*qt),o=r/360,a=o/s,c=r/ho/s;if(i.unitsPerMeter=[c,c,c],i.metersPerUnit=[1/c,1/c,1/c],i.unitsPerDegree=[o,a,c],i.degreesPerUnit=[1/o,1/a,1/c],e){const l=qt*Math.tan(n*qt)/s,u=o*l/2,h=r/ho*l,f=h/a*c;i.unitsPerDegree2=[0,u,h],i.unitsPerMeter2=[f,0,f]}return i}function Ou(n,t){const[e,i,r]=n,[s,o,a]=t,{unitsPerMeter:c,unitsPerMeter2:l}=sr({longitude:e,latitude:i,highPrecision:!0}),u=an(n);u[0]+=s*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);const h=Ae(u),f=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[h[0],h[1],f]:h}function Cu({height:n,pitch:t,bearing:e,altitude:i,scale:r,center:s=null}){const o=rr();return lo(o,o,[0,0,-i]),QE(o,o,-t*qt),JE(o,o,e*qt),r/=n,Iu(o,o,[r,r,r]),s&&lo(o,o,ov([],s)),o}function Nu({width:n,height:t,fovy:e=or(Ru),altitude:i,pitch:r=0,nearZMultiplier:s=1,farZMultiplier:o=1}){i!==void 0&&(e=or(i));const a=.5*e*qt,c=Du(e),l=r*qt,u=Math.sin(a)*c/Math.sin(Math.min(Math.max(Math.PI/2-l-a,.01),Math.PI-.01)),h=Math.sin(l)*u+c;return{fov:2*a,aspect:n/t,focalDistance:c,near:s,far:h*o}}function hv({width:n,height:t,pitch:e,altitude:i,fovy:r,nearZMultiplier:s,farZMultiplier:o}){const{fov:a,aspect:c,near:l,far:u}=Nu({width:n,height:t,altitude:i,fovy:r,pitch:e,nearZMultiplier:s,farZMultiplier:o});return tv([],a,c,l,u)}function or(n){return 2*Math.atan(.5/n)*uo}function Du(n){return .5/Math.tan(.5*n*qt)}function fo(n,t){const[e,i,r=0]=n;return pe(Number.isFinite(e)&&Number.isFinite(i)&&Number.isFinite(r)),on(t,[e,i,r,1])}function si(n,t,e=0){const[i,r,s]=n;if(pe(Number.isFinite(i)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(s))return on(t,[i,r,s,1]);const o=on(t,[i,r,0,1]),a=on(t,[i,r,1,1]),c=o[2],l=a[2],u=c===l?0:((e||0)-c)/(l-c);return Lu([],o,a,u)}function Fu({width:n,height:t,bounds:e,minExtent:i=0,maxZoom:r=24,padding:s=0,offset:o=[0,0]}){const[[a,c],[l,u]]=e;if(Number.isFinite(s)){const N=s;s={top:N,bottom:N,left:N,right:N}}else pe(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right));const h=new ar({width:n,height:t,longitude:0,latitude:0,zoom:0}),f=h.project([a,u]),g=h.project([l,c]),m=[Math.max(Math.abs(g[0]-f[0]),i),Math.max(Math.abs(g[1]-f[1]),i)],_=[n-s.left-s.right-Math.abs(o[0])*2,t-s.top-s.bottom-Math.abs(o[1])*2];pe(_[0]>0&&_[1]>0);const T=_[0]/m[0],v=_[1]/m[1],S=(s.right-s.left)/2/T,y=(s.bottom-s.top)/2/v,P=[(g[0]+f[0])/2+S,(g[1]+f[1])/2+y],L=h.unproject(P),x=Math.min(r,h.zoom+ao(Math.abs(Math.min(T,v))));return pe(Number.isFinite(x)),{longitude:L[0],latitude:L[1],zoom:x}}const Uu=Math.PI/180;function Bu(n,t=0){const{width:e,height:i,unproject:r}=n,s={targetZ:t},o=r([0,i],s),a=r([e,i],s);let c,l;const u=n.fovy?.5*n.fovy*Uu:Math.atan(.5/n.altitude),h=(90-n.pitch)*Uu;return u>h-.01?(c=ku(n,0,t),l=ku(n,e,t)):(c=r([0,0],s),l=r([e,0],s)),[o,a,l,c]}function ku(n,t,e){const{pixelUnprojectionMatrix:i}=n,r=on(i,[t,0,1,1]),s=on(i,[t,n.height,1,1]),a=(e*n.distanceScales.unitsPerMeter[2]-r[2])/(s[2]-r[2]),c=Lu([],r,s,a),l=Ae(c);return l[2]=e,l}class ar{constructor({width:t,height:e,latitude:i=0,longitude:r=0,zoom:s=0,pitch:o=0,bearing:a=0,altitude:c=null,fovy:l=null,position:u=null,nearZMultiplier:h=.02,farZMultiplier:f=1.01}={width:1,height:1}){t=t||1,e=e||1,l===null&&c===null?(c=Ru,l=or(c)):l===null?l=or(c):c===null&&(c=Du(l));const g=cv(s);c=Math.max(.75,c);const m=sr({longitude:r,latitude:i}),_=an([r,i]);_[2]=0,u&&rv(_,_,av([],u,m.unitsPerMeter)),this.projectionMatrix=hv({width:t,height:e,pitch:o,fovy:l,nearZMultiplier:h,farZMultiplier:f}),this.viewMatrix=Cu({height:e,scale:g,center:_,pitch:o,bearing:a,altitude:c}),this.width=t,this.height=e,this.scale=g,this.latitude=i,this.longitude=r,this.zoom=s,this.pitch=o,this.bearing=a,this.altitude=c,this.fovy=l,this.center=_,this.meterOffset=u||[0,0,0],this.distanceScales=m,this._initMatrices(),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),Object.freeze(this)}_initMatrices(){const{width:t,height:e,projectionMatrix:i,viewMatrix:r}=this,s=rr();co(s,s,i),co(s,s,r),this.viewProjectionMatrix=s;const o=rr();Iu(o,o,[t/2,-e/2,1]),lo(o,o,[1,-1,0]),co(o,o,s);const a=KE(rr(),o);if(!a)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=o,this.pixelUnprojectionMatrix=a}equals(t){return t instanceof ar?t.width===this.width&&t.height===this.height&&Pu(t.projectionMatrix,this.projectionMatrix)&&Pu(t.viewMatrix,this.viewMatrix):!1}project(t,{topLeft:e=!0}={}){const i=this.projectPosition(t),r=fo(i,this.pixelProjectionMatrix),[s,o]=r,a=e?o:this.height-o;return t.length===2?[s,a]:[s,a,r[2]]}unproject(t,{topLeft:e=!0,targetZ:i=void 0}={}){const[r,s,o]=t,a=e?s:this.height-s,c=i&&i*this.distanceScales.unitsPerMeter[2],l=si([r,a,o],this.pixelUnprojectionMatrix,c),[u,h,f]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,f]:Number.isFinite(i)?[u,h,i]:[u,h]}projectPosition(t){const[e,i]=an(t),r=(t[2]||0)*this.distanceScales.unitsPerMeter[2];return[e,i,r]}unprojectPosition(t){const[e,i]=Ae(t),r=(t[2]||0)*this.distanceScales.metersPerUnit[2];return[e,i,r]}projectFlat(t){return an(t)}unprojectFlat(t){return Ae(t)}getMapCenterByLngLatPosition({lngLat:t,pos:e}){const i=si(e,this.pixelUnprojectionMatrix),r=an(t),s=xu([],r,nv([],i)),o=xu([],this.center,s);return Ae(o)}getLocationAtPoint({lngLat:t,pos:e}){return this.getMapCenterByLngLatPosition({lngLat:t,pos:e})}fitBounds(t,e={}){const{width:i,height:r}=this,{longitude:s,latitude:o,zoom:a}=Fu(Object.assign({width:i,height:r,bounds:t},e));return new ar({width:i,height:r,longitude:s,latitude:o,zoom:a})}getBounds(t){const e=this.getBoundingRegion(t),i=Math.min(...e.map(a=>a[0])),r=Math.max(...e.map(a=>a[0])),s=Math.min(...e.map(a=>a[1])),o=Math.max(...e.map(a=>a[1]));return[[i,s],[r,o]]}getBoundingRegion(t={}){return Bu(this,t.z||0)}}const Vu=512;function fv({width:n,height:t,longitude:e,latitude:i,zoom:r,pitch:s=0,bearing:o=0}){(e<-180||e>180)&&(e=Su(e+180,360)-180),(o<-180||o>180)&&(o=Su(o+180,360)-180);const a=ao(t/Vu);if(r<=a)r=a,i=0;else{const c=t/2/Math.pow(2,r),l=Ae([0,c])[1];if(i<l)i=l;else{const u=Ae([0,Vu-c])[1];i>u&&(i=u)}}return{width:n,height:t,longitude:e,latitude:i,zoom:r,pitch:s,bearing:o}}const dv=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,gv=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,pv=ir(Tv),mv=ir(Ev),_v=[0,0,0,1],bv=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function yv(n,t){const[e,i,r]=n,s=si([e,i,r],t);return Number.isFinite(r)?s:[s[0],s[1],0]}function Tv({viewport:n,center:t}){return new $(n.viewProjectionMatrix).invert().transform(t)}function Ev({viewport:n,shadowMatrices:t}){const e=[],i=n.pixelUnprojectionMatrix,r=n.isGeospatial?void 0:1,s=[[0,0,r],[n.width,0,r],[0,n.height,r],[n.width,n.height,r],[0,0,-1],[n.width,0,-1],[0,n.height,-1],[n.width,n.height,-1]].map(o=>yv(o,i));for(const o of t){const a=o.clone().translate(new I(n.center).negate()),c=s.map(u=>a.transform(u)),l=new $().ortho({left:Math.min(...c.map(u=>u[0])),right:Math.max(...c.map(u=>u[0])),bottom:Math.min(...c.map(u=>u[1])),top:Math.max(...c.map(u=>u[1])),near:Math.min(...c.map(u=>-u[2])),far:Math.max(...c.map(u=>-u[2]))});e.push(l.multiplyRight(o))}return e}function vv(n={},t={}){const e={shadow_uDrawShadowMap:Boolean(n.drawToShadowMap),shadow_uUseShadowMap:n.shadowMaps?n.shadowMaps.length>0:!1,shadow_uColor:n.shadowColor||_v,shadow_uLightId:n.shadowLightId||0,shadow_uLightCount:n.shadowMatrices.length},i=pv({viewport:n.viewport,center:t.project_uCenter}),r=[],s=mv({shadowMatrices:n.shadowMatrices,viewport:n.viewport}).slice();for(let o=0;o<n.shadowMatrices.length;o++){const a=s[o],c=a.clone().translate(new I(n.viewport.center).negate());t.project_uCoordinateSystem===H.LNGLAT&&t.project_uProjectionMode===ne.WEB_MERCATOR?(s[o]=c,r[o]=i):(s[o]=a.clone().multiplyRight(bv),r[o]=c.transform(i))}for(let o=0;o<s.length;o++)e["shadow_uViewProjectionMatrices[".concat(o,"]")]=s[o],e["shadow_uProjectCenters[".concat(o,"]")]=r[o],n.shadowMaps&&n.shadowMaps.length>0?e["shadow_uShadowMap".concat(o)]=n.shadowMaps[o]:e["shadow_uShadowMap".concat(o)]=n.dummyShadowMap;return e}var go={name:"shadow",dependencies:[so],vs:dv,fs:gv,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(n={},t={})=>{if(n.drawToShadowMap||n.shadowMaps&&n.shadowMaps.length>0){const{shadowEnabled:e=!0}=n;return e&&n.shadowMatrices&&n.shadowMatrices.length>0?vv(n,t):{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1}}return{}}},po=E({inject:{"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  // for picking depth values
  picking_setPickingAttribute(geometry.position.z);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},XT);const Av=[xE,so],wv=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function Sv(n){const t=ei.getDefaultProgramManager(n);for(const e of Av)t.addDefaultModule(e);for(const e of wv)t.addShaderHook(e);return t}const Iv=[255,255,255],Pv=1;let xv=0;class Lv{constructor(t={}){const{color:e=Iv}=t,{intensity:i=Pv}=t;this.id=t.id||"ambient-".concat(xv++),this.color=e,this.intensity=i,this.type="ambient"}}const Mv=[255,255,255],Rv=1,Ov=[0,0,-1];let Cv=0;class zu{constructor(t={}){const{color:e=Mv}=t,{intensity:i=Rv}=t,{direction:r=Ov}=t,{_shadow:s=!1}=t;this.id=t.id||"directional-".concat(Cv++),this.color=e,this.intensity=i,this.type="directional",this.direction=new I(r).normalize().toArray(),this.shadow=s}getProjectedLight(){return this}}class ju{constructor(t={}){const{id:e="effect"}=t;this.id=e,this.props=E({},t)}preRender(){}getModuleParameters(){}cleanup(){}}class Nv{constructor(t,e={}){const{id:i="pass"}=e;this.id=i,this.gl=t,this.props=E({},e)}setProps(t){Object.assign(this.props,t)}render(){}cleanup(){}}class mo extends Nv{render(t){const e=this.gl;return ue(e,{framebuffer:t.target}),this._drawLayers(t)}_drawLayers(t){const{viewports:e,views:i,onViewportActive:r,clearCanvas:s=!0}=t;t.pass=t.pass||"unknown";const o=this.gl;s&&Fv(o);const a=[];for(const c of e){const l=c.viewport||c,u=i&&i[l.id];r(l);const h=this._getDrawLayerParams(l,t);t.view=u;const f=l.subViewports||[l];for(const g of f){t.viewport=g;const m=this._drawLayersInViewport(o,t,h);a.push(m)}}return a}_getDrawLayerParams(t,{layers:e,pass:i,layerFilter:r,effects:s,moduleParameters:o}){const a=[],c=Gu(),l={viewport:t,isPicking:i.startsWith("picking"),renderPass:i};for(let u=0;u<e.length;u++){const h=e[u],f=this._shouldDrawLayer(h,l,r),g=c(h,f),m={shouldDrawLayer:f,layerRenderIndex:g};f&&(m.moduleParameters=this._getModuleParameters(h,s,i,o),m.layerParameters=this.getLayerParameters(h,u)),a[u]=m}return a}_drawLayersInViewport(t,{layers:e,pass:i,viewport:r,view:s},o){const a=Dv(t,{viewport:r});if(s&&s.props.clear){const l=s.props.clear===!0?{color:!0,depth:!0}:s.props.clear;Gt(t,{scissorTest:!0,scissor:a},()=>Ns(t,l))}const c={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};ue(t,{viewport:a});for(let l=0;l<e.length;l++){const u=e[l],{shouldDrawLayer:h,layerRenderIndex:f,moduleParameters:g,layerParameters:m}=o[l];if(h&&u.props.pickable&&c.pickableCount++,u.isComposite)c.compositeCount++;else if(h){c.visibleCount++,g.viewport=r;try{u.drawLayer({moduleParameters:g,uniforms:{layerIndex:f},parameters:m})}catch(_){u.raiseError(_,"drawing ".concat(u," to ").concat(i))}}}return c}shouldDrawLayer(t){return!0}getModuleParameters(t,e){return null}getLayerParameters(t,e){return t.props.parameters}_shouldDrawLayer(t,e,i){if(!(this.shouldDrawLayer(t)&&t.props.visible)||(e.layer=t,i&&!i(e)))return!1;let s=t.parent;for(;s;){if(!s.filterSubLayer(e))return!1;e.layer=s,s=s.parent}return t.activateViewport(e.viewport),!0}_getModuleParameters(t,e,i,r){const s=Object.assign(Object.create(t.props),{autoWrapLongitude:t.wrapLongitude,viewport:t.context.viewport,mousePosition:t.context.mousePosition,pickingActive:0,devicePixelRatio:We(this.gl)});if(e)for(const o of e)Object.assign(s,o.getModuleParameters(t));return Object.assign(s,this.getModuleParameters(t,e),r)}}function Gu(n=0,t={}){const e={},i=(r,s)=>{const o=r.props._offset,a=r.id,c=r.parent&&r.parent.id;let l;if(c&&!(c in t)&&i(r.parent,!1),c in e){const u=e[c]=e[c]||Gu(t[c],t);l=u(r,s),e[a]=u}else Number.isFinite(o)?(l=o+(t[c]||0),e[a]=null):l=n;return s&&l>=n&&(n=l+1),t[a]=l,l};return i}function Dv(n,{viewport:t}){const e=n.canvas?n.canvas.clientHeight||n.canvas.height:100,i=t,r=We(n);return[i.x*r,(e-i.y-i.height)*r,i.width*r,i.height*r]}function Fv(n){const t=n.drawingBufferWidth,e=n.drawingBufferHeight;ue(n,{viewport:[0,0,t,e]}),n.clear(16384|256)}class Uv extends mo{constructor(t,e){super(t,e);this.shadowMap=new It(t,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new Ze(t,{format:33189,width:1,height:1}),this.fbo=new ct(t,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(t){const e=this.fbo;Gt(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{const i=t.viewports[0],r=We(this.gl),s=i.width*r,o=i.height*r;(s!==e.width||o!==e.height)&&e.resize({width:s,height:o}),super.render(k(E({},t),{target:e,pass:"shadow"}))})}shouldDrawLayer(t){return t.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}}const Bv={color:[255,255,255],intensity:1},$u=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],kv=[0,0,0,200/255];class Hu extends ju{constructor(t){super(t);this.ambientLight=null,this.directionalLights=[],this.pointLights=[],this.shadowColor=kv,this.shadowPasses=[],this.shadowMaps=[],this.dummyShadowMap=null,this.shadow=!1,this.programManager=null;for(const e in t){const i=t[e];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow)}preRender(t,{layers:e,layerFilter:i,viewports:r,onViewportActive:s,views:o}){if(!!this.shadow){this.shadowMatrices=this._createLightMatrix(),this.shadowPasses.length===0&&this._createShadowPasses(t),this.programManager||(this.programManager=ei.getDefaultProgramManager(t),go&&this.programManager.addDefaultModule(go)),this.dummyShadowMap||(this.dummyShadowMap=new It(t,{width:1,height:1}));for(let a=0;a<this.shadowPasses.length;a++)this.shadowPasses[a].render({layers:e,layerFilter:i,viewports:r,onViewportActive:s,views:o,moduleParameters:{shadowLightId:a,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(t){const e=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return e.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:t})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:t}))},e}cleanup(){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(go),this.programManager=null)}_createLightMatrix(){const t=[];for(const e of this.directionalLights){const i=new $().lookAt({eye:new I(e.direction).negate()});t.push(i)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){const i=new Uv(t);this.shadowPasses[e]=i,this.shadowMaps[e]=i.shadowMap}}_applyDefaultLights(){const{ambientLight:t,pointLights:e,directionalLights:i}=this;!t&&e.length===0&&i.length===0&&(this.ambientLight=new Lv(Bv),this.directionalLights.push(new zu($u[0]),new zu($u[1])))}}class Vv{constructor(t){this._pool=[],this.props={overAlloc:2,poolSize:100},this.setProps(t)}setProps(t){Object.assign(this.props,t)}allocate(t,e,{size:i=1,type:r,padding:s=0,copy:o=!1,initialize:a=!1,maxCount:c}){const l=r||t&&t.constructor||Float32Array,u=e*i+s;if(ArrayBuffer.isView(t)){if(u<=t.length)return t;if(u*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new l(t.buffer,0,u)}let h;c&&(h=c*i+s);const f=this._allocate(l,u,a,h);return t&&o?f.set(t):a||f.fill(0,0,4),this._release(t),f}release(t){this._release(t)}_allocate(t,e,i,r){let s=Math.max(Math.ceil(e*this.props.overAlloc),1);s>r&&(s=r);const o=this._pool,a=t.BYTES_PER_ELEMENT*s,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){const l=new t(o.splice(c,1)[0],0,s);return i&&l.fill(0),l}return new t(s)}_release(t){if(!ArrayBuffer.isView(t))return;const e=this._pool,{buffer:i}=t,{byteLength:r}=i,s=e.findIndex(o=>o.byteLength>=r);s<0?e.push(i):(s>0||e.length<this.props.poolSize)&&e.splice(s,0,i),e.length>this.props.poolSize&&e.shift()}}var oi=new Vv;function ai(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function zv(n){return[n[12],n[13],n[14]]}function jv(n){const t={};return t.left=cn(n[3]+n[0],n[7]+n[4],n[11]+n[8],n[15]+n[12]),t.right=cn(n[3]-n[0],n[7]-n[4],n[11]-n[8],n[15]-n[12]),t.bottom=cn(n[3]+n[1],n[7]+n[5],n[11]+n[9],n[15]+n[13]),t.top=cn(n[3]-n[1],n[7]-n[5],n[11]-n[9],n[15]-n[13]),t.near=cn(n[3]+n[2],n[7]+n[6],n[11]+n[10],n[15]+n[14]),t.far=cn(n[3]-n[2],n[7]-n[6],n[11]-n[10],n[15]-n[14]),t}const Wu=new I;function cn(n,t,e,i){Wu.set(n,t,e);const r=Wu.len();return{distance:i/r,normal:new I(-n/r,-t/r,-e/r)}}function Gv(n){return n-Math.fround(n)}let ci;function _o(n,{size:t=1,startIndex:e=0,endIndex:i}){Number.isFinite(i)||(i=n.length);const r=(i-e)/t;ci=oi.allocate(ci,r,{type:Float32Array,size:t*2});let s=e,o=0;for(;s<i;){for(let a=0;a<t;a++){const c=n[s++];ci[o+a]=c,ci[o+a+t]=Gv(c)}o+=t*2}return ci.subarray(0,r*t*2)}const $v=Math.PI/180,Hv=ai(),bo=[0,0,0],Wv=0,qv={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class De{constructor(t={}){const{id:e=null,x:i=0,y:r=0,width:s=1,height:o=1}=t;this.id=e||this.constructor.displayName||"viewport",this.x=i,this.y=r,this.width=s||1,this.height=o||1,this._frustumPlanes={},this._initViewMatrix(t),this._initProjectionMatrix(t),this._initPixelMatrices(),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?ne.WEB_MERCATOR:ne.WEB_MERCATOR_AUTO_OFFSET:ne.IDENTITY}equals(t){return t instanceof De?this===t?!0:t.width===this.width&&t.height===this.height&&t.scale===this.scale&&$t(t.projectionMatrix,this.projectionMatrix)&&$t(t.viewMatrix,this.viewMatrix):!1}project(t,{topLeft:e=!0}={}){const i=this.projectPosition(t),r=fo(i,this.pixelProjectionMatrix),[s,o]=r,a=e?o:this.height-o;return t.length===2?[s,a]:[s,a,r[2]]}unproject(t,{topLeft:e=!0,targetZ:i}={}){const[r,s,o]=t,a=e?s:this.height-s,c=i&&i*this.distanceScales.unitsPerMeter[2],l=si([r,a,o],this.pixelUnprojectionMatrix,c),[u,h,f]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,f]:Number.isFinite(i)?[u,h,i]:[u,h]}projectPosition(t){const[e,i]=this.projectFlat(t),r=(t[2]||0)*this.distanceScales.unitsPerMeter[2];return[e,i,r]}unprojectPosition(t){const[e,i]=this.unprojectFlat(t),r=(t[2]||0)*this.distanceScales.metersPerUnit[2];return[e,i,r]}projectFlat(t){return this.isGeospatial?an(t):t}unprojectFlat(t){return this.isGeospatial?Ae(t):t}getBounds(t={}){const e={targetZ:t.z||0},i=this.unproject([0,0],e),r=this.unproject([this.width,0],e),s=this.unproject([0,this.height],e),o=this.unproject([this.width,this.height],e);return[Math.min(i[0],r[0],s[0],o[0]),Math.min(i[1],r[1],s[1],o[1]),Math.max(i[0],r[0],s[0],o[0]),Math.max(i[1],r[1],s[1],o[1])]}getDistanceScales(t=null){return t?sr({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:i=1,height:r=1}){return t<this.x+this.width&&this.x<t+i&&e<this.y+this.height&&this.y<e+r}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,jv(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(t,e){return null}getCameraPosition(){return this.cameraPosition}getCameraDirection(){return this.cameraDirection}getCameraUp(){return this.cameraUp}_createProjectionMatrix({orthographic:t,fovyRadians:e,aspect:i,focalDistance:r,near:s,far:o}){return t?new $().orthographic({fovy:e,aspect:i,focalDistance:r,near:s,far:o}):new $().perspective({fovy:e,aspect:i,near:s,far:o})}_initViewMatrix(t){const{viewMatrix:e=Hv,longitude:i=null,latitude:r=null,zoom:s=null,position:o=null,modelMatrix:a=null,focalDistance:c=1,distanceScales:l=null}=t;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(i),this.zoom=s,Number.isFinite(this.zoom)||(this.zoom=this.isGeospatial?uv({latitude:r})+Math.log2(c):Wv);const u=Math.pow(2,this.zoom);this.scale=u,this.distanceScales=this.isGeospatial?sr({latitude:r,longitude:i}):l||qv,this.focalDistance=c,this.distanceScales.metersPerUnit=new I(this.distanceScales.metersPerUnit),this.distanceScales.unitsPerMeter=new I(this.distanceScales.unitsPerMeter),this.position=bo,this.meterOffset=bo,o&&(this.position=o,this.modelMatrix=a,this.meterOffset=a?a.transformVector(o):o),this.isGeospatial?(this.longitude=i,this.latitude=r,this.center=this._getCenterInWorld({longitude:i,latitude:r})):this.center=o?this.projectPosition(o):[0,0,0],this.viewMatrixUncentered=e,this.viewMatrix=new $().multiplyRight(this.viewMatrixUncentered).translate(new I(this.center||bo).negate())}_getCenterInWorld({longitude:t,latitude:e}){const{meterOffset:i,distanceScales:r}=this,s=new I(this.projectPosition([t,e,0]));if(i){const o=new I(i).scale(r.unitsPerMeter);s.add(o)}return s}_initProjectionMatrix(t){const{projectionMatrix:e=null,orthographic:i=!1,fovyRadians:r,fovy:s=75,near:o=.1,far:a=1e3,focalDistance:c=1}=t;this.projectionMatrix=e||this._createProjectionMatrix({orthographic:i,fovyRadians:r||s*$v,aspect:this.width/this.height,focalDistance:c,near:o,far:a})}_initPixelMatrices(){const t=ai();ii(t,t,this.projectionMatrix),ii(t,t,this.viewMatrix),this.viewProjectionMatrix=t,this.viewMatrixInverse=Eu([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=zv(this.viewMatrixInverse);const e=ai(),i=ai();CE(e,e,[this.width/2,-this.height/2,1]),OE(e,e,[1,-1,0]),ii(i,e,this.viewProjectionMatrix),this.pixelProjectionMatrix=i,this.viewportMatrix=e,this.pixelUnprojectionMatrix=Eu(ai(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||W.warn("Pixel project matrix not invertible")()}}De.displayName="Viewport";function Yv(){var n=new rn(2);return rn!=Float32Array&&(n[0]=0,n[1]=0),n}function qu(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function Xv(n,t){return n[0]=-t[0],n[1]=-t[1],n}(function(){var n=Yv();return function(t,e,i,r,s,o){var a,c;for(e||(e=2),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();class Fe extends De{constructor(t={}){const{latitude:e=0,longitude:i=0,zoom:r=11,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,orthographic:l=!1,repeat:u=!1,worldOffset:h=0}=t;let{width:f,height:g,altitude:m=1.5}=t;const _=Math.pow(2,r);f=f||1,g=g||1,m=Math.max(.75,m);const{fov:T,aspect:v,focalDistance:S,near:y,far:P}=Nu({width:f,height:g,pitch:s,altitude:m,nearZMultiplier:a,farZMultiplier:c});let L=Cu({height:g,pitch:s,bearing:o,scale:_,altitude:m});h&&(L=new $().translate([512*h,0,0]).multiplyLeft(L));super(k(E({},t),{width:f,height:g,viewMatrix:L,longitude:i,latitude:e,zoom:r,orthographic:l,fovyRadians:T,aspect:v,focalDistance:S,near:y,far:P}));this.latitude=e,this.longitude=i,this.zoom=r,this.pitch=s,this.bearing=o,this.altitude=m,this.orthographic=l,this._subViewports=u?[]:null,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const t=this.getBounds(),e=Math.floor((t[0]+180)/360),i=Math.ceil((t[2]-180)/360);for(let r=e;r<=i;r++){const s=r?new Fe(k(E({},this),{worldOffset:r})):this;this._subViewports.push(s)}}return this._subViewports}addMetersToLngLat(t,e){return Ou(t,e)}panByPosition(t,e){const i=si(e,this.pixelUnprojectionMatrix),r=this.projectFlat(t),s=qu([],r,Xv([],i)),o=qu([],this.center,s),[a,c]=this.unprojectFlat(o);return{longitude:a,latitude:c}}getBounds(t={}){const e=Bu(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){const{width:i,height:r}=this,{longitude:s,latitude:o,zoom:a}=Fu(E({width:i,height:r,bounds:t},e));return new Fe({width:i,height:r,longitude:s,latitude:o,zoom:a})}}Fe.displayName="WebMercatorViewport";function Zv(){var n=new rn(3);return rn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Kv(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}var Qv=Kv;(function(){var n=Zv();return function(t,e,i,r,s,o){var a,c;for(e||(e=3),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();function yo(n,t,e=!1){const i=t.projectPosition(n);if(e&&t instanceof Fe){const[r,s,o=0]=n,a=t.getDistanceScales([r,s]);i[2]=o*a.unitsPerMeter[2]}return i}function Jv(n){const t=E({},n);let{coordinateSystem:e}=n;const{viewport:i,coordinateOrigin:r,fromCoordinateSystem:s,fromCoordinateOrigin:o}=n;return e===H.DEFAULT&&(e=i.isGeospatial?H.LNGLAT:H.CARTESIAN),s===void 0&&(t.fromCoordinateSystem=e),o===void 0&&(t.fromCoordinateOrigin=r),t.coordinateSystem=e,t}function Yu(n,{viewport:t,modelMatrix:e,coordinateSystem:i,coordinateOrigin:r,offsetMode:s}){let[o,a,c=0]=n;switch(e&&([o,a,c]=vu([],[o,a,c,1],e)),i){case H.LNGLAT:return yo([o,a,c],t,s);case H.LNGLAT_OFFSETS:return yo([o+r[0],a+r[1],c+(r[2]||0)],t,s);case H.METER_OFFSETS:return yo(Ou(r,[o,a,c]),t,s);case H.CARTESIAN:default:return t.isGeospatial?[o+r[0],a+r[1],c+r[2]]:t.projectPosition([o,a,c])}}function t1(n,t){const{viewport:e,coordinateSystem:i,coordinateOrigin:r,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=Jv(t),{geospatialOrigin:c,shaderCoordinateOrigin:l,offsetMode:u}=wu(e,i,r),h=Yu(n,{viewport:e,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:u});if(u){const f=e.projectPosition(c||l);Qv(h,h,f)}return h}const ln={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},cr={COMPONENT:Symbol.for("component"),ASYNC_DEFAULTS:Symbol.for("asyncPropDefaults"),ASYNC_ORIGINAL:Symbol.for("asyncPropOriginal"),ASYNC_RESOLVED:Symbol.for("asyncPropResolved")};function To(n,t=()=>!0){return Array.isArray(n)?Xu(n,t,[]):t(n)?[n]:[]}function Xu(n,t,e){let i=-1;for(;++i<n.length;){const r=n[i];Array.isArray(r)?Xu(r,t,e):t(r)&&e.push(r)}return e}function e1({target:n,source:t,start:e=0,count:i=1}){const r=t.length,s=i*r;let o=0;for(let a=e;o<r;o++)n[a++]=t[o];for(;o<s;)o<s-o?(n.copyWithin(e+o,e,e+o),o*=2):(n.copyWithin(e+o,e,e+s-o),o=s);return n}class n1{constructor(t,e,i){this.id=t,this.context=i,this._loadCount=0,this._subscribers=new Set,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;const i=++this._loadCount;let r=t;typeof t=="string"&&(r=$e(t)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(s=>{this._loadCount===i&&(this.isLoaded=!0,this._error=null,this._content=s)}).catch(s=>{this._loadCount===i&&(this.isLoaded=!0,this._error=s||!0)})):(this.isLoaded=!0,this._error=null,this._content=t);for(const s of this._subscribers)s.onChange(this.getData())}}class i1{constructor({gl:t,protocol:e}){this.protocol=e||"resource://",this._context={gl:t,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return t.startsWith(this.protocol)?!0:t in this._resources}add({resourceId:t,data:e,forceUpdate:i=!1,persistent:r=!0}){let s=this._resources[t];s?s.setData(e,i):(s=new n1(t,e,this._context),this._resources[t]=s),s.persistent=r}remove(t){const e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){const e=this._consumers[t];if(e){for(const i in e){const r=e[i];r.resource&&r.resource.unsubscribe(r)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:i,requestId:r="default"}){const{_resources:s,protocol:o}=this;t.startsWith(o)&&(t=t.replace(o,""),s[t]||this.add({resourceId:t,data:null,persistent:!1}));const a=s[t];if(this._track(i,r,a,e),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const t in this._resources)this._resources[t].delete()}_track(t,e,i,r){const s=this._consumers,o=s[t]=s[t]||{},a=o[e]||{};a.resource&&(a.resource.unsubscribe(a),a.resource=null,this.prune()),i&&(o[e]=a,a.onChange=r,a.resource=i,i.subscribe(a))}_prune(){this._pruneRequest=null;for(const t of Object.keys(this._resources)){const e=this._resources[t];!e.persistent&&!e.inUse()&&(e.delete(),delete this._resources[t])}}}const r1="layerManager.setLayers",s1="layerManager.activateViewport",o1=Object.seal({layerManager:null,resourceManager:null,deck:null,gl:null,stats:null,shaderCache:null,pickingFBO:null,mousePosition:null,userData:{}});class a1{constructor(t,{deck:e,stats:i,viewport:r,timeline:s}={}){this.lastRenderedLayers=[],this.layers=[],this.resourceManager=new i1({gl:t,protocol:"deck://"}),this.context=k(E({},o1),{layerManager:this,gl:t,deck:e,programManager:t&&Sv(t),stats:i||new Ln({id:"deck.gl"}),viewport:r||new De({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:s||new yu,resourceManager:this.resourceManager}),this._nextLayers=null,this._needsRedraw="Initial render",this._needsUpdate=!1,this._debug=!1,this.activateViewport=this.activateViewport.bind(this),Object.seal(this)}finalize(){this.resourceManager.finalize();for(const t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const r=i.getNeedsRedraw(t);e=e||r}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this.lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t=null}={}){return t?this.layers.filter(e=>t.find(i=>e.id.indexOf(i)===0)):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){gt(r1,this,e,t),this.lastRenderedLayers=t,t=To(t,Boolean);for(const i of t)i.context=this.context;return this._updateLayers(this.layers,t),this}updateLayers(){const t=this.needsUpdate();t&&(this.setNeedsRedraw("updating layers: ".concat(t)),this.setLayers(this._nextLayers||this.lastRenderedLayers,t)),this._nextLayers=null}activateViewport(t){return gt(s1,this,t),t&&(this.context.viewport=t),this}_handleError(t,e,i){i.raiseError(e,"".concat(t," of ").concat(i))}_updateLayers(t,e){const i={};for(const o of t)i[o.id]?W.warn("Multiple old layers with same id ".concat(o.id))():i[o.id]=o;const r=[];this._updateSublayersRecursively(e,i,r),this._finalizeOldLayers(i);let s=!1;for(const o of r)if(o.hasUniformTransition()){s=!0;break}this._needsUpdate=s,this.layers=r}_updateSublayersRecursively(t,e,i){for(const r of t){r.context=this.context;const s=e[r.id];s===null&&W.warn("Multiple new layers with same id ".concat(r.id))(),e[r.id]=null;let o=null;try{this._debug&&s!==r&&r.validateProps(),s?(this._transferLayerState(s,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),o=r.isComposite&&r.getSubLayers()}catch(a){this._handleError("matching",a,r)}o&&this._updateSublayersRecursively(o,e,i)}}_finalizeOldLayers(t){for(const e in t){const i=t[e];i&&this._finalizeLayer(i)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=ln.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=ln.MATCHED,e!==t&&(t.lifecycle=ln.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||"finalized ".concat(t),t.lifecycle=ln.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=ln.FINALIZED}catch(e){this._handleError("finalization",e,t)}}}function li(n,t){if(n===t)return!0;if(!n||!t)return!1;for(const e in n){const i=n[e],r=t[e];if(!(i===r||Array.isArray(i)&&Array.isArray(r)&&li(i,r)))return!1}return!0}class c1{constructor(t={}){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="Initial render",this._needsUpdate=!0,this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(const t in this.controllers)this.controllers[t]&&this.controllers[t].finalize();this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(const t in this.controllers){const e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){const t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return typeof t=="string"?this.views.find(e=>e.id===t):t}getViewState(t){const e=this.getView(t),i=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(i):i}getViewport(t){return this._viewportMap[t]}unproject(t,e){const i=this.getViewports(),r={x:t[0],y:t[1]};for(let s=i.length-1;s>=0;--s){const o=i[s];if(o.containsPixel(r)){const a=t.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,e)}}return null}setProps(t){"views"in t&&this._setViews(t.views),"viewState"in t&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=To(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(!li(t,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=t):W.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(t,e){e.viewId=t,this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange(e)}_createController(t,e){const i=e.type;return new i(E({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,e.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:s=>t._getViewport(s,{width:s.width,height:s.height})},e))}_updateController(t,e,i,r){let s=t.controller;return s?(s=k(E(E(E({},e),t.props),s),{id:t.id,x:i.x,y:i.y,width:i.width,height:i.height}),r?r.setProps(s):r=this._createController(t,s),r):null}_rebuildViewports(){const{width:t,height:e,views:i}=this,r=this.controllers;this._viewports=[],this.controllers={};let s=!1;for(let o=i.length;o--;){const a=i[o],c=this.getViewState(a),l=a.makeViewport({width:t,height:e,viewState:c});let u=r[a.id];a.controller&&!u&&(s=!0),(s||!a.controller)&&u&&(u.finalize(),u=null),this.controllers[a.id]=this._updateController(a,c,l,u),this._viewports.unshift(l)}for(const o in r)r[o]&&!this.controllers[o]&&r[o].finalize();this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length?!0:t.some((i,r)=>!t[r].equals(e[r]))}}const l1=/([0-9]+\.?[0-9]*)(%|px)/;function lr(n){switch(typeof n){case"number":return{position:n,relative:!1};case"string":const t=n.match(l1);if(t&&t.length>=3){const e=t[2]==="%",i=parseFloat(t[1]);return{position:e?i/100:i,relative:e}}default:throw new Error("Could not parse position string ".concat(n))}}function ur(n,t){return n.relative?Math.round(n.position*t):n.position}function Yt(n,t){if(!n)throw new Error(t||"deck.gl: assertion failed.")}class u1{constructor(t={}){const{id:e=null,x:i=0,y:r=0,width:s="100%",height:o="100%",projectionMatrix:a=null,fovy:c=50,near:l=.1,far:u=1e3,modelMatrix:h=null,viewportInstance:f=null,type:g=De}=t;Yt(!f||f instanceof De),this.viewportInstance=f,this.id=e||this.constructor.displayName||"view",this.type=g,this.props=k(E({},t),{id:this.id,projectionMatrix:a,fovy:c,near:l,far:u,modelMatrix:h}),this._parseDimensions({x:i,y:r,width:s,height:o}),this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t?!0:this.viewportInstance?t.viewportInstance&&this.viewportInstance.equals(t.viewportInstance):li(this.props,t.props)}makeViewport({width:t,height:e,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);const r=this.getDimensions({width:t,height:e});return this._getViewport(i,r)}getViewStateId(){switch(typeof this.props.viewState){case"string":return this.props.viewState;case"object":return this.props.viewState&&this.props.viewState.id;default:return this.id}}filterViewState(t){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const e=E({},t);for(const i in this.props.viewState)i!=="id"&&(e[i]=this.props.viewState[i]);return e}return t}getDimensions({width:t,height:e}){return{x:ur(this._x,t),y:ur(this._y,e),width:ur(this._width,t),height:ur(this._height,e)}}_getControllerProps(t){let e=this.props.controller;return e?e===!0?t:(typeof e=="function"&&(e={type:e}),E(E({},t),e)):null}_getViewport(t,e){const{type:i}=this;return new i(E(E(E({},t),this.props),e))}_parseDimensions({x:t,y:e,width:i,height:r}){this._x=lr(t),this._y=lr(e),this._width=lr(i),this._height=lr(r)}}function hr(){}const h1={onStart:hr,onUpdate:hr,onInterrupt:hr,onEnd:hr};class ui{constructor(t){this._inProgress=!1,this._handle=null,this.timeline=t,this.settings={}}get inProgress(){return this._inProgress}start(t){this.cancel(),this.settings=E(E({},h1),t),this._inProgress=!0,this.settings.onStart(this)}end(){this._inProgress&&(this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd(this))}cancel(){this._inProgress&&(this.settings.onInterrupt(this),this.timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this.timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate(this),this.timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const hi=()=>{},fr={BREAK:1,SNAP_TO_END:2,IGNORE:3},Zu={transitionEasing:n=>n,transitionInterruption:fr.BREAK,onTransitionStart:hi,onTransitionInterrupt:hi,onTransitionEnd:hi};class f1{constructor(t,e={}){this.ControllerState=t,this.props=E(E({},Zu),e),this.propsInTransition=null,this.transition=new ui(e.timeline),this.onViewStateChange=e.onViewStateChange||hi,this.onStateChange=e.onStateChange||hi,this._onTransitionUpdate=this._onTransitionUpdate.bind(this)}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1;const i=this.props;if(t=E(E({},Zu),t),this.props=t,this._shouldIgnoreViewportChange(i,t))return e;if(this._isTransitionEnabled(t)){const{interruption:r,endProps:s}=this.transition.settings,o=E(E({},i),r===fr.SNAP_TO_END?s:this.propsInTransition||i);this._triggerTransition(o,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){const{transitionDuration:e,transitionInterpolator:i}=t;return(e>0||e==="auto")&&Boolean(i)}_isUpdateDueToCurrentTransition(t){return this.transition.inProgress?this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition):!1}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===fr.IGNORE||this._isUpdateDueToCurrentTransition(e):this._isTransitionEnabled(e)?e.transitionInterpolator.arePropsEqual(t,e):!0}_triggerTransition(t,e){const i=new this.ControllerState(t),r=new this.ControllerState(e).shortestPathFrom(i),{transitionInterpolator:s}=e,o=s.getDuration?s.getDuration(t,e):e.transitionDuration;if(o===0)return;const a=e.transitionInterpolator.initializeProps(t,r);this.propsInTransition={},this.duration=o,this.transition.start({duration:o,easing:e.transitionEasing,interpolator:e.transitionInterpolator,interruption:e.transitionInterruption,startProps:a.start,endProps:a.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)}),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),t(e)}}_onTransitionUpdate(t){const{time:e,settings:{interpolator:i,startProps:r,endProps:s,duration:o,easing:a}}=t,c=a(e/o),l=i.interpolateProps(r,s,c);this.propsInTransition=new this.ControllerState(E(E({},this.props),l)).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}}class d1{constructor(t={}){Array.isArray(t)&&(t={compare:t,extract:t,required:t});const{compare:e,extract:i,required:r}=t;this._propsToCompare=e,this._propsToExtract=i,this._requiredProps=r}arePropsEqual(t,e){for(const i of this._propsToCompare||Object.keys(e))if(!(i in t)||!(i in e)||!$t(t[i],e[i]))return!1;return!0}initializeProps(t,e){let i;if(this._propsToExtract){const r={},s={};for(const o of this._propsToExtract)r[o]=t[o],s[o]=e[o];i={start:r,end:s}}else i={start:t,end:e};return this._checkRequiredProps(i.start),this._checkRequiredProps(i.end),i}interpolateProps(t,e,i){return e}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){!this._requiredProps||this._requiredProps.forEach(e=>{const i=t[e];Yt(Number.isFinite(i)||Array.isArray(i),"".concat(e," is required for transition"))})}}const Ku=["longitude","latitude","zoom","bearing","pitch"],g1=["longitude","latitude","zoom"];class Qu extends d1{constructor(t={}){const e=Array.isArray(t)?t:t.transitionProps;super(e||{compare:Ku,extract:Ku,required:g1});this.opts=t}initializeProps(t,e){const i=super.initializeProps(t,e),{makeViewport:r,around:s}=this.opts;if(r&&s){const o=r(t),a=r(e),c=o.unproject(s);i.start.around=s,Object.assign(i.end,{around:a.project(c),aroundPosition:c,width:e.width,height:e.height})}return i}interpolateProps(t,e,i){const r={};for(const s of this._propsToExtract)r[s]=Ji(t[s]||0,e[s]||0,i);if(e.aroundPosition){const s=this.opts.makeViewport(E(E({},e),r));Object.assign(r,s.panByPosition(e.aroundPosition,Ji(t.around,e.around,i)))}return r}}const we={transitionDuration:0},p1={transitionDuration:300,transitionEasing:n=>n,transitionInterruption:fr.BREAK},m1=300,dr=n=>1-(1-n)*(1-n),un={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]};class _1{constructor(t,e={}){this.ControllerState=t,this.controllerState=null,this.controllerStateProps=null,this.eventManager=null,this.transitionManager=new f1(t,k(E({},e),{onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}));const i=this.linearTransitionProps;this._transition=i&&k(E({},p1),{transitionInterpolator:new Qu({transitionProps:i})}),this._events=null,this._interactionState={isDragging:!1},this._customEvents=[],this.onViewStateChange=null,this.onStateChange=null,this.handleEvent=this.handleEvent.bind(this),this.setProps(e)}get linearTransitionProps(){return null}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.setProps(this.controllerStateProps)}finalize(){for(const t in this._events)this._events[t]&&this.eventManager.off(t,this.handleEvent);this.transitionManager.finalize()}handleEvent(t){const{ControllerState:e}=this;this.controllerState=new e(E(E({makeViewport:this.makeViewport},this.controllerStateProps),this._state));const i=this._eventStartBlocked;switch(t.type){case"panstart":return i?!1:this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return i?!1:this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"tripanstart":return i?!1:this._onTriplePanStart(t);case"tripanmove":return this._onTriplePan(t);case"tripanend":return this._onTriplePanEnd(t);case"doubletap":return this._onDoubleTap(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}getCenter(t){const{x:e,y:i}=this.controllerStateProps,{offsetCenter:r}=t;return[r.x-e,r.y-i]}isPointInBounds(t,e){const{width:i,height:r}=this.controllerStateProps;if(e&&e.handled)return!1;const s=t[0]>=0&&t[0]<=i&&t[1]>=0&&t[1]<=r;return s&&e&&e.stopPropagation(),s}isFunctionKeyPressed(t){const{srcEvent:e}=t;return Boolean(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging}blockEvents(t){const e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){"onViewStateChange"in t&&(this.onViewStateChange=t.onViewStateChange),"onStateChange"in t&&(this.onStateChange=t.onStateChange),"makeViewport"in t&&(this.makeViewport=t.makeViewport),"dragMode"in t&&(this.dragMode=t.dragMode),this.controllerStateProps=t,"eventManager"in t&&this.eventManager!==t.eventManager&&(this.eventManager=t.eventManager,this._events={},this.toggleEvents(this._customEvents,!0)),"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);let{inertia:e}=t;e===!0&&(e=m1),this.inertia=e;const{scrollZoom:i=!0,dragPan:r=!0,dragRotate:s=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=t,u=Boolean(this.onViewStateChange);this.toggleEvents(un.WHEEL,u&&i),this.toggleEvents(un.PAN,u&&(r||s)),this.toggleEvents(un.PINCH,u&&(a||c)),this.toggleEvents(un.TRIPLE_PAN,u&&c),this.toggleEvents(un.DOUBLE_TAP,u&&o),this.toggleEvents(un.KEYBOARD,u&&l),this.scrollZoom=i,this.dragPan=r,this.dragRotate=s,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(i=>{this._events[i]!==e&&(this._events[i]=e,e?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(t,e={},i={}){const r=E(E({},t.getViewportProps()),e),s=this.controllerState!==t;if(this._state=t.getState(),this._setInteractionState(i),s){const o=this.controllerState?this.controllerState.getViewportProps():null;this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:o})}}_onTransition(t){this.onViewStateChange&&(t.interactionState=this._interactionState,this.onViewStateChange(t))}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange&&this.onStateChange(this._interactionState)}_onPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.isFunctionKeyPressed(t)||t.rightButton;(this.invertPan||this.dragMode==="pan")&&(i=!i);const r=this.controllerState[i?"panStart":"rotateStart"]({pos:e});return this._panMove=i,this.updateViewport(r,we,{isDragging:!0}),!0}_onPan(t){return this.isDragging()?this._panMove?this._onPanMove(t):this._onPanRotate(t):!1}_onPanEnd(t){return this.isDragging()?this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t):!1}_onPanMove(t){if(!this.dragPan)return!1;const e=this.getCenter(t),i=this.controllerState.pan({pos:e});return this.updateViewport(i,we,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){const{inertia:e}=this;if(this.dragPan&&e&&t.velocity){const i=this.getCenter(t),r=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],s=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(s,k(E({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:dr}),{isDragging:!1,isPanning:!0})}else{const i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;const e=this.getCenter(t),i=this.controllerState.rotate({pos:e});return this.updateViewport(i,we,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){const{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){const i=this.getCenter(t),r=[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2],s=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(s,k(E({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:dr}),{isDragging:!1,isRotating:!0})}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;t.preventDefault();const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const{speed:i=.01,smooth:r=!1}=this.scrollZoom,{delta:s}=t;let o=2/(1+Math.exp(-Math.abs(s*i)));s<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(a,k(E({},this._getTransitionProps({around:e})),{transitionDuration:r?250:1}),{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.rotateStart({pos:e});return this.updateViewport(i,we,{isDragging:!0}),!0}_onTriplePan(t){if(!this.touchRotate||!this.isDragging())return!1;const e=this.getCenter(t);e[0]-=t.deltaX;const i=this.controllerState.rotate({pos:e});return this.updateViewport(i,we,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){const i=this.getCenter(t),r=[i[0],i[1]+=t.velocityY*e/2],s=this.controllerState.rotate({pos:r});this.updateViewport(s,k(E({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:dr}),{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return this._startPinchRotation=t.rotation,this._lastPinchEvent=t,this.updateViewport(i,we,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){const{scale:i}=t,r=this.getCenter(t);e=e.zoom({pos:r,scale:i})}if(this.touchRotate){const{rotation:i}=t;e=e.rotate({deltaAngleX:this._startPinchRotation-i})}return this.updateViewport(e,we,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),this._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;const{inertia:e,_lastPinchEvent:i}=this;if(this.touchZoom&&e&&i&&t.scale!==i.scale){const r=this.getCenter(t);let s=this.controllerState.rotateEnd();const o=Math.log2(t.scale),a=(o-Math.log2(i.scale))/(t.deltaTime-i.deltaTime),c=Math.pow(2,o+a*e/2);s=s.zoom({pos:r,scale:c}).zoomEnd(),this.updateViewport(s,k(E({},this._getTransitionProps({around:r})),{transitionDuration:e,transitionEasing:dr}),{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{const r=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return this._startPinchRotation=null,this._lastPinchEvent=null,!0}_onDoubleTap(t){if(!this.doubleClickZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.isFunctionKeyPressed(t),r=this.controllerState.zoom({pos:e,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;const e=this.isFunctionKeyPressed(t),{zoomSpeed:i,moveSpeed:r,rotateSpeedX:s,rotateSpeedY:o}=this.keyboard,{controllerState:a}=this;let c;const l={};switch(t.srcEvent.code){case"Minus":c=e?a.zoomOut(i).zoomOut(i):a.zoomOut(i),l.isZooming=!0;break;case"Equal":c=e?a.zoomIn(i).zoomIn(i):a.zoomIn(i),l.isZooming=!0;break;case"ArrowLeft":e?(c=a.rotateLeft(s),l.isRotating=!0):(c=a.moveLeft(r),l.isPanning=!0);break;case"ArrowRight":e?(c=a.rotateRight(s),l.isRotating=!0):(c=a.moveRight(r),l.isPanning=!0);break;case"ArrowUp":e?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(r),l.isPanning=!0);break;case"ArrowDown":e?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(r),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(t){const{_transition:e}=this;return e?t?k(E({},e),{transitionInterpolator:new Qu(k(E({},t),{transitionProps:this.linearTransitionProps,makeViewport:this.controllerState.makeViewport}))}):e:we}}class b1{constructor(t){this._viewportProps=this._applyConstraints(t)}getViewportProps(){return this._viewportProps}getState(){return this._state}shortestPathFrom(t){return this._viewportProps}_applyConstraints(t){return t}}const Ju=5,y1=1.2,Ue={pitch:0,bearing:0,altitude:1.5,minZoom:0,maxZoom:20,minPitch:0,maxPitch:60};class T1 extends b1{constructor({makeViewport:t,width:e,height:i,latitude:r,longitude:s,zoom:o,bearing:a=Ue.bearing,pitch:c=Ue.pitch,altitude:l=Ue.altitude,maxZoom:u=Ue.maxZoom,minZoom:h=Ue.minZoom,maxPitch:f=Ue.maxPitch,minPitch:g=Ue.minPitch,startPanLngLat:m,startZoomLngLat:_,startRotatePos:T,startBearing:v,startPitch:S,startZoom:y,normalize:P}={}){Yt(Number.isFinite(s)),Yt(Number.isFinite(r)),Yt(Number.isFinite(o));super({width:e,height:i,latitude:r,longitude:s,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:u,minZoom:h,maxPitch:f,minPitch:g,normalize:P});this._state={startPanLngLat:m,startZoomLngLat:_,startRotatePos:T,startBearing:v,startPitch:S,startZoom:y},this.makeViewport=t}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){const i=this._state.startPanLngLat||this._unproject(e);if(!i)return this;const s=this.makeViewport(this._viewportProps).panByPosition(i,t);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this._viewportProps.bearing,startPitch:this._viewportProps.pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){const{startRotatePos:r,startBearing:s,startPitch:o}=this._state;if(!r||!Number.isFinite(s)||!Number.isFinite(o))return this;let a;return t?a=this._calculateNewPitchAndBearing(k(E({},this._getRotationParams(t,r)),{startBearing:s,startPitch:o})):a={bearing:s+e,pitch:o+i},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this._viewportProps.zoom})}zoom({pos:t,startPos:e,scale:i}){let{startZoom:r,startZoomLngLat:s}=this._state;Number.isFinite(r)||(r=this._viewportProps.zoom,s=this._unproject(e)||this._unproject(t));const o=this._calculateNewZoom({scale:i,startZoom:r}),a=this.makeViewport(k(E({},this._viewportProps),{zoom:o}));return this._getUpdatedState(E({zoom:o},a.panByPosition(s,t)))}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this._viewportProps.bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this._viewportProps.bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this._viewportProps.pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this._viewportProps.pitch-t})}shortestPathFrom(t){const e=t.getViewportProps(),i=E({},this._viewportProps),{bearing:r,longitude:s}=i;return Math.abs(r-e.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(s-e.longitude)>180&&(i.longitude=s<0?s+360:s-360),i}_zoomFromCenter(t){const{width:e,height:i}=this._viewportProps;return this.zoom({pos:[e/2,i/2],scale:t})}_panFromCenter(t){const{width:e,height:i}=this._viewportProps;return this.pan({startPos:[e/2,i/2],pos:[e/2+t[0],i/2+t[1]]})}_getUpdatedState(t){return new this.constructor(E(E(E({makeViewport:this.makeViewport},this._viewportProps),this._state),t))}_applyConstraints(t){const{maxZoom:e,minZoom:i,zoom:r}=t;t.zoom=Kn(r,i,e);const{maxPitch:s,minPitch:o,pitch:a}=t;t.pitch=Kn(a,o,s);const{normalize:c=!0}=t;return c&&Object.assign(t,fv(t)),t}_unproject(t){const e=this.makeViewport(this._viewportProps);return t&&e.unproject(t)}_calculateNewZoom({scale:t,startZoom:e}){const{maxZoom:i,minZoom:r}=this._viewportProps,s=e+Math.log2(t);return Kn(s,r,i)}_calculateNewPitchAndBearing({deltaScaleX:t,deltaScaleY:e,startBearing:i,startPitch:r}){e=Kn(e,-1,1);const{minPitch:s,maxPitch:o}=this._viewportProps,a=i+180*t;let c=r;return e>0?c=r+e*(o-r):e<0&&(c=r-e*(s-r)),{pitch:c,bearing:a}}_getRotationParams(t,e){const i=t[0]-e[0],r=t[1]-e[1],s=t[1],o=e[1],{width:a,height:c}=this._viewportProps,l=i/a;let u=0;return r>0?Math.abs(c-o)>Ju&&(u=r/(o-c)*y1):r<0&&o>Ju&&(u=1-s/o),u=Math.min(1,Math.max(-1,u)),{deltaScaleX:l,deltaScaleY:u}}}class E1 extends _1{constructor(t){t.dragMode=t.dragMode||"pan";super(T1,t)}setProps(t){const e=this.controllerStateProps;super.setProps(t),(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState(E(E({makeViewport:this.makeViewport},this.controllerStateProps),this._state)))}get linearTransitionProps(){return["longitude","latitude","zoom","bearing","pitch"]}}class th extends u1{constructor(t){super(k(E({},t),{type:Fe}))}get controller(){return this._getControllerProps({type:E1})}}th.displayName="MapView";const v1=new Hu;class A1{constructor(){this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(t){"effects"in t&&(t.effects.length!==this.effects.length||!li(t.effects,this.effects))&&(this.setEffects(t.effects),this._needsRedraw="effects changed")}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(t=[]){this.cleanup(),this.effects=t,this._createInternalEffects()}cleanup(){for(const t of this.effects)t.cleanup();for(const t of this._internalEffects)t.cleanup();this.effects.length=0,this._internalEffects.length=0}_createInternalEffects(){this._internalEffects=this.effects.slice(),this.effects.some(t=>t instanceof Hu)||this._internalEffects.push(v1)}}class w1 extends mo{}const eh={blendFunc:[1,0,32771,0],blendEquation:32774};class nh extends mo{render(t){t.pickingFBO?(this.useAlpha=!0,this._drawPickingBuffer(t)):(this.useAlpha=!1,super.render(t))}_drawPickingBuffer({layers:t,layerFilter:e,views:i,viewports:r,onViewportActive:s,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:u},pass:h="picking",redrawReason:f,pickZ:g}){const m=this.gl;return this.pickZ=g,Gt(m,k(E({scissorTest:!0,scissor:[a,c,l,u],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0]},eh),{blend:!g}),()=>{super.render({target:o,layers:t,layerFilter:e,views:i,viewports:r,onViewportActive:s,pass:h,redrawReason:f})})}shouldDrawLayer(t){return t.props.pickable}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(t,e){const i=this.pickZ?{blend:!1}:k(E({},eh),{blend:!0,blendColor:[0,0,0,this.useAlpha?(e+1)/255:1]});return E(E({},t.props.parameters),i)}}const S1="deckRenderer.renderLayers";class I1{constructor(t){this.gl=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new w1(t),this.pickLayersPass=new nh(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){"layerFilter"in t&&this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in t&&this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){const e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;t.layerFilter=this.layerFilter,t.effects=t.effects||[],t.target=t.target||ct.getDefaultFramebuffer(this.gl),this._preRender(t.effects,t);const i=this.lastPostProcessEffect?this.renderBuffers[0]:t.target,r=e.render(k(E({},t),{target:i}));this._postRender(t.effects,t),this.renderCount++,gt(S1,this,r,t)}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){const{renderBuffers:t}=this;for(const e of t)e.delete();t.length=0}_preRender(t,e){let i=null;for(const r of t)r.preRender(this.gl,e),r.postRender&&(i=r);i&&this._resizeRenderBuffers(),this.lastPostProcessEffect=i}_resizeRenderBuffers(){const{renderBuffers:t}=this;t.length===0&&t.push(new ct(this.gl),new ct(this.gl));for(const e of t)e.resize()}_postRender(t,e){const{renderBuffers:i}=this,r={inputBuffer:i[0],swapBuffer:i[1],target:null};for(const s of t)if(s.postRender){if(s===this.lastPostProcessEffect){r.target=e.target,s.postRender(this.gl,r);break}const o=s.postRender(this.gl,r);r.inputBuffer=o,r.swapBuffer=o===i[0]?i[1]:i[0]}}}const P1={pickedColor:null,pickedLayer:null,pickedObjectIndex:-1};function x1({pickedColors:n,layers:t,deviceX:e,deviceY:i,deviceRadius:r,deviceRect:s}){if(n){const{x:o,y:a,width:c,height:l}=s;let u=r*r,h=-1,f=0;for(let g=0;g<l;g++){const m=g+a-i,_=m*m;if(_>u)f+=4*c;else for(let T=0;T<c;T++){if(n[f+3]-1>=0){const S=T+o-e,y=S*S+_;y<=u&&(u=y,h=f)}f+=4}}if(h>=0){const g=n[h+3]-1,m=n.slice(h,h+4),_=t[g];if(_){const T=_.decodePickingColor(m),v=Math.floor(h/4/c),S=h/4-v*c;return{pickedColor:m,pickedLayer:_,pickedObjectIndex:T,pickedX:o+S,pickedY:a+v}}W.error("Picked non-existent layer. Is picking buffer corrupt?")()}}return P1}function L1({pickedColors:n,layers:t}){const e=new Map;if(n)for(let i=0;i<n.length;i+=4){const r=n[i+3]-1;if(r>=0){const s=n.slice(i,i+4),o=s.join(",");if(!e.has(o)){const a=t[r];a?e.set(o,{pickedColor:s,pickedLayer:a,pickedObjectIndex:a.decodePickingColor(s)}):W.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(e.values())}function ih({pickInfo:n,mode:t,viewports:e,layerFilter:i,pixelRatio:r,x:s,y:o,z:a}){const c=n&&n.pickedLayer,u=R1(e,{x:s,y:o},i&&c&&(f=>i({layer:c,viewport:f,isPicking:!0,renderPass:"picking:".concat(t)}))),h=u&&u.unproject([s-u.x,o-u.y],{targetZ:a});return{color:null,layer:null,viewport:u,index:-1,picked:!1,x:s,y:o,pixel:[s,o],coordinate:h,devicePixel:n&&[n.pickedX,n.pickedY],pixelRatio:r}}function M1(n){const{pickInfo:t,lastPickedInfo:e,mode:i,layers:r}=n,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=t,c=o?[o]:[];if(i==="hover"){const h=e.index,f=e.layerId,g=o&&o.props.id;if(g!==f||a!==h){if(g!==f){const m=r.find(_=>_.props.id===f);m&&c.unshift(m)}e.layerId=g,e.index=a,e.info=null}}const l=ih(n),u=new Map;return u.set(null,l),c.forEach(h=>{let f=E({},l);h===o&&(f.color=s,f.index=a,f.picked=!0),f=rh({layer:h,info:f,mode:i}),h===o&&i==="hover"&&(e.info=f),u.set(f.layer.id,f),i==="hover"&&f.layer.updateAutoHighlight(f)}),u}function rh({layer:n,info:t,mode:e}){for(;n&&t;){const i=t.layer||null;t.sourceLayer=i,t.layer=n,t=n.getPickingInfo({info:t,mode:e,sourceLayer:i}),n=n.parent}return t}function R1(n,t,e){for(let i=n.length-1;i>=0;i--){const r=n[i];if(r.containsPixel(t)&&(!e||e(r)))return r}return n[0]}class O1{constructor(t){this.gl=t,this.pickingFBO=null,this.pickLayersPass=new nh(t),this.layerFilter=null,this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:i,viewports:r},s=this.lastPickedInfo.info){const o=s&&s.layer&&s.layer.id,a=s&&s.viewport&&s.viewport.id,c=o?i.find(f=>f.id===o):null,l=a&&r.find(f=>f.id===a)||r[0],u=l&&l.unproject([t-l.x,e-l.y]),h={x:t,y:e,viewport:l,coordinate:u,layer:c};return c?E(E({},s),h):Object.assign(h,{color:null,object:null,index:-1})}_resizeBuffer(){const{gl:t}=this;return this.pickingFBO||(this.pickingFBO=new ct(t),ct.isSupported(t,{colorBufferFloat:!0})&&(this.depthFBO=new ct(t),this.depthFBO.attach({[36064]:new It(t,{format:j(t)?34836:6408,type:5126})}))),this.pickingFBO.resize({width:t.canvas.width,height:t.canvas.height}),this.depthFBO&&this.depthFBO.resize({width:t.canvas.width,height:t.canvas.height}),this.pickingFBO}_getPickable(t){if(this._pickable===!1)return null;const e=t.filter(i=>i.isPickable()&&!i.isComposite);return e.length>255?(W.warn("Too many pickable layers, only picking the first 255")(),e.slice(0,255)):e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:i,x:r,y:s,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u}){if(t=this._getPickable(t),!t)return{result:[],emptyInfo:ih({viewports:i,x:r,y:s})};this._resizeBuffer();const h=We(this.gl),f=Ss(this.gl,[r,s],!0),g=[f.x+Math.floor(f.width/2),f.y+Math.floor(f.height/2)],m=Math.round(o*h),{width:_,height:T}=this.pickingFBO,v=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:_,deviceHeight:T});let S;const y=[],P={};for(let L=0;L<a;L++){const x=v&&this._drawAndSample({layers:t,views:e,viewports:i,onViewportActive:u,deviceRect:v,pass:"picking:".concat(c),redrawReason:c}),N=x1({pickedColors:x,layers:t,deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:v});let U;if(N.pickedLayer&&l&&this.depthFBO&&(U=this._drawAndSample({layers:[N.pickedLayer],views:e,viewports:i,onViewportActive:u,deviceRect:{x:N.pickedX,y:N.pickedY,width:1,height:1},pass:"picking:".concat(c),redrawReason:"pick-z",pickZ:!0})[0]*i[0].distanceScales.metersPerUnit[2]+i[0].position[2]),N.pickedColor&&L+1<a){const C=N.pickedColor[3]-1;P[C]=!0,t[C].disablePickingIndex(N.pickedObjectIndex)}S=M1({pickInfo:N,lastPickedInfo:this.lastPickedInfo,mode:c,layers:t,layerFilter:this.layerFilter,viewports:i,x:r,y:s,z:U,pixelRatio:h});for(const C of S.values())C.layer&&y.push(C);if(!N.pickedColor)break}for(const L in P)t[L].restorePickingColors();return{result:y,emptyInfo:S&&S.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:i,x:r,y:s,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u}){if(t=this._getPickable(t),!t)return[];this._resizeBuffer();const h=We(this.gl),f=Ss(this.gl,[r,s],!0),g=f.x,m=f.y+f.height,_=Ss(this.gl,[r+o,s+a],!0),T=_.x+_.width,v=_.y,S={x:g,y:v,width:T-g,height:m-v},y=this._drawAndSample({layers:t,views:e,viewports:i,onViewportActive:u,deviceRect:S,pass:"picking:".concat(c),redrawReason:c}),P=L1({pickedColors:y,layers:t}),L=new Map,x=Number.isFinite(l);for(let N=0;N<P.length&&!(x&&L.size>=l);N++){const U=P[N];let C={color:U.pickedColor,layer:null,index:U.pickedObjectIndex,picked:!0,x:r,y:s,width:o,height:a,pixelRatio:h};C=rh({layer:U.pickedLayer,info:C,mode:c}),L.has(C.object)||L.set(C.object,C)}return Array.from(L.values())}_drawAndSample({layers:t,views:e,viewports:i,onViewportActive:r,deviceRect:s,pass:o,redrawReason:a,pickZ:c}){if(t.length<1)return null;const l=c?this.depthFBO:this.pickingFBO;this.pickLayersPass.render({layers:t,layerFilter:this.layerFilter,views:e,viewports:i,onViewportActive:r,pickingFBO:l,deviceRect:s,pass:o,redrawReason:a,pickZ:c});const{x:u,y:h,width:f,height:g}=s,m=new(c?Float32Array:Uint8Array)(f*g*4);return Gi(l,{sourceX:u,sourceY:h,sourceWidth:f,sourceHeight:g,target:m}),m}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:i,deviceWidth:r,deviceHeight:s}){const o=Math.max(0,t-i),a=Math.max(0,e-i),c=Math.min(r,t+i+1)-o,l=Math.min(s,e+i+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}}const C1={zIndex:1,position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:0,left:0,display:"none"};class N1{constructor(t){const e=t.parentElement;e&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,C1),e.appendChild(this.el)),this.isVisible=!1}setTooltip(t,e,i){const r=this.el;if(typeof t=="string")r.innerText=t;else if(t)"text"in t&&(r.innerText=t.text),"html"in t&&(r.innerHTML=t.html),"className"in t&&(r.className=t.className),Object.assign(r.style,t.style);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform="translate(".concat(e,"px, ").concat(i,"px)")}remove(){this.el&&this.el.remove()}}var sh={exports:{}};/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */(function(n){(function(t,e,i,r){var s=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",c=Math.round,l=Math.abs,u=Date.now;function h(d,p,b){return setTimeout(y(d,b),p)}function f(d,p,b){return Array.isArray(d)?(g(d,b[p],b),!0):!1}function g(d,p,b){var w;if(!!d)if(d.forEach)d.forEach(p,b);else if(d.length!==r)for(w=0;w<d.length;)p.call(b,d[w],w,d),w++;else for(w in d)d.hasOwnProperty(w)&&p.call(b,d[w],w,d)}function m(d,p,b){var w="DEPRECATED METHOD: "+p+`
`+b+` AT 
`;return function(){var M=new Error("get-stack-trace"),D=M&&M.stack?M.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",G=t.console&&(t.console.warn||t.console.log);return G&&G.call(t.console,w,D),d.apply(this,arguments)}}var _;typeof Object.assign!="function"?_=function(p){if(p===r||p===null)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(p),w=1;w<arguments.length;w++){var M=arguments[w];if(M!==r&&M!==null)for(var D in M)M.hasOwnProperty(D)&&(b[D]=M[D])}return b}:_=Object.assign;var T=m(function(p,b,w){for(var M=Object.keys(b),D=0;D<M.length;)(!w||w&&p[M[D]]===r)&&(p[M[D]]=b[M[D]]),D++;return p},"extend","Use `assign`."),v=m(function(p,b){return T(p,b,!0)},"merge","Use `assign`.");function S(d,p,b){var w=p.prototype,M;M=d.prototype=Object.create(w),M.constructor=d,M._super=w,b&&_(M,b)}function y(d,p){return function(){return d.apply(p,arguments)}}function P(d,p){return typeof d==a?d.apply(p&&p[0]||r,p):d}function L(d,p){return d===r?p:d}function x(d,p,b){g(B(p),function(w){d.addEventListener(w,b,!1)})}function N(d,p,b){g(B(p),function(w){d.removeEventListener(w,b,!1)})}function U(d,p){for(;d;){if(d==p)return!0;d=d.parentNode}return!1}function C(d,p){return d.indexOf(p)>-1}function B(d){return d.trim().split(/\s+/g)}function V(d,p,b){if(d.indexOf&&!b)return d.indexOf(p);for(var w=0;w<d.length;){if(b&&d[w][b]==p||!b&&d[w]===p)return w;w++}return-1}function z(d){return Array.prototype.slice.call(d,0)}function Y(d,p,b){for(var w=[],M=[],D=0;D<d.length;){var G=p?d[D][p]:d[D];V(M,G)<0&&w.push(d[D]),M[D]=G,D++}return b&&(p?w=w.sort(function(ht,bt){return ht[p]>bt[p]}):w=w.sort()),w}function R(d,p){for(var b,w,M=p[0].toUpperCase()+p.slice(1),D=0;D<s.length;){if(b=s[D],w=b?b+M:p,w in d)return w;D++}return r}var Dt=1;function ke(){return Dt++}function Pe(d){var p=d.ownerDocument||d;return p.defaultView||p.parentWindow||t}var Vr=/mobile|tablet|ip(ad|hone|od)|android/i,vi="ontouchstart"in t,_d=R(t,"PointerEvent")!==r,bd=vi&&Vr.test(navigator.userAgent),Tn="touch",yd="pen",zr="mouse",Td="kinect",Ed=25,_t=1,xe=2,ot=4,vt=8,Ai=1,En=2,vn=4,An=8,wn=16,Zt=En|vn,Le=An|wn,ha=Zt|Le,fa=["x","y"],wi=["clientX","clientY"];function Ft(d,p){var b=this;this.manager=d,this.callback=p,this.element=d.element,this.target=d.options.inputTarget,this.domHandler=function(w){P(d.options.enable,[d])&&b.handler(w)},this.init()}Ft.prototype={handler:function(){},init:function(){this.evEl&&x(this.element,this.evEl,this.domHandler),this.evTarget&&x(this.target,this.evTarget,this.domHandler),this.evWin&&x(Pe(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&N(this.element,this.evEl,this.domHandler),this.evTarget&&N(this.target,this.evTarget,this.domHandler),this.evWin&&N(Pe(this.element),this.evWin,this.domHandler)}};function vd(d){var p,b=d.options.inputClass;return b?p=b:_d?p=Gr:bd?p=Pi:vi?p=$r:p=Ii,new p(d,Ad)}function Ad(d,p,b){var w=b.pointers.length,M=b.changedPointers.length,D=p&_t&&w-M==0,G=p&(ot|vt)&&w-M==0;b.isFirst=!!D,b.isFinal=!!G,D&&(d.session={}),b.eventType=p,wd(d,b),d.emit("hammer.input",b),d.recognize(b),d.session.prevInput=b}function wd(d,p){var b=d.session,w=p.pointers,M=w.length;b.firstInput||(b.firstInput=da(p)),M>1&&!b.firstMultiple?b.firstMultiple=da(p):M===1&&(b.firstMultiple=!1);var D=b.firstInput,G=b.firstMultiple,ut=G?G.center:D.center,ht=p.center=ga(w);p.timeStamp=u(),p.deltaTime=p.timeStamp-D.timeStamp,p.angle=jr(ut,ht),p.distance=Si(ut,ht),Sd(b,p),p.offsetDirection=ma(p.deltaX,p.deltaY);var bt=pa(p.deltaTime,p.deltaX,p.deltaY);p.overallVelocityX=bt.x,p.overallVelocityY=bt.y,p.overallVelocity=l(bt.x)>l(bt.y)?bt.x:bt.y,p.scale=G?xd(G.pointers,w):1,p.rotation=G?Pd(G.pointers,w):0,p.maxPointers=b.prevInput?p.pointers.length>b.prevInput.maxPointers?p.pointers.length:b.prevInput.maxPointers:p.pointers.length,Id(b,p);var Qt=d.element;U(p.srcEvent.target,Qt)&&(Qt=p.srcEvent.target),p.target=Qt}function Sd(d,p){var b=p.center,w=d.offsetDelta||{},M=d.prevDelta||{},D=d.prevInput||{};(p.eventType===_t||D.eventType===ot)&&(M=d.prevDelta={x:D.deltaX||0,y:D.deltaY||0},w=d.offsetDelta={x:b.x,y:b.y}),p.deltaX=M.x+(b.x-w.x),p.deltaY=M.y+(b.y-w.y)}function Id(d,p){var b=d.lastInterval||p,w=p.timeStamp-b.timeStamp,M,D,G,ut;if(p.eventType!=vt&&(w>Ed||b.velocity===r)){var ht=p.deltaX-b.deltaX,bt=p.deltaY-b.deltaY,Qt=pa(w,ht,bt);D=Qt.x,G=Qt.y,M=l(Qt.x)>l(Qt.y)?Qt.x:Qt.y,ut=ma(ht,bt),d.lastInterval=p}else M=b.velocity,D=b.velocityX,G=b.velocityY,ut=b.direction;p.velocity=M,p.velocityX=D,p.velocityY=G,p.direction=ut}function da(d){for(var p=[],b=0;b<d.pointers.length;)p[b]={clientX:c(d.pointers[b].clientX),clientY:c(d.pointers[b].clientY)},b++;return{timeStamp:u(),pointers:p,center:ga(p),deltaX:d.deltaX,deltaY:d.deltaY}}function ga(d){var p=d.length;if(p===1)return{x:c(d[0].clientX),y:c(d[0].clientY)};for(var b=0,w=0,M=0;M<p;)b+=d[M].clientX,w+=d[M].clientY,M++;return{x:c(b/p),y:c(w/p)}}function pa(d,p,b){return{x:p/d||0,y:b/d||0}}function ma(d,p){return d===p?Ai:l(d)>=l(p)?d<0?En:vn:p<0?An:wn}function Si(d,p,b){b||(b=fa);var w=p[b[0]]-d[b[0]],M=p[b[1]]-d[b[1]];return Math.sqrt(w*w+M*M)}function jr(d,p,b){b||(b=fa);var w=p[b[0]]-d[b[0]],M=p[b[1]]-d[b[1]];return Math.atan2(M,w)*180/Math.PI}function Pd(d,p){return jr(p[1],p[0],wi)+jr(d[1],d[0],wi)}function xd(d,p){return Si(p[0],p[1],wi)/Si(d[0],d[1],wi)}var Ld={mousedown:_t,mousemove:xe,mouseup:ot},Md="mousedown",Rd="mousemove mouseup";function Ii(){this.evEl=Md,this.evWin=Rd,this.pressed=!1,Ft.apply(this,arguments)}S(Ii,Ft,{handler:function(p){var b=Ld[p.type];b&_t&&p.button===0&&(this.pressed=!0),b&xe&&p.which!==1&&(b=ot),!!this.pressed&&(b&ot&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[p],changedPointers:[p],pointerType:zr,srcEvent:p}))}});var Od={pointerdown:_t,pointermove:xe,pointerup:ot,pointercancel:vt,pointerout:vt},Cd={2:Tn,3:yd,4:zr,5:Td},_a="pointerdown",ba="pointermove pointerup pointercancel";t.MSPointerEvent&&!t.PointerEvent&&(_a="MSPointerDown",ba="MSPointerMove MSPointerUp MSPointerCancel");function Gr(){this.evEl=_a,this.evWin=ba,Ft.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}S(Gr,Ft,{handler:function(p){var b=this.store,w=!1,M=p.type.toLowerCase().replace("ms",""),D=Od[M],G=Cd[p.pointerType]||p.pointerType,ut=G==Tn,ht=V(b,p.pointerId,"pointerId");D&_t&&(p.button===0||ut)?ht<0&&(b.push(p),ht=b.length-1):D&(ot|vt)&&(w=!0),!(ht<0)&&(b[ht]=p,this.callback(this.manager,D,{pointers:b,changedPointers:[p],pointerType:G,srcEvent:p}),w&&b.splice(ht,1))}});var Nd={touchstart:_t,touchmove:xe,touchend:ot,touchcancel:vt},Dd="touchstart",Fd="touchstart touchmove touchend touchcancel";function ya(){this.evTarget=Dd,this.evWin=Fd,this.started=!1,Ft.apply(this,arguments)}S(ya,Ft,{handler:function(p){var b=Nd[p.type];if(b===_t&&(this.started=!0),!!this.started){var w=Ud.call(this,p,b);b&(ot|vt)&&w[0].length-w[1].length==0&&(this.started=!1),this.callback(this.manager,b,{pointers:w[0],changedPointers:w[1],pointerType:Tn,srcEvent:p})}}});function Ud(d,p){var b=z(d.touches),w=z(d.changedTouches);return p&(ot|vt)&&(b=Y(b.concat(w),"identifier",!0)),[b,w]}var Bd={touchstart:_t,touchmove:xe,touchend:ot,touchcancel:vt},kd="touchstart touchmove touchend touchcancel";function Pi(){this.evTarget=kd,this.targetIds={},Ft.apply(this,arguments)}S(Pi,Ft,{handler:function(p){var b=Bd[p.type],w=Vd.call(this,p,b);!w||this.callback(this.manager,b,{pointers:w[0],changedPointers:w[1],pointerType:Tn,srcEvent:p})}});function Vd(d,p){var b=z(d.touches),w=this.targetIds;if(p&(_t|xe)&&b.length===1)return w[b[0].identifier]=!0,[b,b];var M,D,G=z(d.changedTouches),ut=[],ht=this.target;if(D=b.filter(function(bt){return U(bt.target,ht)}),p===_t)for(M=0;M<D.length;)w[D[M].identifier]=!0,M++;for(M=0;M<G.length;)w[G[M].identifier]&&ut.push(G[M]),p&(ot|vt)&&delete w[G[M].identifier],M++;if(!!ut.length)return[Y(D.concat(ut),"identifier",!0),ut]}var zd=2500,Ta=25;function $r(){Ft.apply(this,arguments);var d=y(this.handler,this);this.touch=new Pi(this.manager,d),this.mouse=new Ii(this.manager,d),this.primaryTouch=null,this.lastTouches=[]}S($r,Ft,{handler:function(p,b,w){var M=w.pointerType==Tn,D=w.pointerType==zr;if(!(D&&w.sourceCapabilities&&w.sourceCapabilities.firesTouchEvents)){if(M)jd.call(this,b,w);else if(D&&Gd.call(this,w))return;this.callback(p,b,w)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function jd(d,p){d&_t?(this.primaryTouch=p.changedPointers[0].identifier,Ea.call(this,p)):d&(ot|vt)&&Ea.call(this,p)}function Ea(d){var p=d.changedPointers[0];if(p.identifier===this.primaryTouch){var b={x:p.clientX,y:p.clientY};this.lastTouches.push(b);var w=this.lastTouches,M=function(){var D=w.indexOf(b);D>-1&&w.splice(D,1)};setTimeout(M,zd)}}function Gd(d){for(var p=d.srcEvent.clientX,b=d.srcEvent.clientY,w=0;w<this.lastTouches.length;w++){var M=this.lastTouches[w],D=Math.abs(p-M.x),G=Math.abs(b-M.y);if(D<=Ta&&G<=Ta)return!0}return!1}var va=R(o.style,"touchAction"),Aa=va!==r,wa="compute",Sa="auto",Hr="manipulation",Me="none",Sn="pan-x",In="pan-y",xi=Hd();function Wr(d,p){this.manager=d,this.set(p)}Wr.prototype={set:function(d){d==wa&&(d=this.compute()),Aa&&this.manager.element.style&&xi[d]&&(this.manager.element.style[va]=d),this.actions=d.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var d=[];return g(this.manager.recognizers,function(p){P(p.options.enable,[p])&&(d=d.concat(p.getTouchAction()))}),$d(d.join(" "))},preventDefaults:function(d){var p=d.srcEvent,b=d.offsetDirection;if(this.manager.session.prevented){p.preventDefault();return}var w=this.actions,M=C(w,Me)&&!xi[Me],D=C(w,In)&&!xi[In],G=C(w,Sn)&&!xi[Sn];if(M){var ut=d.pointers.length===1,ht=d.distance<2,bt=d.deltaTime<250;if(ut&&ht&&bt)return}if(!(G&&D)&&(M||D&&b&Zt||G&&b&Le))return this.preventSrc(p)},preventSrc:function(d){this.manager.session.prevented=!0,d.preventDefault()}};function $d(d){if(C(d,Me))return Me;var p=C(d,Sn),b=C(d,In);return p&&b?Me:p||b?p?Sn:In:C(d,Hr)?Hr:Sa}function Hd(){if(!Aa)return!1;var d={},p=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(b){d[b]=p?t.CSS.supports("touch-action",b):!0}),d}var Li=1,Ut=2,Ve=4,ye=8,oe=ye,Pn=16,Kt=32;function ae(d){this.options=_({},this.defaults,d||{}),this.id=ke(),this.manager=null,this.options.enable=L(this.options.enable,!0),this.state=Li,this.simultaneous={},this.requireFail=[]}ae.prototype={defaults:{},set:function(d){return _(this.options,d),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(d){if(f(d,"recognizeWith",this))return this;var p=this.simultaneous;return d=Mi(d,this),p[d.id]||(p[d.id]=d,d.recognizeWith(this)),this},dropRecognizeWith:function(d){return f(d,"dropRecognizeWith",this)?this:(d=Mi(d,this),delete this.simultaneous[d.id],this)},requireFailure:function(d){if(f(d,"requireFailure",this))return this;var p=this.requireFail;return d=Mi(d,this),V(p,d)===-1&&(p.push(d),d.requireFailure(this)),this},dropRequireFailure:function(d){if(f(d,"dropRequireFailure",this))return this;d=Mi(d,this);var p=V(this.requireFail,d);return p>-1&&this.requireFail.splice(p,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(d){return!!this.simultaneous[d.id]},emit:function(d){var p=this,b=this.state;function w(M){p.manager.emit(M,d)}b<ye&&w(p.options.event+Ia(b)),w(p.options.event),d.additionalEvent&&w(d.additionalEvent),b>=ye&&w(p.options.event+Ia(b))},tryEmit:function(d){if(this.canEmit())return this.emit(d);this.state=Kt},canEmit:function(){for(var d=0;d<this.requireFail.length;){if(!(this.requireFail[d].state&(Kt|Li)))return!1;d++}return!0},recognize:function(d){var p=_({},d);if(!P(this.options.enable,[this,p])){this.reset(),this.state=Kt;return}this.state&(oe|Pn|Kt)&&(this.state=Li),this.state=this.process(p),this.state&(Ut|Ve|ye|Pn)&&this.tryEmit(p)},process:function(d){},getTouchAction:function(){},reset:function(){}};function Ia(d){return d&Pn?"cancel":d&ye?"end":d&Ve?"move":d&Ut?"start":""}function Pa(d){return d==wn?"down":d==An?"up":d==En?"left":d==vn?"right":""}function Mi(d,p){var b=p.manager;return b?b.get(d):d}function zt(){ae.apply(this,arguments)}S(zt,ae,{defaults:{pointers:1},attrTest:function(d){var p=this.options.pointers;return p===0||d.pointers.length===p},process:function(d){var p=this.state,b=d.eventType,w=p&(Ut|Ve),M=this.attrTest(d);return w&&(b&vt||!M)?p|Pn:w||M?b&ot?p|ye:p&Ut?p|Ve:Ut:Kt}});function Ri(){zt.apply(this,arguments),this.pX=null,this.pY=null}S(Ri,zt,{defaults:{event:"pan",threshold:10,pointers:1,direction:ha},getTouchAction:function(){var d=this.options.direction,p=[];return d&Zt&&p.push(In),d&Le&&p.push(Sn),p},directionTest:function(d){var p=this.options,b=!0,w=d.distance,M=d.direction,D=d.deltaX,G=d.deltaY;return M&p.direction||(p.direction&Zt?(M=D===0?Ai:D<0?En:vn,b=D!=this.pX,w=Math.abs(d.deltaX)):(M=G===0?Ai:G<0?An:wn,b=G!=this.pY,w=Math.abs(d.deltaY))),d.direction=M,b&&w>p.threshold&&M&p.direction},attrTest:function(d){return zt.prototype.attrTest.call(this,d)&&(this.state&Ut||!(this.state&Ut)&&this.directionTest(d))},emit:function(d){this.pX=d.deltaX,this.pY=d.deltaY;var p=Pa(d.direction);p&&(d.additionalEvent=this.options.event+p),this._super.emit.call(this,d)}});function qr(){zt.apply(this,arguments)}S(qr,zt,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Me]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.scale-1)>this.options.threshold||this.state&Ut)},emit:function(d){if(d.scale!==1){var p=d.scale<1?"in":"out";d.additionalEvent=this.options.event+p}this._super.emit.call(this,d)}});function Yr(){ae.apply(this,arguments),this._timer=null,this._input=null}S(Yr,ae,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[Sa]},process:function(d){var p=this.options,b=d.pointers.length===p.pointers,w=d.distance<p.threshold,M=d.deltaTime>p.time;if(this._input=d,!w||!b||d.eventType&(ot|vt)&&!M)this.reset();else if(d.eventType&_t)this.reset(),this._timer=h(function(){this.state=oe,this.tryEmit()},p.time,this);else if(d.eventType&ot)return oe;return Kt},reset:function(){clearTimeout(this._timer)},emit:function(d){this.state===oe&&(d&&d.eventType&ot?this.manager.emit(this.options.event+"up",d):(this._input.timeStamp=u(),this.manager.emit(this.options.event,this._input)))}});function Xr(){zt.apply(this,arguments)}S(Xr,zt,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Me]},attrTest:function(d){return this._super.attrTest.call(this,d)&&(Math.abs(d.rotation)>this.options.threshold||this.state&Ut)}});function Zr(){zt.apply(this,arguments)}S(Zr,zt,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Zt|Le,pointers:1},getTouchAction:function(){return Ri.prototype.getTouchAction.call(this)},attrTest:function(d){var p=this.options.direction,b;return p&(Zt|Le)?b=d.overallVelocity:p&Zt?b=d.overallVelocityX:p&Le&&(b=d.overallVelocityY),this._super.attrTest.call(this,d)&&p&d.offsetDirection&&d.distance>this.options.threshold&&d.maxPointers==this.options.pointers&&l(b)>this.options.velocity&&d.eventType&ot},emit:function(d){var p=Pa(d.offsetDirection);p&&this.manager.emit(this.options.event+p,d),this.manager.emit(this.options.event,d)}});function Oi(){ae.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}S(Oi,ae,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[Hr]},process:function(d){var p=this.options,b=d.pointers.length===p.pointers,w=d.distance<p.threshold,M=d.deltaTime<p.time;if(this.reset(),d.eventType&_t&&this.count===0)return this.failTimeout();if(w&&M&&b){if(d.eventType!=ot)return this.failTimeout();var D=this.pTime?d.timeStamp-this.pTime<p.interval:!0,G=!this.pCenter||Si(this.pCenter,d.center)<p.posThreshold;this.pTime=d.timeStamp,this.pCenter=d.center,!G||!D?this.count=1:this.count+=1,this._input=d;var ut=this.count%p.taps;if(ut===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=oe,this.tryEmit()},p.interval,this),Ut):oe}return Kt},failTimeout:function(){return this._timer=h(function(){this.state=Kt},this.options.interval,this),Kt},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==oe&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function ce(d,p){return p=p||{},p.recognizers=L(p.recognizers,ce.defaults.preset),new Kr(d,p)}ce.VERSION="2.0.7",ce.defaults={domEvents:!1,touchAction:wa,enable:!0,inputTarget:null,inputClass:null,preset:[[Xr,{enable:!1}],[qr,{enable:!1},["rotate"]],[Zr,{direction:Zt}],[Ri,{direction:Zt},["swipe"]],[Oi],[Oi,{event:"doubletap",taps:2},["tap"]],[Yr]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Wd=1,xa=2;function Kr(d,p){this.options=_({},ce.defaults,p||{}),this.options.inputTarget=this.options.inputTarget||d,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=d,this.input=vd(this),this.touchAction=new Wr(this,this.options.touchAction),La(this,!0),g(this.options.recognizers,function(b){var w=this.add(new b[0](b[1]));b[2]&&w.recognizeWith(b[2]),b[3]&&w.requireFailure(b[3])},this)}Kr.prototype={set:function(d){return _(this.options,d),d.touchAction&&this.touchAction.update(),d.inputTarget&&(this.input.destroy(),this.input.target=d.inputTarget,this.input.init()),this},stop:function(d){this.session.stopped=d?xa:Wd},recognize:function(d){var p=this.session;if(!p.stopped){this.touchAction.preventDefaults(d);var b,w=this.recognizers,M=p.curRecognizer;(!M||M&&M.state&oe)&&(M=p.curRecognizer=null);for(var D=0;D<w.length;)b=w[D],p.stopped!==xa&&(!M||b==M||b.canRecognizeWith(M))?b.recognize(d):b.reset(),!M&&b.state&(Ut|Ve|ye)&&(M=p.curRecognizer=b),D++}},get:function(d){if(d instanceof ae)return d;for(var p=this.recognizers,b=0;b<p.length;b++)if(p[b].options.event==d)return p[b];return null},add:function(d){if(f(d,"add",this))return this;var p=this.get(d.options.event);return p&&this.remove(p),this.recognizers.push(d),d.manager=this,this.touchAction.update(),d},remove:function(d){if(f(d,"remove",this))return this;if(d=this.get(d),d){var p=this.recognizers,b=V(p,d);b!==-1&&(p.splice(b,1),this.touchAction.update())}return this},on:function(d,p){if(d!==r&&p!==r){var b=this.handlers;return g(B(d),function(w){b[w]=b[w]||[],b[w].push(p)}),this}},off:function(d,p){if(d!==r){var b=this.handlers;return g(B(d),function(w){p?b[w]&&b[w].splice(V(b[w],p),1):delete b[w]}),this}},emit:function(d,p){this.options.domEvents&&qd(d,p);var b=this.handlers[d]&&this.handlers[d].slice();if(!(!b||!b.length)){p.type=d,p.preventDefault=function(){p.srcEvent.preventDefault()};for(var w=0;w<b.length;)b[w](p),w++}},destroy:function(){this.element&&La(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function La(d,p){var b=d.element;if(!!b.style){var w;g(d.options.cssProps,function(M,D){w=R(b.style,D),p?(d.oldCssProps[w]=b.style[w],b.style[w]=M):b.style[w]=d.oldCssProps[w]||""}),p||(d.oldCssProps={})}}function qd(d,p){var b=e.createEvent("Event");b.initEvent(d,!0,!0),b.gesture=p,p.target.dispatchEvent(b)}_(ce,{INPUT_START:_t,INPUT_MOVE:xe,INPUT_END:ot,INPUT_CANCEL:vt,STATE_POSSIBLE:Li,STATE_BEGAN:Ut,STATE_CHANGED:Ve,STATE_ENDED:ye,STATE_RECOGNIZED:oe,STATE_CANCELLED:Pn,STATE_FAILED:Kt,DIRECTION_NONE:Ai,DIRECTION_LEFT:En,DIRECTION_RIGHT:vn,DIRECTION_UP:An,DIRECTION_DOWN:wn,DIRECTION_HORIZONTAL:Zt,DIRECTION_VERTICAL:Le,DIRECTION_ALL:ha,Manager:Kr,Input:Ft,TouchAction:Wr,TouchInput:Pi,MouseInput:Ii,PointerEventInput:Gr,TouchMouseInput:$r,SingleTouchInput:ya,Recognizer:ae,AttrRecognizer:zt,Tap:Oi,Pan:Ri,Swipe:Zr,Pinch:qr,Rotate:Xr,Press:Yr,on:x,off:N,each:g,merge:v,extend:T,assign:_,inherit:S,bindFn:y,prefixed:R});var Yd=typeof t!="undefined"?t:typeof self!="undefined"?self:{};Yd.Hammer=ce,typeof r=="function"&&r.amd?r(function(){return ce}):n.exports?n.exports=ce:t[i]=ce})(window,document,"Hammer")})(sh);var Mt=sh.exports;const oh=1,ah=2,Eo=4,D1={mousedown:oh,mousemove:ah,mouseup:Eo};function F1(n,t){for(let e=0;e<n.length;e++)if(t(n[e]))return!0;return!1}function U1(n){const t=n.prototype.handler;n.prototype.handler=function(i){const r=this.store;i.button>0&&i.type==="pointerdown"&&(F1(r,s=>s.pointerId===i.pointerId)||r.push(i)),t.call(this,i)}}function B1(n){n.prototype.handler=function(e){let i=D1[e.type];i&oh&&e.button>=0&&(this.pressed=!0),i&ah&&e.which===0&&(i=Eo),!!this.pressed&&(i&Eo&&(this.pressed=!1),this.callback(this.manager,i,{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e}))}}U1(Mt.PointerEventInput);B1(Mt.MouseInput);const k1=Mt.Manager,V1=Mt?[[Mt.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[Mt.Rotate,{enable:!1}],[Mt.Pinch,{enable:!1}],[Mt.Swipe,{enable:!1}],[Mt.Pan,{threshold:0,enable:!1}],[Mt.Press,{enable:!1}],[Mt.Tap,{event:"doubletap",taps:2,enable:!1}],[Mt.Tap,{event:"anytap",enable:!1}],[Mt.Tap,{enable:!1}]]:null,ch={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},z1={doubletap:["tap"]},j1={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},vo={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},G1={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},lh={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},$1=typeof navigator!="undefined"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",hn=typeof window!="undefined"?window:global;let uh=!1;try{const n={get passive(){return uh=!0,!0}};hn.addEventListener("test",n,n),hn.removeEventListener("test",n,n)}catch(n){}const H1=$1.indexOf("firefox")!==-1,{WHEEL_EVENTS:W1}=vo,hh="wheel",fh=4.000244140625,q1=40,Y1=.25;class X1{constructor(t,e,i={}){this.element=t,this.callback=e,this.options=Object.assign({enable:!0},i),this.events=W1.concat(i.events||[]),this.handleEvent=this.handleEvent.bind(this),this.events.forEach(r=>t.addEventListener(r,this.handleEvent,uh?{passive:!1}:!1))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===hh&&(this.options.enable=e)}handleEvent(t){if(!this.options.enable)return;let e=t.deltaY;hn.WheelEvent&&(H1&&t.deltaMode===hn.WheelEvent.DOM_DELTA_PIXEL&&(e/=hn.devicePixelRatio),t.deltaMode===hn.WheelEvent.DOM_DELTA_LINE&&(e*=q1));const i={x:t.clientX,y:t.clientY};e!==0&&e%fh==0&&(e=Math.floor(e/fh)),t.shiftKey&&e&&(e=e*Y1),this._onWheel(t,-e,i)}_onWheel(t,e,i){this.callback({type:hh,center:i,delta:e,srcEvent:t,pointerType:"mouse",target:t.target})}}const{MOUSE_EVENTS:Z1}=vo,dh="pointermove",gh="pointerover",ph="pointerout",mh="pointerleave";class K1{constructor(t,e,i={}){this.element=t,this.callback=e,this.pressed=!1,this.options=Object.assign({enable:!0},i),this.enableMoveEvent=this.options.enable,this.enableLeaveEvent=this.options.enable,this.enableOutEvent=this.options.enable,this.enableOverEvent=this.options.enable,this.events=Z1.concat(i.events||[]),this.handleEvent=this.handleEvent.bind(this),this.events.forEach(r=>t.addEventListener(r,this.handleEvent))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===dh&&(this.enableMoveEvent=e),t===gh&&(this.enableOverEvent=e),t===ph&&(this.enableOutEvent=e),t===mh&&(this.enableLeaveEvent=e)}handleEvent(t){this.handleOverEvent(t),this.handleOutEvent(t),this.handleLeaveEvent(t),this.handleMoveEvent(t)}handleOverEvent(t){this.enableOverEvent&&t.type==="mouseover"&&this.callback({type:gh,srcEvent:t,pointerType:"mouse",target:t.target})}handleOutEvent(t){this.enableOutEvent&&t.type==="mouseout"&&this.callback({type:ph,srcEvent:t,pointerType:"mouse",target:t.target})}handleLeaveEvent(t){this.enableLeaveEvent&&t.type==="mouseleave"&&this.callback({type:mh,srcEvent:t,pointerType:"mouse",target:t.target})}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":t.which===0&&(this.pressed=!1),this.pressed||this.callback({type:dh,srcEvent:t,pointerType:"mouse",target:t.target});break;case"mouseup":this.pressed=!1;break}}}const{KEY_EVENTS:Q1}=vo,_h="keydown",bh="keyup";class J1{constructor(t,e,i={}){this.element=t,this.callback=e,this.options=Object.assign({enable:!0},i),this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=Q1.concat(i.events||[]),this.handleEvent=this.handleEvent.bind(this),t.tabIndex=i.tabIndex||0,t.style.outline="none",this.events.forEach(r=>t.addEventListener(r,this.handleEvent))}destroy(){this.events.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t===_h&&(this.enableDownEvent=e),t===bh&&(this.enableUpEvent=e)}handleEvent(t){const e=t.target||t.srcElement;e.tagName==="INPUT"&&e.type==="text"||e.tagName==="TEXTAREA"||(this.enableDownEvent&&t.type==="keydown"&&this.callback({type:_h,srcEvent:t,key:t.key,target:t.target}),this.enableUpEvent&&t.type==="keyup"&&this.callback({type:bh,srcEvent:t,key:t.key,target:t.target}))}}const yh="contextmenu";class tA{constructor(t,e,i={}){this.element=t,this.callback=e,this.options=Object.assign({enable:!0},i),this.handleEvent=this.handleEvent.bind(this),t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t===yh&&(this.options.enable=e)}handleEvent(t){!this.options.enable||this.callback({type:yh,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const Ao=1,gr=2,wo=4,eA={pointerdown:Ao,pointermove:gr,pointerup:wo,mousedown:Ao,mousemove:gr,mouseup:wo},nA=1,iA=2,rA=3,sA=0,oA=1,aA=2,cA=1,lA=2,uA=4;function hA(n){const t=eA[n.srcEvent.type];if(!t)return null;const{buttons:e,button:i,which:r}=n.srcEvent;let s=!1,o=!1,a=!1;return t===wo||t===gr&&!Number.isFinite(e)?(s=r===nA,o=r===iA,a=r===rA):t===gr?(s=Boolean(e&cA),o=Boolean(e&uA),a=Boolean(e&lA)):t===Ao&&(s=i===sA,o=i===oA,a=i===aA),{leftButton:s,middleButton:o,rightButton:a}}function fA(n,t){const{srcEvent:e}=n;if(!n.center&&!Number.isFinite(e.clientX))return null;const i=n.center||{x:e.clientX,y:e.clientY},r=t.getBoundingClientRect(),s=r.width/t.offsetWidth||1,o=r.height/t.offsetHeight||1,a={x:(i.x-r.left-t.clientLeft)/s,y:(i.y-r.top-t.clientTop)/o};return{center:i,offsetCenter:a}}const Th={srcElement:"root",priority:0};class dA{constructor(t){this.eventManager=t,this.handlers=[],this.handlersByElement=new Map,this.handleEvent=this.handleEvent.bind(this),this._active=!1}isEmpty(){return!this._active}add(t,e,i,r=!1,s=!1){const{handlers:o,handlersByElement:a}=this;i&&(typeof i!="object"||i.addEventListener)&&(i={srcElement:i}),i=i?Object.assign({},Th,i):Th;let c=a.get(i.srcElement);c||(c=[],a.set(i.srcElement,c));const l={type:t,handler:e,srcElement:i.srcElement,priority:i.priority};r&&(l.once=!0),s&&(l.passive=!0),o.push(l),this._active=this._active||!l.passive;let u=c.length-1;for(;u>=0&&!(c[u].priority>=l.priority);)u--;c.splice(u+1,0,l)}remove(t,e){const{handlers:i,handlersByElement:r}=this;for(let s=i.length-1;s>=0;s--){const o=i[s];if(o.type===t&&o.handler===e){i.splice(s,1);const a=r.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&r.delete(o.srcElement)}}this._active=i.some(s=>!s.passive)}handleEvent(t){if(this.isEmpty())return;const e=this._normalizeEvent(t);let i=t.srcEvent.target;for(;i&&i!==e.rootElement;){if(this._emit(e,i),e.handled)return;i=i.parentNode}this._emit(e,"root")}_emit(t,e){const i=this.handlersByElement.get(e);if(i){let r=!1;const s=()=>{t.handled=!0},o=()=>{t.handled=!0,r=!0},a=[];for(let c=0;c<i.length;c++){const{type:l,handler:u,once:h}=i[c];if(u(Object.assign({},t,{type:l,stopPropagation:s,stopImmediatePropagation:o})),h&&a.push(i[c]),r)break}for(let c=0;c<a.length;c++){const{type:l,handler:u}=a[c];this.remove(l,u)}}}_normalizeEvent(t){const e=this.eventManager.element;return Object.assign({},t,hA(t),fA(t,e),{handled:!1,rootElement:e})}}const gA={events:null,recognizers:null,recognizerOptions:{},Manager:k1,touchAction:"none",tabIndex:0};class pA{constructor(t=null,e={}){this.options=Object.assign({},gA,e),this.events=new Map,this._onBasicInput=this._onBasicInput.bind(this),this._onOtherEvent=this._onOtherEvent.bind(this),this.setElement(t);const{events:i}=e;i&&this.on(i)}setElement(t){if(this.element&&this.destroy(),this.element=t,!t)return;const{options:e}=this,i=e.Manager;this.manager=new i(t,{touchAction:e.touchAction,recognizers:e.recognizers||V1}).on("hammer.input",this._onBasicInput),e.recognizers||Object.keys(ch).forEach(r=>{const s=this.manager.get(r);s&&ch[r].forEach(o=>{s.recognizeWith(o)})});for(const r in e.recognizerOptions){const s=this.manager.get(r);if(s){const o=e.recognizerOptions[r];delete o.enable,s.set(o)}}this.wheelInput=new X1(t,this._onOtherEvent,{enable:!1}),this.moveInput=new K1(t,this._onOtherEvent,{enable:!1}),this.keyInput=new J1(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new tA(t,this._onOtherEvent,{enable:!1});for(const[r,s]of this.events)s.isEmpty()||(this._toggleRecognizer(s.recognizerName,!0),this.manager.on(r,s.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(t,e,i){this._addEventHandler(t,e,i,!1)}once(t,e,i){this._addEventHandler(t,e,i,!0)}watch(t,e,i){this._addEventHandler(t,e,i,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){const{manager:i}=this;if(!i)return;const r=i.get(t);if(r&&r.options.enable!==e){r.set({enable:e});const s=z1[t];s&&!this.options.recognizers&&s.forEach(o=>{const a=i.get(o);e?(a.requireFailure(t),r.dropRequireFailure(o)):a.dropRequireFailure(t)})}this.wheelInput.enableEventType(t,e),this.moveInput.enableEventType(t,e),this.keyInput.enableEventType(t,e),this.contextmenuInput.enableEventType(t,e)}_addEventHandler(t,e,i,r,s){if(typeof t!="string"){i=e;for(const u in t)this._addEventHandler(u,t[u],i,r,s);return}const{manager:o,events:a}=this,c=lh[t]||t;let l=a.get(c);l||(l=new dA(this),a.set(c,l),l.recognizerName=G1[c]||c,o&&o.on(c,l.handleEvent)),l.add(t,e,i,r,s),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(t,e){if(typeof t!="string"){for(const o in t)this._removeEventHandler(o,t[o]);return}const{events:i}=this,r=lh[t]||t,s=i.get(r);if(!!s&&(s.remove(t,e),s.isEmpty())){const{recognizerName:o}=s;let a=!1;for(const c of i.values())if(c.recognizerName===o&&!c.isEmpty()){a=!0;break}a||this._toggleRecognizer(o,!1)}}_onBasicInput(t){const{srcEvent:e}=t,i=j1[e.type];i&&this.manager.emit(i,t)}_onOtherEvent(t){this.manager.emit(t.type,t)}}function Be(){}const mA=({isDragging:n})=>n?"grabbing":"grab";function _A(n){return{id:n.string,width:n.oneOfType([n.number,n.string]),height:n.oneOfType([n.number,n.string]),layers:n.oneOfType([n.object,n.array]),layerFilter:n.func,views:n.oneOfType([n.object,n.array]),viewState:n.object,effects:n.arrayOf(n.instanceOf(ju)),controller:n.oneOfType([n.func,n.bool,n.object]),gl:n.object,glOptions:n.object,parameters:n.object,pickingRadius:n.number,useDevicePixels:n.oneOfType([n.bool,n.number]),touchAction:n.string,eventRecognizerOptions:n.object,onWebGLInitialized:n.func,onResize:n.func,onViewStateChange:n.func,onInteractionStateChange:n.func,onBeforeRender:n.func,onAfterRender:n.func,onLoad:n.func,onError:n.func,debug:n.bool,drawPickingColors:n.bool,_framebuffer:n.object,_animate:n.bool,_pickable:n.bool,_typedArrayManagerProps:n.object}}const Eh={id:"",width:"100%",height:"100%",pickingRadius:0,layerFilter:null,glOptions:{},gl:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},onWebGLInitialized:Be,onResize:Be,onViewStateChange:Be,onInteractionStateChange:Be,onBeforeRender:Be,onAfterRender:Be,onLoad:Be,onError:(n,t)=>W.error(n)(),_onMetrics:null,getCursor:mA,debug:!1,drawPickingColors:!1};class pr{constructor(t){t=E(E({},Eh),t),this.props={},this.width=0,this.height=0,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this._needsRedraw=!0,this._pickRequest={},this._lastPointerDownInfo=null,this.viewState=null,this.interactiveState={isHovering:!1,isDragging:!1},this._onEvent=this._onEvent.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),t.viewState&&t.initialViewState&&W.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),J.getBrowser()==="IE"&&W.warn("IE 11 support will be deprecated in v8.0")(),t.gl||typeof document!="undefined"&&(this.canvas=this._createCanvas(t)),this.animationLoop=this._createAnimationLoop(t),this.stats=new Ln({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(t),t._typedArrayManagerProps&&oi.setProps(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager&&(this.layerManager.finalize(),this.layerManager=null,this.viewManager.finalize(),this.viewManager=null,this.effectManager.finalize(),this.effectManager=null,this.deckRenderer.finalize(),this.deckRenderer=null,this.deckPicker.finalize(),this.deckPicker=null,this.eventManager.destroy(),this.eventManager=null,this.tooltip.remove(),this.tooltip=null),!this.props.canvas&&!this.props.gl&&this.canvas&&(this.canvas.parentElement.removeChild(this.canvas),this.canvas=null)}setProps(t){this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&W.removed("onLayerHover","onHover")(),"onLayerClick"in t&&W.removed("onLayerClick","onClick")(),t.initialViewState&&!li(this.props.initialViewState,t.initialViewState)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);const e=Object.create(this.props);Object.assign(e,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(e),this.layerManager&&(this.viewManager.setProps(e),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(e),this.effectManager.setProps(e),this.deckRenderer.setProps(e),this.deckPicker.setProps(e)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(t),r=this.layerManager.needsRedraw(t),s=this.effectManager.needsRedraw(t),o=this.deckRenderer.needsRedraw(t);return e=e||i||r||s||o,e}redraw(t){if(!this.layerManager)return;const e=t||this.needsRedraw({clearRedrawFlags:!0});!e||(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}getViews(){return this.viewManager.views}getViewports(t){return this.viewManager.getViewports(t)}pickObject(t){const e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(const i in t)this.layerManager.resourceManager.add({resourceId:i,data:t[i],forceUpdate:e})}_removeResources(t){for(const e of t)this.layerManager.resourceManager.remove(e)}_pick(t,e,i){const{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(e).timeStart();const s=this.deckPicker[t](E({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport},i));return r.get(e).timeEnd(),s}_createCanvas(t){let e=t.canvas;return typeof e=="string"&&(e=document.getElementById(e),Yt(e)),e||(e=document.createElement("canvas"),e.id=t.id||"deckgl-overlay",(t.parent||document.body).appendChild(e)),Object.assign(e.style,t.style),e}_setCanvasSize(t){if(!this.canvas)return;let{width:e,height:i}=t;(e||e===0)&&(e=Number.isFinite(e)?"".concat(e,"px"):e,this.canvas.style.width=e),(i||i===0)&&(i=Number.isFinite(i)?"".concat(i,"px"):i,this.canvas.style.position="absolute",this.canvas.style.height=i)}_updateCanvasSize(){if(this._checkForCanvasSizeChange()){const{width:t,height:e}=this;this.viewManager.setProps({width:t,height:e}),this.props.onResize({width:this.width,height:this.height})}}_checkForCanvasSizeChange(){const{canvas:t}=this;if(!t)return!1;const e=t.clientWidth||t.width,i=t.clientHeight||t.height;return e!==this.width||i!==this.height?(this.width=e,this.height=i,!0):!1}_createAnimationLoop(t){const{width:e,height:i,gl:r,glOptions:s,debug:o,onError:a,onBeforeRender:c,onAfterRender:l,useDevicePixels:u,autoResizeDrawingBuffer:h}=t;return new Ob({width:e,height:i,useDevicePixels:u,autoResizeDrawingBuffer:h,autoResizeViewport:!1,gl:r,onCreateContext:f=>Wc(k(E(E({},s),f),{canvas:this.canvas,debug:o,onContextLost:()=>this._onContextLost()})),onInitialize:f=>this._setGLContext(f.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:c,onAfterRender:l,onError:a})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let t=this.props.views||[new th({id:"default-view"})];return t=Array.isArray(t)?t:[t],t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:t}=this.props;this.animationLoop&&t&&t(new Error("WebGL context is lost"))}_onPointerMove(t){const{_pickRequest:e}=this;if(t.type==="pointerleave")e.x=-1,e.y=-1,e.radius=0;else{if(t.leftButton||t.rightButton)return;{const i=t.offsetCenter;if(!i)return;e.x=i.x,e.y=i.y,e.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:e.x,y:e.y}),e.event=t,e.mode="hover"}_pickAndCallback(){const{_pickRequest:t}=this;if(t.event){const{result:e,emptyInfo:i}=this._pick("pickObject","pickObject Time",t);this.interactiveState.isHovering=e.length>0;let r=i,s=!1;for(const o of e)r=o,s=o.layer.onHover(o,t.event);if(!s&&this.props.onHover&&this.props.onHover(r,t.event),this.props.getTooltip){const o=this.props.getTooltip(r);this.tooltip.setTooltip(o,r.x,r.y)}t.event=null}}_updateCursor(){const t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.interactiveState))}_setGLContext(t){if(this.layerManager)return;this.canvas||(this.canvas=t.canvas,Ps(t,{enable:!0,copyState:!0})),this.tooltip=new N1(this.canvas),ue(t,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(t);const e=new yu;e.play(),this.animationLoop.attachTimeline(e),this.eventManager=new pA(this.props.parent||t.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const r in Tu)this.eventManager.on(r,this._onEvent);this.viewManager=new c1({timeline:e,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new a1(t,{deck:this,stats:this.stats,viewport:i,timeline:e}),this.effectManager=new A1,this.deckRenderer=new I1(t),this.deckPicker=new O1(t),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){const{gl:i}=this.layerManager.context;ue(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers(E({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:t,effects:this.effectManager.getEffects()},e)),this.props.onAfterRender({gl:i})}_onRenderFrame(t){this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),W.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(!1),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){const e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState=k(E({},this.viewState),{[t.viewId]:e}),this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.interactiveState.isDragging=t.isDragging,this.props.onInteractionStateChange(t)}_onEvent(t){const e=Tu[t.type],i=t.offsetCenter;if(!e||!i)return;const r=this.layerManager.getLayers(),s=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:r,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:o}=s,a=o&&(o[e.handler]||o.props[e.handler]),c=this.props[e.handler];let l=!1;a&&(l=a.call(o,s,t)),!l&&c&&c(s,t)}_onPointerDown(t){const e=t.offsetCenter;this._lastPointerDownInfo=this.pickObject({x:e.x,y:e.y,radius:this.props.pickingRadius})}_getFrameStats(){const{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();const e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();const i=Oe.get("Memory Usage");t.bufferMemory=i.get("Buffer Memory").count,t.textureMemory=i.get("Texture Memory").count,t.renderbufferMemory=i.get("Renderbuffer Memory").count,t.gpuMemory=i.get("GPU Memory").count}}pr.getPropTypes=_A;pr.defaultProps=Eh;pr.VERSION=Um.VERSION;class So{constructor(t,e){this.opts=e,this.source=t}get value(){return this.source.value}getValue(){const t=this.source.getBuffer(),e=this.getAccessor();if(t)return[t,e];const{value:i}=this.source,{size:r}=e;let s=i;if(i&&i.length!==r){s=new Float32Array(r);const o=e.elementOffset||0;for(let a=0;a<r;++a)s[a]=i[o+a]}return s}getAccessor(){return E(E({},this.source.getAccessor()),this.opts)}}function bA(n){switch(n){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function mr(n){return n.stride||n.size*n.bytesPerElement}function vh(n,t){t.offset&&W.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const e=mr(n),i="vertexOffset"in t?t.vertexOffset:n.vertexOffset||0,r=t.elementOffset||0,s=i*e+r*n.bytesPerElement+(n.offset||0);return k(E({},t),{offset:s,stride:e})}function yA(n,t){const e=vh(n,t);return{high:e,low:k(E({},e),{offset:e.offset+n.size*4})}}class TA{constructor(t,e){this.gl=t,this.id=e.id,this.size=e.size;const i=e.logicalType||e.type,r=i===5130;let{defaultValue:s}=e;s=Number.isFinite(s)?[s]:s||new Array(this.size).fill(0),e.defaultValue=s;let o=i;r?o=5126:!o&&e.isIndexed?o=t&&Ds(t,Q.ELEMENT_INDEX_UINT32)?5125:5123:o||(o=5126),e.logicalType=i,e.type=o;let a=bA(i||o||5126);this.shaderAttributes={},this.doublePrecision=r,r&&e.fp64===!1&&(a=Float32Array),e.bytesPerElement=a.BYTES_PER_ELEMENT,this.defaultType=a,this.value=null,this.settings=e,this.state={externalBuffer:null,bufferAccessor:e,allocatedValue:null,constant:!1},this._buffer=null,this.setData(e)}get buffer(){if(!this._buffer){const{isIndexed:t,type:e}=this.settings;this._buffer=new X(this.gl,{id:this.id,target:t?34963:34962,accessor:{type:e}})}return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*mr(t):0}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),oi.release(this.state.allocatedValue)}getShaderAttributes(t,e){if(this.doublePrecision){const i={},r=this.value instanceof Float64Array,s=yA(this.getAccessor(),e||{});return i[t]=new So(this,s.high),i["".concat(t,"64Low")]=r?new So(this,s.low):new Float32Array(this.size),i}if(e){const i=vh(this.getAccessor(),e);return{[t]:new So(this,i)}}return{[t]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}setData(t){const{state:e}=this;ArrayBuffer.isView(t)?t={value:t}:t instanceof X&&(t={buffer:t});const i=E(E({},this.settings),t);if(e.bufferAccessor=i,t.constant){let r=t.value;if(r=this._normalizeValue(r,[],0),this.settings.normalized&&(r=this._normalizeConstant(r)),!(!e.constant||!this._areValuesEqual(r,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=r}else if(t.buffer){const r=t.buffer;e.externalBuffer=r,e.constant=!1,this.value=t.value;const s=t.value instanceof Float64Array;i.type=t.type||r.accessor.type,i.bytesPerElement=r.accessor.BYTES_PER_ELEMENT*(s?2:1),i.stride=mr(i)}else if(t.value){this._checkExternalBuffer(t);let r=t.value;e.externalBuffer=null,e.constant=!1,this.value=r,i.bytesPerElement=r.BYTES_PER_ELEMENT,i.stride=mr(i);const{buffer:s,byteOffset:o}=this;this.doublePrecision&&r instanceof Float64Array&&(r=_o(r,i));const a=r.byteLength+o+i.stride*2;s.byteLength<a&&s.reallocate(a),s.setAccessor(null),s.subData({data:r,offset:o}),i.type=t.type||s.accessor.type}return!0}updateSubBuffer(t={}){const{value:e}=this,{startOffset:i=0,endOffset:r}=t;this.buffer.subData({data:this.doublePrecision&&e instanceof Float64Array?_o(e,{size:this.size,startIndex:i,endIndex:r}):e.subarray(i,r),offset:i*e.BYTES_PER_ELEMENT+this.byteOffset})}allocate({numInstances:t,copy:e=!1}){const{state:i}=this,r=i.allocatedValue,s=oi.allocate(r,t+1,{size:this.size,type:this.defaultType,copy:e});this.value=s;const{buffer:o,byteOffset:a}=this;return o.byteLength<s.byteLength+a&&(o.reallocate(s.byteLength+a),e&&r&&o.subData({data:r instanceof Float64Array?_o(r,this):r,offset:a})),i.allocatedValue=s,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(t){const{value:e}=t;if(!t.constant&&e){const i=this.defaultType;let r=!1;if(this.doublePrecision&&(r=e.BYTES_PER_ELEMENT<4),r)throw new Error("Attribute ".concat(this.id," does not support ").concat(e.constructor.name));!(e instanceof i)&&this.settings.normalized&&!("normalized"in t)&&W.warn("Attribute ".concat(this.id," is normalized"))()}}_normalizeConstant(t){switch(this.settings.type){case 5120:return new Float32Array(t).map(e=>(e+128)/255*2-1);case 5122:return new Float32Array(t).map(e=>(e+32768)/65535*2-1);case 5121:return new Float32Array(t).map(e=>e/255);case 5123:return new Float32Array(t).map(e=>e/65535);default:return t}}_normalizeValue(t,e,i){const{defaultValue:r,size:s}=this.settings;if(Number.isFinite(t))return e[i]=t,e;if(!t)return e[i]=r[0],e;switch(s){case 4:e[i+3]=Number.isFinite(t[3])?t[3]:r[3];case 3:e[i+2]=Number.isFinite(t[2])?t[2]:r[2];case 2:e[i+1]=Number.isFinite(t[1])?t[1]:r[1];case 1:e[i+0]=Number.isFinite(t[0])?t[0]:r[0];break;default:let o=s;for(;--o>=0;)e[i+o]=Number.isFinite(t[o])?t[o]:r[o]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:i}=this;for(let r=0;r<i;r++)if(t[r]!==e[r])return!1;return!0}}const Ah=[],wh=[];function Sh(n,t=0,e=1/0){let i=Ah;const r={index:-1,data:n,target:[]};return n?typeof n[Symbol.iterator]=="function"?i=n:n.length>0&&(wh.length=n.length,i=wh):i=Ah,(t>0||Number.isFinite(e))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(t,e),r.index=t-1),{iterable:i,objectInfo:r}}function Ih(n){return n&&n[Symbol.asyncIterator]}function EA(n,{size:t,stride:e,offset:i,startIndices:r,nested:s}){const o=n.BYTES_PER_ELEMENT,a=e?e/o:t,c=i?i/o:0,l=Math.floor((n.length-c)/a);return(u,{index:h,target:f})=>{if(!r){const T=h*a+c;for(let v=0;v<t;v++)f[v]=n[T+v];return f}const g=r[h],m=r[h+1]||l;let _;if(s){_=new Array(m-g);for(let T=g;T<m;T++){const v=T*a+c;f=new Array(t);for(let S=0;S<t;S++)f[S]=n[v+S];_[T-g]=f}}else if(a===t)_=n.subarray(g*t+c,m*t+c);else{_=new n.constructor((m-g)*t);let T=0;for(let v=g;v<m;v++){const S=v*a+c;for(let y=0;y<t;y++)_[T++]=n[S+y]}}return _}}const vA=[],_r=[[0,1/0]];function AA(n,t){if(n===_r||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return n;const e=[],i=n.length;let r=0;for(let s=0;s<i;s++){const o=n[s];o[1]<t[0]?(e.push(o),r=s+1):o[0]>t[1]?e.push(o):t=[Math.min(o[0],t[0]),Math.max(o[1],t[1])]}return e.splice(r,0,t),e}function Io({source:n,target:t,start:e=0,end:i,size:r,getData:s}){i=i||t.length;const o=n.length,a=i-e;if(o>a){t.set(n.subarray(0,a),e);return}if(t.set(n,e),!s)return;let c=o;for(;c<a;){const l=s(c,n);for(let u=0;u<r;u++)t[e+c]=l[u]||0,c++}}function wA({source:n,target:t,size:e,getData:i,sourceStartIndices:r,targetStartIndices:s}){if(!Array.isArray(s))return Io({source:n,target:t,size:e,getData:i}),t;let o=0,a=0;const c=i&&((u,h)=>i(u+a,h)),l=Math.min(r.length,s.length);for(let u=1;u<l;u++){const h=r[u]*e,f=s[u]*e;Io({source:n.subarray(o,h),target:t,start:a,end:f,size:e,getData:c}),o=h,a=f}return a<t.length&&Io({source:[],target:t,start:a,size:e,getData:c}),t}const SA={interpolation:{duration:0,easing:n=>n},spring:{stiffness:.05,damping:.5}};function Ph(n,t){return n?(Number.isFinite(n)&&(n={duration:n}),n.type=n.type||"interpolation",E(E(E({},SA[n.type]),t),n)):null}function xh(n,t){return t.getBuffer()?[t.getBuffer(),{divisor:0,size:t.size,normalized:t.settings.normalized}]:t.value}function Lh(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(n,'"'))}}function Mh(n){n.push(n.shift())}function Po(n,t){const{doublePrecision:e,settings:i,value:r,size:s}=n,o=e&&r instanceof Float64Array?2:1;return(i.noAlloc?r.length:t*s)*o}function Rh({buffer:n,numInstances:t,attribute:e,fromLength:i,fromStartIndices:r,getData:s=o=>o}){const o=e.doublePrecision&&e.value instanceof Float64Array?2:1,a=e.size*o,c=e.byteOffset,l=e.startIndices,u=r&&l,h=Po(e,t),f=e.state.constant;if(!u&&i>=h)return;const g=f?e.value:e.getBuffer().getData({srcByteOffset:c});if(e.settings.normalized&&!f){const v=s;s=(S,y)=>e._normalizeConstant(v(S,y))}const m=f?(v,S)=>s(g,S):(v,S)=>s(g.subarray(v,v+a),S),_=n.getData({length:i}),T=new Float32Array(h);wA({source:_,target:T,sourceStartIndices:r,targetStartIndices:l,size:a,getData:m}),n.byteLength<T.byteLength+c&&n.reallocate(T.byteLength+c),n.subData({data:T,offset:c})}class xo extends TA{constructor(t,e={}){super(t,e);const{transition:i=!1,noAlloc:r=!1,update:s=null,accessor:o=null,transform:a=null,startIndices:c=null}=e;Object.assign(this.settings,{transition:i,noAlloc:r,update:s||o&&this._autoUpdater,accessor:o,transform:a}),Object.assign(this.state,{lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:_r,startIndices:c}),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat(typeof t!="function"&&t||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,i=this.settings.transition,r=Array.isArray(e)?t[e.find(s=>t[s])]:t[e];return Ph(r,i)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:i=0,endRow:r=1/0}=e;this.state.updateRanges=AA(this.state.updateRanges,[i,r])}else this.state.updateRanges=_r}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=vA}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}update(t){this.setData(t)}allocate(t){const{state:e,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate({numInstances:t,copy:e.updateRanges!==_r}),!0):!1}updateBuffer({numInstances:t,data:e,props:i,context:r}){if(!this.needsUpdate())return!1;const{state:{updateRanges:s},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[l,u]of s)o.call(r,this,{data:e,startRow:l,endRow:u,props:i,numInstances:t});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[l,u]of s){const h=Number.isFinite(l)?this.getVertexOffset(l):0,f=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:h,endOffset:f})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(t){return t===void 0||typeof t=="function"?!1:(this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){const{state:i,settings:r}=this;if(!t)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===t)return this.clearNeedsUpdate(),!0;if(i.binaryValue=t,this.setNeedsRedraw(),ArrayBuffer.isView(t)&&(t={value:t}),r.transform||e!==this.startIndices){Yt(ArrayBuffer.isView(t.value),"invalid ".concat(r.accessor));const o=t.size&&t.size!==this.size;return i.binaryAccessor=EA(t.value,{size:t.size||this.size,stride:t.stride,offset:t.offset,startIndices:e,nested:o}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?e[t]:t)*this.size}getShaderAttributes(){const t=this.settings.shaderAttributes||{[this.id]:null},e={};for(const i in t)Object.assign(e,super.getShaderAttributes(i,t[i]));return e}_autoUpdater(t,{data:e,startRow:i,endRow:r,props:s,numInstances:o}){if(t.constant)return;const{settings:a,state:c,value:l,size:u,startIndices:h}=t,{accessor:f,transform:g}=a,m=c.binaryAccessor||(typeof f=="function"?f:s[f]);Yt(typeof m=="function",'accessor "'.concat(f,'" is not a function'));let _=t.getVertexOffset(i);const{iterable:T,objectInfo:v}=Sh(e,i,r);for(const S of T){v.index++;let y=m(S,v);if(g&&(y=g.call(this,y)),h){const P=(v.index<h.length-1?h[v.index+1]:o)-h[v.index];if(y&&Array.isArray(y[0])){let L=_;for(const x of y)t._normalizeValue(x,l,L),L+=u}else y&&y.length>u?l.set(y,_):(t._normalizeValue(y,v.target,0),e1({target:l,source:v.target,start:_,count:P}));_+=P*u}else t._normalizeValue(y,l,_),_+=u}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||typeof t.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let i=!0;switch(e){case 4:i=i&&Number.isFinite(t[3]);case 3:i=i&&Number.isFinite(t[2]);case 2:i=i&&Number.isFinite(t[1]);case 1:i=i&&Number.isFinite(t[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}}class IA{constructor({gl:t,attribute:e,timeline:i}){this.gl=t,this.type="interpolation",this.transition=new ui(i),this.attribute=e,this.attributeInTransition=new xo(t,e.settings),this.currentStartIndices=e.startIndices,this.currentLength=0,this.transform=xA(t,e);const r={byteLength:0,usage:35050};this.buffers=[new X(t,r),new X(t,r)]}get inProgress(){return this.transition.inProgress}start(t,e){if(t.duration<=0){this.transition.cancel();return}const{gl:i,buffers:r,attribute:s}=this;Mh(r);const o={numInstances:e,attribute:s,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const a of r)Rh(E({buffer:a},o));this.currentStartIndices=s.startIndices,this.currentLength=Po(s,e),this.attributeInTransition.update({buffer:r[1],value:s.value}),this.transition.start(t),this.transform.update({elementCount:Math.floor(this.currentLength/s.size),sourceBuffers:{aFrom:r[0],aTo:xh(i,s)},feedbackBuffers:{vCurrent:r[1]}})}update(){const t=this.transition.update();if(t){const{time:e,settings:{duration:i,easing:r}}=this.transition,s=r(e/i);this.transform.run({uniforms:{time:s}})}return t}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete()}}const PA=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function xA(n,t){const e=Lh(t.size);return new ro(n,{vs:PA,defines:{ATTRIBUTE_TYPE:e},varyings:["vCurrent"]})}class LA{constructor({gl:t,attribute:e,timeline:i}){this.gl=t,this.type="spring",this.transition=new ui(i),this.attribute=e,this.attributeInTransition=new xo(t,k(E({},e.settings),{normalized:!1})),this.currentStartIndices=e.startIndices,this.currentLength=0,this.texture=RA(t),this.framebuffer=OA(t,this.texture),this.transform=MA(t,e,this.framebuffer);const r={byteLength:0,usage:35050};this.buffers=[new X(t,r),new X(t,r),new X(t,r)]}get inProgress(){return this.transition.inProgress}start(t,e){const{gl:i,buffers:r,attribute:s}=this,o={numInstances:e,attribute:s,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const a of r)Rh(E({buffer:a},o));this.currentStartIndices=s.startIndices,this.currentLength=Po(s,e),this.attributeInTransition.update({buffer:r[1],value:s.value}),this.transition.start(t),this.transform.update({elementCount:Math.floor(this.currentLength/s.size),sourceBuffers:{aTo:xh(i,s)}})}update(){const{buffers:t,transform:e,framebuffer:i,transition:r}=this;return r.update()?(e.update({sourceBuffers:{aPrev:t[0],aCur:t[1]},feedbackBuffers:{vNext:t[2]}}),e.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:r.settings.stiffness,damping:r.settings.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),Mh(t),this.attributeInTransition.update({buffer:t[1],value:this.attribute.value}),Gi(i)[0]>0||r.end(),!0):!1}cancel(){for(this.transition.cancel(),this.transform.delete();this.buffers.length;)this.buffers.pop().delete();this.texture.delete(),this.texture=null,this.framebuffer.delete(),this.framebuffer=null}}function MA(n,t,e){const i=Lh(t.size);return new ro(n,{framebuffer:e,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function RA(n){return new It(n,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function OA(n,t){return new ct(n,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:t}})}const CA={interpolation:IA,spring:LA};class NA{constructor(t,{id:e,timeline:i}){this.id=e,this.gl=t,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=ro.isSupported(t)}finalize(){for(const t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:i}){this.numInstances=i||1;for(const r in t){const s=t[r],o=s.getTransitionSetting(e);!o||this._updateAttribute(r,s,o)}for(const r in this.transitions){const s=t[r];(!s||!s.getTransitionSetting(e))&&this._removeTransition(r)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const i=this.transitions[e];i.inProgress&&(t[e]=i.attributeInTransition)}return t}run(){if(!this.isSupported||this.numInstances===0)return!1;for(const e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].cancel(),delete this.transitions[t]}_updateAttribute(t,e,i){const r=this.transitions[t];let s=!r||r.type!==i.type;if(s){if(!this.isSupported){W.warn("WebGL2 not supported by this browser. Transition for ".concat(t," is disabled."))();return}r&&this._removeTransition(t);const o=CA[i.type];o?this.transitions[t]=new o({attribute:e,timeline:this.timeline,gl:this.gl}):(W.error("unsupported transition type '".concat(i.type,"'"))(),s=!1)}(s||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(i,this.numInstances))}}const Oh="attributeManager.invalidate",DA="attributeManager.updateStart",FA="attributeManager.updateEnd",UA="attribute.updateStart",BA="attribute.allocate",kA="attribute.updateEnd";class VA{constructor(t,{id:e="attribute-manager",stats:i,timeline:r}={}){this.id=e,this.gl=t,this.attributes={},this.updateTriggers={},this.accessors={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new NA(t,{id:"".concat(e,"-transitions"),timeline:r}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(t=!0){return this.needsRedraw=!0,this}add(t,e){this._add(t,e)}addInstanced(t,e){this._add(t,e,{instanced:1})}remove(t){for(let e=0;e<t.length;e++){const i=t[e];this.attributes[i]!==void 0&&(this.attributes[i].delete(),delete this.attributes[i])}}invalidate(t,e){const i=this._invalidateTrigger(t,e);gt(Oh,this,t,i)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);gt(Oh,this,"all")}update({data:t,numInstances:e,startIndices:i=null,transitions:r,props:s={},buffers:o={},context:a={}}={}){let c=!1;gt(DA,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const u=this.attributes[l],h=u.settings.accessor;u.startIndices=i,s[l]&&W.removed("props.".concat(l),"data.attributes.".concat(l))(),u.setExternalBuffer(o[l])||u.setBinaryValue(o[h],t.startIndices)||!o[h]&&u.setConstantValue(s[h])||u.needsUpdate()&&(c=!0,this._updateAttribute({attribute:u,numInstances:e,data:t,props:s,context:a})),this.needsRedraw|=u.needsRedraw()}c&&gt(FA,this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:r})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return this.attributes}getChangedAttributes(t={clearChangedFlags:!1}){const{attributes:e,attributeTransitionManager:i}=this,r=E({},i.getAttributes());for(const s in e){const o=e[s];o.needsRedraw(t)&&!i.hasAttribute(s)&&(r[s]=o)}return r}getShaderAttributes(t,e={}){t||(t=this.getAttributes());const i={};for(const r in t)e[r]||Object.assign(i,t[r].getShaderAttributes());return i}getAccessors(){return this.updateTriggers}_add(t,e,i={}){e&&W.warn("AttributeManager.add({updaters}) - updater map no longer supported")();for(const r in t){const s=t[r];this.attributes[r]=this._createAttribute(r,s,i)}this._mapUpdateTriggersToAttributes()}_createAttribute(t,e,i){const r=k(E({},e),{id:t,isIndexed:e.isIndexed||e.elements||!1,constant:e.constant||!1,size:e.elements&&1||e.size||1,value:e.value||null,divisor:e.instanced||i.instanced?1:e.divisor||0});return new xo(this.gl,r)}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes)this.attributes[e].getUpdateTriggers().forEach(r=>{t[r]||(t[r]=[]),t[r].push(e)});this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:i,updateTriggers:r}=this,s=r[t];return s&&s.forEach(o=>{const a=i[o];a&&a.setNeedsUpdate(a.id,e)}),s}_updateAttribute(t){const{attribute:e,numInstances:i}=t;if(gt(UA,e),e.constant){e.setConstantValue(e.value);return}e.allocate(i)&&gt(BA,e,i),e.updateBuffer(t)&&(this.needsRedraw=!0,gt(kA,e,i))}}class zA extends ui{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:i,duration:r,easing:s}}=this,o=s(t/r);this._value=Ji(e,i,o)}}const Ch=1e-5;function Nh(n,t,e,i,r){const s=t-n,a=(e-t)*r,c=-s*i;return a+c+s+t}function jA(n,t,e,i,r){if(Array.isArray(e)){const s=[];for(let o=0;o<e.length;o++)s[o]=Nh(n[o],t[o],e[o],i,r);return s}return Nh(n,t,e,i,r)}function Dh(n,t){if(Array.isArray(n)){let e=0;for(let i=0;i<n.length;i++){const r=n[i]-t[i];e+=r*r}return Math.sqrt(e)}return Math.abs(n-t)}class GA extends ui{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:i,stiffness:r}=this.settings,{_prevValue:s=t,_currValue:o=t}=this;let a=jA(s,o,e,i,r);const c=Dh(a,e),l=Dh(a,o);c<Ch&&l<Ch&&(a=e,this.end()),this._prevValue=o,this._currValue=a}}const $A={interpolation:zA,spring:GA};class HA{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,i,r){const{transitions:s}=this;if(s.has(t)){const c=s.get(t),{value:l=c.settings.fromValue}=c;e=l,this.remove(t)}if(r=Ph(r),!r)return;const o=$A[r.type];if(!o){W.error("unsupported transition type '".concat(r.type,"'"))();return}const a=new o(this.timeline);a.start(k(E({},r),{fromValue:e,toValue:i})),s.set(t,a)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,i]of this.transitions)i.update(),t[e]=i.value,i.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}const{COMPONENT:WA}=cr;function qA(n){const t=Mo(n);for(const e in t){const i=t[e],{validate:r}=i;if(r&&!r(n[e],i))throw new Error("Invalid prop ".concat(e,": ").concat(n[e]))}}function YA(n,t){const e=Fh({newProps:n,oldProps:t,propTypes:Mo(n),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=ZA(n,t);let r=!1;return i||(r=KA(n,t)),{dataChanged:i,propsChanged:e,updateTriggersChanged:r,extensionsChanged:QA(n,t),transitionsChanged:XA(n,t)}}function XA(n,t){if(!n.transitions)return null;const e={},i=Mo(n);for(const r in n.transitions){const s=i[r],o=s&&s.type;(o==="number"||o==="color"||o==="array")&&Lo(n[r],t[r],s)&&(e[r]=!0)}return e}function Fh({newProps:n,oldProps:t,ignoreProps:e={},propTypes:i={},triggerName:r="props"}={}){if(t===n)return null;if(typeof n!="object"||n===null||typeof t!="object"||t===null)return"".concat(r," changed shallowly");for(const s of Object.keys(n))if(!(s in e)){if(!(s in t))return"".concat(r,".").concat(s," added");const o=Lo(n[s],t[s],i[s]);if(o)return"".concat(r,".").concat(s," ").concat(o)}for(const s of Object.keys(t))if(!(s in e)){if(!(s in n))return"".concat(r,".").concat(s," dropped");if(!Object.hasOwnProperty.call(n,s)){const o=Lo(n[s],t[s],i[s]);if(o)return"".concat(r,".").concat(s," ").concat(o)}}return null}function Lo(n,t,e){let i=e&&e.equal;return i&&!i(n,t,e)||!i&&(i=n&&t&&n.equals,i&&!i.call(n,t))?"changed deeply":!i&&t!==n?"changed shallowly":null}function ZA(n,t){if(t===null)return"oldProps is null, initial diff";let e=null;const{dataComparator:i,_dataDiff:r}=n;return i?i(n.data,t.data)||(e="Data comparator detected a change"):n.data!==t.data&&(e="A new data container was supplied"),e&&r&&(e=r(n.data,t.data)||e),e}function KA(n,t){if(t===null)return"oldProps is null, initial diff";if("all"in n.updateTriggers&&Uh(n,t,"all"))return{all:!0};const e={};let i=!1;for(const r in n.updateTriggers)r!=="all"&&Uh(n,t,r)&&(e[r]=!0,i=e);return i}function QA(n,t){if(t===null)return"oldProps is null, initial diff";const e=t.extensions,{extensions:i}=n;if(i===e)return!1;if(i.length!==e.length)return!0;for(let r=0;r<i.length;r++)if(!i[r].equals(e[r]))return!0;return!1}function Uh(n,t,e){let i=n.updateTriggers[e];i=i==null?{}:i;let r=t.updateTriggers[e];return r=r==null?{}:r,Fh({oldProps:r,newProps:i,triggerName:e})}function Mo(n){const t=n[WA],e=t&&t.constructor;return e?e._propTypes:{}}const JA="count(): argument not an object",tw="count(): argument not a container";function ew(n){if(!iw(n))throw new Error(JA);if(typeof n.count=="function")return n.count();if(Number.isFinite(n.size))return n.size;if(Number.isFinite(n.length))return n.length;if(nw(n))return Object.keys(n).length;throw new Error(tw)}function nw(n){return n!==null&&typeof n=="object"&&n.constructor===Object}function iw(n){return n!==null&&typeof n=="object"}function rw(n,t){if(!t)return n;const e=E(E({},n),t);if("defines"in t&&(e.defines=E(E({},n.defines),t.defines)),"modules"in t&&(e.modules=(n.modules||[]).concat(t.modules),t.modules.some(i=>i.name==="project64"))){const i=e.modules.findIndex(r=>r.name==="project32");i>=0&&e.modules.splice(i,1)}if("inject"in t)if(!n.inject)e.inject=t.inject;else{const i=E({},n.inject);for(const r in t.inject)i[r]=(i[r]||"")+t.inject[r];e.inject=i}return e}const sw={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},Ro={};function ow(n,t){const e=n.context&&n.context.gl;if(!e||!t)return null;if(t instanceof It)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let i=null;t.compressed&&(i={[10241]:t.data.length>1?9985:9729});const r=new It(e,k(E({},t),{parameters:E(E(E({},sw),i),n.props.textureParameters)}));return Ro[r.id]=!0,r}function aw(n){!n||!(n instanceof It)||Ro[n.id]&&(n.delete(),delete Ro[n.id])}const cw={boolean:{validate(n,t){return!0},equal(n,t,e){return Boolean(n)===Boolean(t)}},number:{validate(n,t){return Number.isFinite(n)&&(!("max"in t)||n<=t.max)&&(!("min"in t)||n>=t.min)}},color:{validate(n,t){return t.optional&&!n||di(n)&&(n.length===3||n.length===4)},equal(n,t,e){return Oo(n,t)}},accessor:{validate(n,t){const e=br(n);return e==="function"||e===br(t.value)},equal(n,t,e){return typeof t=="function"?!0:Oo(n,t)}},array:{validate(n,t){return t.optional&&!n||di(n)},equal(n,t,e){return e.compare?Oo(n,t):n===t}},function:{validate(n,t){return t.optional&&!n||typeof n=="function"},equal(n,t,e){return!e.compare||n===t}},data:{transform:(n,t,e)=>{const{dataTransform:i}=e?e.props:{};return i&&n?i(n):n}},image:{transform:(n,t,e)=>ow(e,n),release:n=>{aw(n)}}};function Oo(n,t){if(n===t)return!0;if(!di(n)||!di(t))return!1;const e=n.length;if(e!==t.length)return!1;for(let i=0;i<e;i++)if(n[i]!==t[i])return!1;return!0}function lw(n){const t={},e={},i={};for(const[r,s]of Object.entries(n))if(s&&s.deprecatedFor)i[r]=Array.isArray(s.deprecatedFor)?s.deprecatedFor:[s.deprecatedFor];else{const o=uw(r,s);t[r]=o,e[r]=o.value}return{propTypes:t,defaultProps:e,deprecatedProps:i}}function uw(n,t){switch(br(t)){case"object":return fi(n,t);case"array":return fi(n,{type:"array",value:t,compare:!1});case"boolean":return fi(n,{type:"boolean",value:t});case"number":return fi(n,{type:"number",value:t});case"function":return fi(n,{type:"function",value:t,compare:!0});default:return{name:n,type:"unknown",value:t}}}function fi(n,t){return"type"in t?E(E({name:n},cw[t.type]),t):"value"in t?E({name:n,type:br(t.value)},t):{name:n,type:"object",value:t}}function di(n){return Array.isArray(n)||ArrayBuffer.isView(n)}function br(n){return di(n)?"array":n===null?"null":typeof n}const{COMPONENT:Co,ASYNC_ORIGINAL:yr,ASYNC_RESOLVED:gi,ASYNC_DEFAULTS:Tr}=cr;function hw(){const n=this,t=Bh(n.constructor),e=Object.create(t);e[Co]=n,e[yr]={},e[gi]={};for(let i=0;i<arguments.length;++i){const r=arguments[i];for(const s in r)e[s]=r[s]}return Object.freeze(e),e}function Bh(n){const t=Er(n,"_mergedDefaultProps");return t||(fw(n),n._mergedDefaultProps)}function fw(n){if(!n.prototype)return;const e=Object.getPrototypeOf(n),i=Bh(e),r=Er(n,"defaultProps")||{},s=lw(r),o=dw(s.defaultProps,i,n),a=E(E({},e._propTypes),s.propTypes);pw(o,a);const c=E(E({},e._deprecatedProps),s.deprecatedProps);gw(o,c),n._mergedDefaultProps=o,n._propTypes=a,n._deprecatedProps=c}function dw(n,t,e){const i=Object.create(null);Object.assign(i,t,n);const r=_w(e);return delete n.id,Object.defineProperties(i,{id:{writable:!0,value:r}}),i}function gw(n,t){for(const e in t)Object.defineProperty(n,e,{enumerable:!1,set(i){const r="".concat(this.id,": ").concat(e);for(const s of t[e])kh(this,s)||(this[s]=i);W.deprecated(r,t[e].join("/"))()}})}function pw(n,t){const e={},i={};for(const r in t){const s=t[r],{name:o,value:a}=s;s.async&&(e[o]=a,i[o]=mw(o))}n[Tr]=e,n[yr]={},Object.defineProperties(n,i)}function mw(n){return{enumerable:!0,set(t){typeof t=="string"||t instanceof Promise||Ih(t)?this[yr][n]=t:this[gi][n]=t},get(){if(this[gi]){if(n in this[gi])return this[gi][n]||this[Tr][n];if(n in this[yr]){const t=this[Co]&&this[Co].internalState;if(t&&t.hasAsyncProp(n))return t.getAsyncProp(n)||this[Tr][n]}}return this[Tr][n]}}}function kh(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function Er(n,t){return kh(n,t)&&n[t]}function _w(n){const t=Er(n,"layerName")||Er(n,"componentName");return t||W.once(0,"".concat(n.name,".componentName not specified"))(),t||n.name}const{ASYNC_ORIGINAL:bw,ASYNC_RESOLVED:yw,ASYNC_DEFAULTS:Tw}=cr,Ew=Object.freeze({});class Vh{constructor(t=null){this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=Ew,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}freezeAsyncOldProps(){if(!this.oldAsyncProps){this.oldProps=this.oldProps||this.component.props,this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return Boolean(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){const e=t[yw]||{},i=t[bw]||t,r=t[Tw]||{};for(const s in e){const o=e[s];this._createAsyncPropData(s,r[s]),this._updateAsyncProp(s,o),e[s]=this.getAsyncProp(s)}for(const s in i){const o=i[s];this._createAsyncPropData(s,r[s]),this._updateAsyncProp(s,o)}}_updateAsyncProp(t,e){if(!!this._didAsyncInputValueChange(t,e)){if(typeof e=="string"){var i;const r=(i=this.layer)===null||i===void 0?void 0:i.props.fetch;r&&(e=r(e,{propName:t,layer:this.layer}))}if(e instanceof Promise){this._watchPromise(t,e);return}if(Ih(e)){this._resolveAsyncIterable(t,e);return}this._setPropValue(t,e)}}_didAsyncInputValueChange(t,e){const i=this.asyncProps[t];return e===i.resolvedValue||e===i.lastValue?!1:(i.lastValue=e,!0)}_setPropValue(t,e){this.freezeAsyncOldProps();const i=this.asyncProps[t];e=this._postProcessValue(i,e),i.resolvedValue=e,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount}_setAsyncPropValue(t,e,i){const r=this.asyncProps[t];r&&i>=r.resolvedLoadCount&&e!==void 0&&(this.freezeAsyncOldProps(),r.resolvedValue=e,r.resolvedLoadCount=i,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const i=this.asyncProps[t];i.pendingLoadCount++;const r=i.pendingLoadCount;e.then(s=>{var o;s=this._postProcessValue(i,s),this._setAsyncPropValue(t,s,r);const a=(o=this.layer)===null||o===void 0?void 0:o.props.onDataLoad;t==="data"&&a&&a(s,{propName:t,layer:this.layer})}).catch(s=>{var o;(o=this.layer)===null||o===void 0||o.raiseError(s,"loading ".concat(t," of ").concat(this.layer))})}async _resolveAsyncIterable(t,e){var i;t!=="data"&&this._setPropValue(t,e);const r=this.asyncProps[t];r.pendingLoadCount++;const s=r.pendingLoadCount;let o=[],a=0;for await(const l of e){const{dataTransform:u}=this.component?this.component.props:{};u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(t,o,s)}const c=(i=this.layer)===null||i===void 0?void 0:i.props.onDataLoad;c&&c(o,{propName:t,layer:this.layer})}_postProcessValue(t,e){const i=t.type;return i&&(i.release&&i.release(t.resolvedValue,i,this.component),i.transform)?i.transform(e,i,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const r=this.component&&this.component.constructor._propTypes;this.asyncProps[t]={type:r&&r[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}const{ASYNC_ORIGINAL:zh,ASYNC_RESOLVED:jh,ASYNC_DEFAULTS:vw}=cr,Aw={};let ww=0;class No{constructor(){this.props=hw.apply(this,arguments),this.id=this.props.id,this.count=ww++,this.lifecycle=ln.NO_STATE,this.parent=null,this.context=null,this.state=null,this.internalState=null,Object.seal(this)}clone(t){const{props:e}=this,i={};for(const r in e[vw])r in e[jh]?i[r]=e[jh][r]:r in e[zh]&&(i[r]=e[zh][r]);return new this.constructor(E(E(E({},e),i),t))}get stats(){return this.internalState.stats}_initState(){this.internalState=new Vh({})}}No.componentName="Component";No.defaultProps=Aw;class Sw extends Vh{constructor({attributeManager:t,layer:e}){super(e);this.attributeManager=t,this.model=null,this.needsRedraw=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(t){this.component=t}}const Iw="layer.changeFlag",Pw="layer.initialize",xw="layer.update",Lw="layer.finalize",Mw="layer.matched",Gh=2**24-1,Rw=Object.freeze([]),Ow=ir(({oldViewport:n,viewport:t})=>n.equals(t));let ie=new Uint8ClampedArray(0);const Cw={data:{type:"data",value:Rw,async:!0},dataComparator:null,_dataDiff:{type:"function",value:n=>n&&n.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(n,{propName:t,layer:e,loaders:i,loadOptions:r,signal:s})=>{const{resourceManager:o}=e.context;if(r=r||e.getLoadOptions(),i=i||e.props.loaders,s){var a;r=k(E({},r),{fetch:k(E({},(a=r)===null||a===void 0?void 0:a.fetch),{signal:s})})}let c=o.contains(n);return!c&&!r&&(o.add({resourceId:n,data:$e(n,i),persistent:!1}),c=!0),c?o.subscribe({resourceId:n,onChange:l=>e.internalState.reloadAsyncProp(t,l),consumerId:e.id,requestId:t}):$e(n,i,r)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:H.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:n})=>[0,-n*100],compare:!1},highlightedObjectIndex:-1,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class fn extends No{toString(){const t=this.constructor.layerName||this.constructor.name;return"".concat(t,"({id: '").concat(this.props.id,"'})")}raiseError(t,e){var i,r;if(e&&(t.message="".concat(e,": ").concat(t.message)),!((i=(r=this.props).onError)===null||i===void 0?void 0:i.call(r,t))){var s,o;(s=this.context)===null||s===void 0||(o=s.onError)===null||o===void 0||o.call(s,t,this)}}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(t=!0){this.internalState&&(this.internalState.needsRedraw=t)}setNeedsUpdate(){this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams())}hasUniformTransition(){return this.internalState.uniformTransitions.active}get isLoaded(){return this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||(this.state.model?[this.state.model]:[]))}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}project(t){const{viewport:e}=this.context,i=Yu(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,s,o]=fo(i,e.pixelProjectionMatrix);return t.length===2?[r,s]:[r,s,o]}unproject(t){const{viewport:e}=this.context;return e.unproject(t)}projectPosition(t){return t1(t,{viewport:this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem})}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===H.DEFAULT||t===H.LNGLAT||t===H.CARTESIAN}onHover(t,e){return this.props.onHover?this.props.onHover(t,e):!1}onClick(t,e){return this.props.onClick?this.props.onClick(t,e):!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){Yt(t instanceof Uint8Array);const[e,i,r]=t;return e+i*256+r*65536-1}initializeState(){throw new Error("Layer ".concat(this," has not defined initializeState"))}getShaders(t){for(const e of this.props.extensions)t=rw(t,e.getShaders.call(this,e));return t}shouldUpdateState({oldProps:t,props:e,context:i,changeFlags:r}){return r.propsOrDataChanged}updateState({oldProps:t,props:e,context:i,changeFlags:r}){const s=this.getAttributeManager();if(r.dataChanged&&s){const{dataChanged:c}=r;if(Array.isArray(c))for(const l of c)s.invalidateAll(l);else s.invalidateAll()}const o=t.highlightedObjectIndex>=0||t.pickable,a=e.highlightedObjectIndex>=0||e.pickable;if(o!==a&&s){const{pickingColors:c,instancePickingColors:l}=s.attributes,u=c||l;u&&(a&&u.constant&&(u.constant=!1,s.invalidate(u.id)),!u.value&&!a&&(u.constant=!0,u.value=[0,0,0]))}}finalizeState(){for(const e of this.getModels())e.delete();const t=this.getAttributeManager();t&&t.finalize(),this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState.uniformTransitions.clear(),this.internalState.finalize()}draw(t){for(const e of this.getModels())e.draw(t)}getPickingInfo({info:t,mode:e}){const{index:i}=t;return i>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[i]),t}activateViewport(t){const e=this.internalState.viewport;this.internalState.viewport=t,(!e||!Ow({oldViewport:e,viewport:t}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all",e=""){const i=this.getAttributeManager();!i||(t==="all"?i.invalidateAll():i.invalidate(t))}updateAttributes(t){for(const e of this.getModels())this._setModelAttributes(e,t)}_updateAttributes(t){const e=this.getAttributeManager();if(!e)return;const i=this.getNumInstances(t),r=this.getStartIndices(t);e.update({data:t.data,numInstances:i,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this,ignoreUnknownAttributes:!0});const s=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),i=Object.create(this.props);for(const r in e)Object.defineProperty(i,r,{value:e[r]});return i}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;const i=Math.floor(ie.length/3);if(this.internalState.usesPickingColorCache=!0,i<e){e>Gh&&W.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),ie=oi.allocate(ie,e,{size:3,copy:!0,maxCount:Math.max(e,Gh)});const r=Math.floor(ie.length/3),s=[];for(let o=i;o<r;o++)this.encodePickingColor(o,s),ie[o*3+0]=s[0],ie[o*3+1]=s[1],ie[o*3+2]=s[2]}t.value=ie.subarray(0,e*3)}_setModelAttributes(t,e){const i=this.getAttributeManager(),r=t.userData.excludeAttributes||{},s=i.getShaderAttributes(e,r);t.setAttributes(s)}disablePickingIndex(t){this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:i}=this.getAttributeManager().attributes,r=e||i,s=r.getVertexOffset(t),o=r.getVertexOffset(t+1);r.buffer.subData({data:new Uint8Array(o-s),offset:s})}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,i=t||e;this.internalState.usesPickingColorCache&&i.value.buffer!==ie.buffer&&(i.value=ie.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0})}getNumInstances(t){return t=t||this.props,t.numInstances!==void 0?t.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:ew(t.data)}getStartIndices(t){return t=t||this.props,t.startIndices!==void 0?t.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}_initialize(){gt(Pw,this),this._initState(),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:!0,propsChanged:!0,viewportChanged:!0,extensionsChanged:!0}),this._updateState()}_update(){const t=this.needsUpdate();gt(xw,this,t),t&&this._updateState()}_updateState(){const t=this.props,e=this.context.viewport,i=this._updateUniformTransition();this.internalState.propsInTransition=i,this.context.viewport=this.internalState.viewport||e,this.props=i;try{const r=this._getUpdateParams(),s=this.getModels();if(this.context.gl)this.updateState(r);else try{this.updateState(r)}catch(a){}for(const a of this.props.extensions)a.updateState.call(this,r,a);const o=this.getModels()[0]!==s[0];this._updateModules(r,o),this.isComposite?this._renderLayers(r):(this.setNeedsRedraw(),this._updateAttributes(this.props),this.state.model&&this.state.model.setInstanceCount(this.getNumInstances()))}finally{this.context.viewport=e,this.props=t,this.clearChangeFlags(),this.internalState.needsUpdate=!1,this.internalState.resetOldProps()}}_finalize(){gt(Lw,this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,t)}drawLayer({moduleParameters:t=null,uniforms:e={},parameters:i={}}){this._updateAttributeTransition();const r=this.props;this.props=this.internalState.propsInTransition||r;const{opacity:s}=this.props;e.opacity=Math.pow(s,1/2.2);try{t&&this.setModuleParameters(t);const{getPolygonOffset:o}=this.props,a=o&&o(e)||[0,0];ue(this.context.gl,{polygonOffset:a}),Gt(this.context.gl,i,()=>{const c={moduleParameters:t,uniforms:e,parameters:i,context:this.context};for(const l of this.props.extensions)l.draw.call(this,c,l);this.draw(c)})}finally{this.props=r}}getChangeFlags(){return this.internalState.changeFlags}setChangeFlags(t){const{changeFlags:e}=this.internalState;for(const r in t)if(t[r]){let s=!1;switch(r){case"dataChanged":Array.isArray(e[r])&&(e[r]=Array.isArray(t[r])?e[r].concat(t[r]):t[r],s=!0);default:e[r]||(e[r]=t[r],s=!0)}s&&gt(Iw,this,r,t)}const i=e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged;e.propsOrDataChanged=i,e.somethingChanged=i||t.viewportChanged||t.stateChanged}clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}diffProps(t,e){const i=YA(t,e);if(i.updateTriggersChanged)for(const r in i.updateTriggersChanged)i.updateTriggersChanged[r]&&this.invalidateAttribute(r);if(i.transitionsChanged)for(const r in i.transitionsChanged)this.internalState.uniformTransitions.add(r,e[r],t[r],t.transitions[r]);return this.setChangeFlags(i)}validateProps(){qA(this.props)}setModuleParameters(t){for(const e of this.getModels())e.updateModuleSettings(t)}updateAutoHighlight(t){this.props.autoHighlight&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={pickingSelectedColor:t.picked?t.color:null},{highlightColor:i}=this.props;t.picked&&typeof i=="function"&&(e.pickingHighlightColor=i(t)),this.setModuleParameters(e),this.setNeedsRedraw()}_updateModules({props:t,oldProps:e},i){const{autoHighlight:r,highlightedObjectIndex:s,highlightColor:o}=t;if(i||e.autoHighlight!==r||e.highlightedObjectIndex!==s||e.highlightColor!==o){const a={};r||(a.pickingSelectedColor=null),Array.isArray(o)&&(a.pickingHighlightColor=o),Number.isInteger(s)&&(a.pickingSelectedColor=s>=0?this.encodePickingColor(s):null),this.setModuleParameters(a)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags;const i=this.getAttributeManager(),r=i&&i.getNeedsRedraw(t);return e=e||r,e}_getAttributeManager(){return new VA(this.context.gl,{id:this.props.id,stats:this.context.stats,timeline:this.context.timeline})}_initState(){Yt(!this.internalState&&!this.state),Yt(isFinite(this.props.coordinateSystem));const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Sw({attributeManager:t,layer:this}),this.clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(W.deprecated("layer.state.attributeManager","layer.getAttributeManager()"),t)}),this.internalState.layer=this,this.internalState.uniformTransitions=new HA(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props)}_transferState(t){gt(Mw,this,this===t);const{state:e,internalState:i}=t;this!==t&&(this.internalState=i,this.internalState.layer=this,this.state=e,this.internalState.setAsyncProps(this.props),this.diffProps(this.props,this.internalState.getOldProps()))}_onAsyncPropUpdated(){this.diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}fn.layerName="Layer";fn.defaultProps=Cw;const Nw="compositeLayer.renderLayers";class $h extends fn{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id&&(t.object=e.__source.object,t.index=e.__source.index),t}renderLayers(){return null}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:i}=this.props;return i&&i[t]&&i[t].type||e}getSubLayerRow(t,e,i){return t.__source={parent:this,object:e,index:i},t}getSubLayerAccessor(t){if(typeof t=="function"){const e={data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(e.index=i.__source.index,t(i.__source.object,e)):t(i,r)}return t}getSubLayerProps(t={}){const{opacity:e,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:g,modelMatrix:m,extensions:_,fetch:T,_subLayerProps:v}=this.props,S={opacity:e,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:g,modelMatrix:m,extensions:_,fetch:T},y=v&&v[t.id],P=y&&y.updateTriggers,L=t.id||"sublayer";if(y){const x=this.constructor._propTypes,N=t.type?t.type._propTypes:{};for(const U in y){const C=N[U]||x[U];C&&C.type==="accessor"&&(y[U]=this.getSubLayerAccessor(y[U]))}}Object.assign(S,t,y),S.id="".concat(this.props.id,"-").concat(L),S.updateTriggers=E(E({all:this.props.updateTriggers.all},t.updateTriggers),P);for(const x of _){const N=x.getSubLayerProps.call(this,x);N&&Object.assign(S,N,{updateTriggers:Object.assign(S.updateTriggers,N.updateTriggers)})}return S}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_renderLayers(){let{subLayers:t}=this.internalState;const e=!t||this.needsUpdate();e&&(t=this.renderLayers(),t=To(t,Boolean),this.internalState.subLayers=t),gt(Nw,this,e,t);for(const i of t)i.parent=this}}$h.layerName="CompositeLayer";function Dw({map:n,gl:t,deck:e}){if(n.__deck)return n.__deck;const i=e&&e.props._customRender,r={useDevicePixels:!0,_customRender:()=>{n.triggerRepaint(),i&&i()},parameters:{depthMask:!0,depthTest:!0,blendFunc:[770,771,1,771],blendEquation:32774},userData:{isExternal:!1,mapboxLayers:new Set}};return e?(e.setProps(r),e.props.userData.isExternal=!0):(Object.assign(r,{gl:t,width:!1,height:!1,touchAction:"unset",viewState:Do(n)}),e=new pr(r),n.on("move",()=>jw(e,n)),n.on("remove",()=>{e.finalize(),n.__deck=null})),e.props.userData.mapboxVersion=Vw(n),n.__deck=e,n.on("render",()=>{e.layerManager&&zw(e,n)}),e}function Fw(n,t){n.props.userData.mapboxLayers.add(t),Fo(n)}function Uw(n,t){n.props.userData.mapboxLayers.delete(t),Fo(n)}function Bw(n,t){Fo(n)}function kw(n,t,e){let{currentViewport:i}=n.props.userData;i||(i=Hh(n,t,!0),n.props.userData.currentViewport=i),!!n.layerManager&&n._drawLayers("mapbox-repaint",{viewports:[i],layers:Wh(n,r=>qh(e.id,r)),clearCanvas:!1})}function Do(n){const{lng:t,lat:e}=n.getCenter();return{longitude:t,latitude:e,zoom:n.getZoom(),bearing:n.getBearing(),pitch:n.getPitch()}}function Vw(n){let t=0,e=0;return n.version&&([t,e]=n.version.split(".").slice(0,2).map(Number)),{major:t,minor:e}}function Hh(n,t,e=!0){const{mapboxVersion:i}=n.props.userData;return new Fe(Object.assign({x:0,y:0,width:n.width,height:n.height,repeat:!0},Do(t),e?{nearZMultiplier:i.major===1&&i.minor>=3||i.major>=2?.02:1/(n.height||1)}:{nearZMultiplier:.1}))}function zw(n,t){const{mapboxLayers:e,isExternal:i}=n.props.userData;if(i){const r=Array.from(e,o=>o.id),s=Wh(n,o=>{for(const a of r)if(qh(a,o))return!1;return!0});s.length>0&&n._drawLayers("mapbox-repaint",{viewports:[Hh(n,t,!1)],layers:s,clearCanvas:!1})}n.props.userData.currentViewport=null}function jw(n,t){n.setProps({viewState:Do(t)}),n.needsRedraw({clearRedrawFlags:!0})}function Wh(n,t){return n.layerManager.getLayers().filter(t)}function qh(n,t){let e=t;for(;e;){if(e.id===n)return!0;e=e.parent}return!1}function Fo(n){if(n.props.userData.isExternal)return;const t=[];n.props.userData.mapboxLayers.forEach(e=>{const i=e.props.type,r=new i(e.props);t.push(r)}),n.setProps({layers:t})}class sL{constructor(t){if(!t.id)throw new Error("Layer must have an unique id");this.id=t.id,this.type="custom",this.renderingMode=t.renderingMode||"3d",this.map=null,this.deck=null,this.props=t}onAdd(t,e){this.map=t,this.deck=Dw({map:t,gl:e,deck:this.props.deck}),Fw(this.deck,this)}onRemove(){Uw(this.deck,this)}setProps(t){Object.assign(this.props,t,{id:this.id}),this.deck&&Bw(this.deck)}render(t,e){kw(this.deck,this.map,this)}}var Gw=`#define SHADER_NAME point-cloud-layer-vertex-shader

attribute vec3 positions;
attribute vec3 instanceNormals;
attribute vec4 instanceColors;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform float radiusPixels;

varying vec4 vColor;
varying vec2 unitPosition;

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.normal = project_normal(instanceNormals);
  unitPosition = positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;
  vec3 offset = vec3(positions.xy * radiusPixels, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);
  gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);
  vColor = vec4(lightColor, instanceColors.a * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,$w=`#define SHADER_NAME point-cloud-layer-fragment-shader

precision highp float;

varying vec4 vColor;
varying vec2 unitPosition;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition);

  if (distToCenter > 1.0) {
    discard;
  }

  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;const Yh=[0,0,0,255],Xh=[0,0,1],Hw={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:n=>n.position},getNormal:{type:"accessor",value:Xh},getColor:{type:"accessor",value:Yh},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};function Ww(n){const{header:t,attributes:e}=n;!t||!e||(n.length=t.vertexCount,e.POSITION&&(e.instancePositions=e.POSITION),e.NORMAL&&(e.instanceNormals=e.NORMAL),e.COLOR_0&&(e.instanceColors=e.COLOR_0))}class Uo extends fn{getShaders(){return super.getShaders({vs:Gw,fs:$w,modules:[oo,QT,po]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:Xh},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:Yh}})}updateState({props:t,oldProps:e,changeFlags:i}){if(super.updateState({props:t,oldProps:e,changeFlags:i}),i.extensionsChanged){var r;const{gl:s}=this.context;(r=this.state.model)===null||r===void 0||r.delete(),this.state.model=this._getModel(s),this.getAttributeManager().invalidateAll()}i.dataChanged&&Ww(t.data)}draw({uniforms:t}){const{viewport:e}=this.context,{pointSize:i,sizeUnits:r}=this.props,s=r==="meters"?1/e.metersPerPixel:1;this.state.model.setUniforms(t).setUniforms({radiusPixels:i*s}).draw()}_getModel(t){const e=[];for(let i=0;i<3;i++){const r=i/3*Math.PI*2;e.push(Math.cos(r)*2,Math.sin(r)*2,0)}return new nn(t,k(E({},this.getShaders()),{id:this.props.id,geometry:new ni({drawMode:4,attributes:{positions:new Float32Array(e)}}),isInstanced:!0}))}}Uo.layerName="PointCloudLayer";Uo.defaultProps=Hw;const Rt=Object.freeze({OUTSIDE:-1,INTERSECTING:0,INSIDE:1});new I;new I;function qw(n,t){var e=t[0],i=t[1],r=t[2],s=t[4],o=t[5],a=t[6],c=t[8],l=t[9],u=t[10];return n[0]=Math.hypot(e,i,r),n[1]=Math.hypot(s,o,a),n[2]=Math.hypot(c,l,u),n}const pi=new I,Zh=new I;class vr{constructor(t=[0,0,0],e=0){this.radius=-0,this.center=new I,this.fromCenterRadius(t,e)}fromCenterRadius(t,e){return this.center.from(t),this.radius=e,this}fromCornerPoints(t,e){return e=pi.from(e),this.center=new I().from(t).add(e).scale(.5),this.radius=this.center.distance(e),this}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.radius===t.radius}clone(){return new vr(this.center,this.radius)}union(t){const e=this.center,i=this.radius,r=t.center,s=t.radius,o=pi.copy(r).subtract(e),a=o.magnitude();if(i>=a+s)return this.clone();if(s>=a+i)return t.clone();const c=(i+a+s)*.5;return Zh.copy(o).scale((-i+c)/a).add(e),this.center.copy(Zh),this.radius=c,this}expand(t){t=pi.from(t);const e=t.subtract(this.center).magnitude();return e>this.radius&&(this.radius=e),this}transform(t){this.center.transform(t);const e=qw(pi,t);return this.radius=Math.max(e[0],Math.max(e[1],e[2]))*this.radius,this}distanceSquaredTo(t){const e=this.distanceTo(t);return e*e}distanceTo(t){t=pi.from(t);const e=t.subtract(this.center);return Math.max(0,e.len()-this.radius)}intersectPlane(t){const e=this.center,i=this.radius,s=t.normal.dot(e)+t.distance;return s<-i?Rt.OUTSIDE:s<i?Rt.INTERSECTING:Rt.INSIDE}}const Yw=new I,Xw=new I,Ar=new I,wr=new I,Sr=new I,Zw=new I,Kw=new I,me={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class Bo{constructor(t=[0,0,0],e=[0,0,0,0,0,0,0,0,0]){this.center=new I().from(t),this.halfAxes=new dt(e)}get halfSize(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new I(t).len(),new I(e).len(),new I(i).len()]}get quaternion(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),r=new I(t).normalize(),s=new I(e).normalize(),o=new I(i).normalize();return new ti().fromMatrix3(new dt([...r,...s,...o]))}fromCenterHalfSizeQuaternion(t,e,i){const r=new ti(i),s=new dt().fromQuaternion(r);return s[0]=s[0]*e[0],s[1]=s[1]*e[0],s[2]=s[2]*e[0],s[3]=s[3]*e[1],s[4]=s[4]*e[1],s[5]=s[5]*e[1],s[6]=s[6]*e[2],s[7]=s[7]*e[2],s[8]=s[8]*e[2],this.center=new I().from(t),this.halfAxes=s,this}clone(){return new Bo(this.center,this.halfAxes)}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.halfAxes.equals(t.halfAxes)}getBoundingSphere(t=new vr){const e=this.halfAxes,i=e.getColumn(0,Ar),r=e.getColumn(1,wr),s=e.getColumn(2,Sr),o=Yw.copy(i).add(r).add(s);return t.center.copy(this.center),t.radius=o.magnitude(),t}intersectPlane(t){const e=this.center,i=t.normal,r=this.halfAxes,s=i.x,o=i.y,a=i.z,c=Math.abs(s*r[me.COLUMN0ROW0]+o*r[me.COLUMN0ROW1]+a*r[me.COLUMN0ROW2])+Math.abs(s*r[me.COLUMN1ROW0]+o*r[me.COLUMN1ROW1]+a*r[me.COLUMN1ROW2])+Math.abs(s*r[me.COLUMN2ROW0]+o*r[me.COLUMN2ROW1]+a*r[me.COLUMN2ROW2]),l=i.dot(e)+t.distance;return l<=-c?Rt.OUTSIDE:l>=c?Rt.INSIDE:Rt.INTERSECTING}distanceTo(t){return Math.sqrt(this.distanceSquaredTo(t))}distanceSquaredTo(t){const e=Xw.from(t).subtract(this.center),i=this.halfAxes,r=i.getColumn(0,Ar),s=i.getColumn(1,wr),o=i.getColumn(2,Sr),a=r.magnitude(),c=s.magnitude(),l=o.magnitude();r.normalize(),s.normalize(),o.normalize();let u=0,h;return h=Math.abs(e.dot(r))-a,h>0&&(u+=h*h),h=Math.abs(e.dot(s))-c,h>0&&(u+=h*h),h=Math.abs(e.dot(o))-l,h>0&&(u+=h*h),u}computePlaneDistances(t,e,i=[-0,-0]){let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;const o=this.center,a=this.halfAxes,c=a.getColumn(0,Ar),l=a.getColumn(1,wr),u=a.getColumn(2,Sr),h=Zw.copy(c).add(l).add(u).add(o),f=Kw.copy(h).subtract(t);let g=e.dot(f);return r=Math.min(g,r),s=Math.max(g,s),h.copy(o).add(c).add(l).subtract(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),h.copy(o).add(c).subtract(l).add(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),h.copy(o).add(c).subtract(l).subtract(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),o.copy(h).subtract(c).add(l).add(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),o.copy(h).subtract(c).add(l).subtract(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),o.copy(h).subtract(c).subtract(l).add(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),o.copy(h).subtract(c).subtract(l).subtract(u),f.copy(h).subtract(t),g=e.dot(f),r=Math.min(g,r),s=Math.max(g,s),i[0]=r,i[1]=s,i}transform(t){this.center.transformAsPoint(t);const e=this.halfAxes.getColumn(0,Ar);e.transformAsPoint(t);const i=this.halfAxes.getColumn(1,wr);i.transformAsPoint(t);const r=this.halfAxes.getColumn(2,Sr);return r.transformAsPoint(t),this.halfAxes=new dt([...e,...i,...r]),this}getTransform(){throw new Error("not implemented")}}const Kh=new I,Qh=new I;class kt{constructor(t=[0,0,1],e=0){this.normal=new I,this.distance=-0,this.fromNormalDistance(t,e)}fromNormalDistance(t,e){return rt(Number.isFinite(e)),this.normal.from(t).normalize(),this.distance=e,this}fromPointNormal(t,e){t=Kh.from(t),this.normal.from(e).normalize();const i=-this.normal.dot(t);return this.distance=i,this}fromCoefficients(t,e,i,r){return this.normal.set(t,e,i),rt($t(this.normal.len(),1)),this.distance=r,this}clone(t){return new kt(this.normal,this.distance)}equals(t){return $t(this.distance,t.distance)&&$t(this.normal,t.normal)}getPointDistance(t){return this.normal.dot(t)+this.distance}transform(t){const e=Qh.copy(this.normal).transformAsVector(t).normalize(),i=this.normal.scale(-this.distance).transform(t);return this.fromPointNormal(i,e)}projectPointOntoPlane(t,e=[0,0,0]){t=Kh.from(t);const i=this.getPointDistance(t),r=Qh.copy(this.normal).scale(i);return t.subtract(r).to(e)}}const Jh=[new I([1,0,0]),new I([0,1,0]),new I([0,0,1])],tf=new I,Qw=new I;new kt(new I(1,0,0),0);class _e{static get MASK_OUTSIDE(){return 4294967295}static get MASK_INSIDE(){return 0}static get MASK_INDETERMINATE(){return 2147483647}constructor(t=[]){this.planes=t,rt(this.planes.every(e=>e instanceof kt))}fromBoundingSphere(t){this.planes.length=2*Jh.length;const e=t.center,i=t.radius;let r=0;for(const s of Jh){let o=this.planes[r],a=this.planes[r+1];o||(o=this.planes[r]=new kt),a||(a=this.planes[r+1]=new kt);const c=tf.copy(s).scale(-i).add(e);-s.dot(c),o.fromPointNormal(c,s);const l=tf.copy(s).scale(i).add(e),u=Qw.copy(s).negate();-u.dot(l),a.fromPointNormal(l,u),r+=2}return this}computeVisibility(t){rt(t);let e=Rt.INSIDE;for(const i of this.planes)switch(t.intersectPlane(i)){case Rt.OUTSIDE:return Rt.OUTSIDE;case Rt.INTERSECTING:e=Rt.INTERSECTING;break}return e}computeVisibilityWithPlaneMask(t,e){if(rt(t,"boundingVolume is required."),rt(Number.isFinite(e),"parentPlaneMask is required."),e===_e.MASK_OUTSIDE||e===_e.MASK_INSIDE)return e;let i=_e.MASK_INSIDE;const r=this.planes;for(let s=0;s<this.planes.length;++s){const o=s<31?1<<s:0;if(s<31&&(e&o)==0)continue;const a=r[s],c=t.intersectPlane(a);if(c===Rt.OUTSIDE)return _e.MASK_OUTSIDE;c===Rt.INTERSECTING&&(i|=o)}return i}}new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new I;new dt;new dt;new dt;new dt;new dt;new I;new I;new I;new I;new I;new dt;new dt,new dt;const ko=Math.PI/180,Ir=new Float32Array(16),ef=new Float32Array(12);function nf(n,t,e){const i=t[0]*ko,r=t[1]*ko,s=t[2]*ko,o=Math.sin(s),a=Math.sin(i),c=Math.sin(r),l=Math.cos(s),u=Math.cos(i),h=Math.cos(r),f=e[0],g=e[1],m=e[2];n[0]=f*h*u,n[1]=f*c*u,n[2]=f*-a,n[3]=g*(-c*l+h*a*o),n[4]=g*(h*l+c*a*o),n[5]=g*u*o,n[6]=m*(c*o+h*a*l),n[7]=m*(-h*o+c*a*l),n[8]=m*u*l}function rf(n){return n[0]=n[0],n[1]=n[1],n[2]=n[2],n[3]=n[4],n[4]=n[5],n[5]=n[6],n[6]=n[8],n[7]=n[9],n[8]=n[10],n[9]=n[12],n[10]=n[13],n[11]=n[14],n.subarray(0,12)}const sf={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrix__LOCATION_0:{size:3,elementOffset:0},instanceModelMatrix__LOCATION_1:{size:3,elementOffset:3},instanceModelMatrix__LOCATION_2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(n,{startRow:t,endRow:e}){const{data:i,getOrientation:r,getScale:s,getTranslation:o,getTransformMatrix:a}=this.props,c=Array.isArray(a),l=c&&a.length===16,u=Array.isArray(s),h=Array.isArray(r),f=Array.isArray(o),g=l||!c&&Boolean(a(i[0]));g?n.constant=l:n.constant=h&&u&&f;const m=n.value;if(n.constant){let _;g?(Ir.set(a),_=rf(Ir)):(_=ef,nf(_,r,s),_.set(o,9)),n.value=new Float32Array(_)}else{let _=t*n.size;const{iterable:T,objectInfo:v}=Sh(i,t,e);for(const S of T){v.index++;let y;if(g)Ir.set(l?a:a(S,v)),y=rf(Ir);else{y=ef;const P=h?r:r(S,v),L=u?s:s(S,v);nf(y,P,L),y.set(f?o:o(S,v),9)}m[_++]=y[0],m[_++]=y[1],m[_++]=y[2],m[_++]=y[3],m[_++]=y[4],m[_++]=y[5],m[_++]=y[6],m[_++]=y[7],m[_++]=y[8],m[_++]=y[9],m[_++]=y[10],m[_++]=y[11]}}}};function of(n,t){return t===H.CARTESIAN||t===H.METER_OFFSETS||t===H.DEFAULT&&!n.isGeospatial}var Jw=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
uniform float sizeScale;
uniform bool composeModelMatrix;
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in mat3 instanceModelMatrix;
in vec3 instanceTranslation;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = texCoords;
  geometry.pickingColor = instancePickingColors;

  vTexCoord = texCoords;
  cameraPosition = project_uCameraPosition;
  normals_commonspace = project_normal(instanceModelMatrix * normals);
  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
  geometry.normal = normals_commonspace;

  vec3 pos = (instanceModelMatrix * positions) * sizeScale + instanceTranslation;

  if (composeModelMatrix) {
    DECKGL_FILTER_SIZE(pos, geometry);
    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), position_commonspace);
  }
  else {
    pos = project_size(pos);
    DECKGL_FILTER_SIZE(pos, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, position_commonspace);
  }

  geometry.position = position_commonspace;
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,tS=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs

precision highp float;

uniform bool hasTexture;
uniform sampler2D sampler;
uniform bool flatShading;
uniform float opacity;

in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;

out vec4 fragColor;

void main(void) {
  geometry.uv = vTexCoord;

  vec3 normal;
  if (flatShading) {
#ifdef DERIVATIVES_AVAILABLE
    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
#else
    normal = vec3(0.0, 0.0, 1.0);
#endif
  } else {
    normal = normals_commonspace;
  }

  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;
  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
  fragColor = vec4(lightColor, color.a * opacity);

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;function af(n,t){(n.COLOR_0||n.colors)&&t||(n.colors={constant:!0,value:new Float32Array([1,1,1])}),W.assert(n.positions||n.POSITION,'no "postions" or "POSITION" attribute in mesh')}function eS(n,t){if(n.attributes)return af(n.attributes,t),n instanceof ni?n:new ni(n);if(n.positions||n.POSITION)return af(n,t),new ni({attributes:n});throw Error("Invalid mesh")}const nS=[0,0,0,255],iS={mesh:{value:null,type:"object",async:!0},texture:{type:"image",value:null,async:!0},sizeScale:{type:"number",value:1,min:0},_useMeshColors:{type:"boolean",value:!1},_instanced:!0,wireframe:!1,material:!0,getPosition:{type:"accessor",value:n=>n.position},getColor:{type:"accessor",value:nS},getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]}};class Vo extends fn{getShaders(){const t=!j(this.context.gl),e={};return Ds(this.context.gl,Q.GLSL_DERIVATIVES)&&(e.DERIVATIVES_AVAILABLE=1),super.getShaders({vs:Jw,fs:tS,modules:[oo,JT,po],transpileToGLSL100:t,defines:e})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{transition:!0,type:5130,fp64:this.use64bitPositions(),size:3,accessor:"getPosition"},instanceColors:{type:5121,transition:!0,size:this.props.colorFormat.length,normalized:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceModelMatrix:sf}),this.setState({emptyTexture:new It(this.context.gl,{data:new Uint8Array(4),width:1,height:1})})}updateState({props:t,oldProps:e,changeFlags:i}){if(super.updateState({props:t,oldProps:e,changeFlags:i}),t.mesh!==e.mesh||i.extensionsChanged){var r;if((r=this.state.model)===null||r===void 0||r.delete(),t.mesh){this.state.model=this.getModel(t.mesh);const s=t.mesh.attributes||t.mesh;this.setState({hasNormals:Boolean(s.NORMAL||s.normals)})}this.getAttributeManager().invalidateAll()}t.texture!==e.texture&&this.setTexture(t.texture),this.state.model&&this.state.model.setDrawMode(this.props.wireframe?3:4)}finalizeState(){super.finalizeState(),this.state.emptyTexture.delete()}draw({uniforms:t}){if(!this.state.model)return;const{viewport:e}=this.context,{sizeScale:i,coordinateSystem:r,_instanced:s}=this.props;this.state.model.setUniforms(t).setUniforms({sizeScale:i,composeModelMatrix:!s||of(e,r),flatShading:!this.state.hasNormals}).draw()}getModel(t){const e=new nn(this.context.gl,k(E({},this.getShaders()),{id:this.props.id,geometry:eS(t,this.props._useMeshColors),isInstanced:!0})),{texture:i}=this.props,{emptyTexture:r}=this.state;return e.setUniforms({sampler:i||r,hasTexture:Boolean(i)}),e}setTexture(t){const{emptyTexture:e,model:i}=this.state;i==null||i.setUniforms({sampler:t||e,hasTexture:Boolean(t)})}}Vo.layerName="SimpleMeshLayer";Vo.defaultProps=iS;class dn{constructor(t={}){const{id:e}=t;this.id=e||he(this.constructor.name),this.display=!0,this.position=new I,this.rotation=new I,this.scale=new I(1,1,1),this.matrix=new $,this.userData={},this.props={},this._setScenegraphNodeProps(t)}delete(){}setProps(t){return this._setScenegraphNodeProps(t),this}toString(){return`{type: ScenegraphNode, id: ${this.id})}`}setPosition(t){return O(t.length===3,"setPosition requires vector argument"),this.position=t,this}setRotation(t){return O(t.length===3,"setRotation requires vector argument"),this.rotation=t,this}setScale(t){return O(t.length===3,"setScale requires vector argument"),this.scale=t,this}setMatrix(t,e=!0){e?this.matrix.copy(t):this.matrix=t}setMatrixComponents({position:t,rotation:e,scale:i,update:r=!0}){return t&&this.setPosition(t),e&&this.setRotation(e),i&&this.setScale(i),r&&this.updateMatrix(),this}updateMatrix(){const t=this.position,e=this.rotation,i=this.scale;return this.matrix.identity(),this.matrix.translate(t),this.matrix.rotateXYZ(e),this.matrix.scale(i),this}update(t={}){const{position:e,rotation:i,scale:r}=t;return e&&this.setPosition(e),i&&this.setRotation(i),r&&this.setScale(r),this.updateMatrix(),this}getCoordinateUniforms(t,e){O(t),e=e||this.matrix;const i=new $(t).multiplyRight(e),r=i.invert(),s=r.transpose();return{viewMatrix:t,modelMatrix:e,objectMatrix:e,worldMatrix:i,worldInverseMatrix:r,worldInverseTransposeMatrix:s}}_setScenegraphNodeProps(t){"display"in t&&(this.display=t.display),"position"in t&&this.setPosition(t.position),"rotation"in t&&this.setRotation(t.rotation),"scale"in t&&this.setScale(t.scale),"matrix"in t&&this.setMatrix(t.matrix),Object.assign(this.props,t)}}class mi extends dn{constructor(t={}){t=Array.isArray(t)?{children:t}:t;const{children:e=[]}=t;F.assert(e.every(i=>i instanceof dn),"every child must an instance of ScenegraphNode");super(t);this.children=e}add(...t){for(const e of t)Array.isArray(e)?this.add(...e):this.children.push(e);return this}remove(t){const e=this.children,i=e.indexOf(t);return i>-1&&e.splice(i,1),this}removeAll(){return this.children=[],this}delete(){this.children.forEach(t=>t.delete()),this.removeAll(),super.delete()}traverse(t,{worldMatrix:e=new $}={}){const i=new $(e).multiplyRight(this.matrix);for(const r of this.children)r instanceof mi?r.traverse(t,{worldMatrix:i}):t(r,{worldMatrix:i})}}const rS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},sS={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function cf(n){if(!n._animation){const t=sS[n.componentType],e=rS[n.type],i=e*n.count,{buffer:r,byteOffset:s}=n.bufferView.data,o=new t(r,s+(n.byteOffset||0),i);if(e===1)n._animation=Array.from(o);else{const a=[];for(let c=0;c<o.length;c+=e)a.push(Array.from(o.slice(c,c+e)));n._animation=a}}return n._animation}const oS=new $;function aS(n,t){if(t.matrix.identity(),n.translation&&t.matrix.translate(n.translation),n.rotation){const e=oS.fromQuaternion(n.rotation);t.matrix.multiplyRight(e)}n.scale&&t.matrix.scale(n.scale)}const zo=new ti;function cS(n,t,e,i,r){if(t==="rotation"){zo.slerp({start:e,target:i,ratio:r});for(let s=0;s<zo.length;s++)n[t][s]=zo[s]}else for(let s=0;s<e.length;s++)n[t][s]=r*i[s]+(1-r)*e[s]}function lS(n,t,{p0:e,outTangent0:i,inTangent1:r,p1:s,tDiff:o,ratio:a}){for(let c=0;c<n[t].length;c++){const l=i[c]*o,u=r[c]*o;n[t][c]=(2*Math.pow(a,3)-3*Math.pow(a,2)+1)*e[c]+(Math.pow(a,3)-2*Math.pow(a,2)+a)*l+(-2*Math.pow(a,3)+3*Math.pow(a,2))*s[c]+(Math.pow(a,3)-Math.pow(a,2))*u}}function uS(n,t,e){for(let i=0;i<e.length;i++)n[t][i]=e[i]}function hS(n,{input:t,interpolation:e,output:i},r,s){const o=t[t.length-1],a=n%o,c=t.findIndex(f=>f>=a),l=Math.max(0,c-1);if(!Array.isArray(r[s]))switch(s){case"translation":r[s]=[0,0,0];break;case"rotation":r[s]=[0,0,0,1];break;case"scale":r[s]=[1,1,1];break;default:F.warn(`Bad animation path ${s}`)()}O(r[s].length===i[l].length);const u=t[l],h=t[c];switch(e){case"STEP":uS(r,s,i[l]);break;case"LINEAR":if(h>u){const f=(a-u)/(h-u);cS(r,s,i[l],i[c],f)}break;case"CUBICSPLINE":if(h>u){const f=(a-u)/(h-u),g=h-u,m=i[3*l+1],_=i[3*l+2],T=i[3*c+0],v=i[3*c+1];lS(r,s,{p0:m,outTangent0:_,inTangent1:T,p1:v,tDiff:g,ratio:f})}break;default:F.warn(`Interpolation ${e} not supported`)();break}}class fS{constructor(t){this.startTime=0,this.playing=!0,this.speed=1,this.channels=[],Object.assign(this,t)}animate(t){if(!this.playing)return;const i=(t/1e3-this.startTime)*this.speed;this.channels.forEach(({sampler:r,target:s,path:o})=>{hS(i,r,s,o),aS(s,s._node)})}}class dS{constructor(t){this.animations=t.animations.map((e,i)=>{const r=e.name||`Animation-${i}`,s=e.samplers.map(({input:a,interpolation:c="LINEAR",output:l})=>({input:cf(t.accessors[a]),interpolation:c,output:cf(t.accessors[l])})),o=e.channels.map(({sampler:a,target:c})=>({sampler:s[a],target:t.nodes[c.node],path:c.path}));return new fS({name:r,channels:o})})}animate(t){this.setTime(t)}setTime(t){this.animations.forEach(e=>e.animate(t))}getAnimations(){return this.animations}}class gS extends dn{constructor(t,e={}){super(e);this.onBeforeRender=null,this.AfterRender=null,t instanceof nn?(this.model=t,this._setModelNodeProps(e)):this.model=new nn(t,e),this.managedResources=e.managedResources||[]}setProps(t){return super.setProps(t),this._setModelNodeProps(t),this}delete(){this.model&&(this.model.delete(),this.model=null),this.managedResources.forEach(t=>t.delete()),this.managedResources=[]}draw(...t){return this.model.draw(...t)}setUniforms(...t){return this.model.setUniforms(...t),this}setAttributes(...t){return this.model.setAttributes(...t),this}updateModuleSettings(...t){return this.model.updateModuleSettings(...t),this}_setModelNodeProps(t){this.model.setProps(t)}}class lf{constructor(t,{attributes:e,material:i,pbrDebug:r,imageBasedLightingEnvironment:s,lights:o,useTangents:a}){this.gl=t,this.defines={MANUAL_SRGB:1,SRGB_FAST_APPROXIMATION:1},Ds(t,Q.GLSL_TEXTURE_LOD)&&(this.defines.USE_TEX_LOD=1),this.uniforms={u_Camera:[0,0,0],u_MetallicRoughnessValues:[1,1]},this.parameters={},this.generatedTextures=[],s&&(this.uniforms.u_DiffuseEnvSampler=s.getDiffuseEnvSampler(),this.uniforms.u_SpecularEnvSampler=s.getSpecularEnvSampler(),this.uniforms.u_brdfLUT=s.getBrdfTexture(),this.uniforms.u_ScaleIBLAmbient=[1,1]),r&&(this.uniforms.u_ScaleDiffBaseMR=[0,0,0,0],this.uniforms.u_ScaleFGDSpec=[0,0,0,0]),this.defineIfPresent(e.NORMAL,"HAS_NORMALS"),this.defineIfPresent(e.TANGENT&&a,"HAS_TANGENTS"),this.defineIfPresent(e.TEXCOORD_0,"HAS_UV"),this.defineIfPresent(s,"USE_IBL"),this.defineIfPresent(o,"USE_LIGHTS"),this.defineIfPresent(r,"PBR_DEBUG"),i&&this.parseMaterial(i)}defineIfPresent(t,e){t&&(this.defines[e]=1)}parseTexture(t,e,i=null){const r=t.texture&&t.texture.sampler&&t.texture.sampler.parameters||{},s=t.texture.source.image;let o,a={};s.compressed?(o=s,a={[this.gl.TEXTURE_MIN_FILTER]:s.data.length>1?this.gl.LINEAR_MIPMAP_NEAREST:this.gl.LINEAR}):o={data:s};const c=new It(this.gl,E({id:t.name||t.id,parameters:E(E({},r),a),pixelStore:{[this.gl.UNPACK_FLIP_Y_WEBGL]:!1}},o));this.uniforms[e]=c,this.defineIfPresent(i,i),this.generatedTextures.push(c)}parsePbrMetallicRoughness(t){t.baseColorTexture&&this.parseTexture(t.baseColorTexture,"u_BaseColorSampler","HAS_BASECOLORMAP"),this.uniforms.u_BaseColorFactor=t.baseColorFactor||[1,1,1,1],t.metallicRoughnessTexture&&this.parseTexture(t.metallicRoughnessTexture,"u_MetallicRoughnessSampler","HAS_METALROUGHNESSMAP");const{metallicFactor:e=1,roughnessFactor:i=1}=t;this.uniforms.u_MetallicRoughnessValues=[e,i]}parseMaterial(t){if(this.uniforms.pbr_uUnlit=Boolean(t.unlit),t.pbrMetallicRoughness&&this.parsePbrMetallicRoughness(t.pbrMetallicRoughness),t.normalTexture){this.parseTexture(t.normalTexture,"u_NormalSampler","HAS_NORMALMAP");const{scale:e=1}=t.normalTexture;this.uniforms.u_NormalScale=e}if(t.occlusionTexture){this.parseTexture(t.occlusionTexture,"u_OcclusionSampler","HAS_OCCLUSIONMAP");const{strength:e=1}=t.occlusionTexture;this.uniforms.u_OcclusionStrength=e}if(t.emissiveTexture&&(this.parseTexture(t.emissiveTexture,"u_EmissiveSampler","HAS_EMISSIVEMAP"),this.uniforms.u_EmissiveFactor=t.emissiveFactor||[0,0,0]),t.alphaMode==="MASK"){const{alphaCutoff:e=.5}=t;this.defines.ALPHA_CUTOFF=1,this.uniforms.u_AlphaCutoff=e}else t.alphaMode==="BLEND"&&(F.warn("BLEND alphaMode might not work well because it requires mesh sorting")(),Object.assign(this.parameters,{blend:!0,blendEquation:this.gl.FUNC_ADD,blendFunc:[this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA]}))}}const pS=`
#if (__VERSION__ < 300)
  #define _attr attribute
#else
  #define _attr in
#endif

  _attr vec4 POSITION;

  #ifdef HAS_NORMALS
    _attr vec4 NORMAL;
  #endif

  #ifdef HAS_TANGENTS
    _attr vec4 TANGENT;
  #endif

  #ifdef HAS_UV
    _attr vec2 TEXCOORD_0;
  #endif

  void main(void) {
    vec4 _NORMAL = vec4(0.);
    vec4 _TANGENT = vec4(0.);
    vec2 _TEXCOORD_0 = vec2(0.);

    #ifdef HAS_NORMALS
      _NORMAL = NORMAL;
    #endif

    #ifdef HAS_TANGENTS
      _TANGENT = TANGENT;
    #endif

    #ifdef HAS_UV
      _TEXCOORD_0 = TEXCOORD_0;
    #endif

    pbr_setPositionNormalTangentUV(POSITION, _NORMAL, _TANGENT, _TEXCOORD_0);
    gl_Position = u_MVPMatrix * POSITION;
  }
`,mS=`
#if (__VERSION__ < 300)
  #define fragmentColor gl_FragColor
#else
  out vec4 fragmentColor;
#endif

  void main(void) {
    fragmentColor = pbr_filterColor(vec4(0));
  }
`;function uf(n,t){return j(n)?`#version 300 es
${t}`:t}function _S(n,t){const{id:e,drawMode:i,vertexCount:r,attributes:s,modelOptions:o}=t,a=new lf(n,t);F.info(4,"createGLTFModel defines: ",a.defines)();const c=[];c.push(...a.generatedTextures),c.push(...Object.values(s).map(u=>u.buffer));const l=new gS(n,Object.assign({id:e,drawMode:i,vertexCount:r,modules:[io],defines:a.defines,parameters:a.parameters,vs:uf(n,pS),fs:uf(n,mS),managedResources:c},o));return l.setProps({attributes:s}),l.setUniforms(a.uniforms),l}const bS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},yS={modelOptions:{},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1};class TS{constructor(t,e={}){this.gl=t,this.options=Object.assign({},yS,e)}instantiate(t){return this.gltf=t,(t.scenes||[]).map(i=>this.createScene(i))}createAnimator(){return Array.isArray(this.gltf.animations)?new dS(this.gltf):null}createScene(t){const i=(t.nodes||[]).map(s=>this.createNode(s));return new mi({id:t.name||t.id,children:i})}createNode(t){if(!t._node){const i=(t.children||[]).map(s=>this.createNode(s));t.mesh&&i.push(this.createMesh(t.mesh));const r=new mi({id:t.name||t.id,children:i});if(t.matrix)r.setMatrix(t.matrix);else{if(r.matrix.identity(),t.translation&&r.matrix.translate(t.translation),t.rotation){const s=new $().fromQuaternion(t.rotation);r.matrix.multiplyRight(s)}t.scale&&r.matrix.scale(t.scale)}t._node=r}return t._node}createMesh(t){if(!t._mesh){const i=(t.primitives||[]).map((s,o)=>this.createPrimitive(s,o,t)),r=new mi({id:t.name||t.id,children:i});t._mesh=r}return t._mesh}getVertexCount(t){F.warn("getVertexCount() not found")()}createPrimitive(t,e,i){return _S(this.gl,Object.assign({id:t.name||`${i.name||i.id}-primitive-${e}`,drawMode:t.mode||4,vertexCount:t.indices?t.indices.count:this.getVertexCount(t.attributes),attributes:this.createAttributes(t.attributes,t.indices),material:t.material},this.options))}createAttributes(t,e){const i={};return Object.keys(t).forEach(r=>{i[r]=this.createAccessor(t[r],this.createBuffer(t[r],this.gl.ARRAY_BUFFER))}),e&&(i.indices=this.createAccessor(e,this.createBuffer(e,this.gl.ELEMENT_ARRAY_BUFFER))),F.info(4,"glTF Attributes",{attributes:t,indices:e,generated:i})(),i}createBuffer(t,e){t.bufferView||(t.bufferView={});const{bufferView:i}=t;return i.lumaBuffers||(i.lumaBuffers={}),i.lumaBuffers[e]||(i.lumaBuffers[e]=new X(this.gl,{id:`from-${i.id}`,data:i.data||t.value,target:e})),i.lumaBuffers[e]}createAccessor(t,e){return new At({buffer:e,offset:t.byteOffset||0,stride:t.bufferView.byteStride||0,type:t.componentType,size:bS[t.type]})}createSampler(t){return t}needsPOT(){return!1}}function ES(n,t,e){const i=new TS(n,e),r=i.instantiate(t),s=i.createAnimator();return{scenes:r,animator:s}}const hf="KHR_binary_glTF",_i="KHR_draco_mesh_compression",gn="KHR_lights_punctual",Pr="KHR_materials_unlit",xr="KHR_techniques_webgl",vS="3.0.12";function Ot(n,t){if(!n)throw new Error(t||"assert failed: gltf")}function ff(n,t){if(n.startsWith("data:")||n.startsWith("http:")||n.startsWith("https:"))return n;const i=t.baseUri||t.uri;if(!i)throw new Error(`'baseUri' must be provided to resolve relative url ${n}`);return i.substr(0,i.lastIndexOf("/")+1)+n}function AS(n,t,e){const i=n.bufferViews[e];Ot(i);const r=i.buffer,s=t[r];Ot(s);const o=(i.byteOffset||0)+s.byteOffset;return new Uint8Array(s.arrayBuffer,o,i.byteLength)}const wS="3.0.12",SS={draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}},IS={name:"Draco",id:"draco",module:"draco",version:wS,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:SS};function PS(n){let t=1/0,e=1/0,i=1/0,r=-1/0,s=-1/0,o=-1/0;const a=n.POSITION?n.POSITION.value:[],c=a&&a.length;for(let l=0;l<c;l+=3){const u=a[l],h=a[l+1],f=a[l+2];t=u<t?u:t,e=h<e?h:e,i=f<i?f:i,r=u>r?u:r,s=h>s?h:s,o=f>o?f:o}return[[t,e,i],[r,s,o]]}function xS(n,t){if(!n)throw new Error(t||"loader assertion failed.")}class pn{constructor(t,e){A(this,"fields",void 0),A(this,"metadata",void 0),xS(Array.isArray(t)),LS(t),this.fields=t,this.metadata=e||new Map}compareTo(t){if(this.metadata!==t.metadata||this.fields.length!==t.fields.length)return!1;for(let e=0;e<this.fields.length;++e)if(!this.fields[e].compareTo(t.fields[e]))return!1;return!0}select(...t){const e=Object.create(null);for(const r of t)e[r]=!0;const i=this.fields.filter(r=>e[r.name]);return new pn(i,this.metadata)}selectAt(...t){const e=t.map(i=>this.fields[i]).filter(Boolean);return new pn(e,this.metadata)}assign(t){let e,i=this.metadata;if(t instanceof pn){const o=t;e=o.fields,i=df(df(new Map,this.metadata),o.metadata)}else e=t;const r=Object.create(null);for(const o of this.fields)r[o.name]=o;for(const o of e)r[o.name]=o;const s=Object.values(r);return new pn(s,i)}}function LS(n){const t={};for(const e of n)t[e.name]&&console.warn("Schema: duplicated field name",e.name,e),t[e.name]=!0}function df(n,t){return new Map([...n||new Map,...t||new Map])}class Lr{constructor(t,e,i=!1,r=new Map){A(this,"name",void 0),A(this,"type",void 0),A(this,"nullable",void 0),A(this,"metadata",void 0),this.name=t,this.type=e,this.nullable=i,this.metadata=r}get typeId(){return this.type&&this.type.typeId}clone(){return new Lr(this.name,this.type,this.nullable,this.metadata)}compareTo(t){return this.name===t.name&&this.type===t.type&&this.nullable===t.nullable&&this.metadata===t.metadata}toString(){return`${this.type}${this.nullable?", nullable":""}${this.metadata?`, metadata: ${this.metadata}`:""}`}}let et;(function(n){n[n.NONE=0]="NONE",n[n.Null=1]="Null",n[n.Int=2]="Int",n[n.Float=3]="Float",n[n.Binary=4]="Binary",n[n.Utf8=5]="Utf8",n[n.Bool=6]="Bool",n[n.Decimal=7]="Decimal",n[n.Date=8]="Date",n[n.Time=9]="Time",n[n.Timestamp=10]="Timestamp",n[n.Interval=11]="Interval",n[n.List=12]="List",n[n.Struct=13]="Struct",n[n.Union=14]="Union",n[n.FixedSizeBinary=15]="FixedSizeBinary",n[n.FixedSizeList=16]="FixedSizeList",n[n.Map=17]="Map",n[n.Dictionary=-1]="Dictionary",n[n.Int8=-2]="Int8",n[n.Int16=-3]="Int16",n[n.Int32=-4]="Int32",n[n.Int64=-5]="Int64",n[n.Uint8=-6]="Uint8",n[n.Uint16=-7]="Uint16",n[n.Uint32=-8]="Uint32",n[n.Uint64=-9]="Uint64",n[n.Float16=-10]="Float16",n[n.Float32=-11]="Float32",n[n.Float64=-12]="Float64",n[n.DateDay=-13]="DateDay",n[n.DateMillisecond=-14]="DateMillisecond",n[n.TimestampSecond=-15]="TimestampSecond",n[n.TimestampMillisecond=-16]="TimestampMillisecond",n[n.TimestampMicrosecond=-17]="TimestampMicrosecond",n[n.TimestampNanosecond=-18]="TimestampNanosecond",n[n.TimeSecond=-19]="TimeSecond",n[n.TimeMillisecond=-20]="TimeMillisecond",n[n.TimeMicrosecond=-21]="TimeMicrosecond",n[n.TimeNanosecond=-22]="TimeNanosecond",n[n.DenseUnion=-23]="DenseUnion",n[n.SparseUnion=-24]="SparseUnion",n[n.IntervalDayTime=-25]="IntervalDayTime",n[n.IntervalYearMonth=-26]="IntervalYearMonth"})(et||(et={}));let gf,pf,mf;class jo{static isNull(t){return t&&t.typeId===et.Null}static isInt(t){return t&&t.typeId===et.Int}static isFloat(t){return t&&t.typeId===et.Float}static isBinary(t){return t&&t.typeId===et.Binary}static isUtf8(t){return t&&t.typeId===et.Utf8}static isBool(t){return t&&t.typeId===et.Bool}static isDecimal(t){return t&&t.typeId===et.Decimal}static isDate(t){return t&&t.typeId===et.Date}static isTime(t){return t&&t.typeId===et.Time}static isTimestamp(t){return t&&t.typeId===et.Timestamp}static isInterval(t){return t&&t.typeId===et.Interval}static isList(t){return t&&t.typeId===et.List}static isStruct(t){return t&&t.typeId===et.Struct}static isUnion(t){return t&&t.typeId===et.Union}static isFixedSizeBinary(t){return t&&t.typeId===et.FixedSizeBinary}static isFixedSizeList(t){return t&&t.typeId===et.FixedSizeList}static isMap(t){return t&&t.typeId===et.Map}static isDictionary(t){return t&&t.typeId===et.Dictionary}get typeId(){return et.NONE}compareTo(t){return this===t}}gf=Symbol.toStringTag;class mn extends jo{constructor(t,e){super();A(this,"isSigned",void 0),A(this,"bitWidth",void 0),this.isSigned=t,this.bitWidth=e}get typeId(){return et.Int}get[gf](){return"Int"}toString(){return`${this.isSigned?"I":"Ui"}nt${this.bitWidth}`}}class MS extends mn{constructor(){super(!0,8)}}class RS extends mn{constructor(){super(!0,16)}}class OS extends mn{constructor(){super(!0,32)}}class CS extends mn{constructor(){super(!1,8)}}class NS extends mn{constructor(){super(!1,16)}}class DS extends mn{constructor(){super(!1,32)}}const _f={HALF:16,SINGLE:32,DOUBLE:64};pf=Symbol.toStringTag;class bf extends jo{constructor(t){super();A(this,"precision",void 0),this.precision=t}get typeId(){return et.Float}get[pf](){return"Float"}toString(){return`Float${this.precision}`}}class FS extends bf{constructor(){super(_f.SINGLE)}}class US extends bf{constructor(){super(_f.DOUBLE)}}mf=Symbol.toStringTag;class BS extends jo{constructor(t,e){super();A(this,"listSize",void 0),A(this,"children",void 0),this.listSize=t,this.children=[e]}get typeId(){return et.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[mf](){return"FixedSizeList"}toString(){return`FixedSizeList[${this.listSize}]<${this.valueType}>`}}function kS(n){switch(n.constructor){case Int8Array:return new MS;case Uint8Array:return new CS;case Int16Array:return new RS;case Uint16Array:return new NS;case Int32Array:return new OS;case Uint32Array:return new DS;case Float32Array:return new FS;case Float64Array:return new US;default:throw new Error("array type not supported")}}function VS(n,t,e){const i=Tf(t.metadata),r=[],s=zS(t.attributes);for(const o in n){const a=n[o],c=yf(o,a,s[o]);r.push(c)}if(e){const o=yf("indices",e);r.push(o)}return new pn(r,i)}function zS(n){const t={};for(const e in n){const i=n[e];t[i.name||"undefined"]=i}return t}function yf(n,t,e){const i=e?Tf(e.metadata):void 0,r=kS(t.value);return new Lr(n,new BS(t.size,new Lr("value",r)),!1,i)}function Tf(n){const t=new Map;for(const e in n)t.set(`${e}.string`,JSON.stringify(n[e]));return t}const Ef={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},jS={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},GS=4;class $S{constructor(t){A(this,"draco",void 0),A(this,"decoder",void 0),A(this,"metadataQuerier",void 0),this.draco=t,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(t,e={}){const i=new this.draco.DecoderBuffer;i.Init(new Int8Array(t),t.byteLength),this._disableAttributeTransforms(e);const r=this.decoder.GetEncodedGeometryType(i),s=r===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let o;switch(r){case this.draco.TRIANGULAR_MESH:o=this.decoder.DecodeBufferToMesh(i,s);break;case this.draco.POINT_CLOUD:o=this.decoder.DecodeBufferToPointCloud(i,s);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!o.ok()||!s.ptr){const f=`DRACO decompression failed: ${o.error_msg()}`;throw new Error(f)}const a=this._getDracoLoaderData(s,r,e),c=this._getMeshData(s,a,e),l=PS(c.attributes),u=VS(c.attributes,a,c.indices);return k(E({loader:"draco",loaderData:a,header:{vertexCount:s.num_points(),boundingBox:l}},c),{schema:u})}finally{this.draco.destroy(i),s&&this.draco.destroy(s)}}_getDracoLoaderData(t,e,i){const r=this._getTopLevelMetadata(t),s=this._getDracoAttributes(t,i);return{geometry_type:e,num_attributes:t.num_attributes(),num_points:t.num_points(),num_faces:t instanceof this.draco.Mesh?t.num_faces():0,metadata:r,attributes:s}}_getDracoAttributes(t,e){const i={};for(let r=0;r<t.num_attributes();r++){const s=this.decoder.GetAttribute(t,r),o=this._getAttributeMetadata(t,r);i[s.unique_id()]={unique_id:s.unique_id(),attribute_type:s.attribute_type(),data_type:s.data_type(),num_components:s.num_components(),byte_offset:s.byte_offset(),byte_stride:s.byte_stride(),normalized:s.normalized(),attribute_index:r,metadata:o};const a=this._getQuantizationTransform(s,e);a&&(i[s.unique_id()].quantization_transform=a);const c=this._getOctahedronTransform(s,e);c&&(i[s.unique_id()].octahedron_transform=c)}return i}_getMeshData(t,e,i){const r=this._getMeshAttributes(e,t,i);if(!r.POSITION)throw new Error("DRACO: No position attribute found.");if(t instanceof this.draco.Mesh)switch(i.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:r,indices:{value:this._getTriangleStripIndices(t),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:r,indices:{value:this._getTriangleListIndices(t),size:1}}}return{topology:"point-list",mode:0,attributes:r}}_getMeshAttributes(t,e,i){const r={};for(const s of Object.values(t.attributes)){const o=this._deduceAttributeName(s,i);s.name=o;const{value:a,size:c}=this._getAttributeValues(e,s);r[o]={value:a,size:c,byteOffset:s.byte_offset,byteStride:s.byte_stride,normalized:s.normalized}}return r}_getTriangleListIndices(t){const i=t.num_faces()*3,r=i*GS,s=this.draco._malloc(r);try{return this.decoder.GetTrianglesUInt32Array(t,r,s),new Uint32Array(this.draco.HEAPF32.buffer,s,i).slice()}finally{this.draco._free(s)}}_getTriangleStripIndices(t){const e=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(t,e),qS(e)}finally{this.draco.destroy(e)}}_getAttributeValues(t,e){const i=jS[e.data_type],r=e.num_components,o=t.num_points()*r,a=o*i.BYTES_PER_ELEMENT,c=HS(this.draco,i);let l;const u=this.draco._malloc(a);try{const h=this.decoder.GetAttribute(t,e.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(t,h,c,a,u),l=new i(this.draco.HEAPF32.buffer,u,o).slice()}finally{this.draco._free(u)}return{value:l,size:r}}_deduceAttributeName(t,e){const i=t.unique_id;for(const[o,a]of Object.entries(e.extraAttributes||{}))if(a===i)return o;const r=t.attribute_type;for(const o in Ef)if(this.draco[o]===r)return Ef[o];const s=e.attributeNameEntry||"name";return t.metadata[s]?t.metadata[s].string:`CUSTOM_ATTRIBUTE_${i}`}_getTopLevelMetadata(t){const e=this.decoder.GetMetadata(t);return this._getDracoMetadata(e)}_getAttributeMetadata(t,e){const i=this.decoder.GetAttributeMetadata(t,e);return this._getDracoMetadata(i)}_getDracoMetadata(t){if(!t||!t.ptr)return{};const e={},i=this.metadataQuerier.NumEntries(t);for(let r=0;r<i;r++){const s=this.metadataQuerier.GetEntryName(t,r);e[s]=this._getDracoMetadataField(t,s)}return e}_getDracoMetadataField(t,e){const i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(t,e,i);const r=WS(i);return{int:this.metadataQuerier.GetIntEntry(t,e),string:this.metadataQuerier.GetStringEntry(t,e),double:this.metadataQuerier.GetDoubleEntry(t,e),intArray:r}}finally{this.draco.destroy(i)}}_disableAttributeTransforms(t){const{quantizedAttributes:e=[],octahedronAttributes:i=[]}=t,r=[...e,...i];for(const s of r)this.decoder.SkipAttributeTransform(this.draco[s])}_getQuantizationTransform(t,e){const{quantizedAttributes:i=[]}=e,r=t.attribute_type();if(i.map(o=>this.decoder[o]).includes(r)){const o=new this.draco.AttributeQuantizationTransform;try{if(o.InitFromAttribute(t))return{quantization_bits:o.quantization_bits(),range:o.range(),min_values:new Float32Array([1,2,3]).map(a=>o.min_value(a))}}finally{this.draco.destroy(o)}}return null}_getOctahedronTransform(t,e){const{octahedronAttributes:i=[]}=e,r=t.attribute_type();if(i.map(o=>this.decoder[o]).includes(r)){const o=new this.draco.AttributeQuantizationTransform;try{if(o.InitFromAttribute(t))return{quantization_bits:o.quantization_bits()}}finally{this.draco.destroy(o)}}return null}}function HS(n,t){switch(t){case Float32Array:return n.DT_FLOAT32;case Int8Array:return n.DT_INT8;case Int16Array:return n.DT_INT16;case Int32Array:return n.DT_INT32;case Uint8Array:return n.DT_UINT8;case Uint16Array:return n.DT_UINT16;case Uint32Array:return n.DT_UINT32;default:return n.DT_INVALID}}function WS(n){const t=n.size(),e=new Int32Array(t);for(let i=0;i<t;i++)e[i]=n.GetValue(i);return e}function qS(n){const t=n.size(),e=new Int32Array(t);for(let i=0;i<t;i++)e[i]=n.GetValue(i);return e}const Go="1.4.1",YS=`https://www.gstatic.com/draco/versioned/decoders/${Go}/draco_decoder.js`,XS=`https://www.gstatic.com/draco/versioned/decoders/${Go}/draco_wasm_wrapper.js`,ZS=`https://www.gstatic.com/draco/versioned/decoders/${Go}/draco_decoder.wasm`;let bi;async function KS(n){const t=n.modules||{};return t.draco3d?bi=bi||t.draco3d.createDecoderModule({}).then(e=>({draco:e})):bi=bi||QS(n),await bi}async function QS(n){let t,e;switch(n.draco&&n.draco.decoderType){case"js":t=await os(YS,"draco",n);break;case"wasm":default:[t,e]=await Promise.all([await os(XS,"draco",n),await os(ZS,"draco",n)])}return t=t||globalThis.DracoDecoderModule,await JS(t,e)}function JS(n,t){const e={};return t&&(e.wasmBinary=t),new Promise(i=>{n(k(E({},e),{onModuleLoaded:r=>i({draco:r})}))})}const vf=k(E({},IS),{parse:tI});async function tI(n,t){const{draco:e}=await KS(t),i=new $S(e);try{return i.parseSync(n,t==null?void 0:t.draco)}finally{i.destroy()}}const Af=["SCALAR","VEC2","VEC3","VEC4"],eI=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],nI=new Map(eI),iI={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},rI={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},sI={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function wf(n){return Af[n-1]||Af[0]}function Sf(n){const t=nI.get(n.constructor);if(!t)throw new Error("Illegal typed array");return t}function If(n,t){const e=sI[n.componentType],i=iI[n.type],r=rI[n.componentType],s=n.count*i,o=n.count*i*r;return Ot(o>=0&&o<=t.byteLength),{ArrayType:e,length:s,byteLength:o}}const oI={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class Se{constructor(t){A(this,"gltf",void 0),A(this,"sourceBuffers",void 0),A(this,"byteLength",void 0),this.gltf=t||{json:E({},oI),buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(t){return this.json[t]}getExtraData(t){return(this.json.extras||{})[t]}getExtension(t){const e=this.getUsedExtensions().find(r=>r===t),i=this.json.extensions||{};return e?i[t]||!0:null}getRequiredExtension(t){return this.getRequiredExtensions().find(i=>i===t)?this.getExtension(t):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getObjectExtension(t,e){return(t.extensions||{})[e]}getScene(t){return this.getObject("scenes",t)}getNode(t){return this.getObject("nodes",t)}getSkin(t){return this.getObject("skins",t)}getMesh(t){return this.getObject("meshes",t)}getMaterial(t){return this.getObject("materials",t)}getAccessor(t){return this.getObject("accessors",t)}getTexture(t){return this.getObject("textures",t)}getSampler(t){return this.getObject("samplers",t)}getImage(t){return this.getObject("images",t)}getBufferView(t){return this.getObject("bufferViews",t)}getBuffer(t){return this.getObject("buffers",t)}getObject(t,e){if(typeof e=="object")return e;const i=this.json[t]&&this.json[t][e];if(!i)throw new Error(`glTF file error: Could not find ${t}[${e}]`);return i}getTypedArrayForBufferView(t){t=this.getBufferView(t);const e=t.buffer,i=this.gltf.buffers[e];Ot(i);const r=(t.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,r,t.byteLength)}getTypedArrayForAccessor(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer).data,{ArrayType:s,length:o}=If(t,e),a=e.byteOffset+t.byteOffset;return new s(r,a,o)}getTypedArrayForImageData(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),r=this.getBuffer(e.buffer).data,s=e.byteOffset||0;return new Uint8Array(r,s,e.byteLength)}addApplicationData(t,e){return this.json[t]=e,this}addExtraData(t,e){return this.json.extras=this.json.extras||{},this.json.extras[t]=e,this}addObjectExtension(t,e,i){return t.extensions=t.extensions||{},t.extensions[e]=i,this.registerUsedExtension(e),this}setObjectExtension(t,e,i){const r=t.extensions||{};r[e]=i}removeObjectExtension(t,e){const i=t.extensions||{},r=i[e];return delete i[e],r}addExtension(t,e={}){return Ot(e),this.json.extensions=this.json.extensions||{},this.json.extensions[t]=e,this.registerUsedExtension(t),e}addRequiredExtension(t,e={}){return Ot(e),this.addExtension(t,e),this.registerRequiredExtension(t),e}registerUsedExtension(t){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(e=>e===t)||this.json.extensionsUsed.push(t)}registerRequiredExtension(t){this.registerUsedExtension(t),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(e=>e===t)||this.json.extensionsRequired.push(t)}removeExtension(t){this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,t),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,t),this.json.extensions&&delete this.json.extensions[t]}setDefaultScene(t){this.json.scene=t}addScene(t){const{nodeIndices:e}=t;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:e}),this.json.scenes.length-1}addNode(t){const{meshIndex:e,matrix:i}=t;this.json.nodes=this.json.nodes||[];const r={mesh:e};return i&&(r.matrix=i),this.json.nodes.push(r),this.json.nodes.length-1}addMesh(t){const{attributes:e,indices:i,material:r,mode:s=4}=t,a={primitives:[{attributes:this._addAttributes(e),mode:s}]};if(i){const c=this._addIndices(i);a.primitives[0].indices=c}return Number.isFinite(r)&&(a.primitives[0].material=r),this.json.meshes=this.json.meshes||[],this.json.meshes.push(a),this.json.meshes.length-1}addPointCloud(t){const i={primitives:[{attributes:this._addAttributes(t),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(i),this.json.meshes.length-1}addImage(t,e){const i=Ts(t),r=e||(i==null?void 0:i.mimeType),o={bufferView:this.addBufferView(t),mimeType:r};return this.json.images=this.json.images||[],this.json.images.push(o),this.json.images.length-1}addBufferView(t){const e=t.byteLength;Ot(Number.isFinite(e)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(t);const i={buffer:0,byteOffset:this.byteLength,byteLength:e};return this.byteLength+=xn(e,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(t,e){const i={bufferView:t,type:wf(e.size),componentType:e.componentType,count:e.count,max:e.max,min:e.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}addBinaryBuffer(t,e={size:3}){const i=this.addBufferView(t);let r={min:e.min,max:e.max};(!r.min||!r.max)&&(r=this._getAccessorMinMax(t,e.size));const s={size:e.size,componentType:Sf(t),count:Math.round(t.length/e.size),min:r.min,max:r.max};return this.addAccessor(i,Object.assign(s,e))}addTexture(t){const{imageIndex:e}=t,i={source:e};return this.json.textures=this.json.textures||[],this.json.textures.push(i),this.json.textures.length-1}addMaterial(t){return this.json.materials=this.json.materials||[],this.json.materials.push(t),this.json.materials.length-1}createBinaryChunk(){var t,e;this.gltf.buffers=[];const i=this.byteLength,r=new ArrayBuffer(i),s=new Uint8Array(r);let o=0;for(const a of this.sourceBuffers||[])o=Ig(a,s,o);(t=this.json)!==null&&t!==void 0&&(e=t.buffers)!==null&&e!==void 0&&e[0]?this.json.buffers[0].byteLength=i:this.json.buffers=[{byteLength:i}],this.gltf.binary=r,this.sourceBuffers=[r]}_removeStringFromArray(t,e){let i=!0;for(;i;){const r=t.indexOf(e);r>-1?t.splice(r,1):i=!1}}_addAttributes(t={}){const e={};for(const i in t){const r=t[i],s=this._getGltfAttributeName(i),o=this.addBinaryBuffer(r.value,r);e[s]=o}return e}_addIndices(t){return this.addBinaryBuffer(t,{size:1})}_getGltfAttributeName(t){switch(t.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return t}}_getAccessorMinMax(t,e){const i={min:null,max:null};if(t.length<e)return i;i.min=[],i.max=[];const r=t.subarray(0,e);for(const s of r)i.min.push(s),i.max.push(s);for(let s=e;s<t.length;s+=e)for(let o=0;o<e;o++)i.min[0+o]=Math.min(i.min[0+o],t[s+o]),i.max[0+o]=Math.max(i.max[0+o],t[s+o]);return i}}function aI(n){const t={};for(const e in n){const i=n[e];if(e!=="indices"){const r=Pf(i);t[e]=r}}return t}function Pf(n){const{buffer:t,size:e,count:i}=cI(n);return{value:t,size:e,byteOffset:0,count:i,type:wf(e),componentType:Sf(t)}}function cI(n){let t=n,e=1,i=0;return n&&n.value&&(t=n.value,e=n.size||1),t&&(ArrayBuffer.isView(t)||(t=lI(t,Float32Array)),i=t.length/e),{buffer:t,size:e,count:i}}function lI(n,t,e=!1){return n?Array.isArray(n)?new t(n):e&&!(n instanceof t)?new t(n):n:null}async function uI(n,t,e){var i;if(!(t!=null&&(i=t.gltf)!==null&&i!==void 0&&i.decompressMeshes))return;const r=new Se(n),s=[];for(const o of pI(r))r.getObjectExtension(o,_i)&&s.push(fI(r,o,t,e));await Promise.all(s),r.removeExtension(_i)}function hI(n,t={}){const e=new Se(n);for(const i of e.json.meshes||[])dI(i),e.addRequiredExtension(_i)}async function fI(n,t,e,i){const r=n.getObjectExtension(t,_i);if(!r)return;const s=n.getTypedArrayForBufferView(r.bufferView),o=as(s.buffer,s.byteOffset),{parse:a}=i,c=E({},e);delete c["3d-tiles"];const l=await a(o,vf,c,i),u=aI(l.attributes);for(const[h,f]of Object.entries(u))if(h in t.attributes){const g=t.attributes[h],m=n.getAccessor(g);m!=null&&m.min&&m!==null&&m!==void 0&&m.max&&(f.min=m.min,f.max=m.max)}t.attributes=u,l.indices&&(t.indices=Pf(l.indices)),gI(t)}function dI(n,t,e=4,i,r){var s;if(!i.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const o=i.DracoWriter.encodeSync({attributes:n}),a=r==null||(s=r.parseSync)===null||s===void 0?void 0:s.call(r,{attributes:n}),c=i._addFauxAttributes(a.attributes),l=i.addBufferView(o);return{primitives:[{attributes:c,mode:e,extensions:{[_i]:{bufferView:l,attributes:c}}}]}}function gI(n){if(!n.attributes&&Object.keys(n.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*pI(n){for(const t of n.json.meshes||[])for(const e of t.primitives)yield e}var mI=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",decode:uI,encode:hI});async function _I(n){const t=new Se(n),{json:e}=t;t.removeExtension(Pr);for(const i of e.materials||[])i.extensions&&i.extensions.KHR_materials_unlit&&(i.unlit=!0),t.removeObjectExtension(i,Pr)}function bI(n){const t=new Se(n),{json:e}=t;if(t.materials)for(const i of e.materials||[])i.unlit&&(delete i.unlit,t.addObjectExtension(i,Pr,{}),t.addExtension(Pr))}var yI=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",decode:_I,encode:bI});async function TI(n){const t=new Se(n),{json:e}=t,i=t.getExtension(gn);i&&(t.json.lights=i.lights,t.removeExtension(gn));for(const r of e.nodes||[]){const s=t.getObjectExtension(r,gn);s&&(r.light=s.light),t.removeObjectExtension(r,gn)}}async function EI(n){const t=new Se(n),{json:e}=t;if(e.lights){const i=t.addExtension(gn);Ot(!i.lights),i.lights=e.lights,delete e.lights}if(t.json.lights){for(const i of t.json.lights){const r=i.node;t.addObjectExtension(r,gn,i)}delete t.json.lights}}var vI=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",decode:TI,encode:EI});async function AI(n){const t=new Se(n),{json:e}=t,i=t.getExtension(xr);if(i){const r=SI(i,t);for(const s of e.materials||[]){const o=t.getObjectExtension(s,xr);o&&(s.technique=Object.assign({},o,r[o.technique]),s.technique.values=II(s.technique,t)),t.removeObjectExtension(s,xr)}t.removeExtension(xr)}}async function wI(n,t){}function SI(n,t){const{programs:e=[],shaders:i=[],techniques:r=[]}=n,s=new TextDecoder;return i.forEach(o=>{if(Number.isFinite(o.bufferView))o.code=s.decode(t.getTypedArrayForBufferView(o.bufferView));else throw new Error("KHR_techniques_webgl: no shader code")}),e.forEach(o=>{o.fragmentShader=i[o.fragmentShader],o.vertexShader=i[o.vertexShader]}),r.forEach(o=>{o.program=e[o.program]}),r}function II(n,t){const e=Object.assign({},n.values);return Object.keys(n.uniforms||{}).forEach(i=>{n.uniforms[i].value&&!(i in e)&&(e[i]=n.uniforms[i].value)}),Object.keys(e).forEach(i=>{typeof e[i]=="object"&&e[i].index!==void 0&&(e[i].texture=t.getTexture(e[i].index))}),e}var PI=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",decode:AI,encode:wI});const xf={KHR_draco_mesh_compression:mI,KHR_materials_unlit:yI,KHR_lights_punctual:vI,KHR_techniques_webgl:PI};async function xI(n,t={},e){for(const r in xf){var i;const s=(t==null||(i=t.gltf)===null||i===void 0?void 0:i.excludeExtensions)||{};r in s&&!s[r]||await xf[r].decode(n,t,e)}}function LI(n){const t=new Se(n),{json:e}=t;for(const i of e.images||[]){const r=t.removeObjectExtension(i,hf);r&&Object.assign(i,r)}e.buffers&&e.buffers[0]&&delete e.buffers[0].uri,t.removeExtension(hf)}const Lf={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},MI={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class RI{constructor(t){this.idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}}normalize(t,e){this.json=t.json;const i=t.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:console.warn(`glTF: Unknown version ${i.asset.version}`);return}if(!e.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(i),this._convertTopLevelObjectsToArrays(i),LI(t),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}_addAsset(t){t.asset=t.asset||{},t.asset.version="2.0",t.asset.generator=t.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(t){for(const e in Lf)this._convertTopLevelObjectToArray(t,e)}_convertTopLevelObjectToArray(t,e){const i=t[e];if(!(!i||Array.isArray(i))){t[e]=[];for(const r in i){const s=i[r];s.id=s.id||r;const o=t[e].length;t[e].push(s),this.idToIndexMap[e][r]=o}}}_convertObjectIdsToArrayIndices(t){for(const e in Lf)this._convertIdsToIndices(t,e);"scene"in t&&(t.scene=this._convertIdToIndex(t.scene,"scene"));for(const e of t.textures)this._convertTextureIds(e);for(const e of t.meshes)this._convertMeshIds(e);for(const e of t.nodes)this._convertNodeIds(e);for(const e of t.scenes)this._convertSceneIds(e)}_convertTextureIds(t){t.source&&(t.source=this._convertIdToIndex(t.source,"image"))}_convertMeshIds(t){for(const e of t.primitives){const{attributes:i,indices:r,material:s}=e;for(const o in i)i[o]=this._convertIdToIndex(i[o],"accessor");r&&(e.indices=this._convertIdToIndex(r,"accessor")),s&&(e.material=this._convertIdToIndex(s,"material"))}}_convertNodeIds(t){t.children&&(t.children=t.children.map(e=>this._convertIdToIndex(e,"node"))),t.meshes&&(t.meshes=t.meshes.map(e=>this._convertIdToIndex(e,"mesh")))}_convertSceneIds(t){t.nodes&&(t.nodes=t.nodes.map(e=>this._convertIdToIndex(e,"node")))}_convertIdsToIndices(t,e){t[e]||(console.warn(`gltf v1: json doesn't contain attribute ${e}`),t[e]=[]);for(const i of t[e])for(const r in i){const s=i[r],o=this._convertIdToIndex(s,r);i[r]=o}}_convertIdToIndex(t,e){const i=MI[e];if(i in this.idToIndexMap){const r=this.idToIndexMap[i][t];if(!Number.isFinite(r))throw new Error(`gltf v1: failed to resolve ${e} with id ${t}`);return r}return t}_updateObjects(t){for(const e of this.json.buffers)delete e.type}_updateMaterial(t){for(const e of t.materials){e.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const i=e.values&&e.values.tex,r=t.textures.findIndex(s=>s.id===i);r!==-1&&(e.pbrMetallicRoughness.baseColorTexture={index:r})}}}function OI(n,t={}){return new RI().normalize(n,t)}const CI={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},NI={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Vt={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},DI={magFilter:Vt.TEXTURE_MAG_FILTER,minFilter:Vt.TEXTURE_MIN_FILTER,wrapS:Vt.TEXTURE_WRAP_S,wrapT:Vt.TEXTURE_WRAP_T},FI={[Vt.TEXTURE_MAG_FILTER]:Vt.LINEAR,[Vt.TEXTURE_MIN_FILTER]:Vt.NEAREST_MIPMAP_LINEAR,[Vt.TEXTURE_WRAP_S]:Vt.REPEAT,[Vt.TEXTURE_WRAP_]:Vt.REPEAT};function UI(n){return NI[n]}function BI(n){return CI[n]}class kI{postProcess(t,e={}){const{json:i,buffers:r=[],images:s=[],baseUri:o=""}=t;return Ot(i),this.baseUri=o,this.json=i,this.buffers=r,this.images=s,this._resolveTree(this.json,e),this.json}_resolveTree(t,e={}){t.bufferViews&&(t.bufferViews=t.bufferViews.map((i,r)=>this._resolveBufferView(i,r))),t.images&&(t.images=t.images.map((i,r)=>this._resolveImage(i,r))),t.samplers&&(t.samplers=t.samplers.map((i,r)=>this._resolveSampler(i,r))),t.textures&&(t.textures=t.textures.map((i,r)=>this._resolveTexture(i,r))),t.accessors&&(t.accessors=t.accessors.map((i,r)=>this._resolveAccessor(i,r))),t.materials&&(t.materials=t.materials.map((i,r)=>this._resolveMaterial(i,r))),t.meshes&&(t.meshes=t.meshes.map((i,r)=>this._resolveMesh(i,r))),t.nodes&&(t.nodes=t.nodes.map((i,r)=>this._resolveNode(i,r))),t.skins&&(t.skins=t.skins.map((i,r)=>this._resolveSkin(i,r))),t.scenes&&(t.scenes=t.scenes.map((i,r)=>this._resolveScene(i,r))),t.scene!==void 0&&(t.scene=t.scenes[this.json.scene])}getScene(t){return this._get("scenes",t)}getNode(t){return this._get("nodes",t)}getSkin(t){return this._get("skins",t)}getMesh(t){return this._get("meshes",t)}getMaterial(t){return this._get("materials",t)}getAccessor(t){return this._get("accessors",t)}getCamera(t){return null}getTexture(t){return this._get("textures",t)}getSampler(t){return this._get("samplers",t)}getImage(t){return this._get("images",t)}getBufferView(t){return this._get("bufferViews",t)}getBuffer(t){return this._get("buffers",t)}_get(t,e){if(typeof e=="object")return e;const i=this.json[t]&&this.json[t][e];return i||console.warn(`glTF file error: Could not find ${t}[${e}]`),i}_resolveScene(t,e){return t.id=t.id||`scene-${e}`,t.nodes=(t.nodes||[]).map(i=>this.getNode(i)),t}_resolveNode(t,e){return t.id=t.id||`node-${e}`,t.children&&(t.children=t.children.map(i=>this.getNode(i))),t.mesh!==void 0?t.mesh=this.getMesh(t.mesh):t.meshes!==void 0&&t.meshes.length&&(t.mesh=t.meshes.reduce((i,r)=>{const s=this.getMesh(r);return i.id=s.id,i.primitives=i.primitives.concat(s.primitives),i},{primitives:[]})),t.camera!==void 0&&(t.camera=this.getCamera(t.camera)),t.skin!==void 0&&(t.skin=this.getSkin(t.skin)),t}_resolveSkin(t,e){return t.id=t.id||`skin-${e}`,t.inverseBindMatrices=this.getAccessor(t.inverseBindMatrices),t}_resolveMesh(t,e){return t.id=t.id||`mesh-${e}`,t.primitives&&(t.primitives=t.primitives.map(i=>{i=E({},i);const r=i.attributes;i.attributes={};for(const s in r)i.attributes[s]=this.getAccessor(r[s]);return i.indices!==void 0&&(i.indices=this.getAccessor(i.indices)),i.material!==void 0&&(i.material=this.getMaterial(i.material)),i})),t}_resolveMaterial(t,e){if(t.id=t.id||`material-${e}`,t.normalTexture&&(t.normalTexture=E({},t.normalTexture),t.normalTexture.texture=this.getTexture(t.normalTexture.index)),t.occlusionTexture&&(t.occlustionTexture=E({},t.occlustionTexture),t.occlusionTexture.texture=this.getTexture(t.occlusionTexture.index)),t.emissiveTexture&&(t.emmisiveTexture=E({},t.emmisiveTexture),t.emissiveTexture.texture=this.getTexture(t.emissiveTexture.index)),t.emissiveFactor||(t.emissiveFactor=t.emmisiveTexture?[1,1,1]:[0,0,0]),t.pbrMetallicRoughness){t.pbrMetallicRoughness=E({},t.pbrMetallicRoughness);const i=t.pbrMetallicRoughness;i.baseColorTexture&&(i.baseColorTexture=E({},i.baseColorTexture),i.baseColorTexture.texture=this.getTexture(i.baseColorTexture.index)),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture=E({},i.metallicRoughnessTexture),i.metallicRoughnessTexture.texture=this.getTexture(i.metallicRoughnessTexture.index))}return t}_resolveAccessor(t,e){if(t.id=t.id||`accessor-${e}`,t.bufferView!==void 0&&(t.bufferView=this.getBufferView(t.bufferView)),t.bytesPerComponent=UI(t.componentType),t.components=BI(t.type),t.bytesPerElement=t.bytesPerComponent*t.components,t.bufferView){const i=t.bufferView.buffer,{ArrayType:r,byteLength:s}=If(t,t.bufferView),o=(t.bufferView.byteOffset||0)+(t.byteOffset||0)+i.byteOffset,a=i.arrayBuffer.slice(o,o+s);t.value=new r(a)}return t}_resolveTexture(t,e){return t.id=t.id||`texture-${e}`,t.sampler="sampler"in t?this.getSampler(t.sampler):FI,t.source=this.getImage(t.source),t}_resolveSampler(t,e){t.id=t.id||`sampler-${e}`,t.parameters={};for(const i in t){const r=this._enumSamplerParameter(i);r!==void 0&&(t.parameters[r]=t[i])}return t}_enumSamplerParameter(t){return DI[t]}_resolveImage(t,e){t.id=t.id||`image-${e}`,t.bufferView!==void 0&&(t.bufferView=this.getBufferView(t.bufferView));const i=this.images[e];return i&&(t.image=i),t}_resolveBufferView(t,e){t.id=t.id||`bufferView-${e}`;const i=t.buffer;t.buffer=this.buffers[i];const r=this.buffers[i].arrayBuffer;let s=this.buffers[i].byteOffset||0;return"byteOffset"in t&&(s+=t.byteOffset),t.data=new Uint8Array(r,s,t.byteLength),t}_resolveCamera(t,e){return t.id=t.id||`camera-${e}`,t.perspective,t.orthographic,t}}function VI(n,t){return new kI().postProcess(n,t)}const Mf=1735152710,$o=12,Mr=8,zI=1313821514,jI=5130562,GI=0,$I=1,HI=0,_n=!0;function WI(n,t=0){return`${String.fromCharCode(n.getUint8(t+0))}${String.fromCharCode(n.getUint8(t+1))}${String.fromCharCode(n.getUint8(t+2))}${String.fromCharCode(n.getUint8(t+3))}`}function qI(n,t=0,e={}){const i=new DataView(n),{magic:r=Mf}=e,s=i.getUint32(t,!1);return s===r||s===Mf}function YI(n,t,e=0,i={}){const r=new DataView(t),s=WI(r,e+0),o=r.getUint32(e+4,_n),a=r.getUint32(e+8,_n);switch(Object.assign(n,{header:{byteOffset:e,byteLength:a,hasBinChunk:!1},type:s,version:o,json:{},binChunks:[]}),e+=$o,n.version){case 1:return XI(n,r,e);case 2:return ZI(n,r,e,i={});default:throw new Error(`Invalid GLB version ${n.version}. Only supports v1 and v2.`)}}function XI(n,t,e){Z(n.header.byteLength>$o+Mr);const i=t.getUint32(e+0,_n),r=t.getUint32(e+4,_n);return e+=Mr,Z(r===HI),Ho(n,t,e,i),e+=i,e+=Wo(n,t,e,n.header.byteLength),e}function ZI(n,t,e,i){return Z(n.header.byteLength>$o+Mr),KI(n,t,e,i),e+n.header.byteLength}function KI(n,t,e,i){for(;e+8<=n.header.byteLength;){const r=t.getUint32(e+0,_n),s=t.getUint32(e+4,_n);switch(e+=Mr,s){case zI:Ho(n,t,e,r);break;case jI:Wo(n,t,e,r);break;case GI:i.strict||Ho(n,t,e,r);break;case $I:i.strict||Wo(n,t,e,r);break}e+=xn(r,4)}return e}function Ho(n,t,e,i){const r=new Uint8Array(t.buffer,e,i),o=new TextDecoder("utf8").decode(r);return n.json=JSON.parse(o),xn(i,4)}function Wo(n,t,e,i){return n.header.hasBinChunk=!0,n.binChunks.push({byteOffset:e,byteLength:i,arrayBuffer:t.buffer}),xn(i,4)}async function QI(n,t,e=0,i,r){var s,o,a,c;JI(n,t,e,i),OI(n,{normalize:i==null||(s=i.gltf)===null||s===void 0?void 0:s.normalize});const l=[];if(i!=null&&(o=i.gltf)!==null&&o!==void 0&&o.loadBuffers&&n.json.buffers&&await tP(n,i,r),i!=null&&(a=i.gltf)!==null&&a!==void 0&&a.loadImages){const h=eP(n,i,r);l.push(h)}const u=xI(n,i,r);return l.push(u),await Promise.all(l),i!=null&&(c=i.gltf)!==null&&c!==void 0&&c.postProcess?VI(n,i):n}function JI(n,t,e,i){if(i.uri&&(n.baseUri=i.uri),t instanceof ArrayBuffer&&!qI(t,e,i)&&(t=new TextDecoder().decode(t)),typeof t=="string")n.json=Eg(t);else if(t instanceof ArrayBuffer){const o={};e=YI(o,t,e,i.glb),Ot(o.type==="glTF",`Invalid GLB magic string ${o.type}`),n._glb=o,n.json=o.json}else Ot(!1,"GLTF: must be ArrayBuffer or string");const r=n.json.buffers||[];if(n.buffers=new Array(r.length).fill(null),n._glb&&n._glb.header.hasBinChunk){const{binChunks:o}=n._glb;n.buffers[0]={arrayBuffer:o[0].arrayBuffer,byteOffset:o[0].byteOffset,byteLength:o[0].byteLength}}const s=n.json.images||[];n.images=new Array(s.length).fill({})}async function tP(n,t,e){for(let s=0;s<n.json.buffers.length;++s){const o=n.json.buffers[s];if(o.uri){var i,r;const{fetch:a}=e;Ot(a);const c=ff(o.uri,t),l=await(e==null||(i=e.fetch)===null||i===void 0?void 0:i.call(e,c)),u=await(l==null||(r=l.arrayBuffer)===null||r===void 0?void 0:r.call(l));n.buffers[s]={arrayBuffer:u,byteOffset:0,byteLength:u.byteLength},delete o.uri}}}async function eP(n,t,e){const i=n.json.images||[],r=[];for(let s=0;s<i.length;++s)r.push(nP(n,i[s],s,t,e));return await Promise.all(r)}async function nP(n,t,e,i,r){const{fetch:s,parse:o}=r;let a;if(t.uri){const l=ff(t.uri,i);a=await(await s(l)).arrayBuffer()}if(Number.isFinite(t.bufferView)){const l=AS(n.json,n.buffers,t.bufferView);a=as(l.buffer,l.byteOffset,l.byteLength)}Ot(a,"glTF image has no data");const c=await o(a,Sc,{},r);n.images[e]=c}const Rr={name:"glTF",id:"gltf",module:"gltf",version:vS,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:iP,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};async function iP(n,t={},e){t=E(E({},Rr.options),t),t.gltf=E(E({},Rr.options.gltf),t.gltf);const{byteOffset:i=0}=t;return await QI({},n,i,t,e)}async function rP(n){const t=[];return n.scenes.forEach(e=>{e.traverse(i=>{Object.values(i.model.getUniforms()).forEach(r=>{r.loaded===!1&&t.push(r)})})}),await sP(()=>t.some(e=>!e.loaded))}async function sP(n){for(;n();)await new Promise(t=>requestAnimationFrame(t))}var oP=`#version 300 es
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in mat3 instanceModelMatrix;
in vec3 instanceTranslation;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform mat4 sceneModelMatrix;
uniform bool composeModelMatrix;
in vec4 POSITION;

#ifdef HAS_UV
  in vec2 TEXCOORD_0;
#endif

#ifdef MODULE_PBR
  #ifdef HAS_NORMALS
    in vec4 NORMAL;
  #endif
#endif
out vec4 vColor;
#ifndef MODULE_PBR
  #ifdef HAS_UV
    out vec2 vTEXCOORD_0;
  #endif
#endif
void main(void) {
  #if defined(HAS_UV) && !defined(MODULE_PBR)
    vTEXCOORD_0 = TEXCOORD_0;
    geometry.uv = vTEXCOORD_0;
  #endif

  geometry.worldPosition = instancePositions;
  geometry.pickingColor = instancePickingColors;

  #ifdef MODULE_PBR
    #ifdef HAS_NORMALS
      pbr_vNormal = project_normal(instanceModelMatrix * (sceneModelMatrix * vec4(NORMAL.xyz, 0.0)).xyz);
      geometry.normal = pbr_vNormal;
    #endif

    #ifdef HAS_UV
      pbr_vUV = TEXCOORD_0;
    #else
      pbr_vUV = vec2(0., 0.);
    #endif
    geometry.uv = pbr_vUV;
  #endif

  float originalSize = project_size_to_pixel(sizeScale);
  float clampedSize = clamp(originalSize, sizeMinPixels, sizeMaxPixels);

  vec3 pos = (instanceModelMatrix * (sceneModelMatrix * POSITION).xyz) * sizeScale * (clampedSize / originalSize) + instanceTranslation;
  if(composeModelMatrix) {
    DECKGL_FILTER_SIZE(pos, geometry);
    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
  }
  else {
    pos = project_size(pos);
    DECKGL_FILTER_SIZE(pos, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  #ifdef MODULE_PBR
    pbr_vPosition = geometry.position.xyz;
  #endif

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,aP=`#version 300 es
uniform float opacity;
in vec4 vColor;

out vec4 fragmentColor;
#ifndef MODULE_PBR
  #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)
    in vec2 vTEXCOORD_0;
    uniform sampler2D u_BaseColorSampler;
  #endif
#endif

void main(void) {
  #ifdef MODULE_PBR
    fragmentColor = vColor * pbr_filterColor(vec4(0));
    geometry.uv = pbr_vUV;
  #else
    #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)
      fragmentColor = vColor * texture2D(u_BaseColorSampler, vTEXCOORD_0);
      geometry.uv = vTEXCOORD_0;
    #else
      fragmentColor = vColor;
    #endif
  #endif

  fragmentColor.a *= opacity;
  DECKGL_FILTER_COLOR(fragmentColor, geometry);
}
`;const Rf=[255,255,255,255],cP={scenegraph:{type:"object",value:null,async:!0},getScene:n=>n&&n.scenes?typeof n.scene=="object"?n.scene:n.scenes[n.scene||0]:n,getAnimator:n=>n&&n.animator,_animations:null,sizeScale:{type:"number",value:1,min:0},sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:n=>n.position},getColor:{type:"accessor",value:Rf},_lighting:"flat",_imageBasedLightingEnvironment:null,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},loaders:[Rr]};class qo extends fn{getShaders(){const t=[oo,po];return this.props._lighting==="pbr"&&t.push(io),{vs:oP,fs:aP,modules:t}}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:5121,size:this.props.colorFormat.length,accessor:"getColor",normalized:!0,defaultValue:Rf,transition:!0},instanceModelMatrix:sf})}updateState(t){super.updateState(t);const{props:e,oldProps:i}=t;e.scenegraph!==i.scenegraph?this._updateScenegraph(e):e._animations!==i._animations&&this._applyAnimationsProp(this.state.scenegraph,this.state.animator,e._animations)}finalizeState(){super.finalizeState(),this._deleteScenegraph()}_updateScenegraph(t){const{gl:e}=this.context;let i=null;if(t.scenegraph instanceof dn)i={scenes:[t.scenegraph]};else if(t.scenegraph&&!t.scenegraph.gltf){const a=t.scenegraph,c=ES(e,a,this._getModelOptions());i=E({gltf:a},c),rP(c).then(()=>this.setNeedsRedraw())}else t.scenegraph&&(W.deprecated("ScenegraphLayer.props.scenegraph","Use GLTFLoader instead of GLTFScenegraphLoader")(),i=t.scenegraph);const r={layer:this,gl:e},s=t.getScene(i,r),o=t.getAnimator(i,r);s instanceof dn?(this._deleteScenegraph(),this._applyAllAttributes(s),this._applyAnimationsProp(s,o,t._animations),this.setState({scenegraph:s,animator:o})):s!==null&&W.warn("invalid scenegraph:",s)()}_applyAllAttributes(t){if(this.state.attributesAvailable){const e=this.getAttributeManager().getAttributes();t.traverse(i=>{this._setModelAttributes(i.model,e)})}}_applyAnimationsProp(t,e,i){if(!t||!e||!i)return;const r=e.getAnimations();Object.keys(i).sort().forEach(s=>{const o=i[s];if(s==="*")r.forEach(a=>{Object.assign(a,o)});else if(Number.isFinite(Number(s))){const a=Number(s);a>=0&&a<r.length?Object.assign(r[a],o):W.warn("animation ".concat(s," not found"))()}else{const a=r.find(({name:c})=>c===s);a?Object.assign(a,o):W.warn("animation ".concat(s," not found"))()}})}_deleteScenegraph(){const{scenegraph:t}=this.state;t instanceof dn&&t.delete()}_getModelOptions(){const{_imageBasedLightingEnvironment:t}=this.props;let e=null;return t&&(typeof t=="function"?e=t({gl:this.context.gl,layer:this}):e=t),{gl:this.context.gl,waitForFullLoad:!0,imageBasedLightingEnvironment:e,modelOptions:E({isInstanced:!0,transpileToGLSL100:!j(this.context.gl)},this.getShaders()),useTangents:!1}}updateAttributes(t){this.setState({attributesAvailable:!0}),!!this.state.scenegraph&&this.state.scenegraph.traverse(e=>{this._setModelAttributes(e.model,t)})}draw({moduleParameters:t=null,parameters:e={},context:i}){if(!this.state.scenegraph)return;this.props._animations&&this.state.animator&&(this.state.animator.animate(i.timeline.getTime()),this.setNeedsRedraw());const{viewport:r}=this.context,{sizeScale:s,sizeMinPixels:o,sizeMaxPixels:a,opacity:c,coordinateSystem:l}=this.props,u=this.getNumInstances();this.state.scenegraph.traverse((h,{worldMatrix:f})=>{h.model.setInstanceCount(u),h.updateModuleSettings(t),h.draw({parameters:e,uniforms:{sizeScale:s,opacity:c,sizeMinPixels:o,sizeMaxPixels:a,composeModelMatrix:of(r,l),sceneModelMatrix:f,u_Camera:h.model.getUniforms().project_uCameraPosition}})})}}qo.layerName="ScenegraphLayer";qo.defaultProps=cP;var lP=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
uniform float sizeScale;
uniform bool composeModelMatrix;
uniform bool u_pickFeatureIds;
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec4 uvRegions;
in vec3 featureIdsPickingColors;
in vec4 instanceColors;
in vec3 instancePickingColors;
in mat3 instanceModelMatrix;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;

void main(void) {
  vec2 uv = fract(texCoords) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;

  geometry.uv = uv;
  geometry.uv = texCoords;

  if (u_pickFeatureIds) {
    geometry.pickingColor = featureIdsPickingColors;
  } else {
    geometry.pickingColor = instancePickingColors;
  }

  #ifdef MODULE_PBR
    #ifdef HAS_NORMALS
      pbr_vNormal = project_normal(instanceModelMatrix * normals);
      geometry.normal = pbr_vNormal;
    #endif

    #ifdef HAS_UV
      pbr_vUV = uv;
    #else
      pbr_vUV = vec2(0., 0.);
    #endif
    geometry.uv = pbr_vUV;
  #endif

  vTexCoord = uv;
  cameraPosition = project_uCameraPosition;
  normals_commonspace = project_normal(instanceModelMatrix * normals);
  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
  geometry.normal = normals_commonspace;

  vec3 pos = (instanceModelMatrix * positions) * sizeScale;
  vec3 projectedPosition = project_position(positions);
  position_commonspace = vec4(projectedPosition, 1.0);
  gl_Position = project_common_position_to_clipspace(position_commonspace);

  geometry.position = position_commonspace;

  #ifdef MODULE_PBR
    pbr_vPosition = geometry.position.xyz;
  #endif

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,uP=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs

precision highp float;

uniform bool hasTexture;
uniform sampler2D sampler;
uniform bool flatShading;
uniform float opacity;

in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;

out vec4 fragColor;

void main(void) {
  
#ifdef MODULE_PBR

  fragColor = vColor * pbr_filterColor(vec4(0));
  geometry.uv = pbr_vUV;
  fragColor.a *= opacity;

#else

  geometry.uv = vTexCoord;

  vec3 normal;
  if (flatShading) {
#ifdef DERIVATIVES_AVAILABLE
    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
#else
    normal = vec3(0.0, 0.0, 1.0);
#endif
  } else {
    normal = normals_commonspace;
  }

  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;
  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
  fragColor = vec4(lightColor, color.a * opacity);

#endif

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;function hP(n){n.COLOR_0||n.colors||(n.colors={constant:!0,value:new Float32Array([1,1,1])}),n.uvRegions||(n.uvRegions={constant:!0,value:new Float32Array([0,0,1,1])})}const fP={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class Yo extends Vo{getShaders(){const t=super.getShaders();return t.modules.push(io),k(E({},t),{vs:lP,fs:uP})}initializeState(){const{featureIds:t}=this.props;super.initializeState(),t&&this.state.attributeManager.add({featureIdsPickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState({props:t,oldProps:e,changeFlags:i}){super.updateState({props:t,oldProps:e,changeFlags:i}),t.pbrMaterial!==e.pbrMaterial&&this.updatePbrMaterialUniforms(t.pbrMaterial)}draw(t){const{featureIds:e}=this.props;!this.state.model||(this.state.model.setUniforms({u_Camera:this.state.model.getUniforms().project_uCameraPosition,u_pickFeatureIds:Boolean(e)}),super.draw(t))}getModel(t){const{id:e,pbrMaterial:i}=this.props,r=this.parseMaterial(i,t),s=this.getShaders();return hP(t.attributes),new nn(this.context.gl,k(E({},this.getShaders()),{id:e,geometry:t,defines:E(E({},s.defines),r==null?void 0:r.defines),parameters:r==null?void 0:r.parameters,isInstanced:!0}))}updatePbrMaterialUniforms(t){const{model:e}=this.state;if(e){const{mesh:i}=this.props,r=this.parseMaterial(t,i);e.setUniforms(r.uniforms)}}parseMaterial(t,e){const i=Boolean(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture);return new lf(this.context.gl,{attributes:{NORMAL:e.attributes.normals,TEXCOORD_0:e.attributes.texCoords},material:E({unlit:i},t),pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(t){const{featureIds:e}=this.props,i=new Uint8ClampedArray(e.length*t.size),r=[];for(let s=0;s<e.length;s++)this.encodePickingColor(e[s],r),i[s*3]=r[0],i[s*3+1]=r[1],i[s*3+2]=r[2];t.value=i}}Yo.layerName="_MeshLayer";Yo.defaultProps=fP;var Of=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function dP(){var n=new Of(3);return Of!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function gP(n){var t=n[0],e=n[1],i=n[2];return Math.hypot(t,e,i)}function pP(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}(function(){var n=dP();return function(t,e,i,r,s,o){var a,c;for(e||(e=3),i||(i=0),r?c=Math.min(r*e+i,t.length):c=t.length,a=i;a<c;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();const mP=6378137,_P=6378137,bP=6356752314245179e-9,Or=n=>n,yP=new I;function TP(n,t,e=Or){return ge(n)?(t[0]=e(n[0]),t[1]=e(n[1]),t[2]=n[2]):"longitude"in n?(t[0]=e(n.longitude),t[1]=e(n.latitude),t[2]=n.height):(t[0]=e(n.x),t[1]=e(n.y),t[2]=n.z),t}function EP(n,t=yP){return TP(n,t,nt._cartographicRadians?Or:Zs)}function vP(n,t,e=Or){return ge(t)?(t[0]=e(n[0]),t[1]=e(n[1]),t[2]=n[2]):"longitude"in t?(t.longitude=e(n[0]),t.latitude=e(n[1]),t.height=n[2]):(t.x=e(n[0]),t.y=e(n[1]),t.z=n[2]),t}function AP(n,t){return vP(n,t,nt._cartographicRadians?Or:Ly)}const Cf=new I,wP=new I,SP=new I;function IP(n,t,e=new I){const{oneOverRadii:i,oneOverRadiiSquared:r,centerToleranceSquared:s}=t;Cf.from(n);const o=n.x,a=n.y,c=n.z,l=i.x,u=i.y,h=i.z,f=o*o*l*l,g=a*a*u*u,m=c*c*h*h,_=f+g+m,T=Math.sqrt(1/_);if(!Number.isFinite(T))return;const v=wP;if(v.copy(n).scale(T),_<s)return v.to(e);const S=r.x,y=r.y,P=r.z,L=SP;L.set(v.x*S*2,v.y*y*2,v.z*P*2);let x=(1-T)*n.len()/(.5*L.len()),N=0,U,C,B,V;do{x-=N,U=1/(1+x*S),C=1/(1+x*y),B=1/(1+x*P);const z=U*U,Y=C*C,R=B*B,Dt=z*U,ke=Y*C,Pe=R*B;V=f*z+g*Y+m*R-1;const Vr=f*Dt*S+g*ke*y+m*Pe*P,vi=-2*Vr;N=V/vi}while(Math.abs(V)>to.EPSILON12);return Cf.scale([U,C,B]).to(e)}const Nf=1e-14,PP=new I,Df={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},Xo={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},yi={east:new I,north:new I,up:new I,west:new I,south:new I,down:new I},xP=new I,LP=new I,MP=new I;function Ff(n,t,e,i,r,s){const o=Df[t]&&Df[t][e];rt(o&&(!i||i===o));let a,c,l;const u=PP.copy(r);if($t(u.x,0,Nf)&&$t(u.y,0,Nf)){const f=Math.sign(u.z);a=xP.fromArray(Xo[t]),t!=="east"&&t!=="west"&&a.scale(f),c=LP.fromArray(Xo[e]),e!=="east"&&e!=="west"&&c.scale(f),l=MP.fromArray(Xo[i]),i!=="east"&&i!=="west"&&l.scale(f)}else{const{up:f,east:g,north:m}=yi;g.set(-u.y,u.x,0).normalize(),n.geodeticSurfaceNormal(u,f),m.copy(f).cross(g);const{down:_,west:T,south:v}=yi;_.copy(f).scale(-1),T.copy(g).scale(-1),v.copy(m).scale(-1),a=yi[t],c=yi[e],l=yi[i]}return s[0]=a.x,s[1]=a.y,s[2]=a.z,s[3]=0,s[4]=c.x,s[5]=c.y,s[6]=c.z,s[7]=0,s[8]=l.x,s[9]=l.y,s[10]=l.z,s[11]=0,s[12]=u.x,s[13]=u.y,s[14]=u.z,s[15]=1,s}const Cr=new I,Uf=new I,RP=new I,Xt=new I,OP=new I,Nr=new I;let Zo;class Ct{static get WGS84(){return Zo=Zo||new Ct(mP,_P,bP),Zo}constructor(t=0,e=0,i=0){rt(t>=0),rt(e>=0),rt(i>=0),this.radii=new I(t,e,i),this.radiiSquared=new I(t*t,e*e,i*i),this.radiiToTheFourth=new I(t*t*t*t,e*e*e*e,i*i*i*i),this.oneOverRadii=new I(t===0?0:1/t,e===0?0:1/e,i===0?0:1/i),this.oneOverRadiiSquared=new I(t===0?0:1/(t*t),e===0?0:1/(e*e),i===0?0:1/(i*i)),this.minimumRadius=Math.min(t,e,i),this.maximumRadius=Math.max(t,e,i),this.centerToleranceSquared=to.EPSILON1,this.radiiSquared.z!==0&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||Boolean(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const i=Uf,r=RP,[,,s]=t;this.geodeticSurfaceNormalCartographic(t,i),r.copy(this.radiiSquared).scale(i);const o=Math.sqrt(i.dot(r));return r.scale(1/o),i.scale(s),r.add(i),r.to(e)}cartesianToCartographic(t,e=[0,0,0]){Nr.from(t);const i=this.scaleToGeodeticSurface(Nr,Xt);if(!i)return;const r=this.geodeticSurfaceNormal(i,Uf),s=OP;s.copy(Nr).subtract(i);const o=Math.atan2(r.y,r.x),a=Math.asin(r.z),c=Math.sign(pP(s,Nr))*gP(s);return AP([o,a,c],e)}eastNorthUpToFixedFrame(t,e=new $){return Ff(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,i,r,s=new $){return Ff(this,t,e,i,r,s)}geocentricSurfaceNormal(t,e=[0,0,0]){return Cr.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const i=EP(t),r=i[0],s=i[1],o=Math.cos(s);return Cr.set(o*Math.cos(r),o*Math.sin(r),Math.sin(s)).normalize(),Cr.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return Cr.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return IP(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){Xt.from(t);const i=Xt.x,r=Xt.y,s=Xt.z,o=this.oneOverRadiiSquared,a=1/Math.sqrt(i*i*o.x+r*r*o.y+s*s*o.z);return Xt.multiplyScalar(a).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return Xt.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return Xt.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,i=[0,0,0]){rt($t(this.radii.x,this.radii.y,to.EPSILON15)),rt(this.radii.z>0),Xt.from(t);const r=Xt.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(r)>=this.radii.z-e))return Xt.set(0,0,r).to(i)}}class CP{constructor(t,e,i){this.item=t,this.previous=e,this.next=i}}class NP{constructor(){this.head=null,this.tail=null,this._length=0}get length(){return this._length}add(t){const e=new CP(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){!t||(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const i=t.next;t.next=e,this.tail===t?this.tail=e:i.previous=e,e.next=i,e.previous=t,++this._length}}function Ko(n){return n!=null}class DP{constructor(){A(this,"_list",void 0),A(this,"_sentinel",void 0),A(this,"_trimTiles",void 0),this._list=new NP,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;Ko(e)&&this._list.splice(this._sentinel,e)}add(t,e,i){Ko(e._cacheNode)||(e._cacheNode=this._list.add(e),i&&i(t,e))}unloadTile(t,e,i){const r=e._cacheNode;!Ko(r)||(this._list.remove(r),e._cacheNode=void 0,i&&i(t,e))}unloadTiles(t,e){const i=this._trimTiles;this._trimTiles=!1;const r=this._list,s=t.maximumMemoryUsage*1024*1024,o=this._sentinel;let a=r.head;for(;a!==o&&(t.gpuMemoryUsageInBytes>s||i);){const c=a.item;a=a.next,this.unloadTile(t,c,e)}}trim(){this._trimTiles=!0}}function FP(n,t){Z(n),Z(t);const{rtcCenter:e,gltfUpAxis:i}=t,{computedTransform:r,boundingVolume:{center:s}}=n;let o=new $(r);switch(e&&o.translate(e),i){case"Z":break;case"Y":const h=new $().rotateX(Math.PI/2);o=o.multiplyRight(h);break;case"X":const f=new $().rotateY(-Math.PI/2);o=o.multiplyRight(f);break}t.isQuantized&&o.translate(t.quantizedVolumeOffset).scale(t.quantizedVolumeScale);const a=new I(s);t.cartesianModelMatrix=o,t.cartesianOrigin=a;const c=Ct.WGS84.cartesianToCartographic(a,new I),u=Ct.WGS84.eastNorthUpToFixedFrame(a).invert();t.cartographicModelMatrix=u.multiplyRight(o),t.cartographicOrigin=c,t.modelMatrix=t.cartographicModelMatrix}const UP=new I,Bf=new I,kf=new _e([new kt,new kt,new kt,new kt,new kt,new kt]);function BP(n,t){const{cameraDirection:e,cameraUp:i,height:r}=n,{metersPerUnit:s}=n.distanceScales,o=[n.longitude,n.latitude,0],a=Ct.WGS84.cartographicToCartesian(o,new I),c=Ct.WGS84.eastNorthUpToFixedFrame(a),l=n.unprojectPosition(n.cameraPosition),u=Ct.WGS84.cartographicToCartesian(l,new I),h=new I(c.transformAsVector(new I(e).scale(s))).normalize(),f=new I(c.transformAsVector(new I(i).scale(s))).normalize();return kP(n,a),{camera:{position:u,direction:h,up:f},viewport:n,height:r,cullingVolume:kf,frameNumber:t,sseDenominator:1.15}}function kP(n,t){const e=n.getFrustumPlanes();let i=0;for(const r in e){const s=e[r],o=s.normal.dot(n.center);Bf.copy(s.normal).scale(s.distance-o).add(n.center);const a=n.unprojectPosition(Bf),c=Ct.WGS84.cartographicToCartesian(a,new I);kf.planes[i++].fromPointNormal(c,UP.copy(t).subtract(c))}}const VP=6378137,zP=6378137,Vf=6356752314245179e-9,zf=new I;function jP(n){const{halfAxes:t,radius:e,width:i,height:r}=n;if(t){const s=GP(t);return Math.log2(Vf/s)}else{if(e)return Math.log2(Vf/e);if(r&&i){const s=Math.log2(VP/i),o=Math.log2(zP/r);return(s+o)/2}}return 1}function GP(n){n.getColumn(0,zf);const t=n.getColumn(1),e=n.getColumn(2);return zf.add(t).add(e).len()}const Nt={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5},be={ADD:1,REPLACE:2},bn={EMPTY:"empty",SCENEGRAPH:"scenegraph",POINTCLOUD:"pointcloud",MESH:"mesh"},Ie={I3S:"I3S",TILES3D:"TILES3D"},jf={GEOMETRIC_ERROR:"geometricError",MAX_SCREEN_THRESHOLD:"maxScreenThreshold"},$P={NOT_COMPUTED:-1,USE_OPTIMIZATION:1,SKIP_OPTIMIZATION:0};function Gf(n){return n!=null}const HP=new I,WP=new I,qP=new I;function Qo(n,t,e){if(Z(n,"3D Tile: boundingVolume must be defined"),n.box)return YP(n.box,t,e);if(n.region){const[i,r,s,o,a,c]=n.region,l=Ct.WGS84.cartographicToCartesian([Zn(i),Zn(o),a],WP),u=Ct.WGS84.cartographicToCartesian([Zn(s),Zn(r),c],qP),h=new I().addVectors(l,u).multiplyScalar(.5),f=new I().subVectors(l,u).len()/2;return $f([h[0],h[1],h[2],f],new $)}if(n.sphere)return $f(n.sphere,t,e);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function YP(n,t,e){const i=new I(n[0],n[1],n[2]);t.transform(i,i);let r=[];if(n.length===10){const l=n.slice(3,6),u=new ti;u.fromArray(n,6);const h=new I([1,0,0]),f=new I([0,1,0]),g=new I([0,0,1]);h.transformByQuaternion(u),h.scale(l[0]),f.transformByQuaternion(u),f.scale(l[1]),g.transformByQuaternion(u),g.scale(l[2]),r=[...h.toArray(),...f.toArray(),...g.toArray()]}else r=[...n.slice(3,6),...n.slice(6,9),...n.slice(9,12)];const s=t.transformAsVector(r.slice(0,3)),o=t.transformAsVector(r.slice(3,6)),a=t.transformAsVector(r.slice(6,9)),c=new dt([s[0],s[1],s[2],o[0],o[1],o[2],a[0],a[1],a[2]]);return Gf(e)?(e.center=i,e.halfAxes=c,e):new Bo(i,c)}function $f(n,t,e){const i=new I(n[0],n[1],n[2]);t.transform(i,i);const r=t.getScale(HP),s=Math.max(Math.max(r[0],r[1]),r[2]),o=n[3]*s;return Gf(e)?(e.center=i,e.radius=o,e):new vr(i,o)}new I;new I;new $;new I;new I;new I;function XP(n,t){const e=n*t;return 1-Math.exp(-(e*e))}function ZP(n,t){if(n.dynamicScreenSpaceError&&n.dynamicScreenSpaceErrorComputedDensity){const e=n.dynamicScreenSpaceErrorComputedDensity,i=n.dynamicScreenSpaceErrorFactor;return XP(t,e)*i}return 0}function KP(n,t,e){const i=n.tileset,r=n.parent&&n.parent.lodMetricValue||n.lodMetricValue,s=e?r:n.lodMetricValue;if(s===0)return 0;const o=Math.max(n._distanceToCamera,1e-7),{height:a,sseDenominator:c}=t,{viewDistanceScale:l}=i.options;let u=s*a*(l||1)/(o*c);return u-=ZP(i,o),u}const Ti=6378137,QP=Math.PI/2;function JP(n,t){const e=t.viewport,i=e.metersPerPixel,r=n.header.mbs[1],s=n.header.mbs[0],o=n.header.mbs[2],a=n.header.mbs[3],{height:c,width:l,latitude:u,longitude:h}=e,f=[h,u],g=[s,r,o],m=[h,r],_=[s,u],T=Math.sqrt(c*c+l*l)*i[0],v=Dr(f,g),S=c*.5+a/Ti,y=l*.5+a/Ti;if(v>T+a/Ti||Dr(f,m)>S||Dr(f,_)>y)return"OUT";if(n.lodMetricValue===0)return"DIG";let P=Wf(n,t);return P*=QP,P<.5?"OUT":!n.header.children||P<=n.lodMetricValue?"DRAW":n.header.children?"DIG":"OUT"}function Hf([n,t,e]){const i=Zs(n),r=Zs(t),s=1+e/Ti,o=s*Math.cos(r);return n=o*Math.cos(i),t=o*Math.sin(i),e=s*Math.sin(r),[n,t,e]}function Dr(n,t){const[e,i,r=0]=n,[s,o,a=0]=t,c=Hf([s,o,a]),l=Hf([e,i,r]),u=l[0]-c[0],h=l[1]-c[1],f=l[2]-c[2];return u*u+h*h+f*f}function Wf(n,t){const e=t.viewport,i=n.header.mbs[1],r=n.header.mbs[0],s=n.header.mbs[2],o=n.header.mbs[3],a=[r,i,s],c=e.unprojectPosition(e.cameraPosition),l=Dr(c,a),u=o/Ti,h=l-u*u,f=34028235e31;return h<=0?.5*f:tx(t)*u/Math.sqrt(h)*300}function tx(n){const{projectionMatrix:t}=n.viewport;return t[5]}function ex(n){return{assetGltfUpAxis:n.asset&&n.asset.gltfUpAxis||"Y"}}class qf{constructor(t=0){this._array=new Array(t),this._map=new Map,this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return Z(t<this._array.length),this._array[t]}set(t,e){Z(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){Z(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){Z(t>=0),this.length=t}trim(t){t==null&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const nx={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class Fr{constructor(t){A(this,"options",void 0),A(this,"root",void 0),A(this,"requestedTiles",void 0),A(this,"selectedTiles",void 0),A(this,"emptyTiles",void 0),A(this,"_traversalStack",void 0),A(this,"_emptyTraversalStack",void 0),A(this,"_frameNumber",void 0),this.options=E(E({},nx),t),this._traversalStack=new qf,this._emptyTraversalStack=new qf,this._frameNumber=null,this.root=null,this.selectedTiles={},this.requestedTiles={},this.emptyTiles={}}traverse(t,e,i){this.root=t,this.options=E(E({},this.options),i),this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const i=this._traversalStack;for(t._selectionDepth=1,i.push(t);i.length>0;){const r=i.pop();let s=!1;this.canTraverse(r,e)&&(this.updateChildTiles(r,e),s=this.updateAndPushChildren(r,e,i,r.hasRenderContent?r._selectionDepth+1:r._selectionDepth));const o=r.parent,a=Boolean(!o||o._shouldRefine),c=!s;r.hasRenderContent?r.refine===be.ADD?(this.loadTile(r,e),this.selectTile(r,e)):r.refine===be.REPLACE&&(this.loadTile(r,e),c&&this.selectTile(r,e)):(this.emptyTiles[r.id]=r,this.loadTile(r,e),c&&this.selectTile(r,e)),this.touchTile(r,e),r._shouldRefine=s&&a}this.options.onTraversalEnd(e)}updateChildTiles(t,e){const i=t.children;for(const r of i)this.updateTile(r,e);return!0}updateAndPushChildren(t,e,i,r){const{loadSiblings:s,skipLevelOfDetail:o}=this.options,a=t.children;a.sort(this.compareDistanceToCamera.bind(this));const c=t.refine===be.REPLACE&&t.hasRenderContent&&!o;let l=!1,u=!0;for(const h of a)if(h._selectionDepth=r,h.isVisibleAndInRequestVolume?(i.find(h)&&i.delete(h),i.push(h),l=!0):(c||s)&&(this.loadTile(h,e),this.touchTile(h,e)),c){let f;if(h._inRequestVolume?h.hasRenderContent?f=h.contentAvailable:f=this.executeEmptyTraversal(h,e):f=!1,u=u&&f,!u)return!1}return l||(u=!1),u}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e,i=!1,r=!1){return t.hasChildren?t.hasTilesetContent?!t.contentExpired:!r&&!t.isVisibleAndInRequestVolume?!1:this.shouldRefine(t,e,i):!1}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e,i){let r=t._screenSpaceError;return i&&(r=t.getScreenSpaceError(e,!0)),r>this.options.maximumScreenSpaceError}updateTileVisibility(t,e){const i=[];if(this.options.viewportTraversersMap)for(const r in this.options.viewportTraversersMap)this.options.viewportTraversersMap[r]===e.viewport.id&&i.push(r);else i.push(e.viewport.id);t.updateVisibility(e,i)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let i=!1;for(const r of t.children)r.updateVisibility(e),i=i||r.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(t,e){let i=!0;const r=this._emptyTraversalStack;for(r.push(t);r.length>0&&i;){const s=r.pop();if(this.updateTile(s,e),s.isVisibleAndInRequestVolume||this.loadTile(s,e),this.touchTile(s,e),!s.hasRenderContent&&this.canTraverse(s,e,!1,!0)){const a=s.children;for(const c of a)r.find(c)&&r.delete(c),r.push(c)}else s.contentAvailable||(i=!1)}return i}}const Yf=new I;function ix(n){return n!=null}class Jo{constructor(t,e,i,r=""){A(this,"tileset",void 0),A(this,"header",void 0),A(this,"id",void 0),A(this,"url",void 0),A(this,"parent",void 0),A(this,"refine",void 0),A(this,"type",void 0),A(this,"contentUrl",void 0),A(this,"lodMetricType",void 0),A(this,"lodMetricValue",void 0),A(this,"boundingVolume",void 0),A(this,"content",void 0),A(this,"contentState",void 0),A(this,"gpuMemoryUsageInBytes",void 0),A(this,"children",void 0),A(this,"depth",void 0),A(this,"viewportIds",void 0),A(this,"transform",void 0),A(this,"userData",void 0),A(this,"computedTransform",void 0),A(this,"hasEmptyContent",void 0),A(this,"hasTilesetContent",void 0),A(this,"traverser",void 0),A(this,"_cacheNode",void 0),A(this,"_frameNumber",void 0),A(this,"_lodJudge",void 0),A(this,"_expireDate",void 0),A(this,"_expiredContent",void 0),A(this,"_shouldRefine",void 0),A(this,"_distanceToCamera",void 0),A(this,"_centerZDepth",void 0),A(this,"_screenSpaceError",void 0),A(this,"_visibilityPlaneMask",void 0),A(this,"_visible",void 0),A(this,"_inRequestVolume",void 0),A(this,"_stackLength",void 0),A(this,"_selectionDepth",void 0),A(this,"_touchedFrame",void 0),A(this,"_visitedFrame",void 0),A(this,"_selectedFrame",void 0),A(this,"_requestedFrame",void 0),A(this,"_priority",void 0),A(this,"_contentBoundingVolume",void 0),A(this,"_viewerRequestVolume",void 0),A(this,"_initialTransform",void 0),this.header=e,this.tileset=t,this.id=r||e.id,this.url=e.url,this.parent=i,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this.lodMetricType="geometricError",this.lodMetricValue=0,this.boundingVolume=null,this.content=null,this.contentState=Nt.UNLOADED,this.gpuMemoryUsageInBytes=0,this.children=[],this.hasEmptyContent=!1,this.hasTilesetContent=!1,this.depth=0,this.viewportIds=[],this.userData={},this._priority=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._screenSpaceError=0,this._cacheNode=null,this._frameNumber=null,this._cacheNode=null,this.traverser=new Fr({}),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._initialTransform=new $,this.transform=new $,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),this._lodJudge=null,this._expireDate=null,this._expiredContent=null,Object.seal(this)}destroy(){this.header=null}isDestroyed(){return this.header===null}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===Nt.READY||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===Nt.UNLOADED}get contentExpired(){return this.contentState===Nt.EXPIRED}get contentFailed(){return this.contentState===Nt.FAILED}getScreenSpaceError(t,e){switch(this.tileset.type){case Ie.I3S:return Wf(this,t);case Ie.TILES3D:return KP(this,t,e);default:throw new Error("Unsupported tileset type")}}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,i=this.refine===be.ADD||e;if(i&&!this.isVisible&&this._visible!==void 0||this.tileset._frameNumber-this._touchedFrame>=1||this.contentState===Nt.UNLOADED)return-1;const r=this.parent,o=r&&(!i||this._screenSpaceError===0||r.hasTilesetContent)?r._screenSpaceError:this._screenSpaceError,a=t.root?t.root._screenSpaceError:0;return Math.max(a-o,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=Nt.LOADING;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=Nt.UNLOADED,!1;try{const i=this.tileset.getTileUrl(this.contentUrl),r=this.tileset.loader,s=k(E({},this.tileset.loadOptions),{[r.id]:E(k(E({},this.tileset.loadOptions[r.id]),{isTileset:this.type==="json"}),this._getLoaderSpecificOptions(r.id))});return this.content=await $e(i,r,s),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=Nt.READY,this._onContentLoaded(),!0}catch(i){throw this.contentState=Nt.FAILED,i}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=Nt.UNLOADED,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const i=this.parent,r=i?i._visibilityPlaneMask:_e.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const s=i?i.computedTransform:this.tileset.modelMatrix;this._updateTransform(s)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,r),this._visible=this._visibilityPlaneMask!==_e.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:i}=t,{boundingVolume:r}=this;return i.computeVisibilityWithPlaneMask(r,e)}contentVisibility(){return!0}distanceToTile(t){const e=this.boundingVolume;return Math.sqrt(Math.max(e.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth({camera:t}){const e=this.boundingVolume;return Yf.subVectors(e.center,t.position),t.direction.dot(Yf)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(ix(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=Nt.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){"lodMetricType"in t?this.lodMetricType=t.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in t?this.lodMetricValue=t.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new $(t.transform):new $;const e=this.parent,i=this.tileset,r=e&&e.computedTransform?e.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new $(r).multiplyRight(this.transform);const s=e&&e._initialTransform?e._initialTransform.clone():new $;this._initialTransform=new $(s).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=Nt.UNLOADED,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=_e.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||be.REPLACE}_isTileset(){return this.contentUrl.indexOf(".json")!==-1}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0;break}this._isTileset()&&(this.hasTilesetContent=!0)}_updateBoundingVolume(t){this.boundingVolume=Qo(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;!e||(e.boundingVolume&&(this._contentBoundingVolume=Qo(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=Qo(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(t=new $){const e=t.clone().multiplyRight(this.transform);e.equals(this.computedTransform)||(this.computedTransform=e,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){switch(t){case"i3s":return k(E({},this.tileset.options.i3s),{tile:this.header,tileset:this.tileset.tileset,isTileHeader:!1});case"3d-tiles":case"cesium-ion":default:return ex(this.tileset.tileset)}}}class rx extends Fr{compareDistanceToCamera(t,e){return e._distanceToCamera===0&&t._distanceToCamera===0?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const i=t.children.length>0;if(t.hasTilesetContent&&i){const o=t.children[0];this.updateTileVisibility(o,e),t._visible=o._visible;return}if(this.meetsScreenSpaceErrorEarly(t,e)){t._visible=!1;return}const r=t.refine===be.REPLACE,s=t._optimChildrenWithinParent===$P.USE_OPTIMIZATION;if(r&&s&&i&&!this.anyChildrenVisible(t,e)){t._visible=!1;return}}meetsScreenSpaceErrorEarly(t,e){const{parent:i}=t;return!i||i.hasTilesetContent||i.refine!==be.ADD?!1:!this.shouldRefine(t,e,!0)}}const ta={REQUESTED:"REQUESTED",COMPLETED:"COMPLETED",ERROR:"ERROR"};class sx{constructor(){A(this,"_statusMap",void 0),this._statusMap={}}add(t,e,i,r){this._statusMap[e]||(this._statusMap[e]={request:t,callback:i,key:e,frameState:r,status:ta.REQUESTED},t().then(s=>{this._statusMap[e].status=ta.COMPLETED,this._statusMap[e].callback(s,r)}).catch(s=>{this._statusMap[e].status=ta.ERROR,i(s)}))}update(t,e){this._statusMap[t]&&(this._statusMap[t].frameState=e)}find(t){return this._statusMap[t]}}class ox extends Fr{constructor(t){super(t);A(this,"_tileManager",void 0),this._tileManager=new sx}shouldRefine(t,e){return t._lodJudge=JP(t,e),t._lodJudge==="DIG"}updateChildTiles(t,e){const i=t.header.children||[],r=t.children,s=t.tileset;for(const o of i){const a=`${o.id}-${e.viewport.id}`,c=r&&r.find(l=>l.id===a);if(c)c&&this.updateTile(c,e);else{let l=()=>this._loadTile(o.id,s);this._tileManager.find(a)?this._tileManager.update(a,e):(s.tileset.nodePages&&(l=()=>s.tileset.nodePagesTile.formTileFromNodePages(o.id)),this._tileManager.add(l,a,h=>this._onTileLoad(h,t,a),e))}}return!1}async _loadTile(t,e){const{loader:i}=e,r=e.getTileUrl(`${e.url}/nodes/${t}`),s=k(E({},e.loadOptions),{i3s:k(E({},e.loadOptions.i3s),{isTileHeader:!0,loadContent:!1})});return await $e(r,i,s)}_onTileLoad(t,e,i){const r=new Jo(e.tileset,t,e,i);e.children.push(r);const s=this._tileManager.find(r.id).frameState;this.updateTile(r,s),this._frameNumber===s.frameNumber&&this.executeTraversal(r,s)}}const ax={description:"",ellipsoid:Ct.WGS84,modelMatrix:new $,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:n=>n,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},Xf="Tiles In Tileset(s)",ea="Tiles In Memory",Zf="Tiles In View",Kf="Tiles To Render",Qf="Tiles Loaded",na="Tiles Loading",Jf="Tiles Unloaded",td="Failed Tile Loads",ed="Points",ia="Tile Memory Use";class cx{constructor(t,e){A(this,"options",void 0),A(this,"loadOptions",void 0),A(this,"type",void 0),A(this,"tileset",void 0),A(this,"loader",void 0),A(this,"url",void 0),A(this,"basePath",void 0),A(this,"modelMatrix",void 0),A(this,"ellipsoid",void 0),A(this,"lodMetricType",void 0),A(this,"lodMetricValue",void 0),A(this,"refine",void 0),A(this,"root",void 0),A(this,"roots",void 0),A(this,"asset",void 0),A(this,"description",void 0),A(this,"properties",void 0),A(this,"extras",void 0),A(this,"attributions",void 0),A(this,"credits",void 0),A(this,"stats",void 0),A(this,"traverseCounter",void 0),A(this,"geometricError",void 0),A(this,"selectedTiles",void 0),A(this,"cartographicCenter",void 0),A(this,"cartesianCenter",void 0),A(this,"zoom",void 0),A(this,"boundingVolume",void 0),A(this,"gpuMemoryUsageInBytes",void 0),A(this,"dynamicScreenSpaceErrorComputedDensity",void 0),A(this,"_traverser",void 0),A(this,"_cache",void 0),A(this,"_requestScheduler",void 0),A(this,"_frameNumber",void 0),A(this,"_queryParamsString",void 0),A(this,"_queryParams",void 0),A(this,"_extensionsUsed",void 0),A(this,"_tiles",void 0),A(this,"_pendingCount",void 0),A(this,"lastUpdatedVieports",void 0),A(this,"_requestedTiles",void 0),A(this,"_emptyTiles",void 0),A(this,"frameStateData",void 0),A(this,"maximumMemoryUsage",void 0),Z(t),this.options=E(E({},ax),e),this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||Ga(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this.root=null,this.roots={},this.cartographicCenter=null,this.cartesianCenter=null,this.zoom=1,this.boundingVolume=null,this.traverseCounter=0,this.geometricError=0,this._traverser=this._initializeTraverser(),this._cache=new DP,this._requestScheduler=new Ng({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this._frameNumber=0,this._pendingCount=0,this._tiles={},this.selectedTiles=[],this._emptyTiles=[],this._requestedTiles=[],this.frameStateData={},this.lastUpdatedVieports=null,this._queryParams={},this._queryParamsString="",this.maximumMemoryUsage=this.options.maximumMemoryUsage||32,this.gpuMemoryUsageInBytes=0,this.stats=new Ln({id:this.url}),this._initializeStats(),this._extensionsUsed=void 0,this.dynamicScreenSpaceErrorComputedDensity=0,this.extras=null,this.asset={},this.credits={},this.description=this.options.description||"",this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return this._pendingCount===0&&this._frameNumber!==0}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return this._queryParamsString||(this._queryParamsString=lx(this._queryParams)),this._queryParamsString}setProps(t){this.options=E(E({},this.options),t)}setOptions(t){this.options=E(E({},this.options),t)}getTileUrl(t){return t.startsWith("data:")?t:`${t}${this.queryParams}`}hasExtension(t){return Boolean(this._extensionsUsed&&this._extensionsUsed.indexOf(t)>-1)}update(t){if("loadTiles"in this.options&&!this.options.loadTiles||this.traverseCounter>0)return;!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t instanceof Array||(t=[t]),this._cache.reset(),this._frameNumber++,this.traverseCounter=t.length;const e=[];for(const i of t){const r=i.id;this._needTraverse(r)?e.push(r):this.traverseCounter--}for(const i of t){const r=i.id;if(this.roots[r]||(this.roots[r]=this._initializeTileHeaders(this.tileset,null)),!e.includes(r))continue;const s=BP(i,this._frameNumber);this._traverser.traverse(this.roots[r],s,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[e],r=Object.values(this._traverser.selectedTiles);i.selectedTiles=r,i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,!(this.traverseCounter>0)&&this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const i=new Set(t.map(o=>o.id)),r=new Set(e.map(o=>o.id));let s=t.filter(o=>!r.has(o.id)).length>0;return s=s||e.filter(o=>!i.has(o.id)).length>0,s}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,(t,e)=>t._unloadTile(e))}_updateStats(){let t=0,e=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(t++,i.content.pointCount&&(e+=i.content.pointCount));this.stats.get(Zf).count=this.selectedTiles.length,this.stats.get(Kf).count=t,this.stats.get(ed).count=e}_initializeTileSet(t){this.root=this._initializeTileHeaders(t,null),this.type===Ie.TILES3D&&this._initializeCesiumTileset(t),this.type===Ie.I3S&&this._initializeI3STileset(),this._calculateViewProps()}_calculateViewProps(){const t=this.root;Z(t);const{center:e}=t.boundingVolume;if(!e){console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new I,this.zoom=1;return}this.cartographicCenter=Ct.WGS84.cartesianToCartographic(e,new I),this.cartesianCenter=e,this.zoom=jP(t.boundingVolume)}_initializeStats(){this.stats.get(Xf),this.stats.get(na),this.stats.get(ea),this.stats.get(Zf),this.stats.get(Kf),this.stats.get(Qf),this.stats.get(Jf),this.stats.get(td),this.stats.get(ed,"memory"),this.stats.get(ia,"memory")}_initializeTileHeaders(t,e){const i=new Jo(this,t.root,e);if(e&&(e.children.push(i),i.depth=e.depth+1),this.type===Ie.TILES3D){const r=[];for(r.push(i);r.length>0;){const s=r.pop();this.stats.get(Xf).incrementCount();const o=s.header.children||[];for(const a of o){const c=new Jo(this,a,s);s.children.push(c),c.depth=s.depth+1,r.push(c)}}}return i}_initializeTraverser(){let t;switch(this.type){case Ie.TILES3D:t=rx;break;case Ie.I3S:t=ox;break;default:t=Fr}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(i){this._onTileLoadError(t,i)}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(td).incrementCount();const i=e.message||e.toString(),r=t.url;console.error(`A 3D tile failed to load: ${t.url} ${i}`),this.options.onTileError(t,i,r)}_onTileLoad(t,e){!e||(t&&t.content&&FP(t,t.content),this._addTileToCache(t),this.options.onTileLoad(t))}_onStartTileLoading(){this._pendingCount++,this.stats.get(na).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(na).decrementCount()}_addTileToCache(t){this._cache.add(this,t,e=>e._updateCacheStats(t))}_updateCacheStats(t){this.stats.get(Qf).incrementCount(),this.stats.get(ea).incrementCount(),this.gpuMemoryUsageInBytes+=t.content.byteLength||0,this.stats.get(ia).count=this.gpuMemoryUsageInBytes}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.content&&t.content.byteLength||0,this.stats.get(ea).decrementCount(),this.stats.get(Jf).incrementCount(),this.stats.get(ia).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const i of e.children)t.push(i);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,i=[];for(i.push(e);i.length>0;){t=i.pop();for(const r of t.children)i.push(r);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeCesiumTileset(t){if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if(this.asset.version!=="0.0"&&this.asset.version!=="1.0")throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed,this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}function lx(n){const t=[];for(const e of Object.keys(n))t.push(`${e}=${n[e]}`);switch(t.length){case 0:return"";case 1:return`?${t[0]}`;default:return`?${t.join("&")}`}}const ux="3.0.12",Ur={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GEOMETRY:"geom",VECTOR:"vect"};function nd(n,t,e){Z(n instanceof ArrayBuffer);const i=new TextDecoder("utf8"),r=new Uint8Array(n,t,e);return i.decode(r)}function hx(n,t=0){const e=new DataView(n);return`${String.fromCharCode(e.getUint8(t+0))}${String.fromCharCode(e.getUint8(t+1))}${String.fromCharCode(e.getUint8(t+2))}${String.fromCharCode(e.getUint8(t+3))}`}const fx={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},at={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},q=E(E({},fx),at),ra={[at.DOUBLE]:Float64Array,[at.FLOAT]:Float32Array,[at.UNSIGNED_SHORT]:Uint16Array,[at.UNSIGNED_INT]:Uint32Array,[at.UNSIGNED_BYTE]:Uint8Array,[at.BYTE]:Int8Array,[at.SHORT]:Int16Array,[at.INT]:Int32Array},dx={DOUBLE:at.DOUBLE,FLOAT:at.FLOAT,UNSIGNED_SHORT:at.UNSIGNED_SHORT,UNSIGNED_INT:at.UNSIGNED_INT,UNSIGNED_BYTE:at.UNSIGNED_BYTE,BYTE:at.BYTE,SHORT:at.SHORT,INT:at.INT},sa="Failed to convert GL type";class re{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in ra)if(ra[e]===t)return e;throw new Error(sa)}static fromName(t){const e=dx[t];if(!e)throw new Error(sa);return e}static getArrayType(t){switch(t){case at.UNSIGNED_SHORT_5_6_5:case at.UNSIGNED_SHORT_4_4_4_4:case at.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=ra[t];if(!e)throw new Error(sa);return e}}static getByteSize(t){return re.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return Boolean(re.getArrayType(t))}static createTypedArray(t,e,i=0,r){r===void 0&&(r=(e.byteLength-i)/re.getByteSize(t));const s=re.getArrayType(t);return new s(e,i,r)}}function gx(n,t){if(!n)throw new Error(`math.gl assertion failed. ${t}`)}function px(n,t=[0,0,0]){const e=n>>11&31,i=n>>5&63,r=n&31;return t[0]=e<<3,t[1]=i<<2,t[2]=r<<3,t}new Qs;new I;new Qs;new Qs;function id(n,t=255){return Kn(n,0,t)/t*2-1}function rd(n){return n<0?-1:1}function mx(n,t,e,i){if(gx(i),n<0||n>e||t<0||t>e)throw new Error(`x and y must be unsigned normalized integers between 0 and ${e}`);if(i.x=id(n,e),i.y=id(t,e),i.z=1-(Math.abs(i.x)+Math.abs(i.y)),i.z<0){const r=i.x;i.x=(1-Math.abs(i.y))*rd(r),i.y=(1-Math.abs(r))*rd(i.y)}return i.normalize()}function _x(n,t,e){return mx(n,t,255,e)}class oa{constructor(t,e){this.json=t,this.buffer=e,this.featuresLength=0,this._cachedTypedArrays={}}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t,e=q.UNSIGNED_INT,i=1){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?this._getTypedArrayFromBinary(t,e,i,1,r.byteOffset):r}getPropertyArray(t,e,i){const r=this.json[t];return r&&Number.isFinite(r.byteOffset)?("componentType"in r&&(e=re.fromName(r.componentType)),this._getTypedArrayFromBinary(t,e,i,this.featuresLength,r.byteOffset)):this._getTypedArrayFromArray(t,e,r)}getProperty(t,e,i,r,s){const o=this.json[t];if(!o)return o;const a=this.getPropertyArray(t,e,i);if(i===1)return a[r];for(let c=0;c<i;++c)s[c]=a[i*r+c];return s}_getTypedArrayFromBinary(t,e,i,r,s){const o=this._cachedTypedArrays;let a=o[t];return a||(a=re.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+s,r*i),o[t]=a),a}_getTypedArrayFromArray(t,e,i){const r=this._cachedTypedArrays;let s=r[t];return s||(s=re.createTypedArray(e,i),r[t]=s),s}}const bx={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},yx={SCALAR:(n,t)=>n[t],VEC2:(n,t)=>[n[2*t+0],n[2*t+1]],VEC3:(n,t)=>[n[3*t+0],n[3*t+1],n[3*t+2]],VEC4:(n,t)=>[n[4*t+0],n[4*t+1],n[4*t+2],n[4*t+3]],MAT2:(n,t)=>[n[4*t+0],n[4*t+1],n[4*t+2],n[4*t+3]],MAT3:(n,t)=>[n[9*t+0],n[9*t+1],n[9*t+2],n[9*t+3],n[9*t+4],n[9*t+5],n[9*t+6],n[9*t+7],n[9*t+8]],MAT4:(n,t)=>[n[16*t+0],n[16*t+1],n[16*t+2],n[16*t+3],n[16*t+4],n[16*t+5],n[16*t+6],n[16*t+7],n[16*t+8],n[16*t+9],n[16*t+10],n[16*t+11],n[16*t+12],n[16*t+13],n[16*t+14],n[16*t+15]]},Tx={SCALAR:(n,t,e)=>{t[e]=n},VEC2:(n,t,e)=>{t[2*e+0]=n[0],t[2*e+1]=n[1]},VEC3:(n,t,e)=>{t[3*e+0]=n[0],t[3*e+1]=n[1],t[3*e+2]=n[2]},VEC4:(n,t,e)=>{t[4*e+0]=n[0],t[4*e+1]=n[1],t[4*e+2]=n[2],t[4*e+3]=n[3]},MAT2:(n,t,e)=>{t[4*e+0]=n[0],t[4*e+1]=n[1],t[4*e+2]=n[2],t[4*e+3]=n[3]},MAT3:(n,t,e)=>{t[9*e+0]=n[0],t[9*e+1]=n[1],t[9*e+2]=n[2],t[9*e+3]=n[3],t[9*e+4]=n[4],t[9*e+5]=n[5],t[9*e+6]=n[6],t[9*e+7]=n[7],t[9*e+8]=n[8],t[9*e+9]=n[9]},MAT4:(n,t,e)=>{t[16*e+0]=n[0],t[16*e+1]=n[1],t[16*e+2]=n[2],t[16*e+3]=n[3],t[16*e+4]=n[4],t[16*e+5]=n[5],t[16*e+6]=n[6],t[16*e+7]=n[7],t[16*e+8]=n[8],t[16*e+9]=n[9],t[16*e+10]=n[10],t[16*e+11]=n[11],t[16*e+12]=n[12],t[16*e+13]=n[13],t[16*e+14]=n[14],t[16*e+15]=n[15]}};function Ex(n,t,e,i){const{componentType:r}=n;Z(n.componentType);const s=typeof r=="string"?re.fromName(r):r,o=bx[n.type],a=yx[n.type],c=Tx[n.type];return e+=n.byteOffset,{values:re.createTypedArray(s,t,e,o*i),type:s,size:o,unpacker:a,packer:c}}const se=n=>n!==void 0;function vx(n,t,e){if(!t)return null;let i=n.getExtension("3DTILES_batch_table_hierarchy");const r=t.HIERARCHY;return r&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),t.extensions=t.extensions||{},t.extensions["3DTILES_batch_table_hierarchy"]=r,i=r),i?Ax(i,e):null}function Ax(n,t){let e,i,r;const s=n.instancesLength,o=n.classes;let a=n.classIds,c=n.parentCounts,l=n.parentIds,u=s;se(a.byteOffset)&&(a.componentType=defaultValue(a.componentType,GL.UNSIGNED_SHORT),a.type=AttributeType.SCALAR,r=getBinaryAccessor(a),a=r.createArrayBufferView(t.buffer,t.byteOffset+a.byteOffset,s));let h;if(se(c))for(se(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(t.buffer,t.byteOffset+c.byteOffset,s)),h=new Uint16Array(s),u=0,e=0;e<s;++e)h[e]=u,u+=c[e];se(l)&&se(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(t.buffer,t.byteOffset+l.byteOffset,u));const f=o.length;for(e=0;e<f;++e){const T=o[e].length,v=o[e].instances,S=getBinaryProperties(T,v,t);o[e].instances=combine(S,v)}const g=new Array(f).fill(0),m=new Uint16Array(s);for(e=0;e<s;++e)i=a[e],m[e]=g[i],++g[i];const _={classes:o,classIds:a,classIndexes:m,parentCounts:c,parentIndexes:h,parentIds:l};return Ix(_),_}function Ei(n,t,e){if(!n)return;const i=n.parentCounts;return n.parentIds?e(n,t):i>0?wx(n,t,e):Sx(n,t,e)}function wx(n,t,e){const i=n.classIds,r=n.parentCounts,s=n.parentIds,o=n.parentIndexes,a=i.length,c=scratchVisited;c.length=Math.max(c.length,a);const l=++marker,u=scratchStack;for(u.length=0,u.push(t);u.length>0;){if(t=u.pop(),c[t]===l)continue;c[t]=l;const h=e(n,t);if(se(h))return h;const f=r[t],g=o[t];for(let m=0;m<f;++m){const _=s[g+m];_!==t&&u.push(_)}}return null}function Sx(n,t,e){let i=!0;for(;i;){const r=e(n,t);if(se(r))return r;const s=n.parentIds[t];i=s!==t,t=s}throw new Error("traverseHierarchySingleParent")}function Ix(n){const e=n.classIds.length;for(let i=0;i<e;++i)sd(n,i,stack)}function sd(n,t,e){const i=n.parentCounts,r=n.parentIds,s=n.parentIndexes,a=n.classIds.length;if(!se(r))return;assert(t<a,`Parent index ${t} exceeds the total number of instances: ${a}`),assert(e.indexOf(t)===-1,"Circular dependency detected in the batch table hierarchy."),e.push(t);const c=se(i)?i[t]:1,l=se(i)?s[t]:t;for(let u=0;u<c;++u){const h=r[l+u];h!==t&&sd(n,h,e)}e.pop(t)}function wt(n){return n!=null}const Br=(n,t)=>n,Px={HIERARCHY:!0,extensions:!0,extras:!0};class od{constructor(t,e,i,r={}){var s;Z(i>=0),this.json=t||{},this.binary=e,this.featureCount=i,this._extensions=((s=this.json)===null||s===void 0?void 0:s.extensions)||{},this._properties={};for(const o in this.json)Px[o]||(this._properties[o]=this.json[o]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=vx(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),Z(typeof e=="string",e),this._hierarchy){const i=Ei(this._hierarchy,t,(r,s)=>{const o=r.classIds[s];return r.classes[o].name===e});return wt(i)}return!1}isExactClass(t,e){return Z(typeof e=="string",e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(t,e){return this._checkBatchId(t),Z(typeof e=="string",e),wt(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),e=wt(e)?e:[],e.length=0;const i=Object.keys(this._properties);return e.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),Z(typeof e=="string",e),this._binaryProperties){const r=this._binaryProperties[e];if(wt(r))return this._getBinaryProperty(r,t)}const i=this._properties[e];if(wt(i))return Br(i[t],!0);if(this._hierarchy){const r=this._getHierarchyProperty(t,e);if(wt(r))return r}}setProperty(t,e,i){const r=this.featureCount;if(this._checkBatchId(t),Z(typeof e=="string",e),this._binaryProperties){const o=this._binaryProperties[e];if(o){this._setBinaryProperty(o,t,i);return}}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,i))return;let s=this._properties[e];wt(s)||(this._properties[e]=new Array(r),s=this._properties[e]),s[t]=Br(i,!0)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,i){t.pack(i,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const i=this._properties[e],r=this._initializeBinaryProperty(e,i);r&&(t=t||{},t[e]=r)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const i=e;Z(this.binary,`Property ${t} requires a batch table binary.`),Z(i.type,`Property ${t} requires a type.`);const r=Ex(i,this.binary.buffer,this.binary.byteOffset|0,this.featureCount);return{typedArray:r.values,componentCount:r.size,unpack:r.unpacker,pack:r.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const i=Ei(this._hierarchy,t,(r,s)=>{const o=r.classIds[s],a=r.classes[o].instances;return wt(a[e])});return wt(i)}_getPropertyNamesInHierarchy(t,e){Ei(this._hierarchy,t,(i,r)=>{const s=i.classIds[r],o=i.classes[s].instances;for(const a in o)o.hasOwnProperty(a)&&e.indexOf(a)===-1&&e.push(a)})}_getHierarchyProperty(t,e){return Ei(this._hierarchy,t,(i,r)=>{const s=i.classIds[r],o=i.classes[s],a=i.classIndexes[r],c=o.instances[e];return wt(c)?wt(c.typedArray)?this._getBinaryProperty(c,a):Br(c[a],!0):null})}_setHierarchyProperty(t,e,i,r){const s=Ei(this._hierarchy,e,(o,a)=>{const c=o.classIds[a],l=o.classes[c],u=o.classIndexes[a],h=l.instances[i];return wt(h)?(Z(a===e,`Inherited property "${i}" is read-only.`),wt(h.typedArray)?this._setBinaryProperty(h,u,r):h[u]=Br(r),!0):!1});return wt(s)}}const aa=4;function kr(n,t,e=0){const i=new DataView(t);if(n.magic=i.getUint32(e,!0),e+=aa,n.version=i.getUint32(e,!0),e+=aa,n.byteLength=i.getUint32(e,!0),e+=aa,n.version!==1)throw new Error(`3D Tile Version ${n.version} not supported`);return e}const yn=4,ad="b3dm tile in legacy format.";function ca(n,t,e){const i=new DataView(t);let r;n.header=n.header||{};let s=i.getUint32(e,!0);e+=yn;let o=i.getUint32(e,!0);e+=yn;let a=i.getUint32(e,!0);e+=yn;let c=i.getUint32(e,!0);return e+=yn,a>=570425344?(e-=yn*2,r=s,a=o,c=0,s=0,o=0,console.warn(ad)):c>=570425344&&(e-=yn,r=a,a=s,c=o,s=0,o=0,console.warn(ad)),n.header.featureTableJsonByteLength=s,n.header.featureTableBinaryByteLength=o,n.header.batchTableJsonByteLength=a,n.header.batchTableBinaryByteLength=c,n.header.batchLength=r,e}function la(n,t,e,i){return e=xx(n,t,e),e=Lx(n,t,e),e}function xx(n,t,e,i){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:s,batchLength:o}=n.header;if(n.featureTableJson={BATCH_LENGTH:o||0},r>0){const a=nd(t,e,r);n.featureTableJson=JSON.parse(a)}return e+=r,n.featureTableBinary=new Uint8Array(t,e,s),e+=s,e}function Lx(n,t,e,i){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:s}=n.header;if(r>0){const o=nd(t,e,r);n.batchTableJson=JSON.parse(o),e+=r,s>0&&(n.batchTableBinary=new Uint8Array(t,e,s),n.batchTableBinary=new Uint8Array(n.batchTableBinary),e+=s)}return e}function cd(n,t,e){if(!t&&(!n||!n.batchIds||!e))return null;const{batchIds:i,isRGB565:r,pointCount:s}=n;if(i&&e){const o=new Uint8ClampedArray(s*3);for(let a=0;a<s;a++){const c=i[a],u=e.getProperty(c,"dimensions").map(h=>h*255);o[a*3]=u[0],o[a*3+1]=u[1],o[a*3+2]=u[2]}return{type:q.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}if(r){const o=new Uint8ClampedArray(s*3);for(let a=0;a<s;a++){const c=px(t[a]);o[a*3]=c[0],o[a*3+1]=c[1],o[a*3+2]=c[2]}return{type:q.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}return t&&t.length===s*3?{type:q.UNSIGNED_BYTE,value:t,size:3,normalized:!0}:{type:q.UNSIGNED_BYTE,value:t,size:4,normalized:!0}}const ld=new I;function Mx(n,t){if(!t)return null;if(n.isOctEncoded16P){const e=new Float32Array(n.pointsLength*3);for(let i=0;i<n.pointsLength;i++)_x(t[i*2],t[i*2+1],ld),ld.toArray(e,i*3);return{type:q.FLOAT,size:2,value:e}}return{type:q.FLOAT,size:2,value:t}}function Rx(n,t,e){return n.isQuantized?e["3d-tiles"]&&e["3d-tiles"].decodeQuantizedPositions?(n.isQuantized=!1,Ox(n,t)):{type:q.UNSIGNED_SHORT,value:t,size:3,normalized:!0}:t}function Ox(n,t){const e=new I,i=new Float32Array(n.pointCount*3);for(let r=0;r<n.pointCount;r++)e.set(t[r*3],t[r*3+1],t[r*3+2]).scale(1/n.quantizedRange).multiply(n.quantizedVolumeScale).add(n.quantizedVolumeOffset).toArray(i,r*3);return i}async function Cx(n,t,e,i,r){e=kr(n,t,e),e=ca(n,t,e),e=la(n,t,e),Nx(n);const{featureTable:s,batchTable:o}=Dx(n);return await Vx(n,s,o,i,r),Fx(n,s,i),Ux(n,s,o),Bx(n,s),e}function Nx(n){n.attributes={positions:null,colors:null,normals:null,batchIds:null},n.isQuantized=!1,n.isTranslucent=!1,n.isRGB565=!1,n.isOctEncoded16P=!1}function Dx(n){const t=new oa(n.featureTableJson,n.featureTableBinary),e=t.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(e))throw new Error("POINTS_LENGTH must be defined");t.featuresLength=e,n.featuresLength=e,n.pointsLength=e,n.pointCount=e,n.rtcCenter=t.getGlobalProperty("RTC_CENTER",q.FLOAT,3);const i=kx(n,t);return{featureTable:t,batchTable:i}}function Fx(n,t,e){if(!n.attributes.positions){if(t.hasProperty("POSITION"))n.attributes.positions=t.getPropertyArray("POSITION",q.FLOAT,3);else if(t.hasProperty("POSITION_QUANTIZED")){const i=t.getPropertyArray("POSITION_QUANTIZED",q.UNSIGNED_SHORT,3);if(n.isQuantized=!0,n.quantizedRange=(1<<16)-1,n.quantizedVolumeScale=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",q.FLOAT,3),!n.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(n.quantizedVolumeOffset=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",q.FLOAT,3),!n.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");n.attributes.positions=Rx(n,i,e)}}if(!n.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}function Ux(n,t,e){if(!n.attributes.colors){let i=null;t.hasProperty("RGBA")?(i=t.getPropertyArray("RGBA",q.UNSIGNED_BYTE,4),n.isTranslucent=!0):t.hasProperty("RGB")?i=t.getPropertyArray("RGB",q.UNSIGNED_BYTE,3):t.hasProperty("RGB565")&&(i=t.getPropertyArray("RGB565",q.UNSIGNED_SHORT,1),n.isRGB565=!0),n.attributes.colors=cd(n,i,e)}t.hasProperty("CONSTANT_RGBA")&&(n.constantRGBA=t.getGlobalProperty("CONSTANT_RGBA",q.UNSIGNED_BYTE,4))}function Bx(n,t){if(!n.attributes.normals){let e=null;t.hasProperty("NORMAL")?e=t.getPropertyArray("NORMAL",q.FLOAT,3):t.hasProperty("NORMAL_OCT16P")&&(e=t.getPropertyArray("NORMAL_OCT16P",q.UNSIGNED_BYTE,2),n.isOctEncoded16P=!0),n.attributes.normals=Mx(n,e)}}function kx(n,t){let e=null;if(!n.batchIds&&t.hasProperty("BATCH_ID")&&(n.batchIds=t.getPropertyArray("BATCH_ID",q.UNSIGNED_SHORT,1),n.batchIds)){const i=t.getGlobalProperty("BATCH_LENGTH");if(!i)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:s}=n;e=new od(r,s,i)}return e}async function Vx(n,t,e,i,r){let s,o,a;const c=n.batchTableJson&&n.batchTableJson.extensions&&n.batchTableJson.extensions["3DTILES_draco_point_compression"];c&&(a=c.properties);const l=t.getExtension("3DTILES_draco_point_compression");if(l){o=l.properties;const h=l.byteOffset,f=l.byteLength;if(!o||!Number.isFinite(h)||!f)throw new Error("Draco properties, byteOffset, and byteLength must be defined");s=n.featureTableBinary.slice(h,h+f),n.hasPositions=Number.isFinite(o.POSITION),n.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),n.hasNormals=Number.isFinite(o.NORMAL),n.hasBatchIds=Number.isFinite(o.BATCH_ID),n.isTranslucent=Number.isFinite(o.RGBA)}if(!s)return!0;const u={buffer:s,properties:E(E({},o),a),featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await zx(n,u,i,r)}async function zx(n,t,e,i){const{parse:r}=i,s=k(E({},e),{draco:k(E({},e.draco),{extraAttributes:t.batchTableProperties||{}})});delete s["3d-tiles"];const o=await r(t.buffer,vf,s),a=o.attributes.POSITION&&o.attributes.POSITION.value,c=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,l=o.attributes.NORMAL&&o.attributes.NORMAL.value,u=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,h=a&&o.attributes.POSITION.value.quantization,f=l&&o.attributes.NORMAL.value.quantization;if(h){const m=o.POSITION.data.quantization,_=m.range;n.quantizedVolumeScale=new I(_,_,_),n.quantizedVolumeOffset=new I(m.minValues),n.quantizedRange=(1<<m.quantizationBits)-1,n.isQuantizedDraco=!0}f&&(n.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,n.isOctEncodedDraco=!0);const g={};if(t.batchTableProperties)for(const m of Object.keys(t.batchTableProperties))o.attributes[m]&&o.attributes[m].value&&(g[m.toLowerCase()]=o.attributes[m].value);n.attributes=E({positions:a,colors:cd(n,c),normals:l,batchIds:u},g)}const ua={URI:0,EMBEDDED:1};function ud(n,t,e,i){n.rotateYtoZ=!0;const r=n.byteOffset+n.byteLength-e;if(r===0)throw new Error("glTF byte length must be greater than 0.");return n.gltfUpAxis=i["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y",n.gltfArrayBuffer=as(t,e,r),n.gltfByteOffset=0,n.gltfByteLength=r,e%4==0||console.warn(`${n.type}: embedded glb is not aligned to a 4-byte boundary.`),n.byteOffset+n.byteLength}async function hd(n,t,e,i){const r=e["3d-tiles"]||{};if(jx(n,t),r.loadGLTF){const{parse:s,fetch:o}=i;n.gltfUrl&&(n.gltfArrayBuffer=await o(n.gltfUrl,e),n.gltfByteOffset=0),n.gltfArrayBuffer&&(n.gltf=await s(n.gltfArrayBuffer,Rr,e,i),delete n.gltfArrayBuffer,delete n.gltfByteOffset,delete n.gltfByteLength)}}function jx(n,t,e){switch(t){case ua.URI:const i=new Uint8Array(n.gltfArrayBuffer,n.gltfByteOffset),s=new TextDecoder().decode(i);n.gltfUrl=s.replace(/[\s\0]+$/,""),delete n.gltfArrayBuffer,delete n.gltfByteOffset,delete n.gltfByteLength;break;case ua.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}async function Gx(n,t,e,i,r){var s;e=$x(n,t,e,i),await hd(n,ua.EMBEDDED,i,r);const o=n==null||(s=n.gltf)===null||s===void 0?void 0:s.extensions;return o&&o.CESIUM_RTC&&(n.rtcCenter=o.CESIUM_RTC.center),e}function $x(n,t,e,i,r){e=kr(n,t,e),e=ca(n,t,e),e=la(n,t,e),e=ud(n,t,e,i);const s=new oa(n.featureTableJson,n.featureTableBinary);return n.rtcCenter=s.getGlobalProperty("RTC_CENTER",q.FLOAT,3),e}async function Hx(n,t,e,i,r){return e=Wx(n,t,e,i),await hd(n,n.gltfFormat,i,r),e}function Wx(n,t,e,i,r){if(e=kr(n,t,e),n.version!==1)throw new Error(`Instanced 3D Model version ${n.version} is not supported`);e=ca(n,t,e);const s=new DataView(t);if(n.gltfFormat=s.getUint32(e,!0),e+=4,e=la(n,t,e),e=ud(n,t,e,i),n.featureTableJsonByteLength===0)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new oa(n.featureTableJson,n.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");n.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),n.rtcCenter=o.getGlobalProperty("RTC_CENTER",q.FLOAT,3);const c=new od(n.batchTableJson,n.batchTableBinary,a);return qx(n,o,c,a),e}function qx(n,t,e,i){const s={instances:new Array(i),batchTable:n._batchTable,cull:!1,url:void 0,gltf:void 0,basePath:void 0,incrementallyLoadTextures:!1,forwardAxis:[1,0,0]}.instances,o=new I;new I,new I,new I;const a=new dt,c=new ti,l=new I,u={},h=new $,f=[],g=[],m=new I,_=new I;for(let T=0;T<i;T++){let v;if(t.hasProperty("POSITION"))v=t.getProperty("POSITION",q.FLOAT,3,T,o);else if(t.hasProperty("POSITION_QUANTIZED")){v=t.getProperty("POSITION_QUANTIZED",q.UNSIGNED_SHORT,3,T,o);const N=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",q.FLOAT,3,m);if(!N)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const U=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",q.FLOAT,3,_);if(!U)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const C=65535;for(let B=0;B<3;B++)v[B]=v[B]/C*U[B]+N[B]}if(!v)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(o.copy(v),u.translation=o,n.normalUp=t.getProperty("NORMAL_UP",q.FLOAT,3,T,f),n.normalRight=t.getProperty("NORMAL_RIGHT",q.FLOAT,3,T,g),n.normalUp){if(!n.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");n.hasCustomOrientation=!0}else{if(n.octNormalUp=t.getProperty("NORMAL_UP_OCT32P",q.UNSIGNED_SHORT,2,f),n.octNormalRight=t.getProperty("NORMAL_RIGHT_OCT32P",q.UNSIGNED_SHORT,2,g),n.octNormalUp)throw n.octNormalRight?new Error("i3dm: oct-encoded orientation not implemented"):new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");n.eastNorthUp?(Ct.WGS84.eastNorthUpToFixedFrame(o,h),h.getRotationMatrix3(a)):a.identity()}c.fromMatrix3(a),u.rotation=c,l.set(1,1,1);const S=t.getProperty("SCALE",q.FLOAT,1,T);Number.isFinite(S)&&l.multiplyByScalar(S);const y=t.getProperty("SCALE_NON_UNIFORM",q.FLOAT,3,T,f);y&&l.scale(y),u.scale=l;let P=t.getProperty("BATCH_ID",q.UNSIGNED_SHORT,1,T);P===void 0&&(P=T);const L=new $().fromQuaternion(u.rotation);h.identity(),h.translate(u.translation),h.multiplyRight(L),h.scale(u.scale);const x=h.clone();s[T]={modelMatrix:x,batchId:P}}n.instances=s}async function Yx(n,t,e,i,r,s){e=kr(n,t,e);const o=new DataView(t);for(n.tilesLength=o.getUint32(e,!0),e+=4,n.tiles=[];n.tiles.length<n.tilesLength&&n.byteLength-e>12;){const a={};n.tiles.push(a),e=await s(t,e,i,r,a)}return e}async function fd(n,t=0,e,i,r={}){switch(r.byteOffset=t,r.type=hx(n,t),r.type){case Ur.COMPOSITE:return await Yx(r,n,t,e,i,fd);case Ur.BATCHED_3D_MODEL:return await Gx(r,n,t,e,i);case Ur.INSTANCED_3D_MODEL:return await Hx(r,n,t,e,i);case Ur.POINT_CLOUD:return await Cx(r,n,t,e,i);default:throw new Error(`3DTileLoader: unknown type ${r.type}`)}}function Xx(n){if(!n.contentUrl)return bn.EMPTY;const e=n.contentUrl.split(".").pop();switch(e){case"pnts":return bn.POINTCLOUD;case"i3dm":case"b3dm":return bn.SCENEGRAPH;default:return e}}function Zx(n){switch(n){case"REPLACE":case"replace":return be.REPLACE;case"ADD":case"add":return be.ADD;default:return n}}function dd(n,t){if(n.content){const e=n.content.uri||n.content.url;n.contentUrl=`${t.basePath}/${e}`}return n.id=n.contentUrl,n.lodMetricType=jf.GEOMETRIC_ERROR,n.lodMetricValue=n.geometricError,n.transformMatrix=n.transform,n.type=Xx(n),n.refine=Zx(n.refine),n}function Kx(n){const t=n.basePath,e=dd(n.root,n),i=[];for(i.push(e);i.length>0;){const s=i.pop().children||[];for(const o of s)dd(o,{basePath:t}),i.push(o)}return e}const gd={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:ux,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:eL,options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};function Qx(n){return Ga(n.url)}async function Jx(n,t,e){const i={content:{featureIds:null}};return await fd(n,0,t,e,i.content),i.content}async function tL(n,t,e){const i=JSON.parse(new TextDecoder().decode(n));return i.loader=t.loader||gd,i.url=e.url,i.basePath=Qx(i),i.root=Kx(i),i.type=Ie.TILES3D,i.lodMetricType=jf.GEOMETRIC_ERROR,i.lodMetricValue=i.root.lodMetricValue,i}async function eL(n,t,e){const i=t["3d-tiles"]||{};let r;return i.isTileset==="auto"?r=e.url&&e.url.indexOf(".json")!==-1:r=i.isTileset,r?n=await tL(n,t,e):n=await Jx(n,t,e),n}const pd=[0],nL={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:null,loader:gd,onTilesetLoad:{type:"function",value:n=>{},compare:!1},onTileLoad:{type:"function",value:n=>{},compare:!1},onTileUnload:{type:"function",value:n=>{},compare:!1},onTileError:{type:"function",value:(n,t,e)=>{},compare:!1},_getMeshColor:{type:"function",value:n=>[255,255,255],compare:!1}};class md extends $h{initializeState(){"onTileLoadFail"in this.props&&W.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){const{tileset3d:t}=this.state;return t&&t.isLoaded()}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState({props:t,oldProps:e,changeFlags:i}){if(t.data&&t.data!==e.data&&this._loadTileset(t.data),i.viewportChanged){const{activeViewports:r}=this.state;Object.keys(r).length&&(this._updateTileset(r),this.state.lastUpdatedViewports=r,this.state.activeViewports={})}if(i.propsChanged){const{layerMap:r}=this.state;for(const s in r)r[s].needsUpdate=!0}}activateViewport(t){const{activeViewports:e,lastUpdatedViewports:i}=this.state;this.internalState.viewport=t,e[t.id]=t;const r=i==null?void 0:i[t.id];(!r||!t.equals(r))&&(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:t,sourceLayer:e}){const{layerMap:i}=this.state,r=e&&e.id;if(r){const s=r.substring(this.id.length+1),o=s.substring(s.indexOf("-")+1);t.object=i[o]&&i[o].tile}return t}filterSubLayer({layer:t,viewport:e}){const{tile:i}=t.props,{id:r}=e;return this.props.visible&&i.selected&&i.viewportIds.includes(r)}_updateAutoHighlight(t){t.sourceLayer&&t.sourceLayer.updateAutoHighlight(t)}async _loadTileset(t){const{loadOptions:e={}}=this.props;let i=this.props.loader||this.props.loaders;Array.isArray(i)&&(i=i[0]);const r={loadOptions:E({},e)};if(i.preload){const a=await i.preload(t,e);a.headers&&(r.loadOptions.fetch=k(E({},r.loadOptions.fetch),{headers:a.headers})),Object.assign(r,a)}const s=await $e(t,i,r.loadOptions),o=new cx(s,E({onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileLoadFail:this.props.onTileError},r));this.setState({tileset3d:o,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(o)}_onTileLoad(t){const{lastUpdatedViewports:e}=this.state;this.props.onTileLoad(t),this._updateTileset(e),this.setNeedsUpdate()}_onTileUnload(t){delete this.state.layerMap[t.id],this.props.onTileUnload(t)}_updateTileset(t){const{tileset3d:e}=this.state,{timeline:i}=this.context,r=Object.keys(t).length;if(!i||!r||!e)return;const s=e.update(Object.values(t));this.state.frameNumber!==s&&this.setState({frameNumber:s})}_getSubLayer(t,e){if(!t.content)return null;switch(t.type){case bn.POINTCLOUD:return this._makePointCloudLayer(t,e);case bn.SCENEGRAPH:return this._make3DModelLayer(t,e);case bn.MESH:return this._makeSimpleMeshLayer(t,e);default:throw new Error("Tile3DLayer: Failed to render layer of type ".concat(t.content.type))}}_makePointCloudLayer(t,e){const{attributes:i,pointCount:r,constantRGBA:s,cartographicOrigin:o,modelMatrix:a}=t.content,{positions:c,normals:l,colors:u}=i;if(!c)return null;const h=e&&e.props.data||{header:{vertexCount:r},attributes:{POSITION:c,NORMAL:l,COLOR_0:u}},{pointSize:f,getPointColor:g}=this.props,m=this.getSubLayerClass("pointcloud",Uo);return new m({pointSize:f},this.getSubLayerProps({id:"pointcloud"}),{id:"".concat(this.id,"-pointcloud-").concat(t.id),tile:t,data:h,coordinateSystem:H.METER_OFFSETS,coordinateOrigin:o,modelMatrix:a,getColor:s||g,_offset:0})}_make3DModelLayer(t){const{gltf:e,instances:i,cartographicOrigin:r,modelMatrix:s}=t.content,o=this.getSubLayerClass("scenegraph",qo);return new o({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:"".concat(this.id,"-scenegraph-").concat(t.id),tile:t,data:i||pd,scenegraph:e,coordinateSystem:H.METER_OFFSETS,coordinateOrigin:r,modelMatrix:s,getTransformMatrix:a=>a.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(t,e){const i=t.content,{attributes:r,indices:s,modelMatrix:o,cartographicOrigin:a,material:c,featureIds:l}=i,{_getMeshColor:u}=this.props,h=e&&e.props.mesh||new ni({drawMode:4,attributes:iL(r),indices:s}),f=this.getSubLayerClass("mesh",Yo);return new f(this.getSubLayerProps({id:"mesh"}),{id:"".concat(this.id,"-mesh-").concat(t.id),tile:t,mesh:h,data:pd,getColor:u(t),pbrMaterial:c,modelMatrix:o,coordinateOrigin:a,coordinateSystem:H.METER_OFFSETS,featureIds:l,_offset:0})}renderLayers(){const{tileset3d:t,layerMap:e}=this.state;return t?t.tiles.map(i=>{const r=e[i.id]=e[i.id]||{tile:i};let{layer:s}=r;return i.selected&&(s?r.needsUpdate&&(s=this._getSubLayer(i,s),r.needsUpdate=!1):s=this._getSubLayer(i)),r.layer=s,s}).filter(Boolean):null}}function iL(n){const t={};return t.positions=k(E({},n.positions),{value:new Float32Array(n.positions.value)}),n.normals&&(t.normals=n.normals),n.texCoords&&(t.texCoords=n.texCoords),n.colors&&(t.colors=n.colors),n.uvRegions&&(t.uvRegions=n.uvRegions),t}md.layerName="Tile3DLayer";md.defaultProps=nL;export{Lv as A,zu as D,Hu as L,sL as M,md as T,gd as a};
